# Project State

## Project Reference

See: .planning/PROJECT.md (updated 2026-02-14)

**Core value:** Surface interesting articles and hide noise automatically via local LLM curation
**Current focus:** Phase 8.3 - Category Group Management Redesign

## Current Position

Phase: 8.3 of 10 (Category Group Management Redesign)
Plan: 6 of 6 complete
Status: Complete
Last activity: 2026-02-19 - Completed Phase 08.3 Plan 06 (UAT Gap Closure)

Progress: [██████████] 100% (36/36 total plans estimated from v1.1) + 08.3 in progress

## Performance Metrics

**Velocity (v1.0):**
- Total plans completed: 19
- Average duration: ~5 minutes
- Total execution time: ~1.8 hours

**By Phase:**

| Phase | Plans | Total | Avg/Plan |
|-------|-------|-------|----------|
| 01    | 3     | ~35 min | ~12 min |
| 02    | 4     | ~15 min | ~4 min |
| 03    | 4     | ~20 min | ~5 min |
| 04    | 5     | ~57 min | ~11 min |
| 05    | 3     | ~25 min | ~8 min |
| 06    | 1     | ~1 min | ~1 min |

*Carried forward from v1.0 for reference*

**Phase 06 Metrics:**
| Phase 06-ui-theme-polish P01 | 1.3 | 2 tasks | 3 files |
| Phase 06-ui-theme-polish P02 | 2.7 | 2 tasks | 5 files |
| Phase 06-ui-theme-polish P03 | 2.9 | 2 tasks | 6 files |

**Phase 07 Metrics:**
| Phase 07-ollama-configuration-ui P01 | 4.0 | 2 tasks | 6 files |
| Phase 07-ollama-configuration-ui P02 | 5.4 | 2 tasks | 11 files |
| Phase 07-ollama-configuration-ui P03 | 4.0 | 2 tasks | 5 files |
| Phase 07-ollama-configuration-ui P04 | 5.0 | 3 tasks | 3 files |
| Phase 07-ollama-configuration-ui P05 | 2.0 | 2 tasks | 2 files |
| Phase 07-ollama-configuration-ui P06 | 2.0 | 3 tasks | 4 files |

**Phase 08 Metrics:**
| Phase 08-category-grouping P01 | 3.0 | 2 tasks | 5 files |
| Phase 08-category-grouping P02 | 5.0 | 2 tasks | 9 files |
| Phase 08-category-grouping P03 | 2.5 | 2 tasks | 4 files |
| Phase 08-category-grouping P04 | 5.8 | 2 tasks | 5 files |
| Phase 08-category-grouping P05 | 2.0 | 1 tasks | 2 files |
| Phase 08-category-grouping P06 | 3.7 | 2 tasks | 2 files |
| Phase 08-category-grouping P07 | 7.0 | 2 tasks | 3 files |
| Phase 08-category-grouping P08 | 5.0 | 2 tasks | 3 files |
| Phase 08-category-grouping P09 | 2.0 | 1 tasks | 2 files |
| Phase 08-category-grouping P10 | 2.0 | 1 tasks | 1 files |
| Phase 08-category-grouping P11 | 3.0 | 2 tasks | 1 files |

**Phase 08.1 Metrics:**
| Phase 08.1-categories-settings-ui-redesign P01 | 4.4 | 2 tasks | 5 files |
| Phase 08.1-categories-settings-ui-redesign P02 | 3.8 | 2 tasks | 7 files |
| Phase 08.1-categories-settings-ui-redesign P03 | 6.4 | 2 tasks | 6 files |
| Phase 08.1-categories-settings-ui-redesign P04 | 4.3 | 2 tasks | 4 files |
| Phase 08.1-categories-settings-ui-redesign P05 | 2.0 | 2 tasks | 2 files |
| Phase 08.1-categories-settings-ui-redesign P06 | 4.4 | 2 tasks | 5 files |
| Phase 08.1-categories-settings-ui-redesign P07 | 1.5 | 1 tasks | 1 files |
| Phase 08.1 P08 | 3.1 | 2 tasks | 4 files |
| Phase 08.1 P10 | 2.4 | 2 tasks | 4 files |
| Phase 08.1 P09 | 2.0 | 2 tasks | 4 files |

**Phase 08.2 Metrics:**
| Phase 08.2-category-data-model-refactor P01 | 3.7 | 2 tasks | 4 files |
| Phase 08.2-category-data-model-refactor P02 | 4.3 | 2 tasks | 3 files |
| Phase 08.2-category-data-model-refactor P03 | 6.0 | 2 tasks | 2 files |
| Phase 08.2-category-data-model-refactor P04 | 3.0 | 2 tasks | 3 files |
| Phase 08.2-category-data-model-refactor P05 | 8.0 | 2 tasks | 11 files |
| Phase 08.2-category-data-model-refactor P06 | 2.9 | 2 tasks | 4 files |
| Phase 08.2-category-data-model-refactor P07 | 1.7 | 2 tasks | 3 files |
| Phase 08.2-category-data-model-refactor PP07 | 1.7 | 2 tasks | 3 files |

**Phase 08.3 Metrics:**
| Phase 08.3-category-group-management-redesign P01 | 3.0 | 2 tasks | 4 files |
| Phase 08.3-category-group-management-redesign P02 | 4.0 | 2 tasks | 5 files |

**Phase 08.3 Metrics:**
| Phase 08.3-category-group-management-redesign P01 | 3.3 | 2 tasks | 4 files |
| Phase 08.3-category-group-management-redesign P03 | 5.9 | 2 tasks | 9 files |
| Phase 08.3-category-group-management-redesign P04 | 4.2 | 2 tasks | 4 files |
| Phase 08.3-category-group-management-redesign P05 | 3.4 | 2 tasks | 5 files |
| Phase 08.3-category-group-management-redesign P06 | 2.5 | 2 tasks | 5 files |

## Accumulated Context

### Roadmap Evolution

- Phase 08.1 inserted after Phase 8: Categories Settings UI Redesign (INSERTED) — accordion-based category grouping has fundamental DnD issues with collapsed drop targets; needs full UX rethink before feedback system

### Decisions

Decisions are logged in PROJECT.md Key Decisions table.
v1.0 decisions archived in milestones/v1.0-ROADMAP.md — full log in STATE.md history.

Key architectural decisions carrying forward to v1.1:
- Two-step LLM pipeline (categorize → score) with separate models - enables independent optimization in Phase 7
- Composite scoring formula with interest × category_weight × quality_multiplier - foundation for Phase 8 grouping and Phase 9 feedback
- Pydantic Settings config with `@lru_cache` - creates constraint for Phase 7 (need two-tier config pattern)
- [Phase 06-ui-theme-polish]: Use OKLCH color space with hue ~55 (warm amber) and low chroma (0.01-0.02) for subtle warmth
- [Phase 06-ui-theme-polish]: Three distinct surface levels: bg.DEFAULT (15%), bg.subtle (17%), bg.panel (16%)
- [Phase 07-01]: Two-tier config: UserPreferences for runtime model names, Pydantic Settings for host/thinking/infrastructure
- [Phase 07-01]: Module-level state for download tracking (safe in single-worker asyncio)
- [Phase 07-01]: Score-only re-scoring skips categorization when only scoring model changed
- [Phase 07-02]: useReducer overlay pattern for form state to avoid setState-in-effect lint violations
- [Phase 07-02→07-06]: Upgraded NativeSelect to Chakra Select.Root with Portal/Positioner pattern for model dropdowns
- [Phase 07-03]: fetch+ReadableStream for SSE (not EventSource) because pull endpoint is POST
- [Phase 07-03→07-06]: Pulsing LuDownload icon via Emotion keyframes for download activity on sidebar
- [Phase 07-05]: Explicit intervalMs state for TanStack Query refetchInterval to ensure polling restarts after remount
- [Phase 07-05]: Full-width progress bar layout below trigger elements for consistent UX across all download types
- [Phase 08-01]: Three-tier weight resolution: explicit override > group weight > default normal (1.0)
- [Phase 08-01]: category_groups JSON structure: {groups, hidden_categories, seen_categories, returned_categories}
- [Phase 08-01]: New weight names: block/reduce/normal/boost/max (old names kept as fallback aliases)
- [Phase 08-02]: useCategories hook centralizes all category state management (groups, counts, mutations)
- [Phase 08-02]: ArticleReader uses direct useMutation for inline tag weight changes (decoupled from usePreferences)
- [Phase 08-03]: Compact Button group for weight presets (solid+accent active, ghost inactive) instead of SegmentGroup
- [Phase 08-03]: Accordion header split pattern: trigger on left, presets on right outside trigger with stopPropagation
- [Phase 08-04→Quick 11]: DragDropContext with Droppable/Draggable render props for cross-container category drag-and-drop (@hello-pangea/dnd)
- [Phase 08-04]: No optimistic onDragOver state -- move persists only on dragEnd for simplicity
- [Phase 08-04]: FeedRow rename pattern replicated for group names (double-click desktop, long-press mobile)
- [Phase 08-05]: Header dot badge via shared TanStack Query key reuses same cache as useCategories and SettingsSidebar
- [Phase 08-05]: Auto-acknowledge categories on weight or group weight change for seamless badge dismissal
- [Phase 08-06]: scrollbar-gutter: stable on content wrapper reserves space permanently, preventing sidebar shift
- [Phase 08-07]: Chakra Group+attached for segmented control weight preset buttons
- [Phase 08-07]: Fixed-width Box placeholder for conditional reset button to prevent layout shift
- [Phase 08-07]: Parent Flex hover instead of trigger-only hover for full-row group header coverage
- [Phase 08-08]: Hover-reveal pencil button replaces double-click/long-press for group rename (avoids accordion toggle conflict)
- [Phase 08-08]: Opacity-only visibility for badge X icon to avoid layout shift on hover
- [Phase 08-09/11]: Source container tracking prevents drag placeholder from appearing in source (only destination)
- [Phase 08-11]: Drag placeholder rendered outside Accordion.ItemContent for visibility when group is collapsed
- [Quick 10]: useDroppable setNodeRef on Accordion.Item (always visible) instead of Box inside ItemContent (zero dimensions when collapsed)
- [Quick 11]: Migrated all DnD from @dnd-kit to @hello-pangea/dnd -- Draggable/Droppable render props replace useSortable/useDraggable/useDroppable hooks, DragOverlay removed
- [Phase 08.1-01]: Use children map (dict[parent, list[child]]) instead of groups array for simpler parent-child lookup
- [Phase 08.1-01]: Seed 8 parent categories on fresh install to provide structure out of the box
- [Phase 08.1-01]: Parent categories inherit group weights during migration to preserve user preferences
- [Phase 08.1-02]: Use manual tree layout with CSS connector lines instead of Chakra TreeView for full control over row rendering
- [Phase 08.1-02]: Display inherited weights at 50% opacity to distinguish from explicit overrides
- [Phase 08.1-02]: Render ungrouped categories as flat list after parents (not as a separate section header)
- [Phase 08.1-02]: Display inherited weights at 50% opacity to distinguish from explicit overrides
- [Phase 08.1-02]: Render ungrouped categories as flat list after parents (not as a separate section header)
- [Phase 08.1-03]: Use @dnd-kit instead of @hello-pangea/dnd for tree DnD (better suited for non-list structures)
- [Phase 08.1-03]: Search filtering disables DnD to avoid confusion with filtered tree structure
- [Phase 08.1-03]: Prevent nesting parents with children under other parents (max 2-level hierarchy)
- [Phase 08.1-03]: Drop placeholder shows inside parent row when hovering with active drag
- [Phase 08.1-03]: Hover-reveal pencil/trash buttons replace double-click/long-press for rename/delete
- [Phase 08.1-04]: Desktop hover-expand weight preset strip with CSS max-width transition (collapses to single active icon)
- [Phase 08.1-04]: Mobile swipe-to-reveal edit gesture using react-swipeable with translateX animation
- [Phase 08.1-04]: SwipeableRow uses display: contents on desktop to pass-through without wrapper element
- [Phase 08.1-04]: Old WeightPresets preserved for ArticleReader usage (not deleted during categories UI redesign)
- [Phase 08.1-05]: Request body for DELETE/PATCH category endpoints instead of URL path params (handles slashes and special chars)
- [Phase 08.1-05]: Category rename updates article.categories in DB via full scan (acceptable for single-user app)
- [Phase 08.1-06]: Combined useDroppable + useSortable via callback ref for drop feedback on ungrouped rows
- [Phase 08.1-06]: Ungroup drop zone renders only during active drag (conditional on activeId)
- [Phase 08.1-06]: Prefixed droppable IDs (drop:category) stripped in handleDragEnd to resolve to actual category names
- [Phase 08.1-07]: Optimistic mutations with onMutate snapshot/setQueryData, onError rollback + toast, onSettled invalidate
- [Phase 08.1-07]: Success toasts omitted to reduce noise -- instant UI update is primary feedback
- [Phase 08.1]: Per-child vertical line segments for L-shape connectors (not container line with bg masking)
- [Phase 08.1]: max-width animation per inactive icon wrapper for smooth weight strip expand/collapse
- [Phase 08.1]: Outline variant with accent border/color for active weight icon (not solid fill)
- [Phase 08.1-09]: Unified Flex wrapper for all action icons per row with maxWidth collapse animation (no per-button opacity)
- [Phase 08.1-09]: calc(100% + 4px) connector pseudo-element height to bridge Stack gap=1 between child rows
- [Phase 08.1-10]: Remove auto-acknowledge from weight change handler to eliminate dual categoryGroups invalidation
- [Phase 08.1-10]: Backend detail message propagation in createCategory API error for informative toast feedback
- [Phase 08.2-01]: Category/ArticleCategoryLink SQLModel tables replace JSON blobs (Article.categories, UserPreferences.topic_weights/category_groups)
- [Phase 08.2-01]: Two-pass category creation in migration: create all rows first, then resolve parent_id from slug lookup
- [Phase 08.2-01]: SMART_CASE_MAP dictionary for known acronym/brand casing (AI, iOS, macOS, etc.) with kebab_to_display helper
- [Phase 08.2-02]: LLM outputs display names, system slugifies for matching via get_or_create pattern
- [Phase 08.2-02]: Hidden categories auto-unhide (is_hidden=False, is_seen=False) when they reappear in scoring, replacing returned_categories JSON list
- [Phase 08.2-02]: get_effective_weight three-tier resolution: category.weight > parent.weight > "normal"
- [Phase 08.2-03]: selectinload(categories_rel).joinedload(parent) chain for eager loading article categories + parent
- [Phase 08.2-03]: ArticleResponse Pydantic model for enriched article serialization with rich category embeds
- [Phase 08.2-03]: Merge endpoint deletes source links and creates new target links (composite PK can't be updated in-place)
- [Phase 08.2-03]: CategoryUpdate uses parent_id=-1 sentinel to move to root, weight="inherit" sets to None
- [Phase 08.2-04]: Optimistic cache update only for updateCategory mutation (instant weight/rename feedback); simple invalidation for structural mutations
- [Phase 08.2-04]: useCategories exposes wrapper functions instead of raw mutate for cleaner consumer API
- [Phase 08.2-04]: Articles query invalidated on category mutations that affect article display (weight change, delete, merge, hide)
- [Phase 08.2-05]: Flat Category[] to tree via parent_id in useMemo (parents, childrenMap, ungrouped)
- [Phase 08.2-05]: DnD uses category.id.toString() IDs, parent_id=-1 sentinel for ungroup
- [Phase 08.2-05]: TagChip new weight names (max/boost/normal/reduce/block) with old aliases for backward compat
- [Phase 08.2-05]: ArticleReader uses effective_weight from ArticleCategory embed (no more topic_weights lookup)
- [Phase 08.2-06]: Local optimistic state (localValue) in WeightPresetStrip with useEffect sync for instant visual feedback
- [Phase 08.2-06]: Auto-acknowledge (is_seen: true) injected in useCategories.updateCategory wrapper when weight changes
- [Phase 08.2-06]: React state-driven hover reveal (onMouseEnter/Leave + isHovered state) replaces broken _groupHover CSS patterns
- [Phase 08.3-01]: Hide = is_hidden + clear parent_id (leave group on hide), no weight change -- visibility flag only
- [Phase 08.3-01]: Batch endpoints use POST with category_ids array body, return {ok, count}
- [Phase 08.3-01]: Weight preservation on ungroup: copy parent.weight to child when child.weight is null before clearing parent_id
- [Phase 08.3-01]: Hidden categories in LLM prompt with "NEVER assign" avoidance instruction
- [Phase 08.3-02]: Controlled Collapsible.Root state (no Collapsible.Trigger) for localStorage persistence of parent expand/collapse
- [Phase 08.3-02]: Checkbox multi-select on child/ungrouped rows only (parents have no checkbox)
- [Phase 08.3-02]: Collapsed parent shows 'N new' badge that dismisses all unseen children on click
- [Phase 08.3-03]: CategoryContextMenu shared component with type prop for role-based items (parent/child/ungrouped)
- [Phase 08.3-03]: Desktop static Flex header + mobile Chakra ActionBar.Root with Portal/Positioner/Content for floating bar
- [Phase 08.3-03]: Keep isHovered on child/ungrouped rows for New badge X animation; remove from parent row
- [Phase 08.3-04]: Expose createCategoryMutation for mutateAsync in create-and-move flow
- [Phase 08.3-04]: Unified deleteDialogState object for single/bulk delete instead of separate state variables
- [Phase 08.3-04]: Separate confirmation dialogs for batch ungroup (action bar) vs parent ungroup (context menu)
- [Phase 08.3-05]: Collapsible.Indicator for auto-rotating chevron in hidden section (follows SystemPrompts pattern)
- [Phase 08.3-05]: Dual-render WeightPresetStrip at breakpoints for mobile card layout (display none/block)
- [Phase 08.3-05]: Mobile card pattern: Box wrapper with responsive borderWidth/borderRadius, separate mobile-only weight strip row
- [Phase 08.3-06]: Single map loop with React.Fragment rendering mobile Button (icon+text) and desktop IconButton per weight option
- [Phase 08.3-06]: childrenMap prop for MoveToGroupDialog child count instead of article_count

### Pending Todos

1. **Establish design and UX principles for next milestone** (area: ui) — Define semantic status colors, interaction patterns, responsive UX conventions for v1.2+
2. **Codebase evaluation and simplification phase** (area: general) — Thorough evaluation of codebase, architecture, and data models to surface simplifications and address technical debt (hard-coded values, duplicated logic, inconsistencies) while retaining all functionality
3. **Fix Ollama client file descriptor leak** (area: backend, severity: blocker) — `scoring.py:categorize_article` creates a new `ollama.AsyncClient` per call without closing it, leaking httpx connections and SSL contexts. After ~60-70 articles the process hits `OSError: [Errno 24] Too many open files` and stops accepting connections. Fix: reuse a single client instance or properly close after each call.
4. **Add category search tool for categorisation LLM** (area: backend) — Replace embedded category list in the categorisation prompt with an Ollama tool-use approach, letting the LLM search for existing categories/parents by keyword for accurate matching
5. **Adopt article reader weight pattern in settings view** (area: ui) — Article reader tag chip weight changes are instant; settings WeightPresetStrip has a visible delay. Compare implementations and adopt the faster pattern.

### Blockers/Concerns

### Quick Tasks Completed

| # | Description | Date | Commit | Directory |
|---|-------------|------|--------|-----------|
| 6 | Fix production API URL fallback: change \|\| to ?? so empty NEXT_PUBLIC_API_URL uses relative URLs | 2026-02-14 | a979370 | [6-fix-production-api-url-fallback-change-t](./quick/6-fix-production-api-url-fallback-change-t/) |
| 7 | Switch frontend Docker build from npm to bun for faster CI builds | 2026-02-14 | 6cf07cc | [7-switch-frontend-docker-build-from-npm-to](./quick/7-switch-frontend-docker-build-from-npm-to/) |
| 8 | Switch Ollama client to streaming responses to prevent timeouts on slower models | 2026-02-15 | 7e0add4 | [8-switch-ollama-client-to-streaming-respon](./quick/8-switch-ollama-client-to-streaming-respon/) |
| 9 | Consolidate Ollama disconnected state, split Model Library sub-sections, remove redundant SystemPrompts label | 2026-02-15 | 30be07b | [9-update-ollama-settings-panel-headings-se](./quick/9-update-ollama-settings-panel-headings-se/) |
| 10 | Fix category drag-and-drop placeholder (destination detection) and badge dismiss X spacing/size/divider | 2026-02-16 | 0ffaebc | [10-fix-category-drag-and-drop-placeholder-a](./quick/10-fix-category-drag-and-drop-placeholder-a/) |
| 11 | ~~Migrate all DnD from @dnd-kit to @hello-pangea/dnd~~ (reverted: collapsed accordion drop targets incompatible) | 2026-02-17 | 34908f2 | [11-migrate-drag-and-drop-from-dnd-kit-to-he](./quick/11-migrate-drag-and-drop-from-dnd-kit-to-he/) |

**Phase 7 considerations:**
- Pydantic Settings `@lru_cache` prevents runtime updates - requires two-tier config pattern (Settings for infrastructure, UserPreferences for runtime choices)
- Ollama model switching during active scoring creates race condition - needs investigation during planning (retry vs queue pause)

**Phase 9 considerations:**
- Scope driven by todo #2 (codebase evaluation) plus specific findings from Phase 08.3 review (useCategories hook bloat, wrapper indirection)
- Should be a quick phase — evaluation + targeted fixes, not a rewrite

**Phase 10 considerations:**
- Feedback aggregation strategy is custom (no standard implementation) - flagged for deeper research during planning
- Minimum sample size and weight delta parameters are heuristics not empirically validated - start conservative, monitor in production

## Session Continuity

Last session: 2026-02-19
Stopped at: Phase 9 context gathered
Resume file: .planning/phases/09-frontend-codebase-evaluation-simplification/09-CONTEXT.md

---
*State initialized: 2026-02-14*
*Last updated: 2026-02-19 after Phase 9 context gathering*
