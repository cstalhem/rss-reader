---
phase: 08-category-grouping
plan: 03
type: execute
wave: 3
depends_on: ["08-02"]
files_modified:
  - frontend/src/components/settings/CategoriesSection.tsx
  - frontend/src/components/settings/WeightPresets.tsx
  - frontend/src/components/settings/CategoryRow.tsx
  - frontend/src/components/settings/CategoryGroupAccordion.tsx
autonomous: true

must_haves:
  truths:
    - "User can see categories organized in collapsible accordion groups"
    - "User can see ungrouped categories in a flat list below groups"
    - "User can set a weight on a group via 5 preset buttons in the accordion header"
    - "User can set a weight on an individual category via inline preset buttons"
    - "Overridden categories within a group show a visual indicator and reset-to-inherited action"
    - "User can hide/remove individual categories"
  artifacts:
    - path: "frontend/src/components/settings/WeightPresets.tsx"
      provides: "Reusable 5-button weight preset control (Block/Reduce/Normal/Boost/Max)"
      contains: "WeightPresets"
    - path: "frontend/src/components/settings/CategoryRow.tsx"
      provides: "Single category row with weight presets, hide button, drag handle"
      contains: "CategoryRow"
    - path: "frontend/src/components/settings/CategoryGroupAccordion.tsx"
      provides: "Accordion group with header weight presets and category rows"
      contains: "CategoryGroupAccordion"
    - path: "frontend/src/components/settings/CategoriesSection.tsx"
      provides: "Full categories section with groups and ungrouped list"
      contains: "Accordion.Root"
  key_links:
    - from: "frontend/src/components/settings/CategoriesSection.tsx"
      to: "frontend/src/hooks/useCategories.ts"
      via: "useCategories hook provides data and mutations"
      pattern: "useCategories"
    - from: "frontend/src/components/settings/CategoryGroupAccordion.tsx"
      to: "frontend/src/components/settings/WeightPresets.tsx"
      via: "Group header uses WeightPresets with stopPropagation"
      pattern: "WeightPresets.*stopPropagation"
    - from: "frontend/src/components/settings/CategoryRow.tsx"
      to: "frontend/src/components/settings/WeightPresets.tsx"
      via: "Each row renders inline WeightPresets"
      pattern: "WeightPresets"
---

<objective>
Categories section UI: accordion groups with weight presets, ungrouped category list, hide/unhide, and weight management.

Purpose: Build the core visual UI for category management. Users can see their categories organized into groups, set weights at group and category level using the 5 preset buttons, see override indicators, and hide individual categories. This plan focuses on the static/interactive UI -- drag-and-drop and group CRUD come in Plan 04.

Output: Fully functional categories section with accordion groups, weight presets, and category management (minus DnD and group creation).
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-category-grouping/08-CONTEXT.md
@.planning/phases/08-category-grouping/08-RESEARCH.md
@.planning/phases/08-category-grouping/08-02-SUMMARY.md
@frontend/src/hooks/useCategories.ts
@frontend/src/lib/types.ts
@frontend/src/components/settings/OllamaSection.tsx
@frontend/src/components/feed/FeedRow.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: WeightPresets and CategoryRow components</name>
  <files>
    frontend/src/components/settings/WeightPresets.tsx
    frontend/src/components/settings/CategoryRow.tsx
  </files>
  <action>
**WeightPresets.tsx** -- Create a reusable weight preset control with 5 buttons: Block (0.0), Reduce (0.5), Normal (1.0), Boost (1.5), Max (2.0).

Per user decision, these should feel like a segmented control. Try Chakra v3 `SegmentGroup` first with `size="xs"`. If it renders too wide to fit inline on a category row (5 items in a row is tight), fall back to a compact `Button` group pattern -- small `Button` components with `size="xs"`, `variant="solid"` + `colorPalette="accent"` for active, `variant="ghost"` for inactive (this matches the existing pattern from the old InterestsSection).

Props:
```typescript
interface WeightPresetsProps {
  value: string;           // Current weight: "block" | "reduce" | "normal" | "boost" | "max"
  onChange: (weight: string) => void;
  isOverridden?: boolean;  // Show override indicator (for categories inside groups)
  onReset?: () => void;    // Reset to inherited weight (for categories inside groups)
  size?: "sm" | "xs";      // "sm" for group headers, "xs" for category rows
  onClick?: (e: React.MouseEvent) => void;  // For stopPropagation in accordion headers
}
```

The weight options array:
```typescript
const WEIGHT_OPTIONS = [
  { value: "block", label: "Block" },
  { value: "reduce", label: "Reduce" },
  { value: "normal", label: "Normal" },
  { value: "boost", label: "Boost" },
  { value: "max", label: "Max" },
];
```

When `isOverridden` is true and `onReset` is provided, show a small `LuUndo2` icon button next to the presets for resetting to inherited weight.

**CategoryRow.tsx** -- A single category row that appears both inside group accordions and in the ungrouped list.

Props:
```typescript
interface CategoryRowProps {
  category: string;
  weight: string;                     // Effective weight for this category
  isOverridden?: boolean;             // Has explicit override (within a group)
  isNew?: boolean;                    // Show "New" badge
  isReturned?: boolean;               // Show "Returned" badge
  onWeightChange: (weight: string) => void;
  onResetWeight?: () => void;         // Reset to group weight
  onHide: () => void;                 // Remove/hide this category
  onBadgeDismiss?: () => void;        // Dismiss new/returned badge
  showCheckbox?: boolean;             // For ungrouped list selection
  isChecked?: boolean;
  onCheckChange?: (checked: boolean) => void;
  isDraggable?: boolean;              // Show drag handle
  dragHandleProps?: Record<string, unknown>;  // From useSortable
}
```

Layout: A `Flex` row with:
- Optional checkbox (Chakra `Checkbox.Root` for ungrouped selection)
- Optional drag handle (`LuGripVertical` icon, only when isDraggable)
- Category name as `Text` with `textTransform="capitalize"` and kebab-case to title case conversion (replace `-` with space)
- Optional "New" chip badge (small `Badge` with `colorPalette="accent"`, label "New") or "Returned" chip badge (small `Badge` with `colorPalette="yellow"` or a distinct muted color, label "Returned"). Badges are clickable to dismiss (call `onBadgeDismiss`).
- `WeightPresets` component inline
- Hide button: small `IconButton` with `LuEyeOff` or `LuX` icon, `variant="ghost"`, `size="xs"`, on hover only (use parent hover state or always visible on mobile)

Style: `p={2}`, `bg="bg.subtle"`, `borderRadius="sm"`, matching the existing settings panel card style. When `isOverridden` is true, show accent-colored preset buttons (the WeightPresets handles this via its styling).
  </action>
  <verify>
Run `cd /Users/cstalhem/projects/rss-reader/frontend && bunx tsc --noEmit` -- no type errors.
  </verify>
  <done>
- WeightPresets component renders 5 preset buttons with active state highlighting
- WeightPresets supports size variants for group headers vs category rows
- CategoryRow renders category name, weight presets, optional badges, optional checkbox, optional drag handle
- Override indicator and reset action work correctly
- Components type-check clean
  </done>
</task>

<task type="auto">
  <name>Task 2: CategoryGroupAccordion and CategoriesSection assembly</name>
  <files>
    frontend/src/components/settings/CategoryGroupAccordion.tsx
    frontend/src/components/settings/CategoriesSection.tsx
  </files>
  <action>
**CategoryGroupAccordion.tsx** -- An accordion item for a single category group.

Props:
```typescript
interface CategoryGroupAccordionProps {
  group: CategoryGroup;
  topicWeights: Record<string, string> | null;  // For detecting overrides
  onGroupWeightChange: (groupId: string, weight: string) => void;
  onCategoryWeightChange: (category: string, weight: string) => void;
  onResetCategoryWeight: (category: string) => void;
  onHideCategory: (category: string) => void;
  onBadgeDismiss: (category: string) => void;
  newCategories: Set<string>;         // Categories with "New" badge
  returnedCategories: Set<string>;    // Categories with "Returned" badge
}
```

Uses Chakra v3 `Accordion.Item` structure:
- The accordion header is a custom `Flex` row, NOT entirely wrapped in `Accordion.ItemTrigger`. Place the group name + expand indicator in `Accordion.ItemTrigger`, but the weight presets OUTSIDE the trigger to avoid click conflicts (per research Pitfall 1). Use a `Flex` wrapper with `justifyContent="space-between"` containing the trigger on the left and presets on the right.
- Weight presets in header: `WeightPresets` with `size="sm"`, `onClick={(e) => e.stopPropagation()}` as extra safety.
- Accordion body: List of `CategoryRow` components for each category in `group.categories`.
- For each category in the group, determine if it has an explicit override: check if `topicWeights[category]` exists and differs from the group weight. If so, pass `isOverridden={true}` and the `onResetWeight` callback.
- Effective weight for each category: `topicWeights[category] || group.weight || "normal"`.
- Categories within the group are sorted alphabetically.

**CategoriesSection.tsx** -- Replace the placeholder with the full implementation.

This component orchestrates all category management. It uses `useCategories()` hook for data and mutations, plus `usePreferences()` for topic_weights.

Layout (per user decision -- multi-panel card pattern matching Ollama):
1. Panel header: "Topic Categories" heading + category count badge (showing new category count if > 0, positioned next to the heading) + "Group selected" button (disabled -- will be enabled in Plan 04 when selection is wired up).

2. Accordion section: `Accordion.Root` with `multiple` and `collapsible` props. Render `CategoryGroupAccordion` for each group in `categoryGroups.groups`, sorted alphabetically by group name.

3. Ungrouped section: Below the accordion, render an "Ungrouped" subsection heading (muted style, matching Ollama subsection headings -- `Text` with `fontSize="sm"`, `fontWeight="semibold"`, `color="fg.muted"`, `textTransform="uppercase"`, `letterSpacing="wider"`). Below it, render `CategoryRow` for each ungrouped category.

Ungrouped categories = all categories from `allCategories` list that are NOT in any group's `categories` array and NOT in `hidden_categories`. Each ungrouped category gets `showCheckbox={true}` (but selection state management is Plan 04 -- for now render checkboxes as uncontrolled/disabled).

Weight change handlers:
- Group weight change: Update the group's weight in the category_groups structure, then call `saveGroups` mutation with the full updated structure.
- Category weight change: Call the existing `updateCategoryWeight` API (PATCH /api/categories/{name}/weight) or update `topic_weights` through `saveGroups`. Prefer using the existing preferences-based approach: update `topic_weights` via the preferences endpoint, then invalidate queries.
- Reset category weight: Remove the category from `topic_weights` (so it falls through to group weight), save via preferences.

Hide category: Call `hideCategory` mutation from `useCategories`.

Badge dismiss: Call `acknowledge` mutation with the category name.

Empty state: When no categories exist, show the empty state with LuTag icon (already from Plan 02 placeholder).
  </action>
  <verify>
Run `cd /Users/cstalhem/projects/rss-reader/frontend && bunx tsc --noEmit` -- no type errors.
Run `cd /Users/cstalhem/projects/rss-reader/frontend && bun run lint` -- no lint errors.
Run `cd /Users/cstalhem/projects/rss-reader/frontend && bun run build` -- production build succeeds.
  </verify>
  <done>
- CategoriesSection renders accordion groups with weight presets in headers
- Ungrouped categories render in flat list below groups
- Weight preset buttons work: clicking a preset saves the weight
- Override indicator shows on categories with explicit weights inside groups
- Reset-to-inherited action removes explicit weight override
- Hide category works (category disappears from list)
- New/Returned badges render on appropriate categories
- Production build succeeds
  </done>
</task>

</tasks>

<verification>
- `bunx tsc --noEmit` passes
- `bun run build` succeeds
- Categories section renders groups as collapsible accordions
- Weight presets in group headers work without toggling accordion
- Category rows show inline weight presets
- Override indicator shows correctly for categories with explicit weights in groups
- Hide button removes category from view
</verification>

<success_criteria>
- Full category management UI visible in settings
- Accordion groups with weight presets functional
- Ungrouped list with weight presets functional
- Override/reset mechanism works
- Hide/show categories works
- Clean TypeScript build
</success_criteria>

<output>
After completion, create `.planning/phases/08-category-grouping/08-03-SUMMARY.md`
</output>
