---
phase: 08-category-grouping
plan: 11
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/components/settings/CategoryGroupAccordion.tsx
  - frontend/src/components/settings/CategoriesSection.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Dragged category shows placeholder row in destination container (not source)"
    - "Drag performance is smooth without lag in Safari"
  artifacts:
    - path: "frontend/src/components/settings/CategoryGroupAccordion.tsx"
      provides: "Placeholder outside Accordion.ItemContent with source exclusion"
      pattern: "activeId.*sourceContainer.*Accordion\\.ItemContent"
    - path: "frontend/src/components/settings/CategoriesSection.tsx"
      provides: "activeId and sourceContainer tracking with memoization"
      pattern: "sourceContainer.*useMemo"
  key_links:
    - from: "frontend/src/components/settings/CategoriesSection.tsx"
      to: "CategoryGroupAccordion activeId + sourceContainer props"
      via: "DnD state tracking"
      pattern: "activeId=.*sourceContainer="
---

<objective>
Fix drag placeholder to appear in destination container (not source) and improve Safari drag performance by tracking source container and minimizing re-renders.

Purpose: Address major UX issue where drag preview appears in wrong location and performance lag during drag operations
Output: Correct placeholder positioning in drop targets with smooth drag performance
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-category-grouping/08-04-SUMMARY.md
@.planning/phases/08-category-grouping/08-08-SUMMARY.md
@.planning/phases/08-category-grouping/08-UAT.md

@frontend/src/components/settings/CategoryGroupAccordion.tsx
@frontend/src/components/settings/CategoriesSection.tsx
</context>

<tasks>

<task type="auto">
  <name>Track source container and exclude from placeholder rendering</name>
  <files>
    frontend/src/components/settings/CategoriesSection.tsx
  </files>
  <action>
Update CategoriesSection to track the source container when drag starts and pass it to child components.

**Add sourceContainer state:**
After `const [activeId, setActiveId] = useState<string | null>(null);` (around line 44), add:
```tsx
const [sourceContainer, setSourceContainer] = useState<string | null>(null);
```

**Update handleDragStart (line 251):**
```tsx
const handleDragStart = useCallback((event: DragStartEvent) => {
  const draggedCategory = event.active.id as string;
  const source = findContainer(draggedCategory);
  setActiveId(draggedCategory);
  setSourceContainer(source);
}, [findContainer]);
```

**Update handleDragEnd (line 260):**
```tsx
const handleDragEnd = useCallback((event: DragEndEvent) => {
  // ... existing logic ...
  setActiveId(null);
  setSourceContainer(null); // ADD THIS LINE
  // ... rest of existing logic ...
}, [/* existing deps */]);
```

**Pass sourceContainer to children:**
Update all CategoryGroupAccordion instances (around line 400+) to include:
```tsx
sourceContainer={sourceContainer}
```

Update UngroupedDroppable section (around line 72-87) placeholder condition:
```tsx
{isOver && activeId && sourceContainer !== "ungrouped" && (
  <Box
    borderWidth="2px"
    borderStyle="dashed"
    borderColor="accent.subtle"
    borderRadius="md"
    p={3}
    bg="bg.muted"
    opacity={0.7}
  >
    <Text fontSize="sm" color="fg.muted">
      {toTitleCase(activeId)}
    </Text>
  </Box>
)}
```

**Memoize findContainer:**
Wrap `findContainer` in `useMemo` to prevent re-creation on every render (improves drag performance):
```tsx
const findContainer = useMemo(() => {
  return (categoryId: string): string => {
    // existing logic
  };
}, [categoryGroups]);
```

Gap reason from UAT: "Placeholder does not appear in destination container, only in current container. Performance is also laggy in Safari when dragging."
  </action>
  <verify>
```bash
cd frontend && bun run build && bun dev --port 3210
```
Test drag behavior:
1. Drag category from ungrouped toward a group - placeholder should appear INSIDE the group, not in ungrouped list
2. Drag category from one group to another - placeholder should appear in destination group only
3. Drag should feel smooth in Safari without visible lag
  </verify>
  <done>
CategoriesSection tracks source container on drag start, passes it to all child droppable components, and memoizes findContainer for performance. Placeholder logic excludes source container.
  </done>
</task>

<task type="auto">
  <name>Render placeholder outside Accordion.ItemContent and exclude source</name>
  <files>
    frontend/src/components/settings/CategoryGroupAccordion.tsx
  </files>
  <action>
Update CategoryGroupAccordion to accept `sourceContainer` prop and fix placeholder positioning.

**Add sourceContainer to props interface (around line 12):**
```tsx
interface Props {
  group: CategoryGroup;
  allCategories: string[];
  onWeightChange: (groupId: string, weight: number) => void;
  onCategoryWeightChange: (category: string, weight: number | null) => void;
  onRename: (groupId: string, newName: string) => void;
  onDelete: (groupId: string) => void;
  onBadgeDismiss: (category: string) => void;
  isDragActive: boolean;
  activeId: string | null;
  sourceContainer: string | null; // ADD THIS
}
```

**Update placeholder condition (line 90-91):**
```tsx
const showPlaceholder =
  isOver &&
  activeId &&
  sourceContainer !== group.id &&
  !group.categories.includes(activeId);
```

**Move placeholder outside Accordion.ItemContent:**

Currently placeholder is inside `<Accordion.ItemContent>` which hides it when accordion is collapsed.

Find the `{showPlaceholder && (` section inside ItemContent (around line 200+) and move it AFTER the `</Accordion.ItemContent>` closing tag but still inside the `<Accordion.Item>` wrapper.

Structure should be:
```tsx
<Accordion.Item value={group.id}>
  {/* Header with trigger and controls */}

  <Accordion.ItemContent>
    {/* Category rows */}
  </Accordion.ItemContent>

  {showPlaceholder && (
    <Box
      borderWidth="2px"
      borderStyle="dashed"
      borderColor="accent.subtle"
      borderRadius="md"
      p={3}
      mx={4}
      mb={2}
      bg="bg.muted"
      opacity={0.7}
    >
      <Text fontSize="sm" color="fg.muted">
        {toTitleCase(activeId)}
      </Text>
    </Box>
  )}
</Accordion.Item>
```

Add mx={4} and mb={2} to placeholder Box for proper spacing when group is collapsed.

Gap reason: "Placeholder does NOT appear in destination container because it's inside Accordion.ItemContent which is hidden when accordion is collapsed."
  </action>
  <verify>
```bash
cd frontend && bun run build
```
Test with collapsed groups:
1. Collapse a group accordion
2. Drag a category toward the collapsed group
3. Placeholder should appear below the collapsed group header (not hidden)
4. Drag toward expanded group - placeholder should appear inside the ItemContent area
  </verify>
  <done>
CategoryGroupAccordion accepts sourceContainer prop, excludes source from placeholder logic, and renders placeholder outside Accordion.ItemContent so it's visible even when group is collapsed.
  </done>
</task>

</tasks>

<verification>
Build passes. Drag testing confirms:
- Placeholder appears in destination container, not source
- Placeholder visible for collapsed groups
- No lag during drag operations in Safari
- UAT test #8 passes
</verification>

<success_criteria>
- Dragging category toward any group shows placeholder in that group (not source)
- Placeholder visible even when destination group accordion is collapsed
- Drag performance is smooth without visible lag in Safari
- Source container is excluded from showing placeholder
- UAT test #8 passes with correct placeholder positioning
</success_criteria>

<output>
After completion, create `.planning/phases/08-category-grouping/08-11-SUMMARY.md`
</output>
