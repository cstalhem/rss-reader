---
phase: 08-category-grouping
plan: 04
type: execute
wave: 4
depends_on: ["08-03"]
files_modified:
  - frontend/src/components/settings/CategoriesSection.tsx
  - frontend/src/components/settings/CategoryRow.tsx
  - frontend/src/components/settings/CategoryGroupAccordion.tsx
  - frontend/src/components/settings/GroupNamePopover.tsx
  - frontend/src/components/settings/DeleteGroupDialog.tsx
autonomous: true

must_haves:
  truths:
    - "User can drag categories between groups and from ungrouped into groups"
    - "User can select ungrouped categories and create a new named group"
    - "User can rename a group by double-clicking its name"
    - "User can delete a group, releasing its categories back to ungrouped"
    - "Groups are alphabetically auto-sorted"
  artifacts:
    - path: "frontend/src/components/settings/GroupNamePopover.tsx"
      provides: "Popover for naming new groups during creation"
      contains: "GroupNamePopover"
    - path: "frontend/src/components/settings/DeleteGroupDialog.tsx"
      provides: "Confirmation dialog for deleting a group"
      contains: "DeleteGroupDialog"
    - path: "frontend/src/components/settings/CategoriesSection.tsx"
      provides: "DndContext wrapping all groups and ungrouped list"
      contains: "DndContext"
  key_links:
    - from: "frontend/src/components/settings/CategoriesSection.tsx"
      to: "@dnd-kit/core"
      via: "Single DndContext with closestCorners collision, DragOverlay"
      pattern: "DndContext.*closestCorners"
    - from: "frontend/src/components/settings/CategoryGroupAccordion.tsx"
      to: "@dnd-kit/core"
      via: "useDroppable makes each group a drop target"
      pattern: "useDroppable"
    - from: "frontend/src/components/settings/CategoriesSection.tsx"
      to: "frontend/src/hooks/useCategories.ts"
      via: "saveGroups persists DnD moves and group CRUD"
      pattern: "saveGroups"
---

<objective>
Drag-and-drop between containers and group CRUD: create, rename, delete groups.

Purpose: Add the interactive layer for reorganizing categories. Users can drag categories between groups, select and group ungrouped categories, rename groups inline, and delete groups. This completes the core category grouping functionality.

Output: Fully interactive category management with cross-container drag-and-drop and group lifecycle operations.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-category-grouping/08-CONTEXT.md
@.planning/phases/08-category-grouping/08-RESEARCH.md
@.planning/phases/08-category-grouping/08-03-SUMMARY.md
@frontend/src/components/settings/CategoriesSection.tsx
@frontend/src/components/settings/CategoryRow.tsx
@frontend/src/components/settings/CategoryGroupAccordion.tsx
@frontend/src/components/feed/FeedRow.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Cross-container drag-and-drop</name>
  <files>
    frontend/src/components/settings/CategoriesSection.tsx
    frontend/src/components/settings/CategoryRow.tsx
    frontend/src/components/settings/CategoryGroupAccordion.tsx
  </files>
  <action>
**CategoriesSection.tsx** -- Wrap the accordion groups and ungrouped list in a single `DndContext` (per research Pitfall 2 -- never nest multiple DndContexts).

Import from `@dnd-kit/core`: `DndContext`, `DragOverlay`, `DragStartEvent`, `DragOverEvent`, `DragEndEvent`, `closestCorners`, `PointerSensor`, `useSensor`, `useSensors`, `UniqueIdentifier`.
Import from `@dnd-kit/sortable`: `SortableContext`, `verticalListSortingStrategy`.

Set up sensors: `PointerSensor` with `activationConstraint: { distance: 5 }` to prevent accidental drags on click.

State management for DnD:
- `activeId: string | null` -- which category is being dragged
- Track the container each category belongs to locally for optimistic updates during `onDragOver`

**onDragStart**: Set `activeId` to the dragged category name.

**onDragOver**: Detect when the dragged item crosses into a different container. Update local state optimistically so the item visually appears in the new container during drag. Identify the source and destination containers by checking which group (or "ungrouped") contains the `active.id` and `over.id`.

**onDragEnd**: Persist the move:
1. Determine source container (group ID or "ungrouped") and destination container
2. If different containers: remove category from source group's `categories` array, add to destination group's `categories` array (or remove from group if dropping into ungrouped)
3. Build updated `category_groups` structure and call `saveGroups`
4. If the category had an explicit weight override and is moving into a group, keep the override in `topic_weights` (user can reset it manually later)
5. Reset `activeId` to null

**DragOverlay**: Render a visual preview of the dragged category row. Use a simplified `CategoryRow` (or just a `Box` with the category name styled as a card) rendered in a Portal-like manner via DragOverlay.

Disable accordion toggle during active drag to prevent glitches (per research Pitfall 6). Track `isDragging` state from `activeId !== null` and pass it to accordion component.

**CategoryRow.tsx** -- Add `useSortable` from `@dnd-kit/sortable` to make each category row draggable. Apply `CSS.Transform.toString(transform)` and `transition` from useSortable to the row style. Pass `setNodeRef` to the row's ref. The drag handle (`LuGripVertical`) should use `{...attributes} {...listeners}` from useSortable. Set `isDraggable` to true for all category rows.

**CategoryGroupAccordion.tsx** -- Add `useDroppable` from `@dnd-kit/core` with the group's ID. Apply `setNodeRef` to the accordion body container. Wrap the category rows in a `SortableContext` with `verticalListSortingStrategy`. Highlight the container when `isOver` (e.g., `bg="bg.muted"` or a subtle border color change). Add a prop `isDragActive` to disable the accordion trigger during active drag.

Also add a droppable container for the "ungrouped" section in CategoriesSection, with `useDroppable({ id: "ungrouped" })` and its own `SortableContext`.

Checkbox selection state for ungrouped categories:
- Track `selectedCategories: Set<string>` in CategoriesSection state
- Pass `showCheckbox={true}`, `isChecked`, and `onCheckChange` to ungrouped CategoryRow components
- Clear selection after group creation
  </action>
  <verify>
Run `cd /Users/cstalhem/projects/rss-reader/frontend && bunx tsc --noEmit` -- no type errors.
  </verify>
  <done>
- Single DndContext wraps all groups and ungrouped list
- Categories can be dragged between groups
- Categories can be dragged from ungrouped into groups and from groups to ungrouped
- DragOverlay shows a visual preview during drag
- Drops persist to backend via saveGroups
- Accordion doesn't toggle during active drag
- Checkbox selection works for ungrouped categories
  </done>
</task>

<task type="auto">
  <name>Task 2: Group create, rename, and delete</name>
  <files>
    frontend/src/components/settings/GroupNamePopover.tsx
    frontend/src/components/settings/DeleteGroupDialog.tsx
    frontend/src/components/settings/CategoriesSection.tsx
    frontend/src/components/settings/CategoryGroupAccordion.tsx
  </files>
  <action>
**GroupNamePopover.tsx** -- Popover for naming a new group. Uses Chakra v3 Popover with Portal/Positioner pattern (per project convention).

Props:
```typescript
interface GroupNamePopoverProps {
  selectedCount: number;              // Number of selected categories
  onCreateGroup: (name: string) => void;
  isDisabled: boolean;                // Disabled when no categories selected
}
```

Structure:
```
Popover.Root
  Popover.Trigger (asChild) -> Button "Group selected ({count})"
  Portal
    Popover.Positioner
      Popover.Content
        Popover.Body
          Field (label="Group name")
            Input (placeholder="e.g., Programming", autoFocus)
          Button "Create" (onClick -> validate name not empty, not duplicate, call onCreateGroup, close popover)
```

The trigger button should be disabled when `isDisabled` is true. Use Popover's `onOpenChange` to reset the input value when closing. Use `Popover.CloseTrigger` or manual open state to close after creation.

**DeleteGroupDialog.tsx** -- Confirmation dialog for deleting a group. Uses the same pattern as `DeleteFeedDialog.tsx` (Chakra v3 Dialog with Portal/Positioner).

Props:
```typescript
interface DeleteGroupDialogProps {
  groupName: string | null;           // null = dialog closed
  categoryCount: number;              // Number of categories that will be ungrouped
  onConfirm: () => void;
  onCancel: () => void;
}
```

Dialog body: "Delete group '{name}'? The {count} categories in this group will be moved back to the ungrouped list. Their individual weight overrides will be preserved."

Two buttons: Cancel (ghost) and Delete (red solid).

**CategoriesSection.tsx** -- Wire up "Group selected" button:
- Enable the GroupNamePopover trigger when `selectedCategories.size > 0`
- `onCreateGroup` handler:
  1. Create a new group object: `{ id: crypto.randomUUID(), name, weight: "normal", categories: Array.from(selectedCategories) }`
  2. Remove selected categories from any existing group they might be in (they shouldn't be in groups since they're ungrouped, but safety check)
  3. Add new group to `category_groups.groups` array
  4. Sort groups alphabetically by name (per user decision)
  5. Add selected categories to `seen_categories` (dismiss any "New" badge)
  6. Call `saveGroups` with updated structure
  7. Clear `selectedCategories`
  8. Show success toast

**CategoryGroupAccordion.tsx** -- Add group rename and delete:

**Rename** (matches FeedRow pattern -- per user decision):
- Track `isRenaming` state and `renameValue` state
- Double-click on group name text enters rename mode
- `useRef<HTMLInputElement>` with `useEffect` to auto-focus and select text
- Submit on Enter, cancel on Escape, submit on blur
- Long-press via setTimeout (500ms) for mobile
- On submit: update group name in `category_groups.groups`, re-sort alphabetically, call `saveGroups`
- Replace `Text` with `<input>` in rename mode, using same styling as FeedRow (transparent background, subtle border)

**Delete**:
- Add a delete `IconButton` (LuTrash2, ghost, red) in the accordion header (near the weight presets)
- On click: set `deletingGroup` state in CategoriesSection (lift this state up)
- CategoriesSection renders `DeleteGroupDialog` when `deletingGroup` is not null
- On confirm: remove group from `category_groups.groups`, call `saveGroups`, show success toast

Pass rename and delete handlers down from CategoriesSection to CategoryGroupAccordion.
  </action>
  <verify>
Run `cd /Users/cstalhem/projects/rss-reader/frontend && bunx tsc --noEmit` -- no type errors.
Run `cd /Users/cstalhem/projects/rss-reader/frontend && bun run lint` -- no lint errors.
Run `cd /Users/cstalhem/projects/rss-reader/frontend && bun run build` -- production build succeeds.
  </verify>
  <done>
- "Group selected" button opens popover, creates named group from selected categories
- New groups appear in alphabetical position
- Double-click on group name enters inline rename mode (matches feed rename)
- Delete group shows confirmation dialog, releases categories to ungrouped on confirm
- Drag-and-drop works between all containers
- All CRUD operations persist to backend
- Production build succeeds
  </done>
</task>

</tasks>

<verification>
- `bunx tsc --noEmit` passes
- `bun run build` succeeds
- Can select categories with checkboxes and create a named group
- Can drag a category from ungrouped into a group
- Can drag a category from one group to another
- Can drag a category out of a group back to ungrouped
- Can double-click group name to rename
- Can delete a group, categories return to ungrouped
- Groups stay alphabetically sorted after creation and rename
</verification>

<success_criteria>
- Full drag-and-drop between all containers works
- Group creation, rename, and deletion work
- All operations persist to backend via saveGroups
- Clean TypeScript build
</success_criteria>

<output>
After completion, create `.planning/phases/08-category-grouping/08-04-SUMMARY.md`
</output>
