---
phase: 08-category-grouping
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/backend/models.py
  - backend/src/backend/database.py
  - backend/src/backend/scoring.py
  - backend/src/backend/scoring_queue.py
  - backend/src/backend/main.py
autonomous: true

must_haves:
  truths:
    - "Scoring pipeline resolves effective weight via priority: explicit override > group default > neutral (1.0)"
    - "Existing topic_weights data migrated from old names (blocked/low/neutral/medium/high) to new names (block/reduce/normal/boost/max)"
    - "API endpoints exist for managing category groups, hiding/unhiding categories, and tracking new categories"
    - "Hidden categories are excluded from scoring (treated as blocked)"
    - "Previously hidden categories that reappear via LLM are added to returned_categories list"
  artifacts:
    - path: "backend/src/backend/models.py"
      provides: "UserPreferences with category_groups JSON column"
      contains: "category_groups"
    - path: "backend/src/backend/scoring.py"
      provides: "Group-aware compute_composite_score and is_blocked"
      contains: "category_groups"
    - path: "backend/src/backend/database.py"
      provides: "Migration for category_groups column and weight name migration"
      contains: "category_groups"
    - path: "backend/src/backend/main.py"
      provides: "6 new API endpoints under /api/categories/"
      contains: "category_groups"
  key_links:
    - from: "backend/src/backend/scoring_queue.py"
      to: "backend/src/backend/scoring.py"
      via: "compute_composite_score now receives category_groups parameter"
      pattern: "compute_composite_score.*category_groups"
    - from: "backend/src/backend/main.py"
      to: "backend/src/backend/models.py"
      via: "API endpoints read/write category_groups on UserPreferences"
      pattern: "preferences\\.category_groups"
---

<objective>
Backend data model, migration, scoring pipeline update, and API endpoints for category grouping.

Purpose: Establish the backend foundation that the frontend Categories UI will consume. This includes the new `category_groups` JSON column on UserPreferences, migrating existing weight names, updating the scoring pipeline for group-aware weight resolution, and creating all necessary API endpoints.

Output: Updated backend with group-aware scoring and 6 new API endpoints for category management.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-category-grouping/08-CONTEXT.md
@.planning/phases/08-category-grouping/08-RESEARCH.md
@backend/src/backend/models.py
@backend/src/backend/database.py
@backend/src/backend/scoring.py
@backend/src/backend/scoring_queue.py
@backend/src/backend/main.py
@backend/src/backend/prompts.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Data model, migration, and weight resolution update</name>
  <files>
    backend/src/backend/models.py
    backend/src/backend/database.py
    backend/src/backend/scoring.py
    backend/src/backend/scoring_queue.py
  </files>
  <action>
**models.py** -- Add `category_groups` JSON column to `UserPreferences`:
```python
category_groups: dict | None = Field(default=None, sa_column=Column(JSON))
```
The JSON structure stores:
```json
{
  "groups": [{"id": "grp-uuid", "name": "Programming", "weight": "boost", "categories": ["python", "rust"]}],
  "hidden_categories": ["celebrity-gossip"],
  "seen_categories": ["python", "rust", ...],
  "returned_categories": ["sports"]
}
```

**database.py** -- Add two migrations:
1. `_migrate_category_groups_column()`: Add `category_groups TEXT` column to `user_preferences` if missing.
2. `_migrate_weight_names()`: Convert existing `topic_weights` entries from old names to new names. Mapping: `blocked->block`, `low->reduce`, `neutral->normal`, `medium->boost`, `high->max`. Read current JSON, remap values, write back. Also seed `seen_categories` in `category_groups` with ALL categories currently in `topic_weights` keys (prevents every existing category showing a "New" badge on first load -- per research Pitfall 5).
Call both from `create_db_and_tables()`.

**scoring.py** -- Update `compute_composite_score` signature to accept `category_groups: dict | None` as a new parameter. Implement three-tier weight resolution:
1. Check `topic_weights[category]` (explicit override)
2. Check group weight for the group containing this category (iterate `category_groups["groups"]` to find)
3. Default to `"normal"` (1.0)

Update `weight_map` to use new names: `{"block": 0.0, "reduce": 0.5, "normal": 1.0, "boost": 1.5, "max": 2.0}`. Keep old names as fallback aliases in the same dict for backward safety during migration: `{"blocked": 0.0, "low": 0.5, "neutral": 1.0, "medium": 1.5, "high": 2.0}` (merge both into one dict).

Update `is_blocked` to also check `hidden_categories` list in `category_groups`. If ANY article category is in `hidden_categories`, treat as blocked.

**scoring_queue.py** -- Update the `process_next_batch` method:
- Pass `preferences.category_groups` to `compute_composite_score` call.
- Pass `preferences.category_groups` to `is_blocked` call.
- After categorization step, check if any assigned category is in `category_groups.hidden_categories`. If found, add it to `category_groups.returned_categories` (if not already there), remove it from `hidden_categories`, and persist the updated `category_groups` back to preferences (reassign, don't mutate in-place per SQLAlchemy JSON column rule).
  </action>
  <verify>
Run `cd /Users/cstalhem/projects/rss-reader/backend && uv run pytest` -- all existing tests must pass.
Run `cd /Users/cstalhem/projects/rss-reader/backend && uv run ruff check .` -- no lint errors.
  </verify>
  <done>
- UserPreferences model has `category_groups` JSON column
- Migration adds column and converts old weight names to new names
- `compute_composite_score` resolves weights via explicit > group > default chain
- `is_blocked` checks hidden_categories list
- Scoring queue passes category_groups to scoring functions and handles returned categories
  </done>
</task>

<task type="auto">
  <name>Task 2: Category management API endpoints</name>
  <files>
    backend/src/backend/main.py
  </files>
  <action>
Add 6 new endpoints to `main.py`. Add corresponding Pydantic request/response models at the top of the file alongside existing ones.

**1. GET /api/categories/groups** -- Return the category_groups structure from UserPreferences. If null, return default: `{"groups": [], "hidden_categories": [], "seen_categories": [], "returned_categories": []}`.

**2. PUT /api/categories/groups** -- Accept full category_groups JSON body and save to UserPreferences. Reassign the entire dict (don't mutate). Also trigger re-scoring of recent articles since weight changes affect scores (reuse existing `scoring_queue.enqueue_recent_for_rescoring` pattern).

**3. PATCH /api/categories/{name}/hide** -- Add category name (lowercased) to `hidden_categories` list in `category_groups`. Remove it from any group's `categories` list. Remove its explicit weight from `topic_weights`. Reassign both JSON columns. Return updated category_groups.

**4. PATCH /api/categories/{name}/unhide** -- Remove category name from `hidden_categories` list. Also remove from `returned_categories` if present. Reassign JSON. Return updated category_groups.

**5. GET /api/categories/new-count** -- Calculate count of categories NOT in `seen_categories`. Get all known categories (from articles + topic_weights keys + group categories). Subtract `seen_categories` and `hidden_categories`. Return `{"count": N}`. Also include `returned_count` for returned categories: `{"count": N, "returned_count": M}`.

**6. POST /api/categories/acknowledge** -- Accept `{"categories": ["python", "rust"]}` body. Add these to `seen_categories` list in `category_groups`. Also remove from `returned_categories` if present. Reassign JSON. Return `{"ok": true}`.

Update the existing `PATCH /api/categories/{category_name}/weight` endpoint to use new weight names in its validation (accept "block", "reduce", "normal", "boost", "max"). Also update the existing `PreferencesResponse` model to include `category_groups` field so the frontend can access it through the preferences endpoint too.

For all endpoints that modify `category_groups`, ensure the JSON column is reassigned (not mutated) per SQLAlchemy convention.
  </action>
  <verify>
Run `cd /Users/cstalhem/projects/rss-reader/backend && uv run pytest` -- all tests pass.
Run `cd /Users/cstalhem/projects/rss-reader/backend && uv run ruff check .` -- no lint errors.
Start the dev server briefly: `cd /Users/cstalhem/projects/rss-reader/backend && timeout 5 uv run uvicorn backend.main:app --port 8912 2>&1 || true` -- should start without import errors.
  </verify>
  <done>
- 6 new API endpoints exist and are functional
- PreferencesResponse includes category_groups
- Existing weight endpoint accepts new weight names
- All JSON mutations use reassignment pattern
- Backend starts without errors
  </done>
</task>

</tasks>

<verification>
- `uv run pytest` passes in backend directory
- `uv run ruff check .` passes in backend directory
- Backend starts without import or migration errors
- `compute_composite_score` correctly resolves: explicit override > group weight > default
- Weight migration converts old names to new names on startup
</verification>

<success_criteria>
- All backend changes complete: model, migration, scoring, API endpoints
- Existing tests still pass (backward compatible)
- Backend starts cleanly with new migration
- API endpoints respond correctly (verified by server startup without errors)
</success_criteria>

<output>
After completion, create `.planning/phases/08-category-grouping/08-01-SUMMARY.md`
</output>
