---
phase: 09.1-backend-codebase-evaluation-simplification
plan: 03
type: execute
wave: 2
depends_on: ["09.1-01"]
files_modified:
  - backend/src/backend/scoring.py
  - backend/src/backend/scoring_queue.py
  - backend/src/backend/ollama_service.py
  - backend/src/backend/scheduler.py
autonomous: true
requirements: []

must_haves:
  truths:
    - "Ollama AsyncClient instances are properly closed via async with context manager"
    - "Ollama calls have configurable timeouts (connect=10s, read=120s)"
    - "Retry logic only retries transient errors (ConnectionError, TimeoutError, httpx 503/429)"
    - "Functions that don't await are not declared async"
    - "Scheduler uses Session(engine) directly instead of next(get_session())"
    - "Magic numbers in scheduler and scoring_queue have named constants"
    - "scoring.py settings parameters are typed"
    - "_scoring_activity dict has a TypedDict or documented shape"
  artifacts:
    - path: "backend/src/backend/scoring.py"
      provides: "Scoring pipeline with proper resource management and typed params"
      contains: "async with AsyncClient"
    - path: "backend/src/backend/ollama_service.py"
      provides: "Ollama API wrapper with proper resource management"
      contains: "async with AsyncClient"
    - path: "backend/src/backend/scheduler.py"
      provides: "Scheduler with direct session creation and named constants"
      contains: "SCORING_BATCH_SIZE"
    - path: "backend/src/backend/scoring_queue.py"
      provides: "Queue manager with named constants and non-async functions"
      contains: "RESCORE_LOOKBACK_DAYS"
  key_links:
    - from: "backend/src/backend/scoring.py"
      to: "ollama AsyncClient"
      via: "async with context manager"
      pattern: "async with AsyncClient"
    - from: "backend/src/backend/scheduler.py"
      to: "backend/src/backend/database.py"
      via: "direct Session(engine) creation"
      pattern: "Session\\(engine\\)"
    - from: "backend/src/backend/scoring.py"
      to: "tenacity retry"
      via: "transient-only retry decorator"
      pattern: "TRANSIENT_ERRORS"
---

<objective>
Fix resource leaks, error handling, async correctness, type safety, and magic numbers in the scoring pipeline files (scoring.py, scoring_queue.py, ollama_service.py, scheduler.py).

Purpose: These are correctness and reliability fixes. The Ollama fd leak (pending todo #3) is a known blocker. The retry logic retrying ValidationError wastes time. The false async declarations are misleading. These files are independent of the router split.

Output: Clean scoring pipeline with proper resource management, typed parameters, transient-only retries, and named constants.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09.1-backend-codebase-evaluation-simplification/09.1-CONTEXT.md
@.planning/phases/09.1-backend-codebase-evaluation-simplification/09.1-RESEARCH.md
@.planning/phases/09.1-backend-codebase-evaluation-simplification/09.1-01-SUMMARY.md
@backend/src/backend/scoring.py
@backend/src/backend/scoring_queue.py
@backend/src/backend/ollama_service.py
@backend/src/backend/scheduler.py
@backend/src/backend/config.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix scoring.py and ollama_service.py resource leaks, retries, and type safety</name>
  <files>
    backend/src/backend/scoring.py
    backend/src/backend/ollama_service.py
  </files>
  <action>
**scoring.py** -- Multiple fixes:

1. **Ollama client resource management**: Replace bare `AsyncClient(host=..., timeout=None)` with `async with AsyncClient(host=..., timeout=timeout) as client:` in both `categorize_article` and `score_article`. Add `import httpx` and define timeout constants at module top:
   ```
   OLLAMA_CONNECT_TIMEOUT = 10.0   # Fail fast if Ollama is down
   OLLAMA_READ_TIMEOUT = 120.0     # Per-chunk timeout in streaming mode
   ```
   Create the timeout object inside each function: `timeout = httpx.Timeout(connect=OLLAMA_CONNECT_TIMEOUT, read=OLLAMA_READ_TIMEOUT, write=30.0, pool=10.0)`. See research Example 1 for exact pattern.

2. **Transient-only retries**: Replace `retry_if_exception_type(Exception)` with `retry_if_exception_type(TRANSIENT_ERRORS)` on both retry decorators. Define at module top:
   ```python
   TRANSIENT_ERRORS = (
       ConnectionError,
       TimeoutError,
       httpx.ConnectError,
       httpx.ReadTimeout,
       httpx.ConnectTimeout,
   )
   ```
   See research Pattern 5. This means ValidationError, json.JSONDecodeError, and pydantic errors will fail immediately instead of retrying 3x.

3. **Type the settings parameter**: Change `settings` parameter in `categorize_article` and `score_article` from untyped to `settings: "Settings"` (use string annotation to avoid import at module level if needed, or import `Settings` from `backend.config`).

4. **Type _scoring_activity**: Add a comment or TypedDict documenting the shape: `{"article_id": int | None, "phase": str}`. A comment is sufficient per the "don't over-engineer" constraint.

5. **Fix async correctness**: `get_active_categories` is declared `async def` but has no `await`. Change to plain `def`. Check its callers -- if they `await get_active_categories()`, they need to be updated to call it directly. The callers are in `scoring_queue.py` (`process_scoring_queue`).

**ollama_service.py** -- Resource management fixes:

1. **AsyncClient in list_models, pull_model_stream, delete_model**: Wrap all `AsyncClient` usage with `async with AsyncClient(host=...) as client:` context manager. Currently lines ~59, ~103, ~170 create clients without closing.

2. **Timeout for list_models and delete_model**: Add `httpx.Timeout(connect=OLLAMA_CONNECT_TIMEOUT, read=30.0)` -- shorter read timeout than scoring since these are quick operations. Define constants at module top or import from scoring.py. Better: define `OLLAMA_CONNECT_TIMEOUT = 10.0` locally (simple, no cross-module dependency for a constant).

3. **Specific exception handling in check_health**: Replace broad `except Exception` (~line 45) with `except (httpx.HTTPError, httpx.TimeoutException, ConnectionError, OSError)`. The health check should catch network errors specifically and return `connected=False`.

4. **Specific exception handling in delete_model**: If there's a broad `except Exception`, replace with specific httpx/ollama exceptions.
  </action>
  <verify>
    Run `cd /Users/cstalhem/projects/rss-reader/backend && uv run python -c "from backend.scoring import categorize_article, score_article, get_active_categories, OLLAMA_CONNECT_TIMEOUT, TRANSIENT_ERRORS; print('scoring OK')"` -- imports succeed.
    Run `cd /Users/cstalhem/projects/rss-reader/backend && uv run python -c "import inspect; from backend.scoring import get_active_categories; assert not inspect.iscoroutinefunction(get_active_categories), 'Should not be async'; print('async check OK')"` -- confirms get_active_categories is no longer async.
    Run `cd /Users/cstalhem/projects/rss-reader/backend && uv run ruff check backend/src/backend/scoring.py backend/src/backend/ollama_service.py` -- no lint errors.
  </verify>
  <done>
    All Ollama AsyncClient usage wrapped in async with context manager. Timeout constants defined (connect=10s, read=120s for scoring, 30s for management). Retry only on TRANSIENT_ERRORS. settings parameter typed. get_active_categories is no longer async. check_health catches specific exceptions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix scheduler.py and scoring_queue.py -- sessions, async, magic numbers, imports</name>
  <files>
    backend/src/backend/scheduler.py
    backend/src/backend/scoring_queue.py
  </files>
  <action>
**scheduler.py** -- Three fixes:

1. **Direct session creation**: Replace `with next(get_session()) as session:` (lines ~24, ~47) with `with Session(engine) as session:`. Import `Session` from `sqlmodel` and `engine` from `backend.database`. Remove the `get_session` import. Per research: engine-level connect event listener (set_sqlite_pragma) fires on every connection, so direct sessions still get WAL mode and other pragmas.

2. **expire_on_commit comment**: Add explanatory comment on `session.expire_on_commit = False` (line ~48): `# Prevent lazy-load after commit -- scoring reads article attributes post-commit outside request cycle`

3. **Named constants**: Extract magic numbers at module top:
   ```python
   SCORING_BATCH_SIZE = 5
   SCORING_INTERVAL_SECONDS = 30
   FEED_REFRESH_INTERVAL_MINUTES = 15
   ```
   Replace hardcoded values in `process_scoring_queue` (batch_size=5) and scheduler job configurations (seconds=30, minutes=15).

**scoring_queue.py** -- Three fixes:

1. **Remove false async**: `enqueue_articles` and `enqueue_recent_for_rescoring` are declared `async def` but never `await` anything. Change both to plain `def`. Check callers -- if they `await enqueue_articles()`, update the call site to call directly. Callers are in `scheduler.py` (process_scoring_queue) and `main.py`/routers (feeds.py for enqueue after refresh, preferences.py for rescore after preference change). Since this plan runs in parallel with Plan 02 (router split), note: the callers in main.py will be moved to routers by Plan 02. The scoring_queue.py changes here are compatible -- `await sync_function()` in async context still works (Python evaluates it, gets a non-coroutine, but this would be a TypeError if the caller uses `await`). So: check if callers use `await`. If they do, remove the `await` keyword too. If they use `asyncio.create_task()`, that won't work with sync functions.

   **Actually**: Be careful here. If callers in main.py use `await scoring_queue.enqueue_articles(...)`, removing `async` from enqueue_articles would cause a TypeError (`object list can't be used in 'await' expression`). Check the actual call sites:
   - In main.py's `create_feed`: likely calls `await scoring_queue.enqueue_articles(...)` or uses it directly in sync context
   - In scheduler's `process_scoring_queue`: likely calls it inside async function

   **Strategy**: Read the actual callers first. If they use `await`, the cleanest fix is to remove both `async` from the definition AND `await` from the call sites. But since Plan 02 is rewriting the call sites in routers, just fix scoring_queue.py here and note in the summary that callers need `await` removed. Plan 02 will handle it when creating router files.

2. **Named constants**: Extract magic numbers at module top:
   ```python
   RESCORE_LOOKBACK_DAYS = 7
   RESCORE_MAX_ARTICLES = 100
   ```
   Replace hardcoded values in `enqueue_recent_for_rescoring`.

3. **Import cleanup**: Remove the duplicated `_get_or_create_preferences` function if one exists here. Import `get_or_create_preferences` from `deps.py` instead. If `scoring_queue.py` has its own inline version, replace it with the import. BUT: be careful about circular imports. `deps.py` imports from `database.py` and `models.py` which should be safe. If scoring_queue.py doesn't currently import from deps.py, verify no cycle exists.

4. **Update get_active_categories call**: Since Task 1 changed `get_active_categories` from async to sync, update the call site in `process_scoring_queue` from `await get_active_categories(session)` to `get_active_categories(session)` (remove await).
  </action>
  <verify>
    Run `cd /Users/cstalhem/projects/rss-reader/backend && uv run python -c "from backend.scheduler import SCORING_BATCH_SIZE, SCORING_INTERVAL_SECONDS; print(f'batch={SCORING_BATCH_SIZE} interval={SCORING_INTERVAL_SECONDS}')"` -- prints constants.
    Run `cd /Users/cstalhem/projects/rss-reader/backend && uv run python -c "from backend.scoring_queue import RESCORE_LOOKBACK_DAYS, RESCORE_MAX_ARTICLES; print(f'lookback={RESCORE_LOOKBACK_DAYS} max={RESCORE_MAX_ARTICLES}')"` -- prints constants.
    Run `cd /Users/cstalhem/projects/rss-reader/backend && uv run python -c "import inspect; from backend.scoring_queue import enqueue_articles, enqueue_recent_for_rescoring; assert not inspect.iscoroutinefunction(enqueue_articles); assert not inspect.iscoroutinefunction(enqueue_recent_for_rescoring); print('async check OK')"` -- both are sync.
    Run `cd /Users/cstalhem/projects/rss-reader/backend && uv run ruff check backend/src/backend/scheduler.py backend/src/backend/scoring_queue.py` -- no lint errors.
  </verify>
  <done>
    scheduler.py uses Session(engine) directly with explanatory expire_on_commit comment and named constants. scoring_queue.py has non-async enqueue functions, named constants, and imports get_or_create_preferences from deps. All get_active_categories callers updated for sync call.
  </done>
</task>

</tasks>

<verification>
- `uv run ruff check backend/src/backend/scoring.py backend/src/backend/scoring_queue.py backend/src/backend/ollama_service.py backend/src/backend/scheduler.py` -- no lint errors
- `uv run python -c "from backend.scoring import categorize_article, score_article"` -- imports OK
- `uv run python -c "from backend.scheduler import start_scheduler"` -- imports OK (no circular deps)
- Note: Full integration test requires Plan 02 (router split) to complete. Server start test deferred to Plan 04.
</verification>

<success_criteria>
1. All Ollama AsyncClient usage properly closed via async with
2. Timeout constants: connect=10s, read=120s (scoring), 30s (management)
3. Retry only on TRANSIENT_ERRORS tuple
4. get_active_categories, enqueue_articles, enqueue_recent_for_rescoring are plain def (not async)
5. Scheduler uses Session(engine) directly with expire_on_commit comment
6. Magic numbers replaced: SCORING_BATCH_SIZE, SCORING_INTERVAL_SECONDS, RESCORE_LOOKBACK_DAYS, RESCORE_MAX_ARTICLES, OLLAMA_CONNECT_TIMEOUT, OLLAMA_READ_TIMEOUT
7. settings parameter typed in scoring functions
</success_criteria>

<output>
After completion, create `.planning/phases/09.1-backend-codebase-evaluation-simplification/09.1-03-SUMMARY.md`
</output>
