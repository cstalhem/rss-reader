---
phase: 09.1-backend-codebase-evaluation-simplification
plan: 03
subsystem: api
tags: [ollama, httpx, tenacity, asyncio, resource-management]

# Dependency graph
requires:
  - phase: 09.1-01
    provides: deps.py shared module, schema versioning, MAX_COMPOSITE_SCORE constant
provides:
  - Scoring pipeline with proper Ollama AsyncClient lifecycle (async with)
  - Configurable timeouts (connect=10s, read=120s scoring, 30s management)
  - Transient-only retry logic (TRANSIENT_ERRORS tuple)
  - Named constants for scheduler and scoring queue configuration
  - Sync enqueue functions (no false async)
affects: [09.1-04 integration testing]

# Tech tracking
tech-stack:
  added: []
  patterns: [async with context manager for Ollama clients, transient-only retry with tenacity, Session(engine) for background jobs]

key-files:
  created: []
  modified:
    - backend/src/backend/scoring.py
    - backend/src/backend/ollama_service.py
    - backend/src/backend/scheduler.py
    - backend/src/backend/scoring_queue.py
    - backend/src/backend/main.py
    - backend/src/backend/feeds.py
    - backend/src/backend/routers/feeds.py
    - backend/src/backend/routers/preferences.py
    - backend/src/backend/routers/scoring.py

key-decisions:
  - "TRANSIENT_ERRORS tuple includes ConnectionError, TimeoutError, and httpx-specific errors -- ValidationError and JSON parse errors fail immediately"
  - "Separate timeout constants per file (scoring.py, ollama_service.py) to avoid cross-module dependency for simple values"

patterns-established:
  - "Ollama client lifecycle: always use async with AsyncClient() as client for proper fd cleanup"
  - "Background job sessions: use Session(engine) directly, not next(get_session()) generator"

requirements-completed: []

# Metrics
duration: 4min
completed: 2026-02-20
---

# Phase 09.1 Plan 03: Scoring Pipeline Fixes Summary

**Ollama fd leak fixed via async with context managers, transient-only retries, configurable timeouts, false async removed, magic numbers named**

## Performance

- **Duration:** 4 min
- **Started:** 2026-02-19T22:55:50Z
- **Completed:** 2026-02-19T22:59:50Z
- **Tasks:** 2
- **Files modified:** 9

## Accomplishments
- Fixed Ollama AsyncClient resource leaks in scoring.py and ollama_service.py (resolves pending todo #3)
- Added httpx.Timeout with connect=10s, read=120s for scoring and 30s for management operations
- Replaced retry_if_exception_type(Exception) with TRANSIENT_ERRORS tuple (ConnectionError, TimeoutError, httpx errors)
- Removed false async from get_active_categories, enqueue_articles, enqueue_recent_for_rescoring
- Replaced next(get_session()) with Session(engine) in scheduler.py background jobs
- Extracted 6 named constants: OLLAMA_CONNECT_TIMEOUT, OLLAMA_READ_TIMEOUT, SCORING_BATCH_SIZE, SCORING_INTERVAL_SECONDS, RESCORE_LOOKBACK_DAYS, RESCORE_MAX_ARTICLES
- Typed settings parameter as Settings in categorize_article and score_article
- Narrowed check_health exception handler from bare Exception to specific network errors

## Task Commits

Each task was committed atomically:

1. **Task 1: Fix scoring.py and ollama_service.py resource leaks, retries, and type safety** - `88a3ce4` (fix)
2. **Task 2: Fix scheduler.py and scoring_queue.py -- sessions, async, magic numbers** - `d932c82` (fix)
3. **Cross-plan fix: Remove await from sync enqueue calls in new router files** - `aa562ba` (fix)

## Files Created/Modified
- `backend/src/backend/scoring.py` - Async with for Ollama clients, timeouts, TRANSIENT_ERRORS, typed settings, sync get_active_categories
- `backend/src/backend/ollama_service.py` - Async with for all Ollama clients, management timeouts, specific exception handling
- `backend/src/backend/scheduler.py` - Session(engine) direct creation, named constants, expire_on_commit comment
- `backend/src/backend/scoring_queue.py` - Sync enqueue functions, named constants, removed await on get_active_categories
- `backend/src/backend/main.py` - Removed await on sync enqueue calls (pre-router-split version)
- `backend/src/backend/feeds.py` - Removed await on sync enqueue_articles call
- `backend/src/backend/routers/feeds.py` - Removed await on sync enqueue_articles (post-router-split)
- `backend/src/backend/routers/preferences.py` - Removed await on sync enqueue_recent_for_rescoring (post-router-split)
- `backend/src/backend/routers/scoring.py` - Removed await on sync enqueue_recent_for_rescoring (post-router-split)

## Decisions Made
- TRANSIENT_ERRORS includes ConnectionError, TimeoutError, and httpx-specific errors (ConnectError, ReadTimeout, ConnectTimeout). ValidationError and JSON parse errors fail immediately instead of retrying 3x.
- Timeout constants defined locally per file rather than shared across modules -- simple, no cross-module dependency for constants.

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Fixed await on sync enqueue calls in Plan 02 router files**
- **Found during:** Post-Task 2 verification
- **Issue:** Plan 02 (router split) ran concurrently and created new router files (feeds.py, preferences.py, scoring.py) that use `await` on enqueue_articles and enqueue_recent_for_rescoring, which this plan changed from async to sync.
- **Fix:** Removed `await` keyword from all three router files.
- **Files modified:** backend/src/backend/routers/feeds.py, backend/src/backend/routers/preferences.py, backend/src/backend/routers/scoring.py
- **Verification:** Ruff lint passes, imports succeed
- **Committed in:** aa562ba

---

**Total deviations:** 1 auto-fixed (1 blocking -- cross-plan concurrency)
**Impact on plan:** Necessary to prevent TypeError at runtime. No scope creep.

## Issues Encountered
None beyond the cross-plan deviation documented above.

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- Scoring pipeline has proper resource management, ready for integration testing in Plan 04
- All Ollama fd leaks fixed (pending todo #3 can be closed)
- All existing tests pass (same 6 pre-existing failures, 8 passing)

## Self-Check: PASSED

All files verified present, all commit hashes found in git log.

---
*Phase: 09.1-backend-codebase-evaluation-simplification*
*Completed: 2026-02-20*
