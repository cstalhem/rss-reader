---
phase: 09.1-backend-codebase-evaluation-simplification
verified: 2026-02-20T00:00:00Z
status: passed
score: 28/28 must-haves verified
re_verification: null
gaps: []
human_verification:
  - test: "Run the backend server and make a few API calls"
    expected: "All endpoints respond correctly with the new route names"
    why_human: "Cannot run uvicorn in sandbox; static analysis confirms wiring but not runtime behavior"
  - test: "Open Settings > Ollama, save a model config change with rescore"
    expected: "Two toasts: config saved toast then articles-queued toast (or combined failure toast)"
    why_human: "Two-step save flow in OllamaSection.tsx cannot be exercised without Ollama and the UI running"
---

# Phase 09.1: Backend Codebase Evaluation and Simplification — Verification Report

**Phase Goal:** Evaluate and simplify the backend codebase — models, API endpoints, scoring pipeline, configuration, and database patterns — addressing technical debt from rapid feature development while retaining all functionality

**Verified:** 2026-02-20

**Status:** PASSED

**Re-verification:** No — initial verification

---

## Goal Achievement

### Observable Truths

| # | Truth | Status | Evidence |
|---|-------|--------|----------|
| 1 | schemas.py contains all Pydantic request/response models | VERIFIED | 24 models confirmed in `backend/src/backend/schemas.py` (HealthResponse through OllamaPromptsResponse) |
| 2 | deps.py exports get_session, get_or_create_preferences, resolve_ollama_models | VERIFIED | All 3 functions present and substantive in `backend/src/backend/deps.py` |
| 3 | database.py dead migrations removed (~280 lines), schema versioning added | VERIFIED | `CURRENT_SCHEMA_VERSION = 1`, `_get_schema_version`, `_set_schema_version`, `_seed_default_categories`, `_recover_stuck_scoring` all present; no old migration functions |
| 4 | main.py reduced to ~60-80 line entry point | VERIFIED | 69 lines confirmed; contains only app creation, CORS, lifespan, router registration, health endpoint |
| 5 | 6 router modules exist with all endpoints | VERIFIED | `routers/articles.py`, `feeds.py`, `categories.py`, `preferences.py`, `ollama.py`, `scoring.py` all present and substantive |
| 6 | All REST endpoint renames applied | VERIFIED | `PUT /api/feeds/order`, `POST /api/feeds/{id}/mark-read`, `GET /api/categories/unseen-count`, `POST /api/categories/mark-seen`, `POST/GET/DELETE /api/ollama/downloads`, `POST /api/scoring` all confirmed in routers |
| 7 | Hide/unhide consolidated into PATCH categories/{id} with is_hidden field | VERIFIED | `CategoryUpdate.is_hidden: bool \| None = None` in schemas.py; handler in `categories.py:361-369` processes hide/unhide semantics |
| 8 | Frontend api.ts updated to match renamed endpoints | VERIFIED | `PUT /api/feeds/order`, `POST .../mark-read`, `/api/categories/unseen-count`, `/api/categories/mark-seen`, `/api/ollama/downloads`, `/api/scoring` all confirmed in api.ts |
| 9 | Ollama AsyncClient properly closed via async with | VERIFIED | All 5 AsyncClient usages in scoring.py and ollama_service.py use `async with AsyncClient(...) as client:` |
| 10 | Ollama calls have configurable timeouts | VERIFIED | `OLLAMA_CONNECT_TIMEOUT = 10.0`, `OLLAMA_READ_TIMEOUT = 120.0` in scoring.py; `OLLAMA_CONNECT_TIMEOUT = 10.0`, `OLLAMA_MGMT_READ_TIMEOUT = 30.0` in ollama_service.py |
| 11 | Retry logic only retries transient errors | VERIFIED | `TRANSIENT_ERRORS = (ConnectionError, TimeoutError, httpx.ConnectError, httpx.ReadTimeout, httpx.ConnectTimeout)` used in both retry decorators |
| 12 | False async functions removed | VERIFIED | `get_active_categories`, `enqueue_articles`, `enqueue_recent_for_rescoring` are all plain `def` (not `async def`); grep for async definition returns no matches |
| 13 | Scheduler uses Session(engine) directly | VERIFIED | `with Session(engine) as session:` at scheduler.py:27 and :50; no `next(get_session())` |
| 14 | Magic numbers replaced with named constants | VERIFIED | `MAX_COMPOSITE_SCORE`, `OLLAMA_CONNECT_TIMEOUT`, `OLLAMA_READ_TIMEOUT`, `TRANSIENT_ERRORS`, `SCORING_BATCH_SIZE`, `SCORING_INTERVAL_SECONDS`, `RESCORE_LOOKBACK_DAYS`, `RESCORE_MAX_ARTICLES` all confirmed |
| 15 | list_feeds N+1 replaced with JOIN+GROUP BY | VERIFIED | `outerjoin(Article, ...).group_by(Feed.id)` in `routers/feeds.py:40-47` |
| 16 | get_scoring_status N+1 replaced with GROUP BY | VERIFIED | Single `select(Article.scoring_state, func.count(Article.id)).group_by(Article.scoring_state)` in `routers/scoring.py:31-35` |
| 17 | mark_feed_read uses bulk UPDATE | VERIFIED | `session.exec(update(Article).where(...).values(is_read=True))` with `result.rowcount` in `routers/feeds.py:248-254` |
| 18 | scoring_state and composite_score columns are indexed | VERIFIED | `composite_score: float \| None = Field(default=None, index=True)` at models.py:84; `scoring_state: str = Field(default="unscored", index=True)` at models.py:86 |
| 19 | list_articles has response_model and Literal types | VERIFIED | `@router.get("", response_model=list[ArticleResponse])` with `sort_by: Literal["composite_score", "published_at"]` and `order: Literal["asc", "desc"]` in articles.py:54-64 |
| 20 | Rescoring separated: PUT /api/ollama/config saves only, POST /api/scoring triggers rescore | VERIFIED | ollama.py update_ollama_config has no scoring logic; scoring.py trigger_rescore calls `enqueue_recent_for_rescoring` |
| 21 | Frontend orchestrates config save then rescore as two separate calls | VERIFIED | OllamaSection.tsx:47-68 — saveMutation.mutate() with onSuccess callback that calls rescoreMutation.mutate() |
| 22 | conftest.py imports get_session from deps (dependency override works) | VERIFIED | `from backend.deps import get_session` at conftest.py:8; `app.dependency_overrides[get_session] = get_test_session` |
| 23 | test_scoring.py with unit tests for pure functions | VERIFIED | 15 tests for `get_effective_weight`, `compute_composite_score`, `is_blocked` |
| 24 | test_router_smoke.py with smoke tests for all router domains | VERIFIED | 8 tests covering all 6 router domains plus Literal type validation |
| 25 | Dead code removed from models.py, prompts.py, scoring.py | VERIFIED | No `arbitrary_types_allowed` in models.py; no `DEFAULT_CATEGORIES` in prompts.py; no old weight aliases (`"blocked"`, `"low"`, `"medium"`, `"high"`) in scoring.py weight_map |
| 26 | config.py logs parse failures | VERIFIED | `logging.getLogger(__name__).warning(f"Failed to parse config file: path={config_file} error={e}")` at config.py:125-127 |
| 27 | unread_count only counts scored, non-blocked, unread articles | VERIFIED | `(Article.scoring_state == "scored") & (Article.composite_score > 0)` conditions in list_feeds JOIN at feeds.py:44-45 |
| 28 | settings parameter typed as Settings in scoring functions | VERIFIED | `settings: Settings` in both `categorize_article` and `score_article` signatures |

**Score:** 28/28 truths verified

---

### Required Artifacts

| Artifact | Status | Details |
|----------|--------|---------|
| `backend/src/backend/schemas.py` | VERIFIED | 24 Pydantic models extracted from main.py; inherits from `pydantic.BaseModel` |
| `backend/src/backend/deps.py` | VERIFIED | Exports `get_session`, `get_or_create_preferences`, `resolve_ollama_models`; imports from `backend.database` and `backend.models` |
| `backend/src/backend/database.py` | VERIFIED | `CURRENT_SCHEMA_VERSION = 1`, `schema_version` table functions, seeding separated into `_seed_default_categories` |
| `backend/src/backend/routers/__init__.py` | VERIFIED | Exists |
| `backend/src/backend/routers/articles.py` | VERIFIED | `router = APIRouter(prefix="/api/articles")` with 3 endpoints |
| `backend/src/backend/routers/feeds.py` | VERIFIED | `router = APIRouter(prefix="/api/feeds")` with 7 endpoints including renamed ones |
| `backend/src/backend/routers/categories.py` | VERIFIED | `router = APIRouter(prefix="/api/categories")` with all endpoints including consolidated hide/unhide |
| `backend/src/backend/routers/preferences.py` | VERIFIED | `router = APIRouter(prefix="/api/preferences")` with 2 endpoints |
| `backend/src/backend/routers/ollama.py` | VERIFIED | `router = APIRouter(prefix="/api/ollama")` with downloads singleton pattern |
| `backend/src/backend/routers/scoring.py` | VERIFIED | `router = APIRouter(prefix="/api/scoring")` with SRP-separated rescore endpoint |
| `backend/src/backend/scoring.py` | VERIFIED | `async with AsyncClient`, `TRANSIENT_ERRORS`, `OLLAMA_CONNECT_TIMEOUT`, `OLLAMA_READ_TIMEOUT`, `MAX_COMPOSITE_SCORE`, `Settings`-typed params |
| `backend/src/backend/ollama_service.py` | VERIFIED | All 3 AsyncClient usages wrapped in `async with`; management timeout 30s; specific exceptions in `check_health` |
| `backend/src/backend/scheduler.py` | VERIFIED | `Session(engine)` direct creation; `SCORING_BATCH_SIZE = 5`, `SCORING_INTERVAL_SECONDS = 30`; feed refresh from settings config |
| `backend/src/backend/scoring_queue.py` | VERIFIED | `enqueue_articles` and `enqueue_recent_for_rescoring` are plain `def`; `RESCORE_LOOKBACK_DAYS = 7`, `RESCORE_MAX_ARTICLES = 100` |
| `backend/tests/conftest.py` | VERIFIED | `from backend.deps import get_session` for correct dependency_overrides wiring |
| `backend/tests/test_scoring.py` | VERIFIED | 15 unit tests for pure scoring functions |
| `backend/tests/test_router_smoke.py` | VERIFIED | 8 smoke tests, all router domains covered |
| `frontend/src/lib/api.ts` | VERIFIED | All renamed endpoints confirmed; `hideCategory`/`unhideCategory` delegate to `updateCategory`; `triggerRescore()` calls `POST /api/scoring` |
| `frontend/src/components/settings/OllamaSection.tsx` | VERIFIED | Two-step save flow: saveMutation then rescoreMutation in onSuccess callback |

---

### Key Link Verification

| From | To | Via | Status | Details |
|------|----|-----|--------|---------|
| `routers/*.py` | `deps.py` | `from backend.deps import get_session` | WIRED | All 5 router files confirmed importing from deps |
| `routers/*.py` | `schemas.py` | `from backend.schemas import` | WIRED | 5 of 6 routers import schemas (scoring.py has no schema imports — uses inline dict return, which is correct) |
| `deps.py` | `database.py` | `from backend.database import engine` | WIRED | `from backend.database import engine` at deps.py:8 |
| `deps.py` | `models.py` | `from backend.models import UserPreferences` | WIRED | Confirmed at deps.py:9 |
| `main.py` | `routers/*.py` | `app.include_router()` | WIRED | All 6 routers registered at main.py:58-63 |
| `conftest.py` | `deps.py` | `from backend.deps import get_session` for test override | WIRED | Confirmed at conftest.py:8 |
| `scoring.py` | `ollama AsyncClient` | `async with AsyncClient(...)` | WIRED | Both categorize_article and score_article use context manager |
| `scheduler.py` | `database.py` | `Session(engine)` | WIRED | Two uses confirmed at scheduler.py:27 and 50 |
| `scoring.py` | `tenacity retry` | `retry_if_exception_type(TRANSIENT_ERRORS)` | WIRED | Both retry decorators use TRANSIENT_ERRORS |
| `test_router_smoke.py` | `main.py` | `TestClient(app)` via `test_client` fixture | WIRED | `test_client` fixture in conftest wraps `TestClient(app)` |
| `test_scoring.py` | `scoring.py` | `from backend.scoring import` | WIRED | Imports `compute_composite_score`, `get_effective_weight`, `is_blocked` |
| `routers/feeds.py` | database | `outerjoin + group_by` for unread counts | WIRED | JOIN+GROUP BY query confirmed |
| `OllamaSection.tsx` | `api.ts` | Two-step save + rescore calls | WIRED | `saveMutation.mutate()` then `rescoreMutation.mutate()` in onSuccess |

---

### Requirements Coverage

No requirement IDs assigned — this is an inserted maintenance phase. No REQUIREMENTS.md entries to cross-reference.

---

### Anti-Patterns Found

No anti-patterns detected.

Checked files for:
- TODO/FIXME/PLACEHOLDER comments in all modified backend files → none found
- Empty implementations (`return null`, `return {}`) → none found
- Old endpoint URLs remaining in frontend → none found (acknowledge/new-count references are hook/query-key labels, not API URLs)
- `next(get_session())` pattern in background jobs → confirmed removed
- `retry_if_exception_type(Exception)` broad retry → confirmed replaced with TRANSIENT_ERRORS
- `arbitrary_types_allowed` in models.py → confirmed removed
- `DEFAULT_CATEGORIES` in prompts.py → confirmed removed
- Old weight aliases (`"blocked"`, `"low"`, `"medium"`, `"high"`) in scoring.py → confirmed removed

**Minor note:** Plan 03 specified a `FEED_REFRESH_INTERVAL_MINUTES` constant but the implementation instead reads `settings.scheduler.feed_refresh_interval` (already a config value). This is a better outcome — the interval is already configurable via YAML/env; a redundant constant would not add value. This is not a gap.

---

### Human Verification Required

#### 1. Server startup and routing

**Test:** Start `uv run uvicorn backend.main:app --port 8912` and hit a few renamed endpoints (e.g., `GET /api/categories/unseen-count`, `PUT /api/feeds/order`, `GET /api/ollama/downloads`)

**Expected:** 200 responses with correct shapes for all renamed endpoints; no 404s

**Why human:** Cannot run uvicorn in sandbox

#### 2. Two-step Ollama config save flow

**Test:** Open Settings > Ollama, change the model, click Save with rescore enabled

**Expected:** Config saved first (PUT /api/ollama/config), then rescore triggered (POST /api/scoring), two toasts shown: one for queued articles count

**Why human:** Requires Ollama running and full browser UI interaction

---

### Gaps Summary

No gaps. All 28 observable truths verified against the actual codebase.

The phase goal is fully achieved:

- **Technical debt addressed:** Dead migration functions removed (~280 lines), false async functions corrected, old weight aliases removed, model config removed from `models.py`, unused `DEFAULT_CATEGORIES` removed from `prompts.py`
- **Architecture improved:** 1,426-line `main.py` split into 6 domain-specific router modules (69 lines remaining), `schemas.py` and `deps.py` as shared foundation, `database.py` has schema versioning
- **Correctness fixed:** Ollama fd leak resolved via `async with` context managers, retry logic narrowed to transient errors only, scheduler no longer uses generator-based session
- **Performance improved:** 3 N+1 queries eliminated (list_feeds, get_scoring_status, mark_feed_read), `scoring_state` and `composite_score` indexed
- **REST adherence:** 10 endpoint renames applied, hide/unhide consolidated, SRP separation of config save and rescoring
- **Test coverage added:** 15 unit tests + 8 smoke tests (23 total), full test suite at 31 passing
- **Frontend synchronized:** All API URL changes matched in `api.ts`, two-step save flow implemented in `OllamaSection.tsx`
- **Functionality retained:** No behavioral regressions; same pre-existing 6 test failures (unscored articles filtered by `exclude_blocked` — pre-existing, not introduced by this phase)

---

_Verified: 2026-02-20_
_Verifier: Claude (gsd-verifier)_
