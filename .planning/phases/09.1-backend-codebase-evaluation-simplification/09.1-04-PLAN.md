---
phase: 09.1-backend-codebase-evaluation-simplification
plan: 04
type: execute
wave: 3
depends_on: ["09.1-02", "09.1-03"]
files_modified:
  - backend/src/backend/routers/articles.py
  - backend/src/backend/routers/feeds.py
  - backend/src/backend/routers/scoring.py
  - backend/src/backend/routers/ollama.py
  - backend/src/backend/routers/categories.py
  - backend/src/backend/models.py
  - backend/tests/test_scoring.py
  - backend/tests/test_router_smoke.py
autonomous: true
requirements: []

must_haves:
  truths:
    - "list_feeds N+1 query replaced with single JOIN+GROUP BY query"
    - "get_scoring_status N+1 replaced with single GROUP BY query"
    - "get_active_categories N+1 replaced with selectinload"
    - "mark_feed_read uses bulk UPDATE instead of materializing all articles"
    - "scoring_state and composite_score columns are indexed"
    - "list_articles has response_model=list[ArticleResponse]"
    - "sort_by and order parameters use Literal types"
    - "Rescoring logic is separated from update_ollama_config into POST /api/scoring/rescore"
    - "unread_count only counts scored non-blocked articles"
    - "Pure function tests pass for compute_composite_score, is_blocked, get_effective_weight"
    - "Router smoke tests pass for all 6 domains"
  artifacts:
    - path: "backend/tests/test_scoring.py"
      provides: "Unit tests for scoring pure functions"
      contains: "test_compute_composite_score"
    - path: "backend/tests/test_router_smoke.py"
      provides: "Smoke tests for all router endpoints"
      contains: "test_articles_list"
  key_links:
    - from: "backend/tests/test_router_smoke.py"
      to: "backend/src/backend/main.py"
      via: "TestClient(app)"
      pattern: "TestClient"
    - from: "backend/tests/test_scoring.py"
      to: "backend/src/backend/scoring.py"
      via: "direct function imports"
      pattern: "from backend\\.scoring import"
    - from: "backend/src/backend/routers/feeds.py"
      to: "database query"
      via: "single JOIN+GROUP BY for unread counts"
      pattern: "outerjoin|group_by"
---

<objective>
Apply query efficiency fixes, type safety improvements, and SRP separation in router modules. Write unit tests for scoring pure functions and smoke tests for all routers.

Purpose: Final quality improvements and test coverage. N+1 queries are the biggest performance issues. The SRP fix (rescoring out of config endpoint) addresses a user-identified design concern. Tests provide safety net for the entire refactoring.

Output: Optimized router queries, typed parameters, separated rescoring, test suite.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09.1-backend-codebase-evaluation-simplification/09.1-CONTEXT.md
@.planning/phases/09.1-backend-codebase-evaluation-simplification/09.1-RESEARCH.md
@.planning/phases/09.1-backend-codebase-evaluation-simplification/09.1-02-SUMMARY.md
@.planning/phases/09.1-backend-codebase-evaluation-simplification/09.1-03-SUMMARY.md
@backend/src/backend/routers/articles.py
@backend/src/backend/routers/feeds.py
@backend/src/backend/routers/categories.py
@backend/src/backend/routers/scoring.py
@backend/src/backend/routers/ollama.py
@backend/src/backend/models.py
@backend/src/backend/scoring.py
@backend/tests/conftest.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Query efficiency, type safety, SRP separation, and index additions</name>
  <files>
    backend/src/backend/routers/articles.py
    backend/src/backend/routers/feeds.py
    backend/src/backend/routers/scoring.py
    backend/src/backend/routers/ollama.py
    backend/src/backend/routers/categories.py
    backend/src/backend/models.py
  </files>
  <action>
**routers/feeds.py -- N+1 fix and bulk UPDATE:**

1. **list_feeds N+1 fix**: Replace the per-feed COUNT query loop with a single query using LEFT JOIN + GROUP BY. See research Example 2 for the exact pattern. The fixed query should join Feed with Article, filter unread (`Article.is_read.is_(False)`), and count per feed. Use `outerjoin` so feeds with no articles still appear. Also fix unread_count per roadmap success criteria #6: only count articles where `scoring_state == 'scored'` AND `composite_score > 0` AND `is_read == False` -- this matches what the frontend displays (scored, non-blocked, unread).

2. **mark_feed_read bulk UPDATE**: Replace the pattern that materializes all articles into Python objects and updates them one by one with a single `UPDATE Article SET is_read = True WHERE feed_id = :id AND is_read = False` statement. Use `session.exec(update(Article).where(...).values(is_read=True))` and get `result.rowcount` for the count. See research Example 4.

**routers/scoring.py -- N+1 fix and SRP:**

1. **get_scoring_status N+1 fix**: Replace the 5 separate COUNT queries with a single `GROUP BY scoring_state` query. See research Example 3. Keep the separate blocked_count query (scored articles with composite_score == 0).

2. **SRP: Separate rescoring from config endpoint**: Currently `PUT /api/ollama/config` in routers/ollama.py both saves config AND triggers rescoring if `rescore=True`. Per user decision, separate this:
   - **routers/ollama.py** `PUT /api/ollama/config`: Remove the rescoring logic. Save config only. Return the saved config. Remove the `rescore` field handling. Keep the OllamaConfigUpdate schema as-is (the `rescore` field can stay in the schema but be ignored, OR remove it -- Claude's discretion).
   - **routers/scoring.py** `POST /api/scoring/rescore`: Enhance this endpoint to accept an optional `rescore_mode` query parameter (default "full"). Move the rescoring logic (enqueue_recent_for_rescoring call) here. The endpoint already exists but may be minimal -- flesh it out with the logic from update_ollama_config.
   - Note: The FRONTEND currently sends `rescore: true` as part of config save. This change will require a frontend update (save config, then if models changed, call POST /api/scoring/rescore separately). For now, just do the backend separation. The frontend will be updated in a future phase or quick task.

**routers/articles.py -- Type safety and response_model:**

1. **Add response_model**: `list_articles` endpoint is missing `response_model=list[ArticleResponse]`. Add it to the decorator.

2. **Literal types for sort_by/order**: Change `sort_by: str = "composite_score"` to `sort_by: Literal["composite_score", "published_at"] = "composite_score"` and `order: str = "desc"` to `order: Literal["asc", "desc"] = "desc"`. Import `Literal` from `typing`. FastAPI will auto-validate and return 422 on invalid values instead of silently returning unsorted results.

**routers/categories.py -- Error handling:**

1. **create_feed exception specificity** (if create_feed endpoint is here -- actually it's in feeds.py, so apply there): In `create_feed`, replace the broad `except Exception` that swallows HTTPException with specific catches: `except (httpx.HTTPError, Exception) as e:` where HTTPException is re-raised before the broad catch. Actually, the cleanest pattern: catch specific feed-related errors `except (httpx.HTTPError, feedparser.exceptions.FeedParserError, ValueError) as e:` and let HTTPException propagate naturally.

   Actually, re-read main.py: the issue is in `create_feed` in what will be **routers/feeds.py**. Apply the fix there: the endpoint raises HTTPException for duplicate URL check, then has a broad `except Exception` that catches the HTTPException it just raised. Fix: move the duplicate check before the try block, or catch specific exceptions `(httpx.HTTPError, ValueError, OSError)` instead of `Exception`.

**models.py -- Index additions:**

1. Add `index=True` to `scoring_state` Field definition on Article model
2. Add `index=True` to `composite_score` Field definition on Article model
These are the most-filtered columns in article queries.
  </action>
  <verify>
    Run `cd /Users/cstalhem/projects/rss-reader/backend && uv run python -c "from typing import get_type_hints; from backend.routers.articles import list_articles; print('articles OK')"` -- imports succeed.
    Run `cd /Users/cstalhem/projects/rss-reader/backend && uv run ruff check backend/src/backend/routers/ backend/src/backend/models.py` -- no lint errors.
    Run `cd /Users/cstalhem/projects/rss-reader/backend && uv run pytest backend/tests/test_api.py -v` -- existing tests still pass.
  </verify>
  <done>
    N+1 queries fixed in list_feeds (JOIN+GROUP BY), get_scoring_status (GROUP BY), mark_feed_read (bulk UPDATE). scoring_state and composite_score indexed. list_articles has response_model and Literal types. Rescoring separated from config endpoint. create_feed catches specific exceptions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Unit tests for scoring functions and router smoke tests</name>
  <files>
    backend/tests/test_scoring.py
    backend/tests/test_router_smoke.py
  </files>
  <action>
**test_scoring.py** -- Unit tests for pure scoring functions (no DB needed):

Create test file per research Example 5. Test the following:

1. **get_effective_weight** tests:
   - Explicit weight on category returns that weight
   - No explicit weight, parent has weight -> returns parent weight
   - No explicit weight, no parent -> returns "normal"
   - No explicit weight, parent has no weight -> returns "normal"

2. **compute_composite_score** tests:
   - Normal weight: interest(8) * category(1.0) * quality_mult -> expected value
   - Block weight: returns 0.0 regardless of scores
   - Max weight: high scores capped at MAX_COMPOSITE_SCORE (20.0)
   - Multiple categories: uses minimum weight multiplier (worst category wins)
   - No categories: returns 0.0 or uses default -- check actual behavior
   - Boost weight: interest * 1.5 * quality_mult

3. **is_blocked** tests:
   - Category with weight="block" -> True
   - Category with is_hidden=True -> True
   - Category with weight="normal" -> False
   - Empty category list -> check actual behavior
   - Mixed: one blocked, one normal -> True (any blocked = blocked)

Use a `_make_category` helper that creates Category objects without DB. Set parent relationship manually where needed for inheritance tests. See research Example 5 for the pattern.

**test_router_smoke.py** -- Integration smoke tests for all routers:

Create test file per research Example 6. Use the `test_client` fixture from conftest.py (which already overrides get_session with test DB).

Test each router's primary endpoint:
1. `GET /health` -> 200, has "status" key
2. `GET /api/articles` -> 200, returns list
3. `GET /api/feeds` -> 200, returns list
4. `GET /api/categories` -> 200, returns list
5. `GET /api/preferences` -> 200, has "interests" key
6. `GET /api/scoring/status` -> 200, has expected keys
7. `POST /api/feeds` with valid URL -> test that it accepts the request shape (may fail on actual fetch but validates routing)
8. `GET /api/ollama/health` -> 200 (returns connected=false if Ollama not running, which is fine)

Each test is minimal: hit the endpoint, check status code and basic response shape. These catch wiring issues from the router split, not business logic.

Use the existing `test_client` fixture. For tests that need seed data, use `sample_feed` and `sample_articles` fixtures from conftest.py.
  </action>
  <verify>
    Run `cd /Users/cstalhem/projects/rss-reader/backend && uv run pytest backend/tests/test_scoring.py -v` -- all scoring unit tests pass.
    Run `cd /Users/cstalhem/projects/rss-reader/backend && uv run pytest backend/tests/test_router_smoke.py -v` -- all smoke tests pass.
    Run `cd /Users/cstalhem/projects/rss-reader/backend && uv run pytest backend/tests/ -v` -- entire test suite passes.
  </verify>
  <done>
    test_scoring.py has 8+ unit tests for compute_composite_score, is_blocked, get_effective_weight. test_router_smoke.py has 6+ smoke tests covering all router domains. Entire test suite passes.
  </done>
</task>

</tasks>

<verification>
- `uv run pytest backend/tests/ -v` -- full test suite green
- `uv run ruff check backend/src/backend/` -- entire backend lint-clean
- `uv run ruff format --check backend/src/backend/` -- formatting clean
- Manual: start server with `uv run uvicorn backend.main:app --port 8912`, verify endpoints respond correctly
- Run frontend dev server and verify no regressions in article list, feed management, categories, scoring status
</verification>

<success_criteria>
1. N+1 queries eliminated (list_feeds, get_scoring_status, mark_feed_read bulk UPDATE)
2. Article model has indexed scoring_state and composite_score
3. list_articles has response_model and Literal-typed sort/order params
4. Rescoring logic separated from ollama config endpoint into POST /api/scoring/rescore
5. create_feed catches specific exceptions (not broad except Exception)
6. unread_count matches frontend visibility (scored, non-blocked, unread)
7. test_scoring.py: 8+ passing unit tests
8. test_router_smoke.py: 6+ passing smoke tests
9. Entire test suite green
10. No functional regressions
</success_criteria>

<output>
After completion, create `.planning/phases/09.1-backend-codebase-evaluation-simplification/09.1-04-SUMMARY.md`
</output>
