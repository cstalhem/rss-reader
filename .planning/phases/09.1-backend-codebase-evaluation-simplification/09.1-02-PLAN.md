---
phase: 09.1-backend-codebase-evaluation-simplification
plan: 02
type: execute
wave: 2
depends_on: ["09.1-01"]
files_modified:
  - backend/src/backend/main.py
  - backend/src/backend/routers/__init__.py
  - backend/src/backend/routers/articles.py
  - backend/src/backend/routers/feeds.py
  - backend/src/backend/routers/categories.py
  - backend/src/backend/routers/preferences.py
  - backend/src/backend/routers/ollama.py
  - backend/src/backend/routers/scoring.py
  - backend/tests/conftest.py
autonomous: true
requirements: []

must_haves:
  truths:
    - "main.py is reduced to ~60-80 lines: app creation, CORS, lifespan, router registration, health endpoint"
    - "Each of the 6 router modules has all endpoints from its domain with correct route paths"
    - "All API endpoints return identical responses as before the split"
    - "No circular imports exist between any modules"
    - "Existing tests pass after conftest.py updated to import get_session from deps"
  artifacts:
    - path: "backend/src/backend/routers/__init__.py"
      provides: "Router package init"
    - path: "backend/src/backend/routers/articles.py"
      provides: "Article CRUD endpoints"
      contains: "router = APIRouter"
    - path: "backend/src/backend/routers/feeds.py"
      provides: "Feed CRUD and refresh endpoints"
      contains: "router = APIRouter"
    - path: "backend/src/backend/routers/categories.py"
      provides: "Category CRUD, batch, merge endpoints"
      contains: "router = APIRouter"
    - path: "backend/src/backend/routers/preferences.py"
      provides: "User preferences endpoints"
      contains: "router = APIRouter"
    - path: "backend/src/backend/routers/ollama.py"
      provides: "Ollama health, models, config, prompts endpoints"
      contains: "router = APIRouter"
    - path: "backend/src/backend/routers/scoring.py"
      provides: "Scoring status and rescore endpoints"
      contains: "router = APIRouter"
  key_links:
    - from: "backend/src/backend/main.py"
      to: "backend/src/backend/routers/*.py"
      via: "app.include_router()"
      pattern: "app\\.include_router"
    - from: "backend/src/backend/routers/*.py"
      to: "backend/src/backend/deps.py"
      via: "get_session import"
      pattern: "from backend\\.deps import get_session"
    - from: "backend/src/backend/routers/*.py"
      to: "backend/src/backend/schemas.py"
      via: "schema imports"
      pattern: "from backend\\.schemas import"
    - from: "backend/tests/conftest.py"
      to: "backend/src/backend/deps.py"
      via: "get_session import for dependency override"
      pattern: "from backend\\.deps import get_session"
---

<objective>
Split the 1,426-line main.py into 6 APIRouter modules in a `routers/` subdirectory, reducing main.py to an entry point (~60-80 lines). Update test conftest.py to import get_session from deps.py.

Purpose: The biggest code organization win in this phase. main.py currently contains 6 resource domains interleaved with 159 lines of schemas. After this split, each domain is self-contained and maintainable.

Output: 6 router modules in routers/, slim main.py, updated conftest.py.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09.1-backend-codebase-evaluation-simplification/09.1-CONTEXT.md
@.planning/phases/09.1-backend-codebase-evaluation-simplification/09.1-RESEARCH.md
@.planning/phases/09.1-backend-codebase-evaluation-simplification/09.1-01-SUMMARY.md
@backend/src/backend/main.py
@backend/src/backend/schemas.py
@backend/src/backend/deps.py
@backend/tests/conftest.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create 6 router modules and routers/__init__.py</name>
  <files>
    backend/src/backend/routers/__init__.py
    backend/src/backend/routers/articles.py
    backend/src/backend/routers/feeds.py
    backend/src/backend/routers/categories.py
    backend/src/backend/routers/preferences.py
    backend/src/backend/routers/ollama.py
    backend/src/backend/routers/scoring.py
  </files>
  <action>
Create `backend/src/backend/routers/` directory and `__init__.py` (empty or with brief docstring).

**Each router module follows the locked layout**: imports, router instance, private helpers, endpoints (REST order: GET list, GET detail, POST, PATCH, DELETE).

**routers/articles.py** -- endpoints from main.py:
- `GET /api/articles` (list_articles) -- currently ~L243-330
- `GET /api/articles/{article_id}` (get_article) -- ~L332-350
- `PATCH /api/articles/{article_id}` (update_article) -- ~L352-376
- Uses: `router = APIRouter(prefix="/api/articles", tags=["articles"])`
- Imports: Session, select, func from sqlmodel; Depends from fastapi; selectinload from sqlalchemy.orm; desc, nulls_last from sqlalchemy; schemas (ArticleResponse, ArticleUpdate, ArticleCategoryEmbed); deps (get_session); models (Article, ArticleCategoryLink, Category)
- Move `_article_to_response` helper into this module as a private function
- Move the `VALID_WEIGHTS` set here if only used by articles, OR into deps.py/schemas.py if shared

**routers/feeds.py** -- endpoints from main.py:
- `GET /api/feeds` (list_feeds) -- ~L378-406
- `POST /api/feeds` (create_feed) -- ~L408-487
- `PATCH /api/feeds/reorder` (reorder_feeds) -- ~L489-503
- `DELETE /api/feeds/{feed_id}` (delete_feed) -- ~L505-520
- `PATCH /api/feeds/{feed_id}` (update_feed) -- ~L522-560
- `POST /api/feeds/{feed_id}/mark-all-read` (mark_feed_read) -- ~L562-588
- `POST /api/feeds/refresh` (refresh_all_feeds) -- ~L590-616
- Uses: `router = APIRouter(prefix="/api/feeds", tags=["feeds"])`
- Imports: feeds module (fetch_feed, refresh_feed, save_articles), scoring_queue for enqueue

**routers/categories.py** -- endpoints from main.py:
- `GET /api/categories` (list_categories) -- ~L749-777
- `POST /api/categories` (create_category) -- ~L779-825
- `PATCH /api/categories/{category_id}` (update_category) -- ~L827-896
- `DELETE /api/categories/{category_id}` (delete_category) -- ~L898-925
- `POST /api/categories/merge` (merge_categories) -- ~L927-983
- `GET /api/categories/new-count` (get_new_category_count) -- ~L985-997
- `POST /api/categories/acknowledge` (acknowledge_categories) -- ~L999-1014
- `PATCH /api/categories/{category_id}/hide` (hide_category) -- ~L1016-1033
- `PATCH /api/categories/{category_id}/unhide` (unhide_category) -- ~L1035-1053
- `POST /api/categories/batch-move` (batch_move) -- ~L1055-1107
- `POST /api/categories/batch-hide` (batch_hide) -- ~L1109-1127
- `POST /api/categories/batch-delete` (batch_delete) -- ~L1129-1163
- `POST /api/categories/{category_id}/ungroup` (ungroup_category) -- ~L1165-1188
- Uses: `router = APIRouter(prefix="/api/categories", tags=["categories"])`
- Move `VALID_WEIGHTS` set into this module (or deps.py if shared with articles)
- Imports: slugify, smart_case from database, models

**routers/preferences.py** -- endpoints from main.py:
- `GET /api/preferences` (get_preferences) -- ~L618-630
- `PUT /api/preferences` (update_preferences) -- ~L632-747
- Uses: `router = APIRouter(prefix="/api/preferences", tags=["preferences"])`
- The PUT endpoint triggers rescoring via scoring_queue import. Use deferred import to avoid circular deps: `from backend.scoring_queue import scoring_queue` inside the function body.
- Import get_or_create_preferences from deps

**routers/ollama.py** -- endpoints from main.py:
- `GET /api/ollama/health` -- ~L1237-1243
- `GET /api/ollama/models` -- ~L1244-1250
- `POST /api/ollama/models/pull` -- ~L1251-1266
- `POST /api/ollama/models/pull/cancel` -- ~L1268-1273
- `DELETE /api/ollama/models/{name:path}` -- ~L1275-1283
- `GET /api/ollama/download-status` -- ~L1285-1289
- `GET /api/ollama/config` -- ~L1291-1317
- `PUT /api/ollama/config` -- ~L1319-1406 (keep rescoring logic in this endpoint for NOW -- Plan 04 will separate it)
- `GET /api/ollama/prompts` -- ~L1408-1426
- Uses: `router = APIRouter(prefix="/api/ollama", tags=["ollama"])`
- Imports: ollama_service, StreamingResponse, get_or_create_preferences and resolve_ollama_models from deps

**routers/scoring.py** -- endpoints from main.py:
- `POST /api/scoring/rescore` -- ~L1190-1199
- `GET /api/scoring/status` -- ~L1201-1235
- Uses: `router = APIRouter(prefix="/api/scoring", tags=["scoring"])`
- Imports: scoring module (get_scoring_activity), scoring_queue

**IMPORTANT**: Preserve EVERY endpoint signature exactly. Same route paths, same query parameters, same response shapes. This is a reorganization, not a behavioral change. Be careful with route ordering -- FastAPI matches routes in registration order, so `/api/feeds/reorder` must come before `/api/feeds/{feed_id}` (or use explicit path parameter types).
  </action>
  <verify>
    Run `cd /Users/cstalhem/projects/rss-reader/backend && uv run python -c "from backend.routers import articles, feeds, categories, preferences, ollama, scoring; print('All routers import OK')"` -- must succeed.
    Run `cd /Users/cstalhem/projects/rss-reader/backend && uv run ruff check backend/src/backend/routers/` -- no lint errors.
  </verify>
  <done>
    6 router modules exist in routers/ directory, each with correct APIRouter setup, all endpoints moved with identical signatures, no circular imports.
  </done>
</task>

<task type="auto">
  <name>Task 2: Slim down main.py and update conftest.py</name>
  <files>
    backend/src/backend/main.py
    backend/tests/conftest.py
  </files>
  <action>
**main.py** -- Rewrite to entry point only (~60-80 lines):
1. Keep imports: FastAPI, CORSMiddleware, asynccontextmanager, logging, os
2. Keep: settings, logging.basicConfig, logger
3. Keep: lifespan function (startup/shutdown with DB init, scheduler start/stop)
4. Keep: app = FastAPI(..., lifespan=lifespan)
5. Keep: CORS middleware setup
6. Keep: health endpoint (`GET /health`) -- it's the only non-prefixed route
7. Add router registration: import all 6 routers and call `app.include_router()` for each
8. Remove: ALL Pydantic models (now in schemas.py), ALL endpoint functions (now in routers/), ALL helper functions (_article_to_response, _get_or_create_preferences, etc.), ALL imports only needed by endpoints (slugify, desc, nulls_last, selectinload, etc.)

The logging format should be updated per user decision: change from `"%(asctime)s - %(name)s - %(levelname)s - %(message)s"` to `"%(levelname)s [%(name)s] %(message)s"` -- plain text, human-readable, greppable format matching the locked decision for `[LEVEL] [module] message: key=value` pattern.

**conftest.py** -- Critical fix per research Pitfall 2:
1. Change `from backend.database import get_session` to `from backend.deps import get_session` -- must match where routers import it from, otherwise `dependency_overrides` won't apply.
2. Everything else stays the same (test_engine, test_session, test_client, sample_feed, sample_articles).

**Verify the full chain works**: conftest overrides deps.get_session -> routers import deps.get_session -> override applies correctly.
  </action>
  <verify>
    Run `cd /Users/cstalhem/projects/rss-reader/backend && uv run python -c "from backend.main import app; print(f'Routes: {len(app.routes)}')"` -- should show route count matching total endpoints (35+).
    Run `cd /Users/cstalhem/projects/rss-reader/backend && uv run pytest backend/tests/test_api.py -v` -- existing tests must pass.
    Run `cd /Users/cstalhem/projects/rss-reader/backend && wc -l backend/src/backend/main.py` -- should be ~60-80 lines.
    Run `cd /Users/cstalhem/projects/rss-reader/backend && uv run ruff check backend/src/backend/main.py` -- no lint errors.
  </verify>
  <done>
    main.py is ~60-80 lines (entry point only). All existing tests pass with conftest.py importing get_session from deps. Total route count unchanged. No lint errors.
  </done>
</task>

</tasks>

<verification>
- `uv run pytest backend/tests/ -v` -- all existing tests pass
- `uv run ruff check backend/src/backend/` -- no lint errors across entire backend
- `uv run python -c "from backend.main import app; [print(r.path) for r in app.routes if hasattr(r, 'path')]"` -- all original endpoints listed
- `wc -l backend/src/backend/main.py` -- reduced from 1,426 to ~60-80 lines
- Manual: `uv run uvicorn backend.main:app --port 8912` starts without errors
</verification>

<success_criteria>
1. main.py reduced from 1,426 lines to ~60-80 lines
2. 6 router modules in routers/ with all endpoints preserved
3. All existing tests pass (conftest.py updated)
4. No circular imports
5. Server starts and all endpoints respond correctly
</success_criteria>

<output>
After completion, create `.planning/phases/09.1-backend-codebase-evaluation-simplification/09.1-02-SUMMARY.md`
</output>
