---
phase: 09.1-backend-codebase-evaluation-simplification
plan: 02
type: execute
wave: 2
depends_on: ["09.1-01"]
files_modified:
  - backend/src/backend/main.py
  - backend/src/backend/routers/__init__.py
  - backend/src/backend/routers/articles.py
  - backend/src/backend/routers/feeds.py
  - backend/src/backend/routers/categories.py
  - backend/src/backend/routers/preferences.py
  - backend/src/backend/routers/ollama.py
  - backend/src/backend/routers/scoring.py
  - backend/src/backend/schemas.py
  - backend/tests/conftest.py
  - frontend/src/lib/api.ts
autonomous: true
requirements: []

must_haves:
  truths:
    - "main.py is reduced to ~60-80 lines: app creation, CORS, lifespan, router registration, health endpoint"
    - "Each of the 6 router modules has all endpoints from its domain with correct route paths"
    - "All API endpoints return identical response shapes as before the split"
    - "No circular imports exist between any modules"
    - "Existing tests pass after conftest.py updated to import get_session from deps"
    - "Endpoint renames applied: hide/unhide absorbed into PATCH categories/{id}, new-count→unseen-count, acknowledge→mark-seen, reorder→PUT order, mark-all-read→mark-read, downloads singleton pattern for ollama pulls"
    - "Frontend api.ts updated to match all renamed/consolidated endpoints"
    - "CategoryUpdate schema extended with is_hidden field for hide/unhide consolidation"
  artifacts:
    - path: "backend/src/backend/routers/__init__.py"
      provides: "Router package init"
    - path: "backend/src/backend/routers/articles.py"
      provides: "Article CRUD endpoints"
      contains: "router = APIRouter"
    - path: "backend/src/backend/routers/feeds.py"
      provides: "Feed CRUD and refresh endpoints"
      contains: "router = APIRouter"
    - path: "backend/src/backend/routers/categories.py"
      provides: "Category CRUD, batch, merge endpoints"
      contains: "router = APIRouter"
    - path: "backend/src/backend/routers/preferences.py"
      provides: "User preferences endpoints"
      contains: "router = APIRouter"
    - path: "backend/src/backend/routers/ollama.py"
      provides: "Ollama health, models, config, downloads, prompts endpoints"
      contains: "router = APIRouter"
    - path: "backend/src/backend/routers/scoring.py"
      provides: "Scoring status and trigger endpoints"
      contains: "router = APIRouter"
  key_links:
    - from: "backend/src/backend/main.py"
      to: "backend/src/backend/routers/*.py"
      via: "app.include_router()"
      pattern: "app\\.include_router"
    - from: "backend/src/backend/routers/*.py"
      to: "backend/src/backend/deps.py"
      via: "get_session import"
      pattern: "from backend\\.deps import get_session"
    - from: "backend/src/backend/routers/*.py"
      to: "backend/src/backend/schemas.py"
      via: "schema imports"
      pattern: "from backend\\.schemas import"
    - from: "backend/tests/conftest.py"
      to: "backend/src/backend/deps.py"
      via: "get_session import for dependency override"
      pattern: "from backend\\.deps import get_session"
    - from: "frontend/src/lib/api.ts"
      to: "backend/src/backend/routers/*.py"
      via: "HTTP fetch calls to API endpoints"
---

<objective>
Split the 1,426-line main.py into 6 APIRouter modules in a `routers/` subdirectory, reducing main.py to an entry point (~60-80 lines). Apply deliberate REST endpoint renames and consolidations. Update test conftest.py and frontend api.ts to match.

Purpose: The biggest code organization win in this phase. main.py currently contains 6 resource domains interleaved with 159 lines of schemas. After this split, each domain is self-contained and maintainable. The endpoint renames improve REST adherence while the code is already being moved.

Output: 6 router modules in routers/, slim main.py, updated conftest.py, updated frontend api.ts.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09.1-backend-codebase-evaluation-simplification/09.1-CONTEXT.md
@.planning/phases/09.1-backend-codebase-evaluation-simplification/09.1-RESEARCH.md
@.planning/phases/09.1-backend-codebase-evaluation-simplification/09.1-01-SUMMARY.md
@backend/src/backend/main.py
@backend/src/backend/schemas.py
@backend/src/backend/deps.py
@backend/tests/conftest.py
@frontend/src/lib/api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create 6 router modules with REST endpoint renames</name>
  <files>
    backend/src/backend/routers/__init__.py
    backend/src/backend/routers/articles.py
    backend/src/backend/routers/feeds.py
    backend/src/backend/routers/categories.py
    backend/src/backend/routers/preferences.py
    backend/src/backend/routers/ollama.py
    backend/src/backend/routers/scoring.py
    backend/src/backend/schemas.py
  </files>
  <action>
Create `backend/src/backend/routers/` directory and `__init__.py` (empty or with brief docstring).

**Each router module follows the locked layout**: imports, router instance, private helpers, endpoints (REST order: GET list, GET detail, POST, PATCH, DELETE).

## Endpoint Renames Reference

Apply these renames during the move. Old paths are what exists in main.py; new paths are what the router modules should use.

| Old path | New path | Method | Notes |
|----------|----------|--------|-------|
| `/api/feeds/reorder` | `/api/feeds/order` | `PATCH` → `PUT` | "order" as a replaceable resource |
| `/api/feeds/{id}/mark-all-read` | `/api/feeds/{id}/mark-read` | POST | Drop redundant "all" |
| `/api/categories/new-count` | `/api/categories/unseen-count` | GET | Matches `is_seen` field |
| `/api/categories/acknowledge` | `/api/categories/mark-seen` | POST | Matches `is_seen` field, pairs with unseen-count |
| `/api/categories/{id}/hide` | *(removed)* | -- | Absorbed into `PATCH /api/categories/{id}` |
| `/api/categories/{id}/unhide` | *(removed)* | -- | Absorbed into `PATCH /api/categories/{id}` |
| `/api/ollama/models/pull` | `/api/ollama/downloads` | POST | Singleton download resource |
| `/api/ollama/models/pull/cancel` | `/api/ollama/downloads` | DELETE | Cancel = delete the download |
| `/api/ollama/download-status` | `/api/ollama/downloads` | GET | Get download state |
| `/api/scoring/rescore` | `/api/scoring` | POST | Collection-level POST triggers scoring |

All other endpoints keep their current paths unchanged.

## Router Details

**routers/articles.py** -- endpoints from main.py (no renames):
- `GET /api/articles` (list_articles) -- currently ~L243-330
- `GET /api/articles/{article_id}` (get_article) -- ~L332-350
- `PATCH /api/articles/{article_id}` (update_article) -- ~L352-376
- Uses: `router = APIRouter(prefix="/api/articles", tags=["articles"])`
- Imports: Session, select, func from sqlmodel; Depends from fastapi; selectinload from sqlalchemy.orm; desc, nulls_last from sqlalchemy; schemas (ArticleResponse, ArticleUpdate, ArticleCategoryEmbed); deps (get_session); models (Article, ArticleCategoryLink, Category)
- Move `_article_to_response` helper into this module as a private function
- Move the `VALID_WEIGHTS` set here if only used by articles, OR into deps.py/schemas.py if shared

**routers/feeds.py** -- endpoints from main.py (2 renames):
- `GET /api/feeds` (list_feeds) -- ~L378-406
- `POST /api/feeds` (create_feed) -- ~L408-487
- `PUT /api/feeds/order` (reorder_feeds) -- **renamed from `PATCH /api/feeds/reorder`**. Change method to PUT since we're replacing the full ordering. Route must come before `/{feed_id}` to avoid path conflicts.
- `DELETE /api/feeds/{feed_id}` (delete_feed) -- ~L505-520
- `PATCH /api/feeds/{feed_id}` (update_feed) -- ~L522-560
- `POST /api/feeds/{feed_id}/mark-read` (mark_feed_read) -- **renamed from `mark-all-read`**
- `POST /api/feeds/refresh` (refresh_all_feeds) -- ~L590-616
- Uses: `router = APIRouter(prefix="/api/feeds", tags=["feeds"])`
- Imports: feeds module (fetch_feed, refresh_feed, save_articles), scoring_queue for enqueue

**routers/categories.py** -- endpoints from main.py (2 renames, 2 consolidations):
- `GET /api/categories` (list_categories) -- ~L749-777
- `POST /api/categories` (create_category) -- ~L779-825
- `PATCH /api/categories/{category_id}` (update_category) -- ~L827-896. **EXPANDED: absorb hide/unhide logic.** When `is_hidden` is set in the request body:
  - `is_hidden: true` → also set `parent_id = None` (leave group on hide, same as old hide endpoint)
  - `is_hidden: false` → if weight is "block", set weight to None (same as old unhide endpoint)
  This requires adding `is_hidden: bool | None = None` to `CategoryUpdate` in schemas.py.
- `DELETE /api/categories/{category_id}` (delete_category) -- ~L898-925
- `POST /api/categories/merge` (merge_categories) -- ~L927-983
- `GET /api/categories/unseen-count` (get_unseen_count) -- **renamed from `new-count`**
- `POST /api/categories/mark-seen` (mark_seen) -- **renamed from `acknowledge`**
- `POST /api/categories/batch-move` (batch_move) -- ~L1055-1107
- `POST /api/categories/batch-hide` (batch_hide) -- ~L1109-1127
- `POST /api/categories/batch-delete` (batch_delete) -- ~L1129-1163
- `POST /api/categories/{category_id}/ungroup` (ungroup_category) -- ~L1165-1188
- **REMOVED**: `PATCH /api/categories/{id}/hide` and `PATCH /api/categories/{id}/unhide` -- absorbed into PATCH update above
- Uses: `router = APIRouter(prefix="/api/categories", tags=["categories"])`
- Move `VALID_WEIGHTS` set into this module (or deps.py if shared with articles)
- Imports: slugify, smart_case from database, models

**routers/preferences.py** -- endpoints from main.py (no renames):
- `GET /api/preferences` (get_preferences) -- ~L618-630
- `PUT /api/preferences` (update_preferences) -- ~L632-747
- Uses: `router = APIRouter(prefix="/api/preferences", tags=["preferences"])`
- The PUT endpoint triggers rescoring via scoring_queue import. Use deferred import to avoid circular deps: `from backend.scoring_queue import scoring_queue` inside the function body.
- Import get_or_create_preferences from deps

**routers/ollama.py** -- endpoints from main.py (3 renames → downloads singleton):
- `GET /api/ollama/health` -- ~L1237-1243
- `GET /api/ollama/models` -- ~L1244-1250
- `DELETE /api/ollama/models/{name:path}` -- ~L1275-1283
- `GET /api/ollama/config` -- ~L1291-1317
- `PUT /api/ollama/config` -- ~L1319-1406 (keep rescoring logic in this endpoint for NOW -- Plan 04 will separate it)
- `GET /api/ollama/prompts` -- ~L1408-1426
- `POST /api/ollama/downloads` (start_download) -- **renamed from `POST /api/ollama/models/pull`**. Singleton download resource. Body: `{model: "name"}`. Returns SSE stream.
- `DELETE /api/ollama/downloads` (cancel_download) -- **renamed from `POST /api/ollama/models/pull/cancel`**. Cancel active download.
- `GET /api/ollama/downloads` (get_download_status) -- **renamed from `GET /api/ollama/download-status`**. Get current download state.
- Uses: `router = APIRouter(prefix="/api/ollama", tags=["ollama"])`
- Imports: ollama_service, StreamingResponse, get_or_create_preferences and resolve_ollama_models from deps

**routers/scoring.py** -- endpoints from main.py (1 rename):
- `POST /api/scoring` (trigger_rescore) -- **renamed from `POST /api/scoring/rescore`**. Collection-level POST triggers scoring.
- `GET /api/scoring/status` -- ~L1201-1235
- Uses: `router = APIRouter(prefix="/api/scoring", tags=["scoring"])`
- Imports: scoring module (get_scoring_activity), scoring_queue

**schemas.py update**: Add `is_hidden: bool | None = None` field to the `CategoryUpdate` class to support the hide/unhide consolidation.

**IMPORTANT**: Be careful with route ordering -- FastAPI matches routes in registration order. Static path segments (e.g., `/order`, `/mark-seen`, `/unseen-count`, `/batch-move`) must be registered before parameterized paths (`/{category_id}`, `/{feed_id}`) to avoid conflicts.
  </action>
  <verify>
    Run `cd /Users/cstalhem/projects/rss-reader/backend && uv run python -c "from backend.routers import articles, feeds, categories, preferences, ollama, scoring; print('All routers import OK')"` -- must succeed.
    Run `cd /Users/cstalhem/projects/rss-reader/backend && uv run ruff check backend/src/backend/routers/ backend/src/backend/schemas.py` -- no lint errors.
  </verify>
  <done>
    6 router modules exist in routers/ directory with all endpoints moved, REST renames applied, hide/unhide absorbed into PATCH categories/{id}, CategoryUpdate schema extended, no circular imports.
  </done>
</task>

<task type="auto">
  <name>Task 2: Slim down main.py, update conftest.py and frontend api.ts</name>
  <files>
    backend/src/backend/main.py
    backend/tests/conftest.py
    frontend/src/lib/api.ts
  </files>
  <action>
**main.py** -- Rewrite to entry point only (~60-80 lines):
1. Keep imports: FastAPI, CORSMiddleware, asynccontextmanager, logging, os
2. Keep: settings, logging.basicConfig, logger
3. Keep: lifespan function (startup/shutdown with DB init, scheduler start/stop)
4. Keep: app = FastAPI(..., lifespan=lifespan)
5. Keep: CORS middleware setup
6. Keep: health endpoint (`GET /health`) -- it's the only non-prefixed route
7. Add router registration: import all 6 routers and call `app.include_router()` for each
8. Remove: ALL Pydantic models (now in schemas.py), ALL endpoint functions (now in routers/), ALL helper functions (_article_to_response, _get_or_create_preferences, etc.), ALL imports only needed by endpoints (slugify, desc, nulls_last, selectinload, etc.)

The logging format should be updated per user decision: change from `"%(asctime)s - %(name)s - %(levelname)s - %(message)s"` to `"%(levelname)s [%(name)s] %(message)s"` -- plain text, human-readable, greppable format matching the locked decision for `[LEVEL] [module] message: key=value` pattern.

**conftest.py** -- Critical fix per research Pitfall 2:
1. Change `from backend.database import get_session` to `from backend.deps import get_session` -- must match where routers import it from, otherwise `dependency_overrides` won't apply.
2. Everything else stays the same (test_engine, test_session, test_client, sample_feed, sample_articles).

**frontend/src/lib/api.ts** -- Update all renamed endpoint URLs. These are mechanical string replacements:

| Old URL in api.ts | New URL |
|-------------------|---------|
| `/api/feeds/reorder` | `/api/feeds/order` |
| `/api/feeds/${feedId}/mark-all-read` | `/api/feeds/${feedId}/mark-read` |
| `/api/categories/new-count` | `/api/categories/unseen-count` |
| `/api/categories/acknowledge` | `/api/categories/mark-seen` |
| `/api/categories/${id}/hide` | `/api/categories/${id}` (PATCH with `{is_hidden: true}` in body) |
| `/api/categories/${id}/unhide` | `/api/categories/${id}` (PATCH with `{is_hidden: false}` in body) |
| `/api/ollama/models/pull` (POST) | `/api/ollama/downloads` |
| `/api/ollama/models/pull/cancel` (POST) | `/api/ollama/downloads` (DELETE) |
| `/api/ollama/download-status` | `/api/ollama/downloads` |
| `/api/scoring/rescore` (in useModelPull.ts or similar) | `/api/scoring` |

For the hide/unhide consolidation: the current `hideCategory(id)` and `unhideCategory(id)` functions in api.ts should be updated to call `updateCategory(id, {is_hidden: true})` and `updateCategory(id, {is_hidden: false})` respectively. Either rewrite the functions to use `updateCategory` internally, or replace them with direct `updateCategory` calls and remove the dedicated functions. Also check for callers in hooks (likely `useCategories.ts`) and update those references.

Also check for the rescore URL in `frontend/src/lib/useModelPull.ts` or similar hooks that may call the rescore endpoint directly (outside of api.ts).

**Verify the full chain works**: conftest overrides deps.get_session -> routers import deps.get_session -> override applies correctly. Frontend calls match new backend routes.
  </action>
  <verify>
    Run `cd /Users/cstalhem/projects/rss-reader/backend && uv run python -c "from backend.main import app; print(f'Routes: {len(app.routes)}')"` -- should show route count (will be ~2 fewer than before due to hide/unhide consolidation).
    Run `cd /Users/cstalhem/projects/rss-reader/backend && uv run pytest backend/tests/ -v` -- existing tests must pass.
    Run `cd /Users/cstalhem/projects/rss-reader/backend && wc -l backend/src/backend/main.py` -- should be ~60-80 lines.
    Run `cd /Users/cstalhem/projects/rss-reader/backend && uv run ruff check backend/src/backend/main.py` -- no lint errors.
    Run `cd /Users/cstalhem/projects/rss-reader/frontend && bun run build` -- frontend builds without errors (verifies api.ts changes compile).
  </verify>
  <done>
    main.py is ~60-80 lines (entry point only). All existing tests pass with conftest.py importing get_session from deps. Frontend api.ts updated with all renamed endpoints. Frontend builds successfully. No lint errors.
  </done>
</task>

</tasks>

<verification>
- `uv run pytest backend/tests/ -v` -- all existing tests pass
- `uv run ruff check backend/src/backend/` -- no lint errors across entire backend
- `uv run python -c "from backend.main import app; [print(r.path) for r in app.routes if hasattr(r, 'path')]"` -- all endpoints listed with new names
- `wc -l backend/src/backend/main.py` -- reduced from 1,426 to ~60-80 lines
- `cd frontend && bun run build` -- frontend compiles with updated API URLs
- Manual: `uv run uvicorn backend.main:app --port 8912` starts without errors
</verification>

<success_criteria>
1. main.py reduced from 1,426 lines to ~60-80 lines
2. 6 router modules in routers/ with all endpoints preserved (with renames applied)
3. All existing tests pass (conftest.py updated)
4. No circular imports
5. REST endpoint renames applied: unseen-count, mark-seen, PUT order, mark-read, POST/GET/DELETE downloads, POST scoring
6. Hide/unhide consolidated into PATCH categories/{id} with is_hidden field
7. Frontend api.ts updated to match all renamed/consolidated endpoints
8. Server starts and all endpoints respond correctly
</success_criteria>

<output>
After completion, create `.planning/phases/09.1-backend-codebase-evaluation-simplification/09.1-02-SUMMARY.md`
</output>
