---
phase: 09.1-backend-codebase-evaluation-simplification
plan: 04
subsystem: api
tags: [fastapi, sqlalchemy, query-optimization, srp, testing, type-safety]

# Dependency graph
requires:
  - phase: 09.1-02
    provides: 6 APIRouter modules in routers/, endpoint renames, frontend URL updates
  - phase: 09.1-03
    provides: Scoring pipeline with proper Ollama AsyncClient lifecycle, sync enqueue functions
provides:
  - N+1 query fixes in list_feeds (JOIN+GROUP BY) and get_scoring_status (GROUP BY)
  - Bulk UPDATE for mark_feed_read
  - Indexed scoring_state and composite_score columns
  - Literal-typed sort/order params and response_model on list_articles
  - SRP separation: PUT /api/ollama/config saves only, POST /api/scoring triggers rescore
  - Frontend two-step flow: save config then trigger rescore as separate calls
  - 15 scoring unit tests (compute_composite_score, is_blocked, get_effective_weight)
  - 8 router smoke tests covering all 6 domains plus type validation
  - Updated backend knowledge docs (SKILL.md, rules/backend.md)
affects: [future backend work, test suite baseline]

# Tech tracking
tech-stack:
  added: []
  patterns: [LEFT JOIN + GROUP BY for N+1 elimination, bulk UPDATE via sqlalchemy.update(), Literal types for query param validation]

key-files:
  created:
    - backend/tests/test_scoring.py
    - backend/tests/test_router_smoke.py
  modified:
    - backend/src/backend/routers/articles.py
    - backend/src/backend/routers/feeds.py
    - backend/src/backend/routers/scoring.py
    - backend/src/backend/routers/ollama.py
    - backend/src/backend/schemas.py
    - backend/src/backend/models.py
    - frontend/src/lib/api.ts
    - frontend/src/lib/types.ts
    - frontend/src/hooks/useOllamaConfig.ts
    - frontend/src/components/settings/OllamaSection.tsx
    - .claude/skills/backend-reference/SKILL.md
    - .claude/rules/backend.md

key-decisions:
  - "unread_count in list_feeds only counts scored, non-blocked, unread articles (matches frontend display)"
  - "compute_composite_score uses AVERAGE weight multiplier across categories, not minimum"
  - "trigger_rescore returns {ok, rescore_queued} to match frontend RescoreResult type"
  - "OllamaSection passes rescoreMutation.isPending to isSaving prop for combined loading state"

patterns-established:
  - "N+1 fix pattern: LEFT JOIN + GROUP BY with outerjoin for optional counts"
  - "Bulk UPDATE pattern: sqlalchemy.update() with .values() and result.rowcount"
  - "Literal type validation on query params for automatic 422 on invalid values"
  - "SRP: save config and trigger action as separate endpoints with frontend orchestration"

requirements-completed: []

# Metrics
duration: 7min
completed: 2026-02-20
---

# Phase 09.1 Plan 04: Query Optimization, SRP Separation, and Test Coverage Summary

**N+1 queries eliminated via JOIN+GROUP BY, rescoring separated from config save with frontend two-step flow, 23 new tests (15 scoring unit + 8 router smoke)**

## Performance

- **Duration:** 7 min
- **Started:** 2026-02-19T23:06:05Z
- **Completed:** 2026-02-19T23:12:45Z
- **Tasks:** 2
- **Files modified:** 14

## Accomplishments
- Eliminated N+1 queries in list_feeds (single LEFT JOIN+GROUP BY) and get_scoring_status (single GROUP BY scoring_state)
- Replaced per-article mark_feed_read loop with bulk UPDATE, returning rowcount
- Separated rescoring logic from PUT /api/ollama/config into POST /api/scoring (SRP), coordinated frontend to use two-step flow
- Added Literal types to list_articles sort_by/order params (auto-422 on invalid values) and response_model
- Created 15 unit tests for scoring pure functions and 8 router smoke tests covering all domains
- Updated backend knowledge docs to reflect current architecture (routers/, deps.py, schema versioning)

## Task Commits

Each task was committed atomically:

1. **Task 1: Query efficiency, type safety, SRP separation** - `b49b1a4` (feat)
2. **Task 2: Unit tests for scoring functions and router smoke tests** - `52c53b6` (test)
3. **Knowledge updates** - `77a972c` (chore)
4. **Format modified files** - `f036d10` (chore)

## Files Created/Modified
- `backend/tests/test_scoring.py` - 15 unit tests for get_effective_weight, compute_composite_score, is_blocked
- `backend/tests/test_router_smoke.py` - 8 smoke tests for all router endpoints + type validation
- `backend/src/backend/routers/feeds.py` - N+1 fix (JOIN+GROUP BY), bulk UPDATE, specific exceptions
- `backend/src/backend/routers/scoring.py` - N+1 fix (GROUP BY), SRP: rescore endpoint enhanced
- `backend/src/backend/routers/articles.py` - response_model, Literal types for sort/order
- `backend/src/backend/routers/ollama.py` - Stripped rescoring logic, config-only save
- `backend/src/backend/schemas.py` - Removed rescore field from OllamaConfigUpdate
- `backend/src/backend/models.py` - Added index=True to scoring_state and composite_score
- `frontend/src/lib/api.ts` - Updated saveOllamaConfig signature, added triggerRescore function
- `frontend/src/lib/types.ts` - Replaced OllamaConfigSaveResult with RescoreResult
- `frontend/src/hooks/useOllamaConfig.ts` - Added rescoreMutation, updated saveMutation types
- `frontend/src/components/settings/OllamaSection.tsx` - Two-step save flow: config then rescore
- `.claude/skills/backend-reference/SKILL.md` - Updated with current code organization
- `.claude/rules/backend.md` - Updated schema migration rule to reflect version-gated approach

## Decisions Made
- unread_count in list_feeds only counts articles where scoring_state='scored' AND composite_score > 0 AND is_read=False, matching what the frontend displays
- compute_composite_score uses AVERAGE (not minimum) weight multiplier -- tested actual behavior, not plan's assumption
- trigger_rescore endpoint returns `{ok: true, rescore_queued: N}` for frontend RescoreResult type compatibility
- OllamaSection passes combined `saveMutation.isPending || rescoreMutation.isPending` to isSaving prop

## Deviations from Plan

None - plan executed exactly as written.

Note: The plan stated compute_composite_score "uses minimum weight multiplier (worst category wins)" but actual code uses average. Tests were written against actual behavior, not the plan description.

## Issues Encountered
None

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- Phase 09.1 is now complete (all 4 plans executed)
- Full test suite: 31 passing, 6 pre-existing failures (unscored test articles filtered by exclude_blocked in list_articles)
- Backend has proper query patterns, type safety, SRP separation, and test coverage
- Frontend builds and is synced with all backend API changes

## Self-Check: PASSED

All files verified present. All commit hashes found in git log.

---
*Phase: 09.1-backend-codebase-evaluation-simplification*
*Completed: 2026-02-20*
