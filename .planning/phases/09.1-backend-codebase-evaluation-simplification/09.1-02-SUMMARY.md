---
phase: 09.1-backend-codebase-evaluation-simplification
plan: 02
subsystem: api
tags: [fastapi, api-router, rest, endpoint-renames, code-organization]

# Dependency graph
requires:
  - phase: 09.1-01
    provides: schemas.py with Pydantic models, deps.py with get_session
provides:
  - 6 APIRouter modules in routers/ (articles, feeds, categories, preferences, ollama, scoring)
  - Slim main.py entry point (69 lines, down from 1,426)
  - REST-compliant endpoint renames (unseen-count, mark-seen, PUT order, mark-read, downloads singleton, POST scoring)
  - Hide/unhide consolidated into PATCH categories/{id} with is_hidden field
  - Frontend api.ts and useModelPull.ts updated to match all renamed endpoints
affects: [09.1-03 error handling, 09.1-04 testing]

# Tech tracking
tech-stack:
  added: []
  patterns: [APIRouter per domain with prefix/tags, router registration in main.py entry point]

key-files:
  created:
    - backend/src/backend/routers/__init__.py
    - backend/src/backend/routers/articles.py
    - backend/src/backend/routers/feeds.py
    - backend/src/backend/routers/categories.py
    - backend/src/backend/routers/preferences.py
    - backend/src/backend/routers/ollama.py
    - backend/src/backend/routers/scoring.py
  modified:
    - backend/src/backend/main.py
    - backend/src/backend/database.py
    - backend/src/backend/schemas.py
    - backend/tests/conftest.py
    - frontend/src/lib/api.ts
    - frontend/src/hooks/useModelPull.ts

key-decisions:
  - "conftest.py imports get_session from deps.py (not database.py) so dependency_overrides match routers"
  - "Removed get_session copy from database.py since no remaining consumers after router split"
  - "Logging format changed to plain text: %(levelname)s [%(name)s] %(message)s"

patterns-established:
  - "APIRouter per domain: prefix + tags, static routes before parameterized to avoid path conflicts"
  - "Router layout: imports, router instance, private helpers, endpoints in REST order"

requirements-completed: []

# Metrics
duration: 7min
completed: 2026-02-19
---

# Phase 09.1 Plan 02: Router Split & Endpoint Renames Summary

**1,426-line main.py split into 6 APIRouter modules with REST endpoint renames, hide/unhide consolidation, and full frontend URL updates**

## Performance

- **Duration:** 7 min
- **Started:** 2026-02-19T22:55:48Z
- **Completed:** 2026-02-19T23:03:07Z
- **Tasks:** 2
- **Files modified:** 13

## Accomplishments
- Split main.py from 1,426 lines to a 69-line entry point with 6 domain-specific router modules
- Applied 10 REST endpoint renames/consolidations (reorder->order, mark-all-read->mark-read, new-count->unseen-count, acknowledge->mark-seen, hide/unhide->PATCH is_hidden, models/pull->downloads, download-status->downloads, rescore->POST scoring)
- Updated conftest.py to import get_session from deps.py (critical for test dependency_overrides)
- Updated frontend api.ts and useModelPull.ts with all renamed endpoint URLs
- Removed dead get_session copy from database.py and unused Session import

## Task Commits

Each task was committed atomically:

1. **Task 1: Create 6 router modules with REST endpoint renames** - `b728591` (feat)
2. **Task 2: Slim down main.py, update conftest.py and frontend api.ts** - `def056f` (refactor)

## Files Created/Modified
- `backend/src/backend/routers/__init__.py` - Router package init
- `backend/src/backend/routers/articles.py` - Article list, get, update endpoints with _article_to_response helper
- `backend/src/backend/routers/feeds.py` - Feed CRUD, PUT /order, POST /mark-read, refresh endpoints
- `backend/src/backend/routers/categories.py` - Category CRUD, batch ops, merge, unseen-count, mark-seen, hide/unhide via PATCH
- `backend/src/backend/routers/preferences.py` - GET/PUT preferences with rescoring trigger
- `backend/src/backend/routers/ollama.py` - Health, models, config, downloads singleton, prompts endpoints
- `backend/src/backend/routers/scoring.py` - POST scoring trigger, GET status
- `backend/src/backend/main.py` - Reduced to entry point: app creation, CORS, lifespan, router registration, health
- `backend/src/backend/database.py` - Removed get_session copy and unused Session import
- `backend/src/backend/schemas.py` - Import sorting fix (ruff auto-fix)
- `backend/tests/conftest.py` - Import get_session from deps instead of database
- `frontend/src/lib/api.ts` - All renamed endpoint URLs, hide/unhide now calls updateCategory
- `frontend/src/hooks/useModelPull.ts` - Pull/cancel URLs updated to downloads endpoint

## Decisions Made
- conftest.py must import get_session from the same module as routers (deps.py) for FastAPI dependency_overrides to work correctly
- Removed the get_session copy from database.py since main.py no longer imports from there
- Logging format updated to plain text `%(levelname)s [%(name)s] %(message)s` per plan specification

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Removed dead get_session from database.py and unused Session import**
- **Found during:** Task 2 (main.py rewrite)
- **Issue:** After rewriting main.py to use routers, no code imports get_session from database.py anymore. The function and its Session import became dead code created by our changes.
- **Fix:** Removed get_session function and unused Session import from database.py
- **Files modified:** backend/src/backend/database.py
- **Verification:** `uv run ruff check src/backend/database.py` passes, app starts correctly
- **Committed in:** def056f (Task 2 commit)

---

**Total deviations:** 1 auto-fixed (1 blocking - dead code cleanup)
**Impact on plan:** Cleanup of code made dead by our own changes. No scope creep.

## Issues Encountered
None

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- All 6 router modules in place, ready for Plan 03 error handling improvements
- conftest.py properly configured for test dependency_overrides
- Frontend fully synced with new backend endpoints
- Same 6 pre-existing test failures (unscored articles filtered by exclude_blocked), 8 passing

## Self-Check: PASSED

All 7 router files verified present. Both task commits (b728591, def056f) found in git history.

---
*Phase: 09.1-backend-codebase-evaluation-simplification*
*Completed: 2026-02-19*
