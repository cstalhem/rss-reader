---
phase: 09.1-backend-codebase-evaluation-simplification
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/backend/schemas.py
  - backend/src/backend/deps.py
  - backend/src/backend/database.py
  - backend/src/backend/models.py
  - backend/src/backend/prompts.py
  - backend/src/backend/scoring.py
  - backend/src/backend/config.py
autonomous: true
requirements: []

must_haves:
  truths:
    - "schemas.py contains all Pydantic request/response models extracted from main.py"
    - "deps.py provides get_session, get_or_create_preferences, and resolve_ollama_models"
    - "database.py dead migration functions are removed (~240 lines) and replaced by schema versioning"
    - "Category seeding is separated from migration logic into its own function"
    - "Dead code removed from prompts.py (DEFAULT_CATEGORIES), models.py (arbitrary_types_allowed), scoring.py (old weight aliases)"
    - "Magic numbers in scoring pipeline have named constants"
    - "Config parse failures are logged"
  artifacts:
    - path: "backend/src/backend/schemas.py"
      provides: "All Pydantic request/response models for API endpoints"
      contains: "class ArticleResponse"
    - path: "backend/src/backend/deps.py"
      provides: "Shared FastAPI dependencies and helpers"
      exports: ["get_session", "get_or_create_preferences", "resolve_ollama_models"]
    - path: "backend/src/backend/database.py"
      provides: "Database initialization with schema versioning"
      contains: "schema_version"
  key_links:
    - from: "backend/src/backend/deps.py"
      to: "backend/src/backend/database.py"
      via: "engine import for get_session"
      pattern: "from backend\\.database import engine"
    - from: "backend/src/backend/deps.py"
      to: "backend/src/backend/models.py"
      via: "UserPreferences import"
      pattern: "from backend\\.models import UserPreferences"
    - from: "backend/src/backend/schemas.py"
      to: "pydantic"
      via: "BaseModel inheritance"
      pattern: "from pydantic import BaseModel"
---

<objective>
Create the shared foundation modules (schemas.py, deps.py) that routers will import from, clean up dead code across backend files, add schema versioning to database.py, and extract magic numbers into named constants.

Purpose: This plan establishes the import structure that Plan 02 (router split) needs. Without schemas.py and deps.py, routers would have circular imports. Dead code removal and schema versioning simplify database.py before the split touches it.

Output: Two new shared modules (schemas.py, deps.py), cleaned database.py with schema versioning, dead code removed from 4 files, magic numbers replaced with constants.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09.1-backend-codebase-evaluation-simplification/09.1-CONTEXT.md
@.planning/phases/09.1-backend-codebase-evaluation-simplification/09.1-RESEARCH.md
@backend/src/backend/main.py
@backend/src/backend/database.py
@backend/src/backend/models.py
@backend/src/backend/prompts.py
@backend/src/backend/scoring.py
@backend/src/backend/config.py
@backend/src/backend/scoring_queue.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create schemas.py and deps.py shared modules</name>
  <files>
    backend/src/backend/schemas.py
    backend/src/backend/deps.py
  </files>
  <action>
**schemas.py** -- Extract ALL Pydantic request/response models from main.py (lines 72-232) into a new schemas.py file. This includes: HealthResponse, ArticleUpdate, RefreshResponse, FeedCreate, FeedUpdate, FeedReorder, FeedResponse, PreferencesResponse, PreferencesUpdate, CategoryResponse, CategoryCreateRequest, CategoryUpdate, CategoryMerge, CategoryAcknowledgeRequest, CategoryBatchMove, CategoryBatchAction, ArticleCategoryEmbed, ArticleResponse, OllamaHealthResponse, OllamaModelResponse, PullModelRequest, OllamaConfigResponse, OllamaConfigUpdate, OllamaPromptsResponse.

All classes inherit from `pydantic.BaseModel`. Import datetime from datetime. Keep the exact same field definitions -- this is a move, not a rewrite.

**deps.py** -- Create shared dependencies module with three items:
1. `get_session()` -- move from database.py. FastAPI dependency yielding `Session(engine)`.
2. `get_or_create_preferences(session: Session) -> UserPreferences` -- consolidate the 3 duplicated copies (main.py, scoring_queue.py, and the inline version in update_ollama_config). Single implementation querying UserPreferences, creating defaults if none exist.
3. `resolve_ollama_models(preferences: UserPreferences) -> tuple[str, str]` -- extract the duplicated `if use_separate_models` logic (appears in main.py get_ollama_config, update_ollama_config, and scoring_queue.py). Returns (categorization_model, scoring_model) tuple.

deps.py imports: `Session` from sqlmodel, `select` from sqlmodel, `engine` from `backend.database`, `UserPreferences` from `backend.models`, `get_settings` from `backend.config`, `datetime` from datetime.

Do NOT modify main.py or any other consumer in this task -- they will be updated during the router split (Plan 02). The goal here is to create the modules that Plan 02 will import from.

Per research Pattern 3 (deps.py) for exact structure.
  </action>
  <verify>
    Run `cd /Users/cstalhem/projects/rss-reader/backend && uv run python -c "from backend.schemas import ArticleResponse, FeedResponse, CategoryResponse, OllamaConfigResponse; print('schemas OK')"` and `cd /Users/cstalhem/projects/rss-reader/backend && uv run python -c "from backend.deps import get_session, get_or_create_preferences, resolve_ollama_models; print('deps OK')"` -- both must print OK without import errors.
  </verify>
  <done>
    schemas.py contains all 23 Pydantic models from main.py. deps.py exports get_session, get_or_create_preferences, and resolve_ollama_models. Both modules import cleanly with no circular import errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Dead code removal, schema versioning, magic numbers, and config logging</name>
  <files>
    backend/src/backend/database.py
    backend/src/backend/models.py
    backend/src/backend/prompts.py
    backend/src/backend/scoring.py
    backend/src/backend/config.py
  </files>
  <action>
**database.py** -- Major cleanup:
1. **Remove all completed migration functions** (~240 lines): `_migrate_articles_scoring_columns`, `_migrate_ollama_config_columns`, `_migrate_json_to_relational`, `_drop_old_json_columns`, `_backup_database`, `_seed_categories_from_hierarchy`. Also remove `import json` and `import shutil` which are only used by these functions.
2. **Separate seeding from migration**: Extract the "seed default categories if DB is empty" logic into a standalone `_seed_default_categories(session)` function. This function checks if any Category rows exist; if not, it seeds from `DEFAULT_CATEGORY_HIERARCHY` in prompts.py. Keep this as the one thing that runs on fresh installs.
3. **Add simple schema versioning**: Create `CURRENT_SCHEMA_VERSION = 1` constant. Add `_get_schema_version(conn) -> int` and `_set_schema_version(conn, version: int)` functions using a `schema_version` table (see research Pattern 6). Update `create_db_and_tables()` to: create all tables via `SQLModel.metadata.create_all(engine)`, check schema version, run any needed migrations (currently none -- version 0->1 just seeds categories and recovers stuck scoring states), set version to CURRENT_SCHEMA_VERSION.
4. **Remove `get_session`** from database.py (it now lives in deps.py). Keep the engine, smart_case helpers, and create_db_and_tables.
5. **Keep `_recover_stuck_scoring_states`** -- this is still needed on startup to reset `scoring -> queued` for interrupted work.

**models.py** -- Remove `model_config = {"arbitrary_types_allowed": True}` from Article class (no non-standard types; leftover from when JSON column existed).

**prompts.py** -- Remove `DEFAULT_CATEGORIES` list (defined but never imported anywhere -- superseded by `DEFAULT_CATEGORY_HIERARCHY` dict). Keep `DEFAULT_CATEGORY_HIERARCHY`.

**scoring.py** -- Two changes:
1. Remove old weight name aliases from `weight_map` in `compute_composite_score`: remove `"blocked"`, `"low"`, `"neutral"`, `"medium"`, `"high"` entries. Data migration already remapped all data to new names (block/reduce/normal/boost/max).
2. Extract magic numbers as named constants at module top: `MAX_COMPOSITE_SCORE = 20.0` (replaces hardcoded 20.0 cap in compute_composite_score).

**config.py** -- Add `logger.warning(f"Failed to parse config file: path={path} error={e}")` in the YAML config loading exception handler (currently silent, lines ~123-125). Import logging and create logger at module top if not already present.
  </action>
  <verify>
    Run `cd /Users/cstalhem/projects/rss-reader/backend && uv run python -c "from backend.database import create_db_and_tables, CURRENT_SCHEMA_VERSION; print(f'schema v{CURRENT_SCHEMA_VERSION}')"` -- should print "schema v1".
    Run `cd /Users/cstalhem/projects/rss-reader/backend && uv run python -c "from backend.scoring import MAX_COMPOSITE_SCORE; print(f'max={MAX_COMPOSITE_SCORE}')"` -- should print "max=20.0".
    Run `cd /Users/cstalhem/projects/rss-reader/backend && uv run ruff check backend/src/backend/database.py backend/src/backend/models.py backend/src/backend/prompts.py backend/src/backend/scoring.py backend/src/backend/config.py` -- no lint errors.
  </verify>
  <done>
    database.py has ~240 fewer lines with dead migrations removed, schema versioning via schema_version table, seeding separated into _seed_default_categories. models.py has no arbitrary_types_allowed. prompts.py has no DEFAULT_CATEGORIES. scoring.py has no old weight aliases and uses MAX_COMPOSITE_SCORE constant. config.py logs parse failures.
  </done>
</task>

</tasks>

<verification>
- `uv run python -c "from backend.schemas import *; from backend.deps import *"` imports without error
- `uv run python -c "from backend.database import create_db_and_tables"` imports without error
- `uv run ruff check backend/src/backend/` passes (may have warnings from main.py still importing get_session from database -- this is expected and will be fixed in Plan 02)
- `uv run pytest backend/tests/` -- existing tests still pass (main.py still has its own inline versions of everything; this plan creates NEW modules without breaking existing code)
</verification>

<success_criteria>
1. schemas.py exists with all 23 Pydantic models
2. deps.py exists with get_session, get_or_create_preferences, resolve_ollama_models
3. database.py reduced by ~240 lines, has schema versioning, seeding separated
4. Dead code removed from models.py, prompts.py, scoring.py
5. config.py logs parse failures
6. All existing tests still pass (no behavioral changes)
</success_criteria>

<output>
After completion, create `.planning/phases/09.1-backend-codebase-evaluation-simplification/09.1-01-SUMMARY.md`
</output>
