# Phase 09.3: Settings Page Architecture -- Audit Findings

**Date:** 2026-02-22
**Scope:** Frontend settings only (`frontend/src/app/settings/`, `frontend/src/components/settings/`)
**Source:** 09.3-RESEARCH.md (full codebase audit of 28 component files and 8 page files)

---

## 1. Executive Summary

The settings page architecture follows a clean App Router pattern -- server component layout with sidebar navigation, six URL-routed pages, each rendering a single client component section. The routing layer and server/client boundaries are well-placed and should not change. Complexity is concentrated in two areas: **CategoriesSection** (491 lines, 15+ callbacks, 8+ state variables, 15-prop interface to CategoryTree) and **repeated inline patterns** across sections (panel card wrappers, empty states, progress bars, and confirmation dialogs copy-pasted rather than shared). Five recommendation themes address these issues: shared layout primitives, category section decomposition, Ollama section cleanup, heading consistency, and a missing mobile nav item.

---

## 2. Component Hierarchy

```
app/settings/
  layout.tsx (SERVER) ................... 45 lines
  |-- Header (from layout/Header.tsx)
  |-- SettingsSidebar ................... 133 lines, CLIENT
  |   (queries: downloadStatus, newCategoryCount)
  |-- SettingsMobileNav ................. 36 lines, CLIENT
  |-- {children} <-- route-based page
  |
  page.tsx (SERVER) .................... redirect -> /settings/feeds
  |
  feeds/page.tsx (SERVER, 5 lines)
  |-- FeedsSection ..................... 259 lines, CLIENT
  |   |-- SortableFeedRow (co-located)
  |   |-- AddFeedDialog (from feed/)
  |   |-- DeleteFeedDialog (from feed/)
  |
  general/page.tsx (SERVER, 5 lines)
  |-- GeneralSection ................... 226 lines, CLIENT
  |   (hooks: usePreferences, countdown timer)
  |
  interests/page.tsx (SERVER, 5 lines)
  |-- InterestsSection ................. 126 lines, CLIENT
  |   |-- InterestsForm (co-located)
  |
  categories/page.tsx (SERVER, 5 lines)
  |-- CategoriesSection ................ 491 lines, CLIENT  <-- HOTSPOT
  |   |-- CategoryActionBar ............ 113 lines
  |   |-- CreateCategoryPopover ........ 85 lines
  |   |-- CategoryTree ................. 166 lines (React.memo)
  |   |   |-- CategoryParentRow ........ 103 lines (React.memo)
  |   |   |   |-- CategoryRowShell ..... 121 lines
  |   |   |   |   |-- WeightPresetStrip  105 lines (React.memo)
  |   |   |   |   |-- CategoryContextMenu 81 lines
  |   |   |   |-- NewCategoryBadge (from badge)
  |   |   |-- CategoryChildRow ......... 86 lines (React.memo)
  |   |   |   |-- CategoryRowShell (shared)
  |   |   |   |-- NewCategoryBadge
  |   |   |-- CategoryUngroupedRow ..... 76 lines (React.memo)
  |   |       |-- CategoryRowShell (shared)
  |   |       |-- NewCategoryBadge
  |   |-- DeleteCategoryDialog ......... 80 lines
  |   |-- MoveToGroupDialog ............ 174 lines
  |   |-- ConfirmDialog x2 (from ui/)
  |   |-- HiddenCategoriesSection ...... 70 lines
  |   |-- CategoriesTreeSkeleton ....... 62 lines
  |
  ollama/page.tsx (SERVER, 5 lines)
  |-- OllamaSection .................... 156 lines, CLIENT
  |   |-- OllamaHealthBadge ............ 44 lines
  |   |-- ModelSelector ................ 299 lines
  |   |   |-- ModelSelect (co-located)
  |   |-- ModelManagement .............. 364 lines  <-- SECONDARY HOTSPOT
  |   |   |-- InstalledModelRow (co-located)
  |   |   |-- ModelPullProgress ........ 75 lines
  |   |-- SystemPrompts ................ 77 lines
  |       |-- PromptSection (co-located)
  |
  feedback/page.tsx (SERVER, 5 lines)
  |-- FeedbackPlaceholder .............. 25 lines
```

**Max nesting depth:** 5 levels (CategoriesSection -> CategoryTree -> CategoryChildRow -> CategoryRowShell -> WeightPresetStrip)

---

## 3. Complexity Hotspots

### Hotspot 1: CategoriesSection (491 lines) -- CRITICAL

| Metric | Value |
|--------|-------|
| Line count | 491 |
| Props passed to CategoryTree | 15 |
| State variables (useState/useLocalStorage) | 8+ |
| useCallback handlers | 15+ |
| useMemo computations | 4 |
| Dialog state objects | 4 |
| Mutation calls | 11 (via useCategories) |

**Core issue:** God component managing 8+ independent state concerns (selection, expansion, search, 4x dialog state, tree computation). The 15-prop interface to CategoryTree is almost entirely pass-through to child row components -- classic prop drilling.

### Hotspot 2: ModelManagement (364 lines) -- MODERATE

| Metric | Value |
|--------|-------|
| Line count | 364 |
| Inline Dialog.Root blocks | 1 (should use ConfirmDialog) |
| Mixed concerns | installed list, curated list, custom pull form, progress, errors, delete dialog |

**Core issue:** Uses an inline `Dialog.Root` for delete confirmation instead of the project's `ConfirmDialog` component. Otherwise functional but could be cleaner with co-located sub-components.

### Hotspot 3: ModelSelector (299 lines) -- MODERATE

| Metric | Value |
|--------|-------|
| Line count | 299 |
| Inline progress bar duplications | 3 identical blocks |

**Core issue:** Three copy-pasted progress bar blocks (categorization model, scoring model, single model views) that should use `ModelPullProgress compact` or a small extracted component.

---

## 4. Repeated Patterns

| # | Pattern | Usages | Where | Extraction Target |
|---|---------|--------|-------|-------------------|
| 1 | Settings panel card (`Box bg="bg.subtle" borderRadius="md" borderWidth="1px" p={5\|6}`) | 7+ | OllamaSection (3x), InterestsSection, GeneralSection, FeedsSection, CategoriesSection | `SettingsPanel` wrapper component |
| 2 | Empty state (centered icon + title + description + optional action) | 4+ | FeedsSection, OllamaSection, CategoriesSection, FeedbackPlaceholder | `EmptyState` component |
| 3 | Inline download progress bar (`Box height="4px" bg="bg.subtle"` + inner fill + text) | 3 | ModelSelector (3 identical blocks) | Use existing `ModelPullProgress compact` or extract `DownloadProgressBar` |
| 4 | Inline confirmation dialog (`Dialog.Root` with header/body/footer) | 1 | ModelManagement | Use existing `ConfirmDialog` |
| 5 | Section heading inconsistency | 9+ | All sections | Standardize: `fontSize="xl"` for page titles, `fontSize="lg"` for panel headings |

---

## 5. Recommendations by Theme

### Theme A: Shared Layout Primitives

| ID | Recommendation | Files Affected | What Changes |
|----|----------------|---------------|--------------|
| A1 | Extract `SettingsPanel` component | OllamaSection, InterestsSection, GeneralSection, FeedsSection, CategoriesSection | Replace 7+ instances of Box with identical card styling |
| A2 | Extract `EmptyState` component | FeedsSection, OllamaSection, CategoriesSection, FeedbackPlaceholder | Replace 4+ instances of centered icon + text + optional action |
| A3 | Remove `OllamaPlaceholder.tsx` (dead code) | OllamaPlaceholder.tsx | Delete unused file |

**Expected outcome:** Consistent visual language for settings panels and empty states. ~50 lines of repeated markup eliminated across 5+ files.

### Theme B: Category Section Simplification

| ID | Recommendation | Files Affected | What Changes |
|----|----------------|---------------|--------------|
| B1 | Extract `useCategoryTree()` hook | CategoriesSection, new hook file | Move 4 useMemo computations (tree build, filtering, newCategoryIds, hidden) into a hook |
| B2 | Create `CategoryTreeContext` | CategoriesSection, CategoryTree, all row components | Move 8 action callbacks + selectedIds + newCategoryIds into context, eliminating prop drilling |
| B3 | Extract `useCategoryDialogs()` hook | CategoriesSection, new hook file | Move 4 dialog state objects and their open/close/confirm handlers into a hook |

**Before:**

```
CategoriesSection (491 lines, 15+ callbacks, 8+ state variables)
  -> CategoryTree (15 props)
    -> Row components (10-12 props each)
```

**After:**

```
CategoriesSection (~200 lines, composition only)
  -> useCategoryTree() for data
  -> useCategoryDialogs() for dialog state
  -> CategoryTreeProvider for actions
    -> CategoryTree (5 props: parents, childrenMap, ungrouped, expanded, onToggleParent)
      -> Row components (3-5 props each + useContext for actions)
```

### Theme C: Ollama Section Cleanup

| ID | Recommendation | Files Affected | What Changes |
|----|----------------|---------------|--------------|
| C1 | Replace ModelManagement inline Dialog with ConfirmDialog | ModelManagement.tsx | Replace ~30-line inline Dialog.Root with ConfirmDialog |
| C2 | Replace ModelSelector inline progress bars | ModelSelector.tsx | Replace 3 copy-pasted progress bar blocks with ModelPullProgress compact or a small DownloadProgressBar |

**Expected outcome:** Consistent dialog usage across the codebase, eliminated progress bar duplication.

### Theme D: Heading/Title Consistency

| ID | Recommendation | Files Affected | What Changes |
|----|----------------|---------------|--------------|
| D1 | Standardize page title pattern | FeedsSection (currently uses `fontSize="lg"` instead of `"xl"`) | All page titles use `fontSize="xl"` |

### Theme E: SettingsMobileNav Missing Item

| ID | Recommendation | Files Affected | What Changes |
|----|----------------|---------------|--------------|
| E1 | Add "General" to SettingsMobileNav SECTIONS array | SettingsMobileNav.tsx | Mobile nav matches desktop sidebar |

---

## 6. Dead Code

- **OllamaPlaceholder.tsx** (25 lines) -- no imports found anywhere in the codebase. Replaced by the connected/disconnected state in OllamaSection itself. Safe to delete.

---

## 7. What's Already Good (Do NOT Change)

These patterns are well-applied and should be preserved through any refactoring:

- **App Router nested layout** -- server component layout with sidebar, thin server page.tsx files rendering a single client section component
- **URL-based navigation** -- each section is its own route, back/forward works, redirect from `/settings` to `/settings/feeds`
- **Server/client boundaries** -- layout is server, sidebar/mobile-nav/sections are client, no unnecessary boundaries
- **TanStack Query for all data** -- hooks (useCategories, usePreferences, useOllamaConfig), query key factory, MutationCache for error handling
- **React.memo on repeated rows** -- CategoryTree, all row components, WeightPresetStrip properly memoized
- **Co-located sub-components** -- SortableFeedRow, InterestsForm, ModelSelect, InstalledModelRow, PromptSection (single-consumer components stay in their parent file)

---

## 8. Open Questions

1. **CategoryRowShell: should it be memoized?**
   - Used by 3 memoized row components (ParentRow, ChildRow, UngroupedRow). The rows are memoized but the shell is not.
   - Likely fine since memo is on the parent component. Verify during implementation if profiling shows an issue.

2. **WeightPresetStrip hover state on mobile**
   - Desktop expand/collapse uses onMouseEnter/Leave. Mobile shows all buttons via responsive display.
   - Low priority -- investigate only if profiling shows unnecessary re-renders on touch devices.

---

*Compiled from 09.3-RESEARCH.md | Source: full audit of 28 component files and 8 page files*
