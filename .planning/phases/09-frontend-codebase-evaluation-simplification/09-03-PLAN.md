---
phase: 09-frontend-codebase-evaluation-simplification
plan: 03
type: execute
wave: 3
depends_on: ["09-02"]
files_modified:
  - frontend/src/components/settings/CategoriesSection.tsx
  - frontend/src/components/settings/CategoryParentRow.tsx
  - frontend/src/components/settings/CategoryChildRow.tsx
  - frontend/src/components/settings/CategoryUngroupedRow.tsx
  - frontend/src/components/settings/CategoryTree.tsx
  - frontend/src/components/settings/CategoryActionBar.tsx
  - frontend/src/components/settings/CategoryContextMenu.tsx
  - frontend/src/components/settings/DeleteCategoryDialog.tsx
  - frontend/src/components/settings/MoveToGroupDialog.tsx
  - frontend/src/components/settings/HiddenCategoriesSection.tsx
  - frontend/src/components/settings/CreateCategoryPopover.tsx
  - frontend/src/components/settings/InterestsSection.tsx
  - frontend/src/components/settings/FeedsSection.tsx
  - frontend/src/components/settings/ModelSelector.tsx
  - frontend/src/components/settings/ModelManagement.tsx
  - frontend/src/components/settings/SettingsSidebar.tsx
  - frontend/src/components/settings/OllamaSection.tsx
  - frontend/src/components/settings/OllamaPlaceholder.tsx
  - frontend/src/components/settings/FeedbackPlaceholder.tsx
  - frontend/src/components/feed/FeedRow.tsx
  - frontend/src/components/feed/AddFeedDialog.tsx
  - frontend/src/components/layout/Sidebar.tsx
  - frontend/src/components/layout/Header.tsx
  - frontend/src/components/layout/AppShell.tsx
  - frontend/src/components/article/ArticleRow.tsx
  - frontend/src/components/article/ArticleReader.tsx
  - frontend/src/components/article/ArticleList.tsx
  - frontend/src/components/article/ScoreBadge.tsx
  - frontend/src/components/settings/WeightPresetStrip.tsx
  - frontend/src/components/ui/confirm-dialog.tsx
  - frontend/src/theme/colors.ts
autonomous: true
requirements:
  - SUCCESS_CRITERIA_2
  - SUCCESS_CRITERIA_5
  - SUCCESS_CRITERIA_6
  - SUCCESS_CRITERIA_7
  - SUCCESS_CRITERIA_8
  - SUCCESS_CRITERIA_9

must_haves:
  truths:
    - "All components consuming useCategories use the new mutation object API"
    - "All components consuming usePreferences/useOllamaConfig use updated return shapes"
    - "ConfirmDialog component replaces inline ungroup confirmation dialogs"
    - "useRenameState hook adopted by all 4 category row components + FeedRow"
    - "No hardcoded color values in any component — all use semantic tokens"
    - "ScoreBadge uses @/components/ui/tooltip wrapper (not raw Tooltip.Root)"
    - "No redundant Portal wrappers on Dialog components"
    - "Cross-file constants imported from lib/constants.ts"
    - "FeedRow uses Chakra Input instead of raw HTML input"
    - "Sidebar 'All Articles' row has correct colorPalette='accent'"
    - "react-icons use CSS inheritance via parent color prop, not var(--chakra-colors-*)"
    - "Application builds and runs without regressions"
  artifacts:
    - path: "frontend/src/components/ui/confirm-dialog.tsx"
      provides: "Reusable confirmation dialog"
      exports: ["ConfirmDialog"]
    - path: "frontend/src/theme/colors.ts"
      provides: "New semantic tokens (bg.code, fg.success, fg.warning)"
      contains: "bg.code"
  key_links:
    - from: "frontend/src/components/settings/CategoriesSection.tsx"
      to: "frontend/src/hooks/useCategories.ts"
      via: "destructured mutation objects"
      pattern: "\\.(mutate|mutateAsync)\\("
    - from: "frontend/src/components/settings/CategoryParentRow.tsx"
      to: "frontend/src/hooks/useRenameState.ts"
      via: "useRenameState hook"
      pattern: "useRenameState"
---

<objective>
Update all consuming components to work with the refactored hooks from Plan 02, extract shared components (ConfirmDialog), adopt useRenameState, fix all theme/token/Portal/Tooltip inconsistencies, and import shared constants.

Purpose: This plan makes the codebase consistent and eliminates all the surface-level issues identified in the evaluation. Every component that consumes the changed hooks must be updated, and all Chakra UI patterns must be standardized.

Output: All components updated for new hook APIs, ConfirmDialog created, semantic tokens added, all hardcoded colors replaced, all Portal/Tooltip inconsistencies fixed.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-frontend-codebase-evaluation-simplification/09-RESEARCH.md
@.planning/phases/09-frontend-codebase-evaluation-simplification/09-01-SUMMARY.md
@.planning/phases/09-frontend-codebase-evaluation-simplification/09-02-SUMMARY.md
@frontend/src/hooks/useCategories.ts
@frontend/src/hooks/usePreferences.ts
@frontend/src/hooks/useOllamaConfig.ts
@frontend/src/hooks/useRenameState.ts
@frontend/src/lib/queryKeys.ts
@frontend/src/lib/constants.ts
@frontend/src/theme/colors.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update all components for new hook return shapes and adopt useRenameState</name>
  <files>
    frontend/src/components/settings/CategoriesSection.tsx
    frontend/src/components/settings/CategoryParentRow.tsx
    frontend/src/components/settings/CategoryChildRow.tsx
    frontend/src/components/settings/CategoryUngroupedRow.tsx
    frontend/src/components/settings/CategoryTree.tsx
    frontend/src/components/settings/CategoryActionBar.tsx
    frontend/src/components/settings/CategoryContextMenu.tsx
    frontend/src/components/settings/DeleteCategoryDialog.tsx
    frontend/src/components/settings/MoveToGroupDialog.tsx
    frontend/src/components/settings/HiddenCategoriesSection.tsx
    frontend/src/components/settings/CreateCategoryPopover.tsx
    frontend/src/components/settings/InterestsSection.tsx
    frontend/src/components/settings/FeedsSection.tsx
    frontend/src/components/settings/ModelSelector.tsx
    frontend/src/components/settings/OllamaSection.tsx
    frontend/src/components/feed/FeedRow.tsx
    frontend/src/components/article/ArticleReader.tsx
  </files>
  <action>
**A. Update useCategories consumers:**

Read each file that calls `useCategories()` and update destructuring. The old wrapper function names are gone. The new API exposes mutation objects directly.

Migration map for useCategories consumers:
- `updateCategory(id, data)` -> stays the same (the helper is preserved)
- `createCategory(name, pid)` -> `createCategoryMutation.mutate({ displayName: name, parentId: pid })`
- `deleteCategory(id)` -> `deleteCategoryMutation.mutate(id)`
- `hideCategory(id)` -> `hideMutation.mutate(id)`
- `unhideCategory(id)` -> `unhideMutation.mutate(id)`
- `acknowledge(ids)` -> `acknowledgeMutation.mutate(ids)`
- `mergeCategories(srcId, tgtId)` -> `mergeMutation.mutate({ sourceId: srcId, targetId: tgtId })`
- `batchMove(ids, pid)` -> `batchMoveMutation.mutate({ categoryIds: ids, targetParentId: pid })`
- `batchHide(ids)` -> `batchHideMutation.mutate(ids)`
- `batchDelete(ids)` -> `batchDeleteMutation.mutate(ids)`
- `ungroupParent(id)` -> `ungroupParentMutation.mutate(id)`
- `createCategoryMutation` -> stays the same (was already exposed)

Use `npx tsc --noEmit` output to find every broken callsite. For each one, read the file, understand the context, and apply the appropriate transformation.

**Components known to consume useCategories (verify by grep):**
- CategoriesSection.tsx (main orchestrator — most callsites)
- CategoryTree.tsx (passes callbacks down)
- CategoryActionBar.tsx (batch operations)
- CategoryContextMenu.tsx (single-item operations)
- CategoryParentRow.tsx, CategoryChildRow.tsx, CategoryUngroupedRow.tsx (updateCategory, acknowledge)
- DeleteCategoryDialog.tsx (deleteCategory)
- MoveToGroupDialog.tsx (batchMove, createCategoryMutation)
- HiddenCategoriesSection.tsx (unhideCategory)
- CreateCategoryPopover.tsx (createCategory)
- ArticleReader.tsx (updateCategory for tag weight changes)

**IMPORTANT:** Many of these components receive callbacks via props from CategoriesSection, not from useCategories directly. Trace the call chain from CategoriesSection down through CategoryTree to the row components. The prop interface may need updating if CategoriesSection passes renamed functions.

**B. Update usePreferences consumers:**

`usePreferences()` now returns `{ preferences, isLoading, updatePreferencesMutation }` instead of `{ preferences, isLoading, updatePreferences, isUpdating }`.

Consumers need to change:
- `updatePreferences(data)` -> `updatePreferencesMutation.mutate(data)`
- `isUpdating` -> `updatePreferencesMutation.isPending`

Known consumers: InterestsSection.tsx, ModelSelector.tsx

**C. Update useOllamaConfig consumers:**

`savedConfig` alias is removed. Consumers using `savedConfig` should use `config` instead.

Known consumer: ModelSelector.tsx (check for `savedConfig` usage)

**D. Adopt useRenameState in category row components and FeedRow:**

In each of CategoryParentRow.tsx, CategoryChildRow.tsx, CategoryUngroupedRow.tsx, and FeedRow.tsx:

1. Add `import { useRenameState } from "@/hooks/useRenameState"`
2. Replace the inline rename state management (useState for isRenaming + renameValue, useRef for inputRef, useEffect for focus/select, handleRenameSubmit, handleRenameCancel) with a single `useRenameState` call
3. Pass the appropriate `currentName` (e.g., `category.display_name` or `feed.title`) and `onRename` callback
4. Update the JSX to use the hook's returned values

The key thing to verify is that each component's `onRename` callback matches the hook's expected `(newName: string) => void` signature. For category rows, this is typically `(name) => updateCategory(cat.id, { display_name: name })`. For FeedRow, it's `(name) => updateFeed.mutate({ id: feed.id, data: { title: name } })`.

Keep each component's visual rendering (JSX) exactly as-is. Only replace the state management logic.

Run `npx tsc --noEmit` after each major component group to catch issues early.
  </action>
  <verify>
Run `cd /Users/cstalhem/projects/rss-reader/frontend && npx tsc --noEmit` — should have no errors related to hook return shapes. All useCategories, usePreferences, useOllamaConfig consumers should compile. Grep for old wrapper function names in component files to ensure none remain: `grep -rn "deleteCategory\|hideCategory\|unhideCategory\|batchMove\|batchHide\|batchDelete\|ungroupParent\b" frontend/src/components/ --include="*.tsx" | grep -v "Mutation"` — should find no direct function calls (only mutation.mutate calls or prop declarations).
  </verify>
  <done>
All components compile with the new hook APIs. useRenameState adopted by all 4 category row components + FeedRow. usePreferences and useOllamaConfig consumers updated. No stale wrapper function calls remain.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ConfirmDialog, fix Tooltip/Portal/token/color/input inconsistencies, import shared constants</name>
  <files>
    frontend/src/components/ui/confirm-dialog.tsx
    frontend/src/components/settings/CategoriesSection.tsx
    frontend/src/components/settings/DeleteCategoryDialog.tsx
    frontend/src/components/settings/MoveToGroupDialog.tsx
    frontend/src/components/article/ScoreBadge.tsx
    frontend/src/components/article/ArticleReader.tsx
    frontend/src/components/article/ArticleRow.tsx
    frontend/src/components/article/ArticleList.tsx
    frontend/src/components/feed/FeedRow.tsx
    frontend/src/components/feed/AddFeedDialog.tsx
    frontend/src/components/settings/ModelSelector.tsx
    frontend/src/components/settings/ModelManagement.tsx
    frontend/src/components/settings/OllamaHealthBadge.tsx
    frontend/src/components/settings/OllamaPlaceholder.tsx
    frontend/src/components/settings/FeedbackPlaceholder.tsx
    frontend/src/components/settings/SettingsSidebar.tsx
    frontend/src/components/settings/FeedsSection.tsx
    frontend/src/components/settings/WeightPresetStrip.tsx
    frontend/src/components/layout/Sidebar.tsx
    frontend/src/components/layout/Header.tsx
    frontend/src/components/layout/AppShell.tsx
    frontend/src/theme/colors.ts
  </files>
  <action>
This task fixes all remaining surface-level inconsistencies. Work through each category:

**A. Create ConfirmDialog component:**

Create `frontend/src/components/ui/confirm-dialog.tsx`:

```typescript
"use client";

import { Dialog, Button } from "@chakra-ui/react";

interface ConfirmDialogProps {
  open: boolean;
  onOpenChange: (details: { open: boolean }) => void;
  title: string;
  body: React.ReactNode;
  confirmLabel?: string;
  confirmColorPalette?: string;
  onConfirm: () => void;
}

export function ConfirmDialog({
  open,
  onOpenChange,
  title,
  body,
  confirmLabel = "Confirm",
  confirmColorPalette = "red",
  onConfirm,
}: ConfirmDialogProps) {
  return (
    <Dialog.Root open={open} onOpenChange={onOpenChange}>
      <Dialog.Backdrop />
      <Dialog.Positioner>
        <Dialog.Content>
          <Dialog.Header>
            <Dialog.Title>{title}</Dialog.Title>
          </Dialog.Header>
          <Dialog.Body>{body}</Dialog.Body>
          <Dialog.Footer>
            <Dialog.CloseTrigger asChild>
              <Button variant="ghost">Cancel</Button>
            </Dialog.CloseTrigger>
            <Button colorPalette={confirmColorPalette} onClick={onConfirm}>
              {confirmLabel}
            </Button>
          </Dialog.Footer>
        </Dialog.Content>
      </Dialog.Positioner>
    </Dialog.Root>
  );
}
```

Then in CategoriesSection.tsx, replace the two inline ungroup confirmation dialogs (batch ungroup and parent ungroup) with `<ConfirmDialog>` instances. Read the current Dialog.Root blocks, extract their title/body/onConfirm, and replace with ConfirmDialog. Also remove the redundant `<Portal>` wrapping these dialogs.

**B. Remove redundant Portal from Dialog components:**

Per research, these 4 files have Dialog wrapped in redundant Portal:
- `CategoriesSection.tsx` (2 dialogs — being replaced with ConfirmDialog above, so Portal removal is automatic)
- `DeleteCategoryDialog.tsx` — remove the `<Portal>` wrapper around the Dialog
- `MoveToGroupDialog.tsx` — remove the `<Portal>` wrapper around the Dialog

Do NOT remove Portal from non-Dialog components (Select, Menu, Tooltip, Popover still need it).

**C. Fix Tooltip inconsistency in ScoreBadge:**

Replace raw `Tooltip.Root` / `Tooltip.Trigger` / `Tooltip.Positioner` / `Tooltip.Content` in ScoreBadge.tsx with the `@/components/ui/tooltip` wrapper component (the `Tooltip` from `@/components/ui/tooltip`). Match the API used by WeightPresetStrip.tsx.

**D. Add semantic tokens to theme/colors.ts:**

Add these semantic tokens:
- `bg.code` — for code block backgrounds in ArticleReader (dark: `oklch(13% 0.008 55)`, light: a suitable light gray)
- `fg.success` — for success indicators (dark: `{colors.green.400}`, light: `{colors.green.600}`)
- `fg.warning` — for warning indicators (dark: `{colors.orange.400}`, light: `{colors.orange.500}`)

Read the existing `colors.ts` to understand the token structure and follow the same pattern.

**E. Replace hardcoded colors with semantic tokens:**

| File | Change |
|------|--------|
| ArticleReader.tsx | Replace `bg: "oklch(13% 0.008 55)"` with `bg: "bg.code"` |
| AddFeedDialog.tsx | Replace `color="green.600"` with `color="fg.success"` |
| ModelSelector.tsx | Replace `color="orange.400"` / `color="var(--chakra-colors-orange-400)"` with `color="fg.warning"` |
| ModelManagement.tsx | Replace `color="red.400"` with `color="fg.error"` (use existing Chakra error token if available, or add `fg.error` token) |
| OllamaHealthBadge.tsx | Replace `bg="red.500"` and `bg="green.500"` with appropriate semantic tokens. For status dots, use `fg.error` and `fg.success` (as bg values, or create `status.error`/`status.success` tokens). Evaluate the simplest approach — if the health badge just needs two colors, using `fg.success` and `fg.error` as background is acceptable since these are small indicator dots. |

**F. Fix var(--chakra-colors-*) on react-icons (9 instances):**

For each instance, set `color` on the nearest Chakra parent element and remove the `color` prop from the icon:

| File | Fix |
|------|-----|
| ModelSelector.tsx | Set `color="fg.warning"` on parent Flex/Box instead of icon |
| OllamaSection.tsx | Set `color="fg.subtle"` on parent element |
| OllamaPlaceholder.tsx | Set `color="fg.subtle"` on parent |
| FeedbackPlaceholder.tsx | Set `color="fg.subtle"` on parent |
| CategoryParentRow.tsx | Set `color="fg.muted"` on parent for folder icon |
| FeedsSection.tsx | Set `color="fg.subtle"` on parent |
| SettingsSidebar.tsx | Set `color="accent.solid"` on parent Box for notification icon |
| CategoriesSection.tsx | Set `color="fg.subtle"` on parent Flex |

Read each file to understand the exact JSX structure before making changes. Some icons may already have a Chakra parent with `color` — in those cases just change the icon's `color` value to use the parent's inheritance.

**G. Extract ModelRow from ModelManagement.tsx:**

Read ModelManagement.tsx and identify the two near-identical model row render blocks (one for curated models with descriptions, one for non-curated models without). Extract a shared `ModelRow` component within the same file (no need for a separate file -- keep it co-located):

```typescript
interface ModelRowProps {
  model: { name: string; description?: string; /* other fields */ };
  isInstalled: boolean;
  onPull: (name: string) => void;
  onDelete: (name: string) => void;
  isPulling: boolean;
}

function ModelRow({ model, isInstalled, onPull, onDelete, isPulling }: ModelRowProps) {
  // Shared rendering logic
}
```

This should eliminate ~100 lines of duplicated JSX. If the two blocks are NOT actually duplicated (check first), skip this step and note it in the SUMMARY.

**I. Fix FeedRow raw HTML input:**

In FeedRow.tsx, replace the raw `<input>` element (the one with `style={{...}}`) with a Chakra `<Input>` component using appropriate semantic tokens and size props. Match the visual appearance of the existing input.

**J. Fix Sidebar "All Articles" colorPalette:**

In Sidebar.tsx, find the "All Articles" row and add `colorPalette="accent"` to the parent element that uses `colorPalette.subtle` or `colorPalette.solid` CSS tokens.

**K. Import shared constants in layout components:**

Replace hardcoded layout dimensions with imports from `lib/constants.ts`:
- Header.tsx: Replace `"64px"` height with `HEADER_HEIGHT`
- Sidebar.tsx: Replace `"48px"` / `"240px"` widths with `SIDEBAR_WIDTH_COLLAPSED` / `SIDEBAR_WIDTH_EXPANDED`, and `"64px"` top with `HEADER_HEIGHT`
- AppShell.tsx: Replace `"64px"` pt and `"48px"` / `"240px"` ml with imported constants

Import `HIGH_SCORE_THRESHOLD` in ArticleRow.tsx and ScoreBadge.tsx, replacing the magic number 15.

Import `NEW_COUNT_POLL_INTERVAL` in Header.tsx and SettingsSidebar.tsx (useCategories already imports it from Plan 02).

Replace inline query key strings in any component files that use them directly (e.g., SettingsSidebar.tsx may have a direct `useQuery` with inline key for sidebar download status).

**L. Name single-file magic numbers in component files:**

At top of SettingsSidebar.tsx: `const SIDEBAR_DOWNLOAD_POLL_INTERVAL = 3_000;`
At top of ArticleRow.tsx: `const MAX_VISIBLE_TAGS = 3;`
  </action>
  <verify>
Run `cd /Users/cstalhem/projects/rss-reader/frontend && npx tsc --noEmit` — expect zero errors.
Run `bun run lint` — expect clean.
Run `bun run build` — expect success.
Grep for remaining hardcoded colors: `grep -rn "green\.600\|orange\.400\|red\.400\|red\.500\|green\.500\|oklch" frontend/src/components/` — should find zero matches.
Grep for var(--chakra-colors): `grep -rn "var(--chakra-colors" frontend/src/components/` — should find zero matches.
Grep for raw Tooltip.Root: `grep -rn "Tooltip\.Root" frontend/src/components/` — should find zero matches (all using wrapper).
  </verify>
  <done>
ConfirmDialog created and adopted. All Dialog Portals cleaned up. ScoreBadge uses Tooltip wrapper. All hardcoded colors replaced with semantic tokens. All var(--chakra-colors-*) patterns fixed. FeedRow uses Chakra Input. Sidebar colorPalette fixed. All shared constants imported. All single-file constants named. Build passes.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `bun run lint` passes
3. `bun run build` succeeds
4. Zero hardcoded color values in components (grep verification)
5. Zero var(--chakra-colors-*) in components
6. Zero raw Tooltip.Root usage
7. Zero redundant Portal on Dialog components
8. Zero inline query key strings in component files
9. All magic numbers named (grep for bare number literals in known locations)
</verification>

<success_criteria>
- All components compile and work with the new hook APIs
- ConfirmDialog replaces inline confirmation dialogs
- useRenameState adopted in all rename implementations
- No hardcoded colors, no var(--chakra-colors-*), no raw Tooltip.Root, no redundant Dialog Portal
- All shared constants imported from lib/constants.ts
- FeedRow uses Chakra Input
- Build passes
</success_criteria>

<output>
After completion, create `.planning/phases/09-frontend-codebase-evaluation-simplification/09-03-SUMMARY.md`
</output>
