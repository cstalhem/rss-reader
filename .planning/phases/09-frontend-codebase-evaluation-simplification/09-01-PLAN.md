---
phase: 09-frontend-codebase-evaluation-simplification
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/lib/queryKeys.ts
  - frontend/src/lib/queryClient.ts
  - frontend/src/lib/constants.ts
  - frontend/src/lib/types.ts
  - frontend/src/lib/api.ts
  - frontend/src/lib/utils.ts
  - frontend/src/hooks/useModelPull.ts
autonomous: true
requirements:
  - SUCCESS_CRITERIA_1
  - SUCCESS_CRITERIA_3
  - SUCCESS_CRITERIA_8

must_haves:
  truths:
    - "All query keys are defined in a single factory object at lib/queryKeys.ts"
    - "MutationCache.onError provides global error toast for mutations without their own error handling"
    - "Cross-file constants (HEADER_HEIGHT, SIDEBAR_WIDTH_*, NEW_COUNT_POLL_INTERVAL, HIGH_SCORE_THRESHOLD) are defined in lib/constants.ts"
    - "ScoringStatus and DownloadStatus interfaces live in types.ts, not api.ts"
    - "parseSortOption function lives in utils.ts, not types.ts"
    - "API_BASE_URL is defined once in api.ts and imported by useModelPull.ts"
  artifacts:
    - path: "frontend/src/lib/queryKeys.ts"
      provides: "Centralized query key factory"
      contains: "export const queryKeys"
    - path: "frontend/src/lib/constants.ts"
      provides: "Cross-file named constants"
      contains: "HEADER_HEIGHT"
    - path: "frontend/src/lib/queryClient.ts"
      provides: "MutationCache with global error handler"
      contains: "MutationCache"
  key_links:
    - from: "frontend/src/lib/queryClient.ts"
      to: "@/components/ui/toaster"
      via: "toaster.create() in MutationCache.onError"
      pattern: "toaster\\.create"
    - from: "frontend/src/lib/queryKeys.ts"
      to: "all hook files"
      via: "import { queryKeys }"
      pattern: "queryKeys\\."
---

<objective>
Create the foundational infrastructure that Plans 02-04 depend on: query key factory, MutationCache global error handler, shared constants file, and file organization fixes.

Purpose: These are the building blocks that enable the hook refactors (Plan 02) and component cleanup (Plan 03). Query keys and MutationCache must exist before hooks can reference them. Constants must be centralized before components can import them.

Output: Four new/updated lib files (queryKeys.ts, constants.ts, queryClient.ts, utils.ts), cleaned api.ts and types.ts.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-frontend-codebase-evaluation-simplification/09-RESEARCH.md
@frontend/src/lib/queryClient.ts
@frontend/src/lib/api.ts
@frontend/src/lib/types.ts
@frontend/src/lib/utils.ts
@frontend/src/hooks/useModelPull.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create query key factory, MutationCache global error handler, and meta type registration</name>
  <files>
    frontend/src/lib/queryKeys.ts
    frontend/src/lib/queryClient.ts
  </files>
  <action>
**Create `frontend/src/lib/queryKeys.ts`:**

Define a plain object mapping with `as const` assertions for all query keys currently scattered across hooks. Use the pattern from 09-RESEARCH.md:

```typescript
export const queryKeys = {
  articles: {
    all: ["articles"] as const,
    list: (filters: Record<string, unknown>) => ["articles", filters] as const,
  },
  feeds: {
    all: ["feeds"] as const,
  },
  categories: {
    all: ["categories"] as const,
    newCount: ["categories", "new-count"] as const,
  },
  preferences: {
    all: ["preferences"] as const,
  },
  scoringStatus: {
    all: ["scoring-status"] as const,
  },
  ollama: {
    health: ["ollama-health"] as const,
    models: ["ollama-models"] as const,
    config: ["ollama-config"] as const,
    prompts: ["ollama-prompts"] as const,
    downloadStatus: ["download-status"] as const,
    sidebarDownloadStatus: ["sidebar-download-status"] as const,
  },
};
```

Verify all keys by grepping the codebase for `queryKey:` to ensure every unique key string is covered.

**Update `frontend/src/lib/queryClient.ts`:**

1. Add TypeScript module augmentation for `@tanstack/react-query` to register `mutationMeta` types:

```typescript
import "@tanstack/react-query";

declare module "@tanstack/react-query" {
  interface Register {
    mutationMeta: {
      errorTitle?: string;
      handlesOwnErrors?: boolean;
    };
  }
}
```

2. Add `MutationCache` import and configure global error handler:

```typescript
import { QueryClient, MutationCache } from "@tanstack/react-query";
import { toaster } from "@/components/ui/toaster";

export const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      staleTime: 30 * 1000,
      refetchOnWindowFocus: true,
    },
  },
  mutationCache: new MutationCache({
    onError: (error, _variables, _context, mutation) => {
      if (mutation.options.meta?.handlesOwnErrors) return;

      const title = (mutation.options.meta?.errorTitle as string) ?? "Operation failed";
      toaster.create({
        title,
        description: error instanceof Error ? error.message : "An unexpected error occurred",
        type: "error",
      });
    },
  }),
});
```

Keep the existing `defaultOptions` exactly as they are. Only add the `mutationCache` property.

**Important:** This task only creates the infrastructure. Plan 02 will update all hooks to use `queryKeys.*` references and add `meta` tags. Do NOT update any hooks in this task.
  </action>
  <verify>
Run `cd /Users/cstalhem/projects/rss-reader/frontend && npx tsc --noEmit` to confirm no type errors. Verify the new files exist and export the expected symbols. The existing code should still compile because no imports have changed yet.
  </verify>
  <done>
`queryKeys.ts` exports a `queryKeys` object covering all query key strings in the codebase. `queryClient.ts` has a `MutationCache.onError` handler that shows error toasts for mutations without `meta.handlesOwnErrors`. TypeScript meta types are registered. No existing code is broken.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create shared constants, fix file organization misplacements, and deduplicate API_BASE_URL</name>
  <files>
    frontend/src/lib/constants.ts
    frontend/src/lib/types.ts
    frontend/src/lib/api.ts
    frontend/src/lib/utils.ts
    frontend/src/hooks/useModelPull.ts
  </files>
  <action>
**Create `frontend/src/lib/constants.ts`:**

Add cross-file constants (used in 2+ files):

```typescript
/** Height of the fixed header bar */
export const HEADER_HEIGHT = "64px";
/** Sidebar width when collapsed (icons only) */
export const SIDEBAR_WIDTH_COLLAPSED = "48px";
/** Sidebar width when expanded (full navigation) */
export const SIDEBAR_WIDTH_EXPANDED = "240px";
/** Polling interval for new category count badge (used in Header, SettingsSidebar, useCategories) */
export const NEW_COUNT_POLL_INTERVAL = 30_000;
/** Score threshold for accent-colored score badge */
export const HIGH_SCORE_THRESHOLD = 15;
```

Do NOT add single-file constants here -- those stay co-located in their files (Plan 02/03 will name them at top of file).

**Move types from `api.ts` to `types.ts`:**

Move the `ScoringStatus` interface (lines 295-304) and `DownloadStatus` interface (lines 389-395) from `api.ts` to `types.ts`. Update imports:
- In `api.ts`: add `import { ScoringStatus, DownloadStatus } from "./types"` (the functions `fetchScoringStatus` and `fetchDownloadStatus` that use these types stay in `api.ts`)
- In `api.ts`: remove the `export interface ScoringStatus` and `export interface DownloadStatus` blocks
- In `types.ts`: add both interfaces at the bottom
- Also move `FetchArticlesParams` interface to types.ts (it's a data contract, not an API function). Update the import in api.ts.

Check all existing imports of `ScoringStatus` and `DownloadStatus` from `"@/lib/api"` and update them to import from `"@/lib/types"` instead. Grep for `from.*api.*import.*ScoringStatus` and `from.*api.*import.*DownloadStatus` to find all consumers.

**Move `parseSortOption` from `types.ts` to `utils.ts`:**

Cut the `parseSortOption` function from `types.ts` and add it to `utils.ts`. It's a runtime function, not a type. Update all imports of `parseSortOption` to come from `"@/lib/utils"` instead of `"@/lib/types"`. Keep the `SortOption` type in `types.ts` (it IS a type). In `utils.ts`, import `SortOption` from `"./types"`.

**Deduplicate `API_BASE_URL` in `useModelPull.ts`:**

In `useModelPull.ts`, remove the local `API_BASE_URL` definition (lines 7-8) and add `import { API_BASE_URL } from "@/lib/api"`. This requires exporting `API_BASE_URL` from `api.ts` -- add the `export` keyword to the existing `const API_BASE_URL` declaration in `api.ts` (change `const API_BASE_URL` to `export const API_BASE_URL`).
  </action>
  <verify>
Run `cd /Users/cstalhem/projects/rss-reader/frontend && npx tsc --noEmit` to confirm no type errors. Grep for `ScoringStatus` and `DownloadStatus` imports to verify they all point to `"@/lib/types"`. Grep for `parseSortOption` imports to verify they all point to `"@/lib/utils"`. Grep for `API_BASE_URL` to verify only one definition exists (in `api.ts`).
  </verify>
  <done>
`constants.ts` exports 5 cross-file constants. `ScoringStatus` and `DownloadStatus` interfaces are in `types.ts`. `parseSortOption` is in `utils.ts`. `API_BASE_URL` has a single definition in `api.ts` exported and imported by `useModelPull.ts`. All imports updated. No type errors.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `bun run lint` passes
3. New files exist: `lib/queryKeys.ts`, `lib/constants.ts`
4. No duplicate `API_BASE_URL` definitions
5. `ScoringStatus`, `DownloadStatus` not exported from `api.ts` (only from `types.ts`)
6. `parseSortOption` not in `types.ts` (only in `utils.ts`)
7. App still builds: `bun run build`
</verification>

<success_criteria>
- Query key factory exists and covers all keys in the codebase
- MutationCache global error handler is configured with meta type registration
- Cross-file constants are centralized
- File organization misplacements are fixed
- No type errors, lint errors, or build failures
</success_criteria>

<output>
After completion, create `.planning/phases/09-frontend-codebase-evaluation-simplification/09-01-SUMMARY.md`
</output>
