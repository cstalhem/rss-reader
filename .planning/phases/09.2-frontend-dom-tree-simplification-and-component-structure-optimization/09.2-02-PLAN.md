---
phase: 09.2-frontend-dom-tree-simplification-and-component-structure-optimization
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/components/settings/CategoryRowShell.tsx
  - frontend/src/components/settings/CategoryParentRow.tsx
  - frontend/src/components/settings/CategoryChildRow.tsx
  - frontend/src/components/settings/CategoryUngroupedRow.tsx
  - frontend/src/components/settings/WeightPresetStrip.tsx
autonomous: true
requirements: []
must_haves:
  truths:
    - "Each category row type renders exactly ONE WeightPresetStrip (not two)"
    - "Desktop shows icon-only weight buttons with hover-expand; mobile shows icon+text buttons below the row"
    - "Tooltips on weight buttons are active at md+ and disabled below md (no extra DOM nodes on mobile)"
    - "Ungrouped rows render WeightPresetStrip at full opacity (isOverridden undefined, not false)"
    - "Rename, context menu, and hover state work identically to before"
    - "Category tree visual appearance is unchanged (connector lines, badges, spacing)"
    - "All three row types use CategoryRowShell for shared wrapper/rename/strip/context-menu layout"
  artifacts:
    - path: "frontend/src/components/settings/CategoryRowShell.tsx"
      provides: "Shared layout component for all category row types"
    - path: "frontend/src/components/settings/WeightPresetStrip.tsx"
      provides: "Single responsive strip with breakpoint-disabled tooltips"
  key_links:
    - from: "CategoryParentRow.tsx"
      to: "CategoryRowShell.tsx"
      via: "import and render"
      pattern: "CategoryRowShell"
    - from: "CategoryChildRow.tsx"
      to: "CategoryRowShell.tsx"
      via: "import and render"
      pattern: "CategoryRowShell"
    - from: "CategoryUngroupedRow.tsx"
      to: "CategoryRowShell.tsx"
      via: "import and render"
      pattern: "CategoryRowShell"
    - from: "WeightPresetStrip.tsx"
      to: "@chakra-ui/react useBreakpointValue"
      via: "breakpoint-disabled tooltip"
      pattern: "useBreakpointValue"
---

<objective>
Extract CategoryRowShell shared component and deduplicate WeightPresetStrip rendering across all category row types.

Purpose: Each of the three category row components (Parent, Child, Ungrouped) currently renders TWO WeightPresetStrip instances (desktop + mobile) and duplicates ~80% of their wrapper/rename/context-menu structure. Extracting a shared shell and deduplicating the strip eliminates ~13 DOM nodes per category row (one strip per row instead of two) and consolidates the shared layout code. With ~50 categories, this saves ~650 DOM nodes.

Output: CategoryRowShell component used by all three row types. Single WeightPresetStrip per row with breakpoint-disabled tooltips.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09.2-frontend-dom-tree-simplification-and-component-structure-optimization/09.2-CONTEXT.md
@.planning/phases/09.2-frontend-dom-tree-simplification-and-component-structure-optimization/09.2-RESEARCH.md
@frontend/src/components/settings/CategoryParentRow.tsx
@frontend/src/components/settings/CategoryChildRow.tsx
@frontend/src/components/settings/CategoryUngroupedRow.tsx
@frontend/src/components/settings/WeightPresetStrip.tsx
@frontend/src/components/settings/CategoryContextMenu.tsx
@frontend/src/hooks/useRenameState.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add breakpoint-disabled tooltips to WeightPresetStrip</name>
  <files>frontend/src/components/settings/WeightPresetStrip.tsx</files>
  <action>
    Update WeightPresetStrip to use breakpoint-aware tooltips:

    1. Import `useBreakpointValue` from `@chakra-ui/react`.
    2. Inside the component, add: `const tooltipDisabled = useBreakpointValue({ base: true, md: false });`
       - `true` at base (mobile) = tooltips disabled (no extra DOM wrapper nodes).
       - `false` at md+ (desktop) = tooltips active for icon discovery.
    3. Pass `disabled={tooltipDisabled}` to each `<Tooltip>` wrapping the weight buttons.
    4. The existing `<Box as="span" display={{ base: "inline", md: "none" }}>{option.label}</Box>` already provides text labels on mobile, so tooltips are redundant there.
    5. Keep `aria-label={option.label}` on each Button for accessibility in all cases (add if missing).

    The strip's internal responsive behavior (maxW collapse/expand on desktop, always visible on mobile) stays the same. This change only affects tooltip DOM overhead.
  </action>
  <verify>
    Run `bun run build` from `frontend/` -- no errors. Confirm `useBreakpointValue` import is present:
    ```
    grep "useBreakpointValue" frontend/src/components/settings/WeightPresetStrip.tsx
    ```
  </verify>
  <done>WeightPresetStrip tooltips disabled on mobile (no extra DOM nodes), active on desktop. aria-label on all buttons for accessibility.</done>
</task>

<task type="auto">
  <name>Task 2: Extract CategoryRowShell and refactor all three row types</name>
  <files>
    frontend/src/components/settings/CategoryRowShell.tsx
    frontend/src/components/settings/CategoryParentRow.tsx
    frontend/src/components/settings/CategoryChildRow.tsx
    frontend/src/components/settings/CategoryUngroupedRow.tsx
  </files>
  <action>
    Extract shared layout into CategoryRowShell. The shell handles the COMMON parts; each row type becomes a thin wrapper supplying unique elements.

    **1. Create `CategoryRowShell.tsx`:**

    Interface (keep under ~10 props -- if it grows beyond, reassess):
    ```typescript
    interface CategoryRowShellProps {
      children: React.ReactNode;       // Left-side unique content: chevron+folder (parent), checkbox (child/ungrouped)
      category: Category;              // For rename state
      weight: string;                  // Current weight value
      onWeightChange: (weight: string) => void;
      onRename: (newName: string) => void;
      renderContextMenu: (startRename: () => void) => React.ReactNode;
      isOverridden?: boolean;          // For WeightPresetStrip opacity + reset button
      onReset?: () => void;            // Reset to parent weight
      badge?: React.ReactNode;         // "New" badge, "N new" badge (between name and spacer)
      trailingContent?: React.ReactNode; // Child count text (for parent rows)
      onHoverChange?: (isHovered: boolean) => void; // For badge X animation on child/ungrouped
      py?: number;                     // Vertical padding override (parent=3, child/ungrouped=2)
    }
    ```

    The shell owns `useRenameState` internally. The `renderContextMenu` render prop exposes `startRename` so each row type can wire it into its `<CategoryContextMenu>` without the shell exposing full rename state.

    Shell structure:
    - Outer `Box` with responsive border/radius, bg="bg.subtle", _hover={{ bg: "bg.muted" }}, transition, optional onMouseEnter/Leave calling `onHoverChange`.
    - Inner `Flex role="group" alignItems="center" gap={2} flexWrap={{ base: "wrap", sm: "nowrap" }} py={py ?? 2} px={3}`:
      - `{children}` (left-side unique content)
      - Rename input (from `useRenameState`) OR name Text with the category's `display_name`
      - `{trailingContent}` (e.g., child count)
      - `{badge}` (New badge)
      - `Box flex={1}` spacer
      - Single `WeightPresetStrip` with `width={{ base: "100%", sm: "auto" }} order={{ base: 99, sm: 0 }}` -- wraps below on mobile, stays inline on desktop
      - Context menu from `renderContextMenu(startRename)`, hidden during rename
    - The `flexWrap` + `order` + `width` approach gives one strip instance that repositions via CSS. The strip's own responsive behavior (maxW collapse on desktop, all-visible on mobile) is unchanged.

    Export the shell unwrapped (not memo'd) -- the thin row wrappers control their own memoization.

    **2. Refactor CategoryParentRow:**
    - Import CategoryRowShell.
    - Remove duplicated wrapper Box, Flex, rename logic, WeightPresetStrip renders.
    - Pass unique content as `children`: chevron icon (with rotate transform and toggle click) + folder icon.
    - Pass `trailingContent`: child count Text.
    - Pass `badge`: the "N new" Badge (when collapsed and newChildCount > 0).
    - Pass `renderContextMenu`: function receiving `startRename` and returning `<CategoryContextMenu type="parent" onRename={startRename} ... />`.
    - Pass `py={3}` (parent rows are taller than child/ungrouped).

    **3. Refactor CategoryChildRow:**
    - Import CategoryRowShell.
    - Remove duplicated wrapper, rename logic, strip renders.
    - Pass unique content as `children`: checkbox.
    - Pass `isOverridden`, `onReset` for the strip.
    - Pass `badge`: "New" badge with X icon and hover animation (needs `onHoverChange`).
    - Pass `renderContextMenu`.

    **4. Refactor CategoryUngroupedRow:**
    - Import CategoryRowShell.
    - Same pattern as child row but without `onReset`.
    - **Bug fix:** Do NOT pass `isOverridden` (let it be `undefined`). The current code passes `isOverridden={false}` which causes 0.5 opacity on the strip, but ungrouped categories are root-level with no parent to inherit from. Per the WeightPresetStrip comment (`true` = explicit override, `false` = inherited, `undefined` = root), ungrouped rows should omit `isOverridden` so the strip renders at full opacity.

    Verify all three rows maintain their existing `React.memo` wrapping.
  </action>
  <verify>
    Run `bun run build` from `frontend/` -- no errors. Run `bun run lint` -- no lint errors.
    Verify CategoryRowShell is imported by all three row types:
    ```
    grep "CategoryRowShell" frontend/src/components/settings/CategoryParentRow.tsx frontend/src/components/settings/CategoryChildRow.tsx frontend/src/components/settings/CategoryUngroupedRow.tsx
    ```
    Verify only ONE WeightPresetStrip import per row file:
    ```
    grep -c "WeightPresetStrip" frontend/src/components/settings/CategoryParentRow.tsx
    grep -c "WeightPresetStrip" frontend/src/components/settings/CategoryChildRow.tsx
    grep -c "WeightPresetStrip" frontend/src/components/settings/CategoryUngroupedRow.tsx
    ```
    Each should return 0 (strip is imported only in the shell, not in the row files).
  </verify>
  <done>CategoryRowShell extracts shared wrapper/rename/strip/context-menu layout. All three row types are thin wrappers passing unique children. Each row renders exactly ONE WeightPresetStrip. Build and lint pass.</done>
</task>

</tasks>

<verification>
1. `bun run build` passes with zero errors
2. `bun run lint` passes
3. Each category row renders exactly ONE WeightPresetStrip (not two)
4. WeightPresetStrip tooltips disabled on mobile, active on desktop
5. CategoryRowShell used by all three row types
6. Visual appearance unchanged: badges, rename, context menu, connector lines all work
7. React.memo preserved on all row components
</verification>

<success_criteria>
CategoryRowShell extracts shared layout. WeightPresetStrip rendered once per row with breakpoint-disabled tooltips. All three row types are thin wrappers. ~650 DOM nodes saved from strip deduplication. Build passes.
</success_criteria>

<output>
After completion, create `.planning/phases/09.2-frontend-dom-tree-simplification-and-component-structure-optimization/09.2-02-SUMMARY.md`
</output>
