---
phase: 09.2-frontend-dom-tree-simplification-and-component-structure-optimization
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/components/settings/CategoryRowShell.tsx
  - frontend/src/components/settings/CategoryParentRow.tsx
  - frontend/src/components/settings/CategoryChildRow.tsx
  - frontend/src/components/settings/CategoryUngroupedRow.tsx
  - frontend/src/components/settings/WeightPresetStrip.tsx
autonomous: true
requirements: []
must_haves:
  truths:
    - "Each category row type renders exactly ONE WeightPresetStrip (not two)"
    - "Desktop shows icon-only weight buttons with hover-expand; mobile shows icon+text buttons below the row"
    - "Tooltips on weight buttons are active at md+ and disabled below md (no extra DOM nodes on mobile)"
    - "Rename, context menu, and hover state work identically to before"
    - "Category tree visual appearance is unchanged (connector lines, badges, spacing)"
    - "All three row types use CategoryRowShell for shared wrapper/rename/strip/context-menu layout"
  artifacts:
    - path: "frontend/src/components/settings/CategoryRowShell.tsx"
      provides: "Shared layout component for all category row types"
    - path: "frontend/src/components/settings/WeightPresetStrip.tsx"
      provides: "Single responsive strip with breakpoint-disabled tooltips"
  key_links:
    - from: "CategoryParentRow.tsx"
      to: "CategoryRowShell.tsx"
      via: "import and render"
      pattern: "CategoryRowShell"
    - from: "CategoryChildRow.tsx"
      to: "CategoryRowShell.tsx"
      via: "import and render"
      pattern: "CategoryRowShell"
    - from: "CategoryUngroupedRow.tsx"
      to: "CategoryRowShell.tsx"
      via: "import and render"
      pattern: "CategoryRowShell"
    - from: "WeightPresetStrip.tsx"
      to: "@chakra-ui/react useBreakpointValue"
      via: "breakpoint-disabled tooltip"
      pattern: "useBreakpointValue"
---

<objective>
Extract CategoryRowShell shared component and deduplicate WeightPresetStrip rendering across all category row types.

Purpose: Each of the three category row components (Parent, Child, Ungrouped) currently renders TWO WeightPresetStrip instances (desktop + mobile) and duplicates ~80% of their wrapper/rename/context-menu structure. Extracting a shared shell and deduplicating the strip eliminates ~13 DOM nodes per category row (one strip per row instead of two) and consolidates the shared layout code. With ~50 categories, this saves ~650 DOM nodes.

Output: CategoryRowShell component used by all three row types. Single WeightPresetStrip per row with breakpoint-disabled tooltips.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09.2-frontend-dom-tree-simplification-and-component-structure-optimization/09.2-CONTEXT.md
@.planning/phases/09.2-frontend-dom-tree-simplification-and-component-structure-optimization/09.2-RESEARCH.md
@frontend/src/components/settings/CategoryParentRow.tsx
@frontend/src/components/settings/CategoryChildRow.tsx
@frontend/src/components/settings/CategoryUngroupedRow.tsx
@frontend/src/components/settings/WeightPresetStrip.tsx
@frontend/src/components/settings/CategoryContextMenu.tsx
@frontend/src/hooks/useRenameState.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add breakpoint-disabled tooltips to WeightPresetStrip</name>
  <files>frontend/src/components/settings/WeightPresetStrip.tsx</files>
  <action>
    Update WeightPresetStrip to use breakpoint-aware tooltips:

    1. Import `useBreakpointValue` from `@chakra-ui/react`.
    2. Inside the component, add: `const tooltipDisabled = useBreakpointValue({ base: true, md: false });`
       - `true` at base (mobile) = tooltips disabled (no extra DOM wrapper nodes).
       - `false` at md+ (desktop) = tooltips active for icon discovery.
    3. Pass `disabled={tooltipDisabled}` to each `<Tooltip>` wrapping the weight buttons.
    4. The existing `<Box as="span" display={{ base: "inline", md: "none" }}>{option.label}</Box>` already provides text labels on mobile, so tooltips are redundant there.
    5. Keep `aria-label={option.label}` on each Button for accessibility in all cases (add if missing).

    The strip's internal responsive behavior (maxW collapse/expand on desktop, always visible on mobile) stays the same. This change only affects tooltip DOM overhead.
  </action>
  <verify>
    Run `bun run build` from `frontend/` -- no errors. Confirm `useBreakpointValue` import is present:
    ```
    grep "useBreakpointValue" frontend/src/components/settings/WeightPresetStrip.tsx
    ```
  </verify>
  <done>WeightPresetStrip tooltips disabled on mobile (no extra DOM nodes), active on desktop. aria-label on all buttons for accessibility.</done>
</task>

<task type="auto">
  <name>Task 2: Extract CategoryRowShell and refactor all three row types</name>
  <files>
    frontend/src/components/settings/CategoryRowShell.tsx
    frontend/src/components/settings/CategoryParentRow.tsx
    frontend/src/components/settings/CategoryChildRow.tsx
    frontend/src/components/settings/CategoryUngroupedRow.tsx
  </files>
  <action>
    Extract shared layout into CategoryRowShell. The shell handles the COMMON parts; each row type becomes a thin wrapper supplying unique elements.

    **1. Create `CategoryRowShell.tsx`:**

    Interface (keep under ~10 props -- if it grows beyond, reassess):
    ```typescript
    interface CategoryRowShellProps {
      children: React.ReactNode;       // Left-side unique content: chevron+folder (parent), checkbox (child/ungrouped)
      category: Category;              // For rename state
      weight: string;                  // Current weight value
      onWeightChange: (weight: string) => void;
      onRename: (newName: string) => void;
      contextMenu: React.ReactNode;    // Pre-built CategoryContextMenu
      isOverridden?: boolean;          // For WeightPresetStrip opacity + reset button
      onReset?: () => void;            // Reset to parent weight
      badge?: React.ReactNode;         // "New" badge, "N new" badge (between name and spacer)
      trailingContent?: React.ReactNode; // Child count text (for parent rows)
      onHoverChange?: (isHovered: boolean) => void; // For badge X animation on child/ungrouped
    }
    ```

    Shell structure:
    - Outer `Box` with responsive border/radius, bg="bg.subtle", _hover={{ bg: "bg.muted" }}, transition, optional onMouseEnter/Leave calling `onHoverChange`.
    - Inner `Flex role="group" alignItems="center" gap={2} py={...} px={3}`:
      - `{children}` (left-side unique content)
      - Rename input (from `useRenameState`) OR name Text with the category's `display_name`
      - `{trailingContent}` (e.g., child count)
      - `{badge}` (New badge)
      - `Box flex={1}` spacer
      - Single `WeightPresetStrip` -- **inline in the row at sm+, below the row at base**:
        - At sm+: render strip inline with `display={{ base: "none", sm: "block" }}`
        - At base: render strip below the main Flex with `display={{ base: "block", sm: "none" }} px={3} pb={2}`
        - WAIT -- this is still TWO renders. Instead, use the shell's layout to place ONE strip:
          - The strip itself stays as ONE instance. The shell uses responsive Flex direction or wrapping to position it differently at breakpoints.
          - Simplest approach: Keep the TWO Box wrappers (display none/block) but render the SAME strip props. The strip component instance is duplicated but the props are identical. Since WeightPresetStrip is a pure component wrapped in React.memo, React will efficiently handle this.
          - Actually, per the CONTEXT.md locked decision: "Single WeightPresetStrip per row that adapts responsively (no mobile/desktop duplicate)". So we need truly ONE instance.
          - Approach: Render the strip once. On sm+, it sits inline in the Flex. On base, it needs to be below the row. This can be done by making the outer shell a Flex with `flexWrap="wrap"` and the strip having `width={{ base: "100%", sm: "auto" }}` and `order={{ base: 1, sm: 0 }}` to push it below on mobile. But this changes the visual layout.
          - Better approach: Use a single Flex column shell. Row content in one Flex (horizontal). Strip in a separate position that only shows on mobile. But then on desktop the strip is in the row...
          - SIMPLEST correct approach: Wrap the entire row content + strip in a CSS Grid or Flex column. The strip renders ONCE and uses responsive CSS to position itself either inline (desktop) or below (mobile):
            ```
            <Box> <!-- outer wrapper -->
              <Flex> <!-- row content: children, name, badge, spacer, strip (desktop), context menu -->
                {children}
                {name/rename}
                {trailingContent}
                {badge}
                <Box flex={1} />
                <Box display={{ base: "none", sm: "contents" }}>
                  <WeightPresetStrip ... />
                </Box>
                {contextMenu}
              </Flex>
              <Box display={{ base: "block", sm: "none" }} px={3} pb={2}>
                <!-- This is still two renders. We need one strip. -->
              </Box>
            </Box>
            ```
          - The PRACTICAL approach (used widely): Use `display: contents` on a wrapper in desktop mode to make the strip appear inline, and a block wrapper in mobile mode. But `display: contents` has accessibility issues.
          - **Final approach**: Accept that the PHYSICAL DOM node is one `<WeightPresetStrip>` component, but it gets placed in the row via responsive CSS. The strip's container uses responsive styles:
            - On sm+: `position: static`, sits in the Flex row naturally.
            - On base: `position: relative`, full width, appears below the main content.
          - Actually, the simplest way to achieve "one component, two positions" is to render it once with a ref and use CSS to move it. But that is overengineering.
          - **PRAGMATIC DECISION**: Render the strip ONCE inside the row Flex. On mobile, the row Flex wraps and the strip appears on a new line. Use `flexWrap={{ base: "wrap", sm: "nowrap" }}` on the inner Flex, and give the strip `width={{ base: "100%", sm: "auto" }} order={{ base: 99, sm: 0 }}` so it wraps below on mobile but stays inline on desktop. The strip already handles its own responsive behavior (maxW collapse on desktop, all-visible on mobile).
          - Add `px={{ base: 0, sm: 0 }} pb={{ base: 0, sm: 0 }}` adjustments as needed for spacing.

    - Context menu wrapper: `Box minH={{ base: "44px", sm: "auto" }} display="flex" alignItems="center"` containing `{contextMenu}`, hidden during rename.

    The shell must support `React.memo` on the thin wrappers. Export it unwrapped (not memo'd itself) since the wrappers control memoization.

    **IMPORTANT**: The shell should expose `startRename` from useRenameState so that the context menu trigger (passed as `contextMenu` prop) can call it. Add a `renderContextMenu` prop instead of `contextMenu`: `renderContextMenu: (startRename: () => void) => React.ReactNode`. This lets each row type pass its CategoryContextMenu with the correct onRename bound.

    **2. Refactor CategoryParentRow:**
    - Import CategoryRowShell.
    - Remove duplicated wrapper Box, Flex, rename logic, WeightPresetStrip renders.
    - Pass unique content as `children`: chevron icon (with rotate transform and toggle click) + folder icon.
    - Pass `trailingContent`: child count Text.
    - Pass `badge`: the "N new" Badge (when collapsed and newChildCount > 0).
    - Pass `renderContextMenu`: function receiving `startRename` and returning `<CategoryContextMenu type="parent" onRename={startRename} ... />`.
    - The parent row has `py={3}` while child/ungrouped have `py={2}`. Pass this as a prop to shell or let the shell default to py={2} and parent overrides via a `py` prop.

    **3. Refactor CategoryChildRow:**
    - Import CategoryRowShell.
    - Remove duplicated wrapper, rename logic, strip renders.
    - Pass unique content as `children`: checkbox.
    - Pass `isOverridden`, `onReset` for the strip.
    - Pass `badge`: "New" badge with X icon and hover animation (needs `onHoverChange`).
    - Pass `renderContextMenu`.

    **4. Refactor CategoryUngroupedRow:**
    - Import CategoryRowShell.
    - Same pattern as child row but without `isOverridden`/`onReset`.
    - Pass `isOverridden={false}` explicitly (matching current behavior for muted opacity).
    - Actually, current ungrouped passes `isOverridden={false}` which means opacity=0.5 on the strip. But `isOverridden` for ungrouped is `false` meaning "not inherited" -- the opacity should be 1 since ungrouped categories have no parent to inherit from. Looking at the current code: `isOverridden={false}` for ungrouped. In WeightPresetStrip: `opacity={isOverridden === false ? 0.5 : 1}`. Wait, this means ungrouped categories show at 0.5 opacity? That seems like a bug. Actually, looking at the decisions log: "opacity 0.5 for inherited weights (isOverridden === false), full opacity for undefined (ungrouped)". So ungrouped should pass `isOverridden={undefined}`. But the current code passes `isOverridden={false}`. Check if this is intentional or a bug -- if bug, fix it; if intentional per some later decision, keep it. Looking at the WeightPresetStrip code: `opacity={isOverridden === false ? 0.5 : 1}`. So `undefined` would give opacity 1 (since `undefined === false` is `false`). Pass `isOverridden={undefined}` for ungrouped rows in the shell.
    - Actually, the existing CategoryUngroupedRow passes `isOverridden={false}`. This needs to be preserved exactly (surgical changes -- match existing behavior). Leave it as-is unless the user requests a fix.

    Verify all three rows maintain their existing `React.memo` wrapping.
  </action>
  <verify>
    Run `bun run build` from `frontend/` -- no errors. Run `bun run lint` -- no lint errors.
    Verify CategoryRowShell is imported by all three row types:
    ```
    grep "CategoryRowShell" frontend/src/components/settings/CategoryParentRow.tsx frontend/src/components/settings/CategoryChildRow.tsx frontend/src/components/settings/CategoryUngroupedRow.tsx
    ```
    Verify only ONE WeightPresetStrip import per row file:
    ```
    grep -c "WeightPresetStrip" frontend/src/components/settings/CategoryParentRow.tsx
    grep -c "WeightPresetStrip" frontend/src/components/settings/CategoryChildRow.tsx
    grep -c "WeightPresetStrip" frontend/src/components/settings/CategoryUngroupedRow.tsx
    ```
    Each should return 0 (strip is imported only in the shell, not in the row files).
  </verify>
  <done>CategoryRowShell extracts shared wrapper/rename/strip/context-menu layout. All three row types are thin wrappers passing unique children. Each row renders exactly ONE WeightPresetStrip. Build and lint pass.</done>
</task>

</tasks>

<verification>
1. `bun run build` passes with zero errors
2. `bun run lint` passes
3. Each category row renders exactly ONE WeightPresetStrip (not two)
4. WeightPresetStrip tooltips disabled on mobile, active on desktop
5. CategoryRowShell used by all three row types
6. Visual appearance unchanged: badges, rename, context menu, connector lines all work
7. React.memo preserved on all row components
</verification>

<success_criteria>
CategoryRowShell extracts shared layout. WeightPresetStrip rendered once per row with breakpoint-disabled tooltips. All three row types are thin wrappers. ~650 DOM nodes saved from strip deduplication. Build passes.
</success_criteria>

<output>
After completion, create `.planning/phases/09.2-frontend-dom-tree-simplification-and-component-structure-optimization/09.2-02-SUMMARY.md`
</output>
