---
phase: 08.3-category-group-management-redesign
plan: 03
type: execute
wave: 2
depends_on: [08.3-01, 08.3-02]
files_modified:
  - frontend/src/components/settings/CategoryActionBar.tsx
  - frontend/src/components/settings/CategoryContextMenu.tsx
  - frontend/src/components/settings/CategoriesSection.tsx
  - frontend/src/components/settings/CategoryTree.tsx
  - frontend/src/components/settings/CategoryParentRow.tsx
  - frontend/src/components/settings/CategoryChildRow.tsx
  - frontend/src/lib/api.ts
  - frontend/src/hooks/useCategories.ts
autonomous: true
requirements: [CATGRP-02, CATGRP-03]

must_haves:
  truths:
    - "Desktop shows a static action header at top of categories section with selection count and action buttons"
    - "Mobile shows a floating action bar (Chakra ActionBar) that slides up when items are selected"
    - "Action buttons: Move to group, Ungroup, Hide, Delete — all disabled when nothing selected"
    - "Every row has a three-dot context menu with row-type-specific actions"
    - "Parent context menu: Ungroup, Edit name, Hide, Delete"
    - "Child context menu: Reset weight (disabled if same as parent), Edit name, Hide, Delete"
    - "Ungrouped context menu: Edit name, Hide, Delete"
    - "Batch API functions exist in api.ts for batch-move, batch-hide, batch-delete, and ungroup"
    - "useCategories hook exposes batch operations with invalidation"
  artifacts:
    - path: "frontend/src/components/settings/CategoryActionBar.tsx"
      provides: "Desktop static header + mobile floating action bar"
    - path: "frontend/src/components/settings/CategoryContextMenu.tsx"
      provides: "Shared context menu with role-based items"
    - path: "frontend/src/lib/api.ts"
      provides: "Batch API client functions"
      contains: "batchMoveCategories"
    - path: "frontend/src/hooks/useCategories.ts"
      provides: "Batch mutation hooks"
      contains: "batchMove"
  key_links:
    - from: "frontend/src/components/settings/CategoriesSection.tsx"
      to: "frontend/src/components/settings/CategoryActionBar.tsx"
      via: "selectedIds, action handlers"
      pattern: "CategoryActionBar"
    - from: "frontend/src/components/settings/CategoryContextMenu.tsx"
      to: "frontend/src/hooks/useCategories.ts"
      via: "Action callbacks from parent component"
      pattern: "onUngroup|onHide|onDelete"
    - from: "frontend/src/lib/api.ts"
      to: "backend POST /api/categories/batch-*"
      via: "fetch calls to batch endpoints"
      pattern: "batch-move|batch-hide|batch-delete"
---

<objective>
Add the action bar (desktop header + mobile floating), context menus per row type, and batch API client functions with hook integration.

Purpose: This completes the primary interaction layer — users can now select categories and act on them via the action bar, or use context menus for individual row actions. The batch API client connects to the endpoints from Plan 01.

Output: Action bar renders with functional buttons, context menus on every row, batch operations wired through useCategories.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08.3-category-group-management-redesign/08.3-RESEARCH.md
@.planning/phases/08.3-category-group-management-redesign/08.3-01-SUMMARY.md
@.planning/phases/08.3-category-group-management-redesign/08.3-02-SUMMARY.md

@frontend/src/components/settings/CategoriesSection.tsx
@frontend/src/components/settings/CategoryTree.tsx
@frontend/src/components/settings/CategoryParentRow.tsx
@frontend/src/components/settings/CategoryChildRow.tsx
@frontend/src/lib/api.ts
@frontend/src/hooks/useCategories.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Batch API functions and useCategories hook integration</name>
  <files>frontend/src/lib/api.ts, frontend/src/hooks/useCategories.ts</files>
  <action>
  **Add to `api.ts`:**

  ```typescript
  export async function batchMoveCategories(
    categoryIds: number[],
    targetParentId: number
  ): Promise<{ ok: boolean; updated: number }> {
    const response = await fetch(`${API_BASE_URL}/api/categories/batch-move`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ category_ids: categoryIds, target_parent_id: targetParentId }),
    });
    if (!response.ok) throw new Error(`Failed to move categories: ${response.statusText}`);
    return response.json();
  }

  export async function batchHideCategories(
    categoryIds: number[]
  ): Promise<{ ok: boolean; updated: number }> {
    const response = await fetch(`${API_BASE_URL}/api/categories/batch-hide`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ category_ids: categoryIds }),
    });
    if (!response.ok) throw new Error(`Failed to hide categories: ${response.statusText}`);
    return response.json();
  }

  export async function batchDeleteCategories(
    categoryIds: number[]
  ): Promise<{ ok: boolean; deleted: number }> {
    const response = await fetch(`${API_BASE_URL}/api/categories/batch-delete`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ category_ids: categoryIds }),
    });
    if (!response.ok) throw new Error(`Failed to delete categories: ${response.statusText}`);
    return response.json();
  }

  export async function ungroupParent(
    categoryId: number
  ): Promise<{ ok: boolean; children_ungrouped: number }> {
    const response = await fetch(`${API_BASE_URL}/api/categories/${categoryId}/ungroup`, {
      method: "POST",
    });
    if (!response.ok) throw new Error(`Failed to ungroup category: ${response.statusText}`);
    return response.json();
  }
  ```

  **Add to `useCategories.ts`:**

  Import the 4 new API functions. Add mutations:

  - `batchMoveMutation`: calls `apiBatchMoveCategories`, on success invalidates `["categories"]`, `["categories", "new-count"]`, `["articles"]`. On error shows toast.
  - `batchHideMutation`: calls `apiBatchHideCategories`, on success invalidates same keys plus `["articles"]`. On error shows toast.
  - `batchDeleteMutation`: calls `apiBatchDeleteCategories`, on success invalidates same keys. On error shows toast.
  - `ungroupParentMutation`: calls `apiUngroupParent`, on success invalidates `["categories"]`. On error shows toast.

  Expose in the return object:
  - `batchMove: (categoryIds: number[], targetParentId: number) => batchMoveMutation.mutate({ categoryIds, targetParentId })`
  - `batchHide: (categoryIds: number[]) => batchHideMutation.mutate(categoryIds)`
  - `batchDelete: (categoryIds: number[]) => batchDeleteMutation.mutate(categoryIds)`
  - `ungroupParent: (categoryId: number) => ungroupParentMutation.mutate(categoryId)`
  </action>
  <verify>
  Run `cd /Users/cstalhem/projects/rss-reader/frontend && npx tsc --noEmit` to verify TypeScript compiles.
  </verify>
  <done>
  - 4 new API client functions in api.ts
  - 4 new mutations in useCategories with cache invalidation and error toasts
  - All exposed via the hook's return object
  </done>
</task>

<task type="auto">
  <name>Task 2: Action bar component, context menu component, and integration into category rows</name>
  <files>frontend/src/components/settings/CategoryActionBar.tsx, frontend/src/components/settings/CategoryContextMenu.tsx, frontend/src/components/settings/CategoriesSection.tsx, frontend/src/components/settings/CategoryTree.tsx, frontend/src/components/settings/CategoryParentRow.tsx, frontend/src/components/settings/CategoryChildRow.tsx</files>
  <action>
  **Create `CategoryActionBar.tsx`:**
  - Props: `selectedCount: number`, `onMoveToGroup: () => void`, `onUngroup: () => void`, `onHide: () => void`, `onDelete: () => void`.
  - Desktop (above `sm` breakpoint): Static `Flex` at top of categories section with `py={2} px={3} bg="bg.subtle" borderRadius="sm"`.
    - Left side: `Text fontSize="sm" color="fg.muted"` showing `"{selectedCount} selected"` (or empty/neutral text when 0).
    - Right side: 4 `Button` components (`variant="outline" size="sm"`), all `disabled={selectedCount === 0}`:
      - "Move to group" — `onClick={onMoveToGroup}`
      - "Ungroup" — `onClick={onUngroup}`
      - "Hide" — `onClick={onHide}`
      - "Delete" — `colorPalette="red"`, `onClick={onDelete}`
  - Mobile (at and below `sm` breakpoint): Use Chakra `ActionBar.Root` with `open={selectedCount > 0}`.
    - `Portal > ActionBar.Positioner > ActionBar.Content`.
    - Inside: `ActionBar.SelectionTrigger` showing count, `ActionBar.Separator`, then 4 buttons (same as desktop but no disabled state needed since bar only appears when count > 0).
  - Use responsive `display` props: `display={{ base: "none", sm: "flex" }}` for desktop, `display={{ base: "block", sm: "none" }}` for mobile wrapper.
  - Import `ActionBar` and `Portal` from `@chakra-ui/react`.

  **Create `CategoryContextMenu.tsx`:**
  - Props: `type: "parent" | "child" | "ungrouped"`, `isWeightOverridden?: boolean`, `onUngroup?: () => void`, `onResetWeight?: () => void`, `onRename: () => void`, `onHide: () => void`, `onDelete: () => void`.
  - Render a `Menu.Root` with `Menu.Trigger` as `IconButton` (`LuMoreVertical`, size="xs", variant="ghost").
  - Inside `Portal > Menu.Positioner > Menu.Content`:
    - If `type === "parent"`: show `Menu.Item` for "Ungroup" (calls `onUngroup`).
    - If `type === "child"`: show `Menu.Item` for "Reset weight" (calls `onResetWeight`, `disabled={!isWeightOverridden}`).
    - Always: `Menu.Item` for "Edit name" (calls `onRename`).
    - Always: `Menu.Item` for "Hide" (calls `onHide`).
    - `Menu.Separator`.
    - Always: `Menu.Item` for "Delete" with `color="fg.error"` (calls `onDelete`).
  - Import `Menu`, `Portal`, `IconButton` from `@chakra-ui/react`.
  - Import `LuMoreVertical` from `react-icons/lu`.

  **Update `CategoryParentRow.tsx`:**
  - Replace the hover-reveal pencil/trash buttons with `<CategoryContextMenu type="parent" onUngroup={onUngroup} onRename={() => setIsRenaming(true)} onHide={onHide} onDelete={onDelete} />`.
  - Add `onUngroup` and `onHide` to the props interface (these are new — parent rows previously didn't have ungroup or hide).
  - Remove the hover-reveal `Flex` containing `IconButton` for pencil and trash (the context menu replaces it).
  - Keep `isHovered` state only if still needed for other interactions. If no other hover-dependent elements remain, remove `isHovered`, `onMouseEnter`, `onMouseLeave`.

  **Update `CategoryChildRow.tsx`:**
  - Replace the hover-reveal pencil/trash/hide buttons with `<CategoryContextMenu type={category.parent_id !== null ? "child" : "ungrouped"} isWeightOverridden={isOverridden} onResetWeight={onResetWeight} onRename={() => setIsRenaming(true)} onHide={onHide} onDelete={onDelete} />`.
  - Remove the hover-reveal `Flex` containing the three `IconButton` components.
  - Keep `isHovered` state only if still needed for the "New" badge X icon expand. If the badge's X icon still uses `isHovered` for its expand animation, keep it.

  **Update `CategoryTree.tsx`:**
  - Add `onUngroup` and `onHideParent` to the interface (pass from CategoriesSection for parent-level actions).
  - Pass `onUngroup` and `onHide` to `CategoryParentRow`.
  - Pass the correct `type` information to child rows.

  **Update `CategoriesSection.tsx`:**
  - Import and render `CategoryActionBar` above the search input and category tree.
  - Wire action bar callbacks:
    - `onMoveToGroup`: placeholder (will be implemented in Plan 04) — for now, `console.log("Move to group", selectedIds)`.
    - `onUngroup`: call `batchMove(Array.from(selectedIds), -1)` then `clearSelection()`. Use the batch-move with target_parent_id=-1 convention.
    - `onHide`: call `batchHide(Array.from(selectedIds))` then `clearSelection()`.
    - `onDelete`: placeholder for confirmation dialog (will be enhanced in Plan 04) — for now, call `batchDelete(Array.from(selectedIds))` then `clearSelection()`.
  - Destructure new functions from `useCategories()`: `batchMove`, `batchHide`, `batchDelete`, `ungroupParent`.
  - Add `handleUngroupParent` callback: calls `ungroupParent(categoryId)`.
  - Pass `onUngroup={handleUngroupParent}` and `onHide={handleHideCategory}` to CategoryTree for parent rows.
  </action>
  <verify>
  Run `cd /Users/cstalhem/projects/rss-reader/frontend && npx tsc --noEmit` to verify TypeScript compiles.
  Run `cd /Users/cstalhem/projects/rss-reader/frontend && bun run build` to verify production build succeeds.
  </verify>
  <done>
  - CategoryActionBar renders with 4 action buttons, responsive desktop/mobile layouts
  - CategoryContextMenu renders per row type with correct menu items
  - Hover-reveal buttons replaced by context menus on all rows
  - Action bar wired to batch operations via useCategories
  - Selection cleared after batch actions
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. `bun run build` succeeds
3. Action bar visible above categories with disabled buttons when nothing selected
4. Three-dot menu on every row with correct items per type
5. Batch operations (ungroup, hide) work from action bar
</verification>

<success_criteria>
- Action bar responds to selection state
- Context menus show correct items per row type
- Batch API calls reach the backend endpoints
- Selection clears after actions
</success_criteria>

<output>
After completion, create `.planning/phases/08.3-category-group-management-redesign/08.3-03-SUMMARY.md`
</output>
