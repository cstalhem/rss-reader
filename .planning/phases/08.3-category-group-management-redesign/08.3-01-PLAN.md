---
phase: 08.3-category-group-management-redesign
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/backend/main.py
  - backend/src/backend/scoring.py
  - backend/src/backend/prompts.py
autonomous: true
requirements: [CATGRP-02, CATGRP-03]

must_haves:
  truths:
    - "Hide endpoint sets is_hidden=True and clears parent_id (leaves group on hide, not on unhide)"
    - "Unhide endpoint only resets weight if it was block (parent_id already cleared on hide)"
    - "Batch move endpoint re-parents multiple categories in one request"
    - "Batch hide endpoint hides multiple categories without modifying weights"
    - "Batch delete endpoint removes multiple categories and their article links"
    - "Ungroup parent endpoint preserves inherited weights on children before clearing parent_id"
    - "LLM categorization prompt includes hidden categories with avoid instruction"
  artifacts:
    - path: "backend/src/backend/main.py"
      provides: "Batch endpoints and fixed hide/unhide semantics"
      contains: "batch-move"
    - path: "backend/src/backend/scoring.py"
      provides: "Hidden categories in active categories list"
      contains: "hidden_categories"
    - path: "backend/src/backend/prompts.py"
      provides: "Categorization prompt with hidden categories section"
      contains: "NEVER assign"
  key_links:
    - from: "backend/src/backend/main.py"
      to: "backend/src/backend/scoring.py"
      via: "get_active_categories returns hidden categories separately"
      pattern: "get_active_categories"
    - from: "backend/src/backend/scoring.py"
      to: "backend/src/backend/prompts.py"
      via: "build_categorization_prompt receives hidden_categories parameter"
      pattern: "hidden_categories"
---

<objective>
Fix hide/unhide semantics, add batch operation endpoints, add ungroup parent endpoint, and update LLM prompt to include hidden categories with avoidance instruction.

Purpose: Backend foundation for the multi-select action bar paradigm. The frontend needs batch endpoints (batch-move, batch-hide, batch-delete) and an ungroup endpoint. Hide/unhide semantics must match the CONTEXT.md decisions (hide = visibility flag only, unhide = return to ungrouped).

Output: Updated backend endpoints ready for frontend consumption.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08.3-category-group-management-redesign/08.3-RESEARCH.md

@backend/src/backend/main.py
@backend/src/backend/scoring.py
@backend/src/backend/prompts.py
@backend/src/backend/models.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix hide/unhide semantics and add batch endpoints</name>
  <files>backend/src/backend/main.py</files>
  <action>
  **Fix hide endpoint** (`PATCH /api/categories/{id}/hide`):
  - Remove the line `category.weight = "block"`. Hide should ONLY set `is_hidden = True`. Per CONTEXT.md, hide is a visibility flag, not a weight mechanism.
  - Add `category.parent_id = None` to clear the parent reference. Hiding removes the category from the active tree, so it should leave its parent group at this point (not on unhide).

  **Fix unhide endpoint** (`PATCH /api/categories/{id}/unhide`):
  - Do NOT set `parent_id` — it was already cleared on hide. The category returns to ungrouped automatically.
  - Keep the existing conditional weight reset (`if category.weight == "block": category.weight = None`).

  **Add batch move endpoint** (`POST /api/categories/batch-move`):
  - Request body: `{ category_ids: list[int], target_parent_id: int }` where `target_parent_id = -1` means ungroup.
  - Create a Pydantic model `CategoryBatchMove` for the body.
  - For each category_id: look up the category, validate it exists.
  - If `target_parent_id == -1` (ungroup): for each child where `weight IS NULL`, set `weight = parent.weight` (preserve inherited weight) before setting `parent_id = None`.
  - If `target_parent_id > 0`: validate the target parent exists and is a root category, set `parent_id = target_parent_id`.
  - Prevent nesting a parent with children under another parent.
  - Return `{ ok: true, updated: N }`.

  **Add batch hide endpoint** (`POST /api/categories/batch-hide`):
  - Request body: `{ category_ids: list[int] }`.
  - Create a Pydantic model `CategoryBatchAction` for the body.
  - For each category_id: set `is_hidden = True` and `parent_id = None` (same as single hide — leaves group on hide). Do NOT modify weight.
  - Return `{ ok: true, updated: N }`.

  **Add batch delete endpoint** (`POST /api/categories/batch-delete`):
  - Request body: `{ category_ids: list[int] }` (reuse `CategoryBatchAction`).
  - For each category_id: release children to root (set their `parent_id = None`, preserve weights), delete article-category links, then delete the category.
  - Return `{ ok: true, deleted: N }`.

  **Add ungroup parent endpoint** (`POST /api/categories/{category_id}/ungroup`):
  - Find all children of this parent.
  - For each child where `child.weight IS NULL`: set `child.weight = parent.weight` (preserve effective weight).
  - Set all children `parent_id = None`.
  - The parent itself stays but now has no children (effectively ungrouped).
  - Return `{ ok: true, children_ungrouped: N }`.

  Place the Pydantic models near the top of the file with other request/response models. Place the endpoints near the existing category endpoints.
  </action>
  <verify>
  Run `cd /Users/cstalhem/projects/rss-reader/backend && uv run ruff check src/` to verify no lint errors.
  Run `cd /Users/cstalhem/projects/rss-reader/backend && uv run pytest` to verify existing tests pass.
  </verify>
  <done>
  - Hide endpoint sets only `is_hidden=True` (no weight change)
  - Unhide endpoint clears `parent_id` and conditionally resets weight
  - `POST /api/categories/batch-move` accepts category_ids + target_parent_id, handles ungroup (-1) with weight preservation
  - `POST /api/categories/batch-hide` accepts category_ids, sets is_hidden without weight change
  - `POST /api/categories/batch-delete` accepts category_ids, releases children, deletes links and categories
  - `POST /api/categories/{id}/ungroup` preserves inherited weights, clears children's parent_id
  </done>
</task>

<task type="auto">
  <name>Task 2: Update LLM prompt to include hidden categories with avoidance instruction</name>
  <files>backend/src/backend/scoring.py, backend/src/backend/prompts.py</files>
  <action>
  **Update `get_active_categories` in `scoring.py`:**
  - Change the return type to `tuple[list[str], dict[str, list[str]] | None, list[str]]` (added hidden category names).
  - Add a second query for hidden categories: `select(Category).where(Category.is_hidden == True)`.
  - Collect hidden category display names into a sorted list.
  - Return `(display_names, hierarchy, hidden_names)`.

  **Update `categorize_article` in `scoring.py`:**
  - Where `get_active_categories` is called, unpack the third element `hidden_categories`.
  - Pass `hidden_categories` to `build_categorization_prompt`.

  **Update `build_categorization_prompt` in `prompts.py`:**
  - Add parameter `hidden_categories: list[str] | None = None`.
  - After the hierarchy section and before the article content, add a conditional section:
    ```
    if hidden_categories:
        hidden_section = f"\n**NEVER assign these categories or similar topics (they are blocked):**\n{', '.join(hidden_categories)}\n"
    ```
  - Insert `hidden_section` into the prompt after the hierarchy section.
  </action>
  <verify>
  Run `cd /Users/cstalhem/projects/rss-reader/backend && uv run ruff check src/` to verify no lint errors.
  Run `cd /Users/cstalhem/projects/rss-reader/backend && uv run pytest` to verify existing tests pass.
  </verify>
  <done>
  - `get_active_categories` returns hidden category names as third tuple element
  - `categorize_article` passes hidden categories to prompt builder
  - `build_categorization_prompt` includes hidden categories with "NEVER assign" instruction when present
  </done>
</task>

</tasks>

<verification>
1. `uv run ruff check src/` passes with no errors
2. `uv run pytest` passes all existing tests
3. Manual inspection: hide endpoint no longer sets weight; unhide clears parent_id; batch endpoints exist with correct URL paths
</verification>

<success_criteria>
- All six new/modified endpoints respond correctly
- No regressions in existing category CRUD or scoring pipeline
- Hidden categories appear in LLM prompt with avoidance instruction
</success_criteria>

<output>
After completion, create `.planning/phases/08.3-category-group-management-redesign/08.3-01-SUMMARY.md`
</output>
