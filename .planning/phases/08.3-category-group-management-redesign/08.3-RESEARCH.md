# Phase 08.3: Category Group Management Redesign - Research

**Researched:** 2026-02-17
**Domain:** Frontend UI paradigm replacement (DnD to multi-select + action bar), backend batch operations, mobile responsive layout
**Confidence:** HIGH

## Summary

This phase replaces the drag-and-drop category grouping interaction with a checkbox multi-select + action bar paradigm, adds collapsible parent rows, context menus, and clarifies Delete/Hide/Block semantics. The scope also includes a card-based mobile layout below the `sm` breakpoint.

The codebase is well-positioned for this change. The existing `CategoriesSection` already computes the tree structure (parents, childrenMap, ungroupedCategories) via `useMemo`, and `useCategories` provides all needed mutations. The main work is: (1) removing all DnD code from category components, (2) adding selection state and action bar, (3) making parent rows collapsible, (4) replacing hover-reveal buttons with context menus, (5) adding the "Move to group" dialog, (6) building mobile card layout, and (7) adjusting backend hide/unhide semantics plus adding batch endpoints.

Chakra UI v3 provides native `ActionBar`, `Collapsible`, `Menu`, `Checkbox`, and `Dialog` components that map directly to the required UI elements. No additional libraries are needed beyond what is already installed.

**Primary recommendation:** Work in layers -- strip DnD first, add selection + action bar, then collapsible tree, then context menus, then "Move to group" dialog, then hidden section, then mobile layout. Each layer is independently testable.

<user_constraints>
## User Constraints (from CONTEXT.md)

### Locked Decisions

#### Interaction paradigm
- **Multi-select with always-on checkboxes** on child and ungrouped category rows (not parents)
- **Desktop action header** always visible at top of categories section, buttons disabled when nothing selected. Layout: selection count left-aligned, action buttons right-aligned
- **Mobile floating bottom bar** slides up from bottom when 1+ items selected
- Action bar actions: **Move to group**, **Ungroup**, **Hide**, **Delete**
- "Move to group" opens a **modal dialog with search** listing existing parents + "Create new group" inline option. Same modal on all screen sizes
- **No select-all shortcuts** -- manual checkbox selection only
- Block is NOT an action bar/menu action -- it's a weight preset on the row's weight strip

#### Tree structure
- **Keep tree view** with indented children and connector lines (same visual structure as 08.1/08.2, minus DnD)
- Parents are **collapsible** -- click to expand/collapse
- Default state: **collapsed**, with expand/collapse state persisted in localStorage per device
- Children checkboxes only accessible when parent is expanded
- Collapsed parent shows: name, child count, weight preset strip (parents are categories with their own weights)
- **No DnD at all** -- all grouping/ungrouping via action bar and context menu

#### Context menu (three-dot per row)
- **Parent row:** Ungroup, Edit name, Hide, Delete
- **Child row:** Reset weight (disabled if same as parent), Edit name, Hide, Delete
- **Ungrouped row:** Edit name, Hide, Delete
- "Ungroup" on parent = ungroup all children AND parent becomes ungrouped (no data deleted)
- Rename via hover-reveal pencil icon (same as current)

#### Category removal semantics (Delete / Hide / Block)
- **Delete:** Category removed from DB, all article-category links removed. LLM no longer sees it in prompt. Purpose: cleanup of erroneous or too-specific categories
- **Hide:** Category exists in DB, flagged as hidden. LLM sees it in prompt but is instructed to never use it or adjacent categories. Purpose: content moderation (inappropriate terms). No scoring effect since it should never be assigned. Hidden categories move to a collapsible "Hidden (N)" section at bottom of categories list. Unhide returns category to ungrouped (loses previous parent)
- **Block (weight):** Normal category with block weight. LLM assigns it normally. If an article has AT LEAST ONE blocked category, the entire article skips scoring and is hidden in UI. Purpose: topic suppression for uninteresting subjects

#### Confirmation and feedback
- **Confirmation dialogs** for both Delete and Ungroup actions (count only, e.g., "Delete 3 categories?")
- **Instant update + toast** after Move to group, Ungroup, Hide actions
- When parent is ungrouped, children that inherited the parent's weight get that weight set explicitly (preserves scoring behavior)

#### Collapsed parent badges
- When a parent is collapsed and has new/unseen children, show a **"N new" chip** on the parent row
- Chip is clickable to dismiss (marks all children as seen), same interaction as individual row badges

#### Mobile experience
- Below Chakra `sm` breakpoint (480px): **card layout** instead of rows
- Card structure: top row = checkbox + category name + three-dot menu, bottom row = full weight preset strip (always visible, no expand/collapse)
- Child cards indented under parent cards with connector lines (same hierarchy visual)
- Floating bottom action bar slides up when items selected
- "Move to group" dialog: same centered modal on all screen sizes
- Three-dot context menu: same icon, tap to open popover/bottom sheet

#### Terminology
- Use "Ungroup" consistently everywhere (not "Split")
- Action bar "Ungroup" = ungroup selected children
- Context menu "Ungroup" on parent = ungroup all children + parent becomes ungrouped

### Claude's Discretion
- Exact animation timing for floating action bar slide-in
- Card styling details (border, shadow, spacing) for mobile
- Connector line styling adjustments for card layout
- Confirmation dialog component choice (Chakra AlertDialog or custom)
- Touch target sizing for mobile checkboxes and three-dot icons
- Search input behavior in "Move to group" dialog (debounce, filtering)

### Deferred Ideas (OUT OF SCOPE)
- **LLM parent category suggestion** -- LLM auto-suggests existing parent for new categories during categorization. Deferred to Phase 9
- **DnD as supplementary interaction** -- Could add optional DnD back later once core button-based paradigm is solid. Not in scope for 08.3
</user_constraints>

<phase_requirements>
## Phase Requirements

| ID | Description | Research Support |
|----|-------------|-----------------|
| CATGRP-02 | User can drag existing categories into groups via tree UI | This phase REPLACES DnD with button-based grouping. "Move to group" dialog provides the new grouping mechanism. Backend `PATCH /api/categories/:id` with `parent_id` already supports re-parenting. A new batch endpoint for multi-select moves will be needed. |
| CATGRP-03 | User can set a weight on a group that cascades to all child categories | Weight cascade already works via `WeightPresetStrip` on parent rows and `get_effective_weight()` in scoring. This phase preserves existing behavior while restructuring the UI around it. The ungroup action must explicitly set inherited weights on children (new backend logic). |
</phase_requirements>

## Standard Stack

### Core (Already Installed)
| Library | Version | Purpose | Why Standard |
|---------|---------|---------|--------------|
| @chakra-ui/react | v3 | All UI components: ActionBar, Collapsible, Menu, Checkbox, Dialog | Already the project's design system |
| @tanstack/react-query | Installed | Server state, optimistic updates, cache invalidation | Already handles all category data fetching |
| react-icons/lu | Installed | Icons for menu items, buttons | Already used throughout the project |

### Components to Use (No New Libraries)
| Component | Purpose | Import |
|-----------|---------|--------|
| `ActionBar` | Desktop action header + mobile floating bar | `import { ActionBar } from "@chakra-ui/react"` |
| `Collapsible` | Parent row expand/collapse | `import { Collapsible } from "@chakra-ui/react"` |
| `Menu` | Context menu (three-dot) per row | `import { Menu } from "@chakra-ui/react"` |
| `Checkbox` | Multi-select checkboxes on rows | `import { Checkbox } from "@chakra-ui/react"` |
| `Dialog` | "Move to group" modal + confirmation dialogs | `import { Dialog } from "@chakra-ui/react"` |

### To Remove
| Library | Reason |
|---------|--------|
| `@dnd-kit/core` imports in category components | DnD removed from category management |
| `@dnd-kit/sortable` imports in category components | DnD removed from category management |
| `@dnd-kit/utilities` imports in category components | DnD removed from category management |

**IMPORTANT:** `@dnd-kit` packages must NOT be uninstalled -- they are still used by `FeedsSection.tsx`, `Sidebar.tsx`, and `FeedRow.tsx` for feed reordering.

### Alternatives Considered
| Instead of | Could Use | Tradeoff |
|------------|-----------|----------|
| Chakra `ActionBar` | Custom fixed-position `Flex` | ActionBar handles portal, positioning, and animation natively -- no reason to hand-roll |
| Chakra `Collapsible` | Manual height animation with `maxHeight` trick | Collapsible handles animation, accessibility (aria-expanded), and controlled state. Simpler code |
| Separate `AlertDialog` component | Chakra `Dialog` with `role="alertdialog"` | Dialog supports `role="alertdialog"` natively -- confirmation dialogs are just dialogs with that role |

## Architecture Patterns

### Current Component Structure (to be modified)
```
frontend/src/components/settings/
  CategoriesSection.tsx      # Top-level: DnD context, tree data, search, delete dialog
  CategoryTree.tsx           # Renders parent groups + ungrouped children
  CategoryParentRow.tsx      # Parent row with droppable, weight strip, hover actions
  CategoryChildRow.tsx       # Child/ungrouped row with sortable+droppable, weight strip, hover actions
  CategoryRow.tsx            # Older version (string-based), still has DnD -- unused by CategoryTree
  WeightPresetStrip.tsx      # Weight button strip (icon-based, expand on hover)
  WeightPresets.tsx           # Older weight buttons (text-based) -- used by CategoryRow
  SwipeableRow.tsx           # Mobile swipe-to-reveal edit button
  DeleteCategoryDialog.tsx   # Confirmation dialog for single delete
  CreateCategoryPopover.tsx  # Popover for creating new categories
```

### Target Component Structure
```
frontend/src/components/settings/
  CategoriesSection.tsx      # Top-level: selection state, tree data, search, action bar, dialogs
  CategoryTree.tsx           # Renders collapsible parent groups + ungrouped children
  CategoryParentRow.tsx      # Collapsible parent row with context menu, weight strip, new-badge
  CategoryChildRow.tsx       # Child row with checkbox, context menu, weight strip
  CategoryUngroupedRow.tsx   # Ungrouped row with checkbox, context menu, weight strip (NEW)
  CategoryContextMenu.tsx    # Shared context menu component (NEW)
  CategoryActionBar.tsx      # Desktop action header + mobile floating action bar (NEW)
  MoveToGroupDialog.tsx      # "Move to group" modal with search (NEW)
  HiddenCategoriesSection.tsx # Collapsible "Hidden (N)" section at bottom (NEW)
  WeightPresetStrip.tsx      # Unchanged
  DeleteCategoryDialog.tsx   # Extended for bulk delete confirmation
  CreateCategoryPopover.tsx  # Unchanged
```

### Pattern 1: Selection State Management
**What:** Centralized selection state in `CategoriesSection` with `Set<number>` for selected category IDs.
**When to use:** All multi-select + action bar interactions.
**Key detail:** Checkboxes only on child and ungrouped rows (not parents). Selection cleared on action completion. Selection IDs filtered against current visible categories to prevent stale selections.

```typescript
// In CategoriesSection.tsx
const [selectedIds, setSelectedIds] = useState<Set<number>>(new Set());

const toggleSelection = useCallback((id: number) => {
  setSelectedIds(prev => {
    const next = new Set(prev);
    if (next.has(id)) next.delete(id);
    else next.add(id);
    return next;
  });
}, []);

const clearSelection = useCallback(() => {
  setSelectedIds(new Set());
}, []);
```

### Pattern 2: Collapsible Parent with localStorage Persistence
**What:** Each parent row is a `Collapsible.Root` with controlled `open` state persisted in localStorage.
**When to use:** Parent category rows with children.

```typescript
// Use existing useLocalStorage hook
const [expandedParents, setExpandedParents] = useLocalStorage<Record<number, boolean>>(
  "category-expanded-parents",
  {} // default: all collapsed
);

const toggleParent = useCallback((parentId: number) => {
  setExpandedParents(prev => ({
    ...prev,
    [parentId]: !prev[parentId], // false/undefined = collapsed, true = expanded
  }));
}, [setExpandedParents]);
```

### Pattern 3: Desktop Action Header (Static) vs Mobile Action Bar (Floating)
**What:** Desktop shows a static header row at top of categories section. Mobile shows Chakra's `ActionBar` component (floating, portalled) that slides up when items are selected.
**When to use:** When 1+ items selected.

Desktop action header:
```tsx
// Static Flex at top of categories section
<Flex alignItems="center" py={2} px={3} bg="bg.subtle" borderRadius="sm">
  <Text fontSize="sm" color="fg.muted">
    {selectedIds.size} selected
  </Text>
  <Box flex={1} />
  <Button size="sm" variant="outline" disabled={selectedIds.size === 0}>
    Move to group
  </Button>
  {/* ... other buttons */}
</Flex>
```

Mobile floating action bar:
```tsx
// Uses Chakra ActionBar component -- portalled, slides up from bottom
<ActionBar.Root open={selectedIds.size > 0}>
  <Portal>
    <ActionBar.Positioner>
      <ActionBar.Content>
        <ActionBar.SelectionTrigger>
          {selectedIds.size} selected
        </ActionBar.SelectionTrigger>
        <ActionBar.Separator />
        <Button variant="outline" size="sm">Move to group</Button>
        {/* ... */}
      </ActionBar.Content>
    </ActionBar.Positioner>
  </Portal>
</ActionBar.Root>
```

### Pattern 4: Context Menu (three-dot) per Row
**What:** `Menu.Root` with `Menu.Trigger` as an `IconButton` containing `LuMoreVertical`. Different menu items per row type.
**When to use:** Every category row.

```tsx
// Source: Chakra UI v3 Menu docs
<Menu.Root>
  <Menu.Trigger asChild>
    <IconButton aria-label="Actions" size="xs" variant="ghost">
      <LuMoreVertical size={14} />
    </IconButton>
  </Menu.Trigger>
  <Portal>
    <Menu.Positioner>
      <Menu.Content>
        <Menu.Item value="rename">Edit name</Menu.Item>
        <Menu.Item value="hide">Hide</Menu.Item>
        <Menu.Separator />
        <Menu.Item value="delete" color="fg.error" _hover={{ bg: "bg.error", color: "fg.error" }}>
          Delete
        </Menu.Item>
      </Menu.Content>
    </Menu.Positioner>
  </Portal>
</Menu.Root>
```

### Pattern 5: "Move to Group" Dialog
**What:** Controlled `Dialog.Root` with search input filtering parent categories, plus "Create new group" inline option.
**When to use:** When user clicks "Move to group" from action bar.

```tsx
<Dialog.Root open={moveDialogOpen} onOpenChange={(e) => setMoveDialogOpen(e.open)}>
  <Portal>
    <Dialog.Backdrop />
    <Dialog.Positioner>
      <Dialog.Content>
        <Dialog.Header>
          <Dialog.Title>Move to group</Dialog.Title>
        </Dialog.Header>
        <Dialog.Body>
          <Input placeholder="Search groups..." mb={3} />
          {/* List of existing parent categories, filterable */}
          {/* "Create new group" inline option at bottom */}
        </Dialog.Body>
        <Dialog.CloseTrigger asChild>
          <CloseButton size="sm" />
        </Dialog.CloseTrigger>
      </Dialog.Content>
    </Dialog.Positioner>
  </Portal>
</Dialog.Root>
```

### Pattern 6: Hidden Categories Section
**What:** A `Collapsible.Root` at the bottom of the categories list showing hidden categories with an "Unhide" action.
**When to use:** When `categories.filter(c => c.is_hidden).length > 0`.

### Anti-Patterns to Avoid
- **DO NOT use `ActionBar` for the desktop header** -- ActionBar is a floating/portalled component designed for bottom-of-screen. Use a static `Flex` row for the always-visible desktop header. Only use ActionBar for the mobile floating bar.
- **DO NOT nest DnD and checkbox interactions** -- checkboxes must not interfere with row click events. Use `e.stopPropagation()` on checkbox clicks.
- **DO NOT store expanded state in React state only** -- must persist to localStorage for cross-session consistency.
- **DO NOT render checkboxes on parent rows** -- only child and ungrouped rows get checkboxes per the locked decision.

## Don't Hand-Roll

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Collapsible sections | Manual height animation with `overflow: hidden` + `maxHeight` | Chakra `Collapsible` | Handles animation, accessibility (aria-expanded), content measurement automatically |
| Context menu positioning | Custom absolute-positioned div | Chakra `Menu` with `Portal > Menu.Positioner > Menu.Content` | Handles z-index stacking, viewport boundary detection, keyboard navigation |
| Mobile floating action bar | Custom `position: fixed` div with animation | Chakra `ActionBar` | Handles portal, positioner, animation, and accessibility out of the box |
| Confirmation dialogs | Custom modal component | Chakra `Dialog` with `role="alertdialog"` | Handles focus trapping, escape key, backdrop click, animation |
| Search filtering in dialog | Custom debounce implementation | Simple `useState` + `useMemo` filter | Category list is small (tens to low hundreds). No debounce needed -- instant filter is fine |

**Key insight:** Every UI element in this phase maps to a native Chakra UI v3 component. Zero additional libraries needed.

## Common Pitfalls

### Pitfall 1: ActionBar renders in Portal -- will cover content
**What goes wrong:** The Chakra `ActionBar` renders via Portal at the bottom of the viewport. On mobile, it may overlap the last category rows.
**Why it happens:** Portal renders outside the normal DOM flow, floating over content.
**How to avoid:** Add bottom padding to the categories list when ActionBar is visible (when selection count > 0), matching the ActionBar height.
**Warning signs:** Last few categories hidden behind the floating bar on mobile.

### Pitfall 2: Hide endpoint currently sets weight to "block" -- needs change
**What goes wrong:** The current `PATCH /api/categories/:id/hide` endpoint sets `weight = "block"`. The CONTEXT.md decision says Hide is NOT a weight mechanism -- it's a visibility flag. Hidden categories should not have their weight modified.
**Why it happens:** The existing implementation conflated Hide and Block semantics.
**How to avoid:** Update the backend `hide_category` endpoint to ONLY set `is_hidden = True` without touching `weight`. Update `unhide_category` correspondingly. The LLM prompt filtering in `get_active_categories()` already excludes hidden categories.
**Warning signs:** Hidden categories having their weights silently changed.

### Pitfall 3: Unhide should clear parent_id -- per CONTEXT.md
**What goes wrong:** The CONTEXT.md says "Unhide returns category to ungrouped (loses previous parent)". The current backend unhide does NOT clear `parent_id`.
**Why it happens:** The current implementation only toggles `is_hidden` and resets weight.
**How to avoid:** Update unhide endpoint to also set `parent_id = None`.
**Warning signs:** Unhidden categories appearing as children of their previous parent instead of ungrouped.

### Pitfall 4: Ungroup parent must preserve children's effective weights
**What goes wrong:** When ungrouping a parent, children that inherited the parent's weight (i.e., `child.weight IS NULL`) lose their effective weight because the parent reference is removed.
**Why it happens:** The scoring system resolves effective weight as `child.weight ?? parent.weight ?? "normal"`. Without a parent, inherited weight becomes "normal".
**How to avoid:** The backend ungroup endpoint must: for each child where `child.weight IS NULL`, set `child.weight = parent.weight` before setting `child.parent_id = None`. This explicitly preserves the weight they were inheriting.
**Warning signs:** Category weights changing after ungrouping.

### Pitfall 5: @dnd-kit packages still needed for feeds
**What goes wrong:** Removing `@dnd-kit` packages from `package.json` breaks feed reordering in `FeedsSection.tsx`, `Sidebar.tsx`, and `FeedRow.tsx`.
**Why it happens:** Only category DnD is being removed, not feed DnD.
**How to avoid:** Only remove DnD imports from category component files. Do NOT run `bun remove @dnd-kit/core @dnd-kit/sortable @dnd-kit/utilities`.
**Warning signs:** Build errors in FeedsSection or Sidebar after removing DnD code.

### Pitfall 6: Stale selection after mutations
**What goes wrong:** After deleting or hiding categories, selected IDs may reference non-existent categories.
**Why it happens:** Selection state is local React state, not synced with server data.
**How to avoid:** Clear selection after every batch action (delete, hide, move, ungroup). Also filter selected IDs against current categories on each render.
**Warning signs:** "N selected" count not updating after actions.

### Pitfall 7: CategoryRow.tsx is orphaned but still exists
**What goes wrong:** `CategoryRow.tsx` (the older string-based component) and `WeightPresets.tsx` are not used by the current tree but still exist in the codebase.
**Why it happens:** Legacy components from pre-08.2 era.
**How to avoid:** These can be deleted as part of cleanup since they use the old string-based API. However, per project conventions, mention this rather than silently deleting pre-existing dead code.
**Warning signs:** Import confusion between `CategoryRow` and `CategoryChildRow`.

### Pitfall 8: Collapsible.Root needs controlled state for localStorage persistence
**What goes wrong:** Using `defaultOpen` on Collapsible won't work because we need to read from localStorage after hydration.
**Why it happens:** Server renders with default (collapsed), then client reads localStorage.
**How to avoid:** Use the controlled `open` + `onOpenChange` props on `Collapsible.Root`. Initialize from `useLocalStorage` which handles hydration correctly (starts with default, syncs in useEffect).
**Warning signs:** Flash of wrong collapsed/expanded state on page load.

## Code Examples

### Existing Patterns to Reuse

#### Tree Data Computation (CategoriesSection.tsx, lines 53-82)
Already computes `parents`, `childrenMap`, and `ungroupedCategories` via `useMemo`. This stays unchanged.

#### Optimistic Updates (useCategories.ts)
The `updateCategoryMutation` already has `onMutate` (optimistic cache update), `onError` (rollback), and `onSettled` (invalidate). Same pattern should be followed for new batch mutations.

#### Weight Preset Strip (WeightPresetStrip.tsx)
Local optimistic state pattern -- stays unchanged. Already handles `localValue` sync with `useEffect`.

#### Delete Confirmation Dialog (DeleteCategoryDialog.tsx)
Uses `Dialog.Root` with `Portal > Dialog.Backdrop > Dialog.Positioner > Dialog.Content`. Correct Chakra v3 pattern. Extend for bulk delete ("Delete N categories?").

### New Backend Endpoints Needed

#### Batch Move (re-parent multiple categories)
```python
class CategoryBatchMove(BaseModel):
    category_ids: list[int]
    target_parent_id: int  # or -1 for ungroup

@app.post("/api/categories/batch-move")
def batch_move_categories(body: CategoryBatchMove, session: Session = Depends(get_session)):
    """Move multiple categories to a new parent (or ungroup with -1)."""
    # ... validate target_parent_id
    # ... for each category: set parent_id
    # ... for ungroup (-1): preserve inherited weights by setting explicit weight
```

#### Batch Hide
```python
class CategoryBatchAction(BaseModel):
    category_ids: list[int]

@app.post("/api/categories/batch-hide")
def batch_hide_categories(body: CategoryBatchAction, session: Session = Depends(get_session)):
    """Hide multiple categories."""
    # ... for each: set is_hidden = True (NOT weight = "block")
```

#### Batch Delete
```python
@app.post("/api/categories/batch-delete")
def batch_delete_categories(body: CategoryBatchAction, session: Session = Depends(get_session)):
    """Delete multiple categories."""
    # ... for each: release children to root, delete links, delete category
```

#### Ungroup Parent (children + parent become ungrouped)
```python
@app.post("/api/categories/{category_id}/ungroup")
def ungroup_parent(category_id: int, session: Session = Depends(get_session)):
    """Ungroup all children + parent. Children that inherited weight get it set explicitly."""
    # ... for each child where weight IS NULL: set weight = parent.weight
    # ... set all children parent_id = None
    # ... parent stays as-is but now has no children (effectively ungrouped)
```

### Chakra ActionBar for Mobile (Verified Pattern)
```tsx
// Source: Chakra UI v3 ActionBar docs
<ActionBar.Root open={selectedIds.size > 0}>
  <Portal>
    <ActionBar.Positioner>
      <ActionBar.Content>
        <ActionBar.SelectionTrigger>
          {selectedIds.size} selected
        </ActionBar.SelectionTrigger>
        <ActionBar.Separator />
        <Button variant="outline" size="sm" onClick={handleMoveToGroup}>
          Move to group
        </Button>
        <Button variant="outline" size="sm" onClick={handleUngroup}>
          Ungroup
        </Button>
        <Button variant="outline" size="sm" onClick={handleHide}>
          Hide
        </Button>
        <Button variant="surface" colorPalette="red" size="sm" onClick={handleDelete}>
          Delete
        </Button>
      </ActionBar.Content>
    </ActionBar.Positioner>
  </Portal>
</ActionBar.Root>
```

### Collapsible Parent Row (Verified Pattern)
```tsx
// Source: Chakra UI v3 Collapsible docs
<Collapsible.Root
  open={expandedParents[parent.id] ?? false}
  onOpenChange={(e) => toggleParent(parent.id)}
>
  <Collapsible.Trigger asChild>
    <Flex alignItems="center" gap={2} py={3} px={3} cursor="pointer">
      <Collapsible.Indicator
        transition="transform 0.2s"
        _open={{ transform: "rotate(90deg)" }}
      >
        <LuChevronRight size={14} />
      </Collapsible.Indicator>
      <LuFolder size={16} />
      <Text fontSize="sm" fontWeight="semibold">{parent.display_name}</Text>
      <Text fontSize="xs" color="fg.muted">({childCount})</Text>
      {/* new badge if collapsed and has unseen children */}
      <Box flex={1} />
      <WeightPresetStrip value={parentWeight} onChange={...} />
      <CategoryContextMenu type="parent" ... />
    </Flex>
  </Collapsible.Trigger>
  <Collapsible.Content>
    {/* Children rows with connector lines */}
    <Box ml={6} pl={3} position="relative">
      {children.map((child, idx) => (
        <CategoryChildRow key={child.id} ... />
      ))}
    </Box>
  </Collapsible.Content>
</Collapsible.Root>
```

### Context Menu (Verified Pattern)
```tsx
// Source: Chakra UI v3 Menu docs - adapted for category row
<Menu.Root>
  <Menu.Trigger asChild>
    <IconButton aria-label="Actions" size="xs" variant="ghost">
      <LuMoreVertical size={14} />
    </IconButton>
  </Menu.Trigger>
  <Portal>
    <Menu.Positioner>
      <Menu.Content>
        {type === "parent" && (
          <Menu.Item value="ungroup" onClick={onUngroup}>Ungroup</Menu.Item>
        )}
        {type === "child" && (
          <Menu.Item value="reset-weight" disabled={!isOverridden} onClick={onResetWeight}>
            Reset weight
          </Menu.Item>
        )}
        <Menu.Item value="rename" onClick={onRename}>Edit name</Menu.Item>
        <Menu.Item value="hide" onClick={onHide}>Hide</Menu.Item>
        <Menu.Separator />
        <Menu.Item value="delete" color="fg.error" _hover={{ bg: "bg.error", color: "fg.error" }} onClick={onDelete}>
          Delete
        </Menu.Item>
      </Menu.Content>
    </Menu.Positioner>
  </Portal>
</Menu.Root>
```

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| DnD for category grouping (08.1) | Multi-select + action bar (08.3) | This phase | Removes unreliable DnD, adds mobile-friendly grouping |
| Hide = set weight to "block" | Hide = visibility flag only | This phase | Correct semantic separation of Hide vs Block |
| Flat list with hover-reveal actions | Collapsible tree with context menus | This phase | Better discoverability, works on mobile |
| No hidden categories section | Dedicated collapsible "Hidden (N)" section | This phase | Clean separation of active vs hidden categories |

**Code to remove (DnD-specific):**
- `CategoriesSection.tsx`: Remove `DndContext`, `DragOverlay`, `DragStartEvent`, `DragEndEvent`, `PointerSensor`, `useSensor`, `useSensors`, `useDroppable` imports and usage. Remove `activeId` state, `sensors`, `handleDragEnd`, ungroup drop zone, and `DragOverlay` render.
- `CategoryParentRow.tsx`: Remove `useDroppable` import and usage. Remove `isOver` and `activeId` props/rendering.
- `CategoryChildRow.tsx`: Remove `useSortable`, `useDroppable`, `CSS` imports. Remove sortable/droppable refs, transform/transition styles, drag grip icon (`LuGripVertical`).
- `CategoryRow.tsx`: Can be deleted entirely (uses old string-based API, still has DnD).
- `SwipeableRow.tsx`: May be removable if context menus fully replace the swipe-to-edit pattern. Evaluate during implementation.

## Backend Changes Required

### 1. Fix Hide Semantics
Current `hide_category` sets `weight = "block"`. CONTEXT.md says hide should NOT affect weight.

**Change:** `hide_category` should only set `is_hidden = True`. Remove `category.weight = "block"` line.

### 2. Fix Unhide Semantics
Current `unhide_category` only toggles `is_hidden` and conditionally resets weight. CONTEXT.md says unhide should also clear `parent_id`.

**Change:** Add `category.parent_id = None` to unhide endpoint.

### 3. Add Batch Endpoints
Need 4 new endpoints:
- `POST /api/categories/batch-move` -- move multiple categories to a parent (or ungroup with parent_id = -1)
- `POST /api/categories/batch-hide` -- hide multiple categories
- `POST /api/categories/batch-delete` -- delete multiple categories
- `POST /api/categories/{id}/ungroup` -- ungroup a parent (preserve inherited weights)

### 4. Add Ungroup Parent Logic
When ungrouping a parent:
1. For each child where `weight IS NULL`: set `weight = parent.weight` (preserve effective weight)
2. Set all children `parent_id = None`
3. Parent itself becomes ungrouped (no children) -- no data deleted

### 5. Update LLM Prompt for Hidden Categories
The CONTEXT.md says hidden categories should appear in the LLM prompt with instruction to avoid them. Currently `get_active_categories()` in `scoring.py` excludes hidden categories entirely. This needs to change:
- Active categories: `is_hidden == False` (as now)
- Hidden categories: include in prompt with "NEVER assign these categories" instruction
- This requires updating `build_categorization_prompt()` to accept a `hidden_categories` parameter

## Open Questions

1. **Batch ungroup from action bar -- which categories?**
   - What we know: Action bar "Ungroup" = ungroup selected children. Context menu "Ungroup" on parent = ungroup all children + parent becomes ungrouped.
   - What's unclear: If selected categories include both grouped children from different parents, should "Ungroup" from action bar just remove their parent_id (move to ungrouped), or should it also preserve their effective weights?
   - Recommendation: Same logic as parent ungroup -- any child with `weight IS NULL` gets `weight = parent.weight` before `parent_id` is cleared. This is safe and consistent.

2. **Mobile card layout breakpoint**
   - What we know: CONTEXT.md specifies below Chakra `sm` breakpoint (480px / 30em).
   - What's unclear: Whether the existing `md` breakpoint patterns in WeightPresetStrip and hover-reveal actions will conflict.
   - Recommendation: The card layout replaces the entire row component below `sm`, so existing `md` breakpoints in child components become irrelevant. Use responsive `display` props to switch between row and card layouts.

3. **Search filtering + selection interaction**
   - What we know: Search already works in CategoriesSection. Selection is new.
   - What's unclear: Should search filter clear the selection? Should selected but filtered-out items remain selected?
   - Recommendation: Keep selection across search filter changes. The action bar count should reflect total selected (including filtered-out). This prevents accidental deselection when searching.

## Sources

### Primary (HIGH confidence)
- Chakra UI v3 MCP -- ActionBar, Collapsible, Menu, Checkbox, Dialog component examples and patterns
- Codebase analysis -- All category component files, backend routes, models, and scoring pipeline

### Secondary (MEDIUM confidence)
- Chakra UI v3 default breakpoints (sm = 30em / 480px) -- from Chakra defaults documentation

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH -- All components are native Chakra UI v3, already installed and used in the project
- Architecture: HIGH -- Clear mapping from locked decisions to component structure, existing patterns to follow
- Pitfalls: HIGH -- Based on direct codebase analysis of existing hide/unhide behavior, DnD dependency graph, and state management patterns

**Research date:** 2026-02-17
**Valid until:** 2026-03-17 (stable -- no external library changes expected)
