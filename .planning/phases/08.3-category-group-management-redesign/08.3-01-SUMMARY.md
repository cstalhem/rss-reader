---
phase: 08.3-category-group-management-redesign
plan: 01
subsystem: api
tags: [fastapi, pydantic, sqlmodel, llm-prompt, batch-operations]

# Dependency graph
requires:
  - phase: 08.2-category-data-model-refactor
    provides: Category SQLModel table with parent_id, is_hidden, weight fields
provides:
  - Fixed hide/unhide semantics (visibility flag only, no weight coupling)
  - Batch move, batch hide, batch delete endpoints for multi-select actions
  - Ungroup parent endpoint for dissolving category groups
  - Hidden categories in LLM categorization prompt with avoidance instruction
affects: [08.3-02, 08.3-03, 08.3-04, 08.3-05]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Batch endpoint pattern: POST with category_ids array, return {ok, count}"
    - "Weight preservation on ungroup: copy parent weight to children with null weight before clearing parent_id"
    - "Hidden categories in LLM prompt: NEVER assign instruction for blocked topics"

key-files:
  created: []
  modified:
    - backend/src/backend/main.py
    - backend/src/backend/scoring.py
    - backend/src/backend/prompts.py
    - backend/src/backend/scoring_queue.py

key-decisions:
  - "Hide = is_hidden + clear parent_id (leave group), no weight change"
  - "Batch endpoints use POST with JSON body (not PATCH) for multi-ID operations"
  - "Weight preservation: copy parent.weight to child before clearing parent_id when child.weight is null"
  - "Hidden categories sent to LLM as NEVER assign instruction to prevent re-categorization into blocked topics"

patterns-established:
  - "Batch operation endpoints: POST /api/categories/batch-{action} with category_ids array"
  - "Parent ungroup: preserve inherited weights before dissolving group structure"

requirements-completed: [CATGRP-02, CATGRP-03]

# Metrics
duration: 3.3min
completed: 2026-02-18
---

# Phase 08.3 Plan 01: Backend Batch Endpoints and Hide/Unhide Fix Summary

**Fixed hide/unhide semantics (visibility-only), added batch-move/hide/delete endpoints, ungroup parent endpoint, and hidden categories in LLM prompt**

## Performance

- **Duration:** 3.3 min
- **Started:** 2026-02-18T12:00:26Z
- **Completed:** 2026-02-18T12:03:43Z
- **Tasks:** 2
- **Files modified:** 4

## Accomplishments
- Hide endpoint decoupled from weight (is_hidden=True + clear parent_id, no weight=block)
- Three batch endpoints for multi-select action bar: batch-move, batch-hide, batch-delete
- Ungroup parent endpoint dissolves groups while preserving inherited weights
- LLM categorization prompt now includes hidden categories with "NEVER assign" avoidance instruction

## Task Commits

Each task was committed atomically:

1. **Task 1: Fix hide/unhide semantics and add batch endpoints** - `3e38c78` (feat)
2. **Task 2: Update LLM prompt to include hidden categories with avoidance instruction** - `944d637` (feat)

## Files Created/Modified
- `backend/src/backend/main.py` - Fixed hide/unhide endpoints, added CategoryBatchMove/CategoryBatchAction models, batch-move/hide/delete endpoints, ungroup endpoint
- `backend/src/backend/scoring.py` - get_active_categories returns hidden category names as third tuple element, categorize_article accepts hidden_categories parameter
- `backend/src/backend/prompts.py` - build_categorization_prompt includes hidden categories with "NEVER assign" instruction
- `backend/src/backend/scoring_queue.py` - Unpacks hidden_categories from get_active_categories, passes to categorize_article

## Decisions Made
- Hide sets is_hidden=True + clears parent_id (leave group on hide). No weight change -- hide is a visibility flag per CONTEXT.md.
- Unhide keeps existing behavior (conditional weight reset if block, parent_id already cleared on hide)
- Batch endpoints use POST method with JSON body containing category_ids array
- Weight preservation on ungroup/batch-move: copy parent.weight to child.weight when child has null weight before clearing parent_id
- batch-delete releases children to root with weight preservation before deleting
- Hidden categories appear in LLM prompt as "NEVER assign these categories or similar topics"

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Updated scoring_queue.py to unpack third return value**
- **Found during:** Task 2 (LLM prompt update)
- **Issue:** scoring_queue.py calls get_active_categories and unpacks only 2 values; after adding the third return value (hidden_categories), this would break
- **Fix:** Updated the unpacking in scoring_queue.py to include hidden_categories and pass it to categorize_article
- **Files modified:** backend/src/backend/scoring_queue.py
- **Verification:** ruff check passes, tests pass
- **Committed in:** 944d637 (Task 2 commit)

---

**Total deviations:** 1 auto-fixed (1 blocking)
**Impact on plan:** Essential fix to prevent runtime error from tuple unpacking mismatch. No scope creep.

## Issues Encountered
None

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- All batch endpoints ready for frontend consumption in Plan 02 (multi-select action bar)
- Ungroup endpoint ready for Plan 03 (group management)
- Hidden category avoidance in LLM prompt active immediately for new articles

## Self-Check: PASSED

All files verified present. All commit hashes verified in git log.

---
*Phase: 08.3-category-group-management-redesign*
*Completed: 2026-02-18*
