---
phase: 08.3-category-group-management-redesign
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/components/settings/CategoriesSection.tsx
  - frontend/src/components/settings/CategoryTree.tsx
  - frontend/src/components/settings/CategoryParentRow.tsx
  - frontend/src/components/settings/CategoryChildRow.tsx
  - frontend/src/components/settings/CategoryUngroupedRow.tsx
autonomous: true
requirements: [CATGRP-02]

must_haves:
  truths:
    - "No DnD code remains in category components (DnD imports, sensors, handlers, drag overlay, drop zones all removed)"
    - "Parent rows are collapsible with expand/collapse persisted in localStorage"
    - "Default state is collapsed for all parents"
    - "Child rows show checkboxes (always visible) for multi-select"
    - "Ungrouped rows rendered by dedicated CategoryUngroupedRow component (no parent-related props)"
    - "Parent rows do NOT have checkboxes"
    - "Selection state managed centrally in CategoriesSection as Set<number>"
  artifacts:
    - path: "frontend/src/components/settings/CategoriesSection.tsx"
      provides: "Selection state management, no DnD context"
    - path: "frontend/src/components/settings/CategoryTree.tsx"
      provides: "Tree with collapsible parents, selection props"
    - path: "frontend/src/components/settings/CategoryParentRow.tsx"
      provides: "Collapsible parent row with Chakra Collapsible component"
    - path: "frontend/src/components/settings/CategoryChildRow.tsx"
      provides: "Child row with checkbox, no DnD sortable/droppable"
    - path: "frontend/src/components/settings/CategoryUngroupedRow.tsx"
      provides: "Ungrouped row with checkbox, no parent-related props (parentWeight, isOverridden, onResetWeight)"
  key_links:
    - from: "frontend/src/components/settings/CategoriesSection.tsx"
      to: "frontend/src/components/settings/CategoryTree.tsx"
      via: "selectedIds + toggleSelection + expandedParents props"
      pattern: "selectedIds"
    - from: "frontend/src/components/settings/CategoryTree.tsx"
      to: "frontend/src/components/settings/CategoryParentRow.tsx"
      via: "Collapsible parent rows with children inside Collapsible.Content"
      pattern: "Collapsible"
---

<objective>
Strip all DnD code from category components, add collapsible parent rows with localStorage persistence, and add checkbox multi-select on child/ungrouped rows.

Purpose: This is the foundational UI restructuring that replaces DnD with the new multi-select paradigm. All subsequent plans build on this cleaned-up component structure.

Output: Category tree renders with collapsible parents (default collapsed), checkboxes on child/ungrouped rows, and selection state in CategoriesSection. No DnD code remains.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08.3-category-group-management-redesign/08.3-RESEARCH.md

@frontend/src/components/settings/CategoriesSection.tsx
@frontend/src/components/settings/CategoryTree.tsx
@frontend/src/components/settings/CategoryParentRow.tsx
@frontend/src/components/settings/CategoryChildRow.tsx
@frontend/src/hooks/useLocalStorage.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Strip DnD from CategoriesSection and add selection state</name>
  <files>frontend/src/components/settings/CategoriesSection.tsx</files>
  <action>
  **Remove all DnD code:**
  - Remove imports: `DndContext`, `DragOverlay`, `DragStartEvent`, `DragEndEvent`, `PointerSensor`, `useSensor`, `useSensors`, `useDroppable` from `@dnd-kit/core`.
  - Remove state: `activeId`, `isDndDisabled`.
  - Remove: `sensors` (useSensors/useSensor).
  - Remove: `setUngroupDropRef`, `isOverUngroup` (useDroppable for ungroup-zone).
  - Remove: `handleDragEnd` callback.
  - Remove from JSX: entire `<DndContext>` wrapper (keep CategoryTree inside), ungroup drop zone Box, `<DragOverlay>` block.
  - Remove props passed to CategoryTree: `isDndEnabled`, `activeId`.

  **Add selection state:**
  - Add `useState<Set<number>>(new Set())` for `selectedIds`.
  - Add `toggleSelection` callback: `(id: number) => setSelectedIds(prev => { const next = new Set(prev); if (next.has(id)) next.delete(id); else next.add(id); return next; })`.
  - Add `clearSelection` callback: `() => setSelectedIds(new Set())`.

  **Add expand/collapse state:**
  - Import `useLocalStorage` from `@/hooks/useLocalStorage`.
  - Add `const [expandedParents, setExpandedParents] = useLocalStorage<Record<number, boolean>>("category-expanded-parents", {})`.
  - Add `toggleParent` callback: `(parentId: number) => setExpandedParents(prev => ({ ...prev, [parentId]: !prev[parentId] }))`.

  **Pass new props to CategoryTree:**
  - `selectedIds={selectedIds}`
  - `onToggleSelection={toggleSelection}`
  - `expandedParents={expandedParents}`
  - `onToggleParent={toggleParent}`
  - Keep all existing props: `parents`, `childrenMap`, `ungroupedCategories`, `newCategoryIds`, `onWeightChange`, `onResetWeight`, `onHide`, `onBadgeDismiss`, `onRename`, `onDelete`.
  </action>
  <verify>
  Run `cd /Users/cstalhem/projects/rss-reader/frontend && npx tsc --noEmit` to verify TypeScript compiles.
  </verify>
  <done>
  - No DnD imports or usage in CategoriesSection
  - Selection state (selectedIds, toggleSelection, clearSelection) exists
  - Expand/collapse state persisted via useLocalStorage
  - Props passed to CategoryTree for selection and collapsible state
  </done>
</task>

<task type="auto">
  <name>Task 2: Collapsible parent rows and checkboxes on child/ungrouped rows</name>
  <files>frontend/src/components/settings/CategoryTree.tsx, frontend/src/components/settings/CategoryParentRow.tsx, frontend/src/components/settings/CategoryChildRow.tsx</files>
  <action>
  **Update CategoryTree.tsx:**
  - Add to interface: `selectedIds: Set<number>`, `onToggleSelection: (id: number) => void`, `expandedParents: Record<number, boolean>`, `onToggleParent: (parentId: number) => void`.
  - Remove from interface: `isDndEnabled`, `activeId`.
  - Wrap each parent group in a pattern where `CategoryParentRow` receives `isExpanded={expandedParents[parent.id] ?? false}` and `onToggleExpand={() => onToggleParent(parent.id)}`.
  - Wrap children in Chakra `Collapsible.Root` with `open={expandedParents[parent.id] ?? false}` and `onOpenChange={() => onToggleParent(parent.id)}`. Place children inside `Collapsible.Content`.
  - Note: The parent row itself acts as the trigger. Use `Collapsible.Trigger asChild` on the parent row's clickable area, OR use controlled state only (since we need the `onOpenChange` to flow through localStorage). Use **controlled state only** — the `CategoryParentRow` click triggers `onToggleExpand` which updates localStorage state, which flows back as `open` prop. Do NOT use `Collapsible.Trigger` (it would add its own toggle logic conflicting with controlled state).
  - Import `Collapsible` from `@chakra-ui/react`.
  - Pass `isSelected` and `onToggleSelection` to `CategoryChildRow` for both children and ungrouped rows.
  - Remove `isDndEnabled` and `activeId` props from CategoryParentRow and CategoryChildRow.

  **Update CategoryParentRow.tsx:**
  - Remove all DnD imports: `useDroppable` from `@dnd-kit/core`.
  - Remove: `setNodeRef`, `isOver` from useDroppable.
  - Remove: `isDndEnabled`, `activeId` from props interface.
  - Remove: the drop placeholder Box at the bottom of the row.
  - Remove: `ref={setNodeRef}` from the Flex.
  - Remove: `SwipeableRow` wrapper (replaced by context menu in a later plan). Import and usage of SwipeableRow removed.
  - Add props: `isExpanded: boolean`, `onToggleExpand: () => void`.
  - Add a chevron icon (`LuChevronRight` from react-icons/lu) at the start of the row. Apply `transform: rotate(90deg)` when `isExpanded` is true, with `transition: transform 0.2s`.
  - Make the parent row name area clickable to toggle expand (call `onToggleExpand` on click of the name/chevron area).
  - Keep: folder icon, display_name, child count, weight strip, rename/delete hover buttons.
  - Add a "new" count chip when parent is collapsed and has unseen children. Accept `newChildCount: number` prop (computed by CategoryTree). Show a chip like `<Badge colorPalette="accent" size="sm">{newChildCount} new</Badge>` when `!isExpanded && newChildCount > 0`. Make chip clickable to dismiss (accept `onDismissNewChildren?: () => void` prop).

  **Update CategoryChildRow.tsx:**
  - Remove all DnD imports: `useSortable` from `@dnd-kit/sortable`, `useDroppable` from `@dnd-kit/core`, `CSS` from `@dnd-kit/utilities`.
  - Remove: sortable ref, droppable ref, combined ref callback, style object with transform/transition, `isDragging`, `isOver`, `attributes`, `listeners`.
  - Remove: `isDndEnabled` from props interface.
  - Remove: `SwipeableRow` wrapper. Import and usage removed.
  - Remove: the drag grip icon (`LuGripVertical`).
  - Add props: `isSelected: boolean`, `onToggleSelection: () => void`.
  - Add a `Checkbox` (from `@chakra-ui/react`) at the start of the row, before the category name. Use `checked={isSelected}` and `onCheckedChange={() => onToggleSelection()}`. Add `onClick={(e) => e.stopPropagation()}` to prevent row click propagation.
  - The Flex should no longer have `ref`, `style`, DnD-dependent `bg` coloring, or `attributes/listeners`.
  - Keep: display_name, new badge, weight strip, hover-reveal pencil/trash/hide buttons.

  **Create CategoryUngroupedRow.tsx:**
  - New component for ungrouped categories (categories with no parent).
  - Props: `category: Category`, `weight: string`, `isNew?: boolean`, `isSelected: boolean`, `onWeightChange: (weight: string) => void`, `onHide: () => void`, `onBadgeDismiss?: () => void`, `onToggleSelection: () => void`, `onRename: (newName: string) => void`, `onDelete: () => void`.
  - NOTE: No `parentWeight`, `isOverridden`, or `onResetWeight` props — ungrouped rows have no parent to inherit from or reset to.
  - Same visual structure as CategoryChildRow: Checkbox at start, category name (with inline rename), new badge, spacer, WeightPresetStrip (with `isOverridden={false}`, no reset), hover-reveal action buttons.
  - Copy the rename logic (isRenaming state, inputRef, handleRenameSubmit, handleRenameCancel) from CategoryChildRow.
  - Export as `React.memo` wrapped component.

  **Update CategoryTree.tsx to use CategoryUngroupedRow:**
  - Import `CategoryUngroupedRow` from `./CategoryUngroupedRow`.
  - In the ungrouped categories section (currently rendering `CategoryChildRow`), replace with `CategoryUngroupedRow`.
  - Pass props: `category`, `weight={category.weight ?? "normal"}`, `isNew`, `isSelected`, `onWeightChange`, `onHide`, `onBadgeDismiss`, `onToggleSelection`, `onRename`, `onDelete`.
  - Do NOT pass `parentWeight`, `isOverridden`, or `onResetWeight`.
  </action>
  <verify>
  Run `cd /Users/cstalhem/projects/rss-reader/frontend && npx tsc --noEmit` to verify TypeScript compiles.
  Run `cd /Users/cstalhem/projects/rss-reader/frontend && bun run build` to verify production build succeeds.
  </verify>
  <done>
  - No DnD code in CategoryTree, CategoryParentRow, or CategoryChildRow
  - Parent rows have chevron icon and clickable name to expand/collapse
  - Children render inside Collapsible.Content, default collapsed
  - Child and ungrouped rows have always-visible checkboxes
  - Ungrouped rows use dedicated CategoryUngroupedRow component (no parentWeight/isOverridden/onResetWeight)
  - Parent rows do NOT have checkboxes
  - Collapsed parent shows "N new" chip when unseen children exist
  - Build passes with no errors
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. `bun run build` succeeds
3. No `@dnd-kit` imports remain in category component files (feeds still use them — that's correct)
4. Visual: Parent rows show chevron + folder + name + count + weight strip
5. Visual: Child rows show checkbox + name + badge + weight strip
6. Visual: Ungrouped rows (CategoryUngroupedRow) show same layout but without parent-related controls
</verification>

<success_criteria>
- Category tree renders without DnD
- Parents are collapsible, default collapsed, state persisted in localStorage
- Checkboxes on child/ungrouped rows toggle selection
- No TypeScript or build errors
</success_criteria>

<output>
After completion, create `.planning/phases/08.3-category-group-management-redesign/08.3-02-SUMMARY.md`
</output>
