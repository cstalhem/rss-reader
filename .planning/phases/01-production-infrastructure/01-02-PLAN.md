---
phase: 01-production-infrastructure
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/next.config.ts
  - frontend/Dockerfile
  - frontend/.dockerignore
autonomous: true

must_haves:
  truths:
    - "Frontend container builds successfully with standalone Next.js output"
    - "Frontend image is optimized (< 200MB) using standalone mode"
    - "Container serves Next.js app on port 3000"
  artifacts:
    - path: "frontend/next.config.ts"
      provides: "Next.js configuration with standalone output"
      contains: "output: 'standalone'"
    - path: "frontend/Dockerfile"
      provides: "Multi-stage Docker build for frontend"
      contains: "FROM node"
    - path: "frontend/.dockerignore"
      provides: "Docker build exclusions"
      min_lines: 4
  key_links:
    - from: "frontend/Dockerfile"
      to: ".next/standalone"
      via: "COPY from builder stage"
      pattern: "COPY.*standalone"
---

<objective>
Create production Docker build for Next.js frontend using standalone output mode for minimal image size.

Purpose: Containerize frontend with optimized build that includes only necessary runtime files.
Output: Frontend Dockerfile producing minimal production image.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-production-infrastructure/01-CONTEXT.md
@.planning/phases/01-production-infrastructure/01-RESEARCH.md
@frontend/package.json
@frontend/next.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure Next.js standalone output and create Dockerfile</name>
  <files>
    frontend/next.config.ts
    frontend/Dockerfile
    frontend/.dockerignore
  </files>
  <action>
    1. Update frontend/next.config.ts:
       - Add output: 'standalone' to the config object
       - Keep any existing configuration options

    2. Create frontend/.dockerignore:
       - node_modules/
       - .next/
       - .git/
       - .env*.local
       - *.log
       - .eslintcache
       - npm-debug.log*

    3. Create frontend/Dockerfile with multi-stage build:

       Dependencies stage (FROM node:22-alpine AS deps):
       - WORKDIR /app
       - COPY package.json package-lock.json* ./
       - RUN npm ci (or npm install if no lock file)

       Builder stage (FROM node:22-alpine AS builder):
       - WORKDIR /app
       - COPY --from=deps /app/node_modules ./node_modules
       - COPY . .
       - ENV NEXT_TELEMETRY_DISABLED=1
       - RUN npm run build

       Runtime stage (FROM node:22-alpine):
       - WORKDIR /app
       - ENV NODE_ENV=production NEXT_TELEMETRY_DISABLED=1 PORT=3000 HOSTNAME=0.0.0.0
       - RUN addgroup --system --gid 1001 nodejs && adduser --system --uid 1001 nextjs
       - COPY --from=builder /app/public ./public (if exists)
       - Copy standalone and static:
         - COPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./
         - COPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static
       - USER nextjs
       - EXPOSE 3000
       - HEALTHCHECK --interval=10s --timeout=5s --retries=3 CMD wget --no-verbose --tries=1 --spider http://localhost:3000/ || exit 1
       - CMD ["node", "server.js"]

    Note: The standalone build creates server.js at the root.
    The public folder may not exist yet - use conditional copy or mkdir.
  </action>
  <verify>
    Build the image:
    cd /Users/cstalhem/projects/rss-reader/frontend && docker build -t rss-reader-frontend:test .
    Verify build completes without error.

    Check image size:
    docker images rss-reader-frontend:test --format "{{.Size}}"
    Should be under 200MB (standalone mode benefit).

    Test container starts:
    docker run --rm -d --name test-frontend -p 3001:3000 rss-reader-frontend:test
    sleep 5
    curl -s http://localhost:3001/ | head -1 && echo "Frontend responding"
    docker stop test-frontend
  </verify>
  <done>
    Dockerfile builds successfully, standalone output produces minimal image, container serves app on port 3000.
  </done>
</task>

</tasks>

<verification>
1. next.config.ts has `output: 'standalone'`
2. Build produces .next/standalone directory: `cd frontend && npm run build && ls -la .next/standalone/`
3. Docker build succeeds: `docker build -t rss-reader-frontend:test frontend/`
4. Image is optimized: `docker images rss-reader-frontend:test` shows < 200MB
5. Container serves app: `curl http://localhost:3001/` returns HTML
</verification>

<success_criteria>
- next.config.ts configured for standalone output
- Dockerfile uses multi-stage build with node:22-alpine
- .dockerignore excludes node_modules, .next, .git
- Built image is under 200MB
- Container starts and serves Next.js app on port 3000
- Health check passes (wget to localhost:3000)
</success_criteria>

<output>
After completion, create `.planning/phases/01-production-infrastructure/01-02-SUMMARY.md`
</output>
