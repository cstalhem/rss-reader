---
phase: 09.4-settings-page-architecture-implementation
plan: 02
type: execute
wave: 2
depends_on: ["09.4-01"]
files_modified:
  - frontend/src/components/settings/CategoriesSection.tsx
  - frontend/src/components/settings/CategoryTree.tsx
  - frontend/src/components/settings/CategoryChildRow.tsx
  - frontend/src/components/settings/CategoryParentRow.tsx
  - frontend/src/components/settings/CategoryUngroupedRow.tsx
  - frontend/src/hooks/useCategoryTree.ts
  - frontend/src/hooks/useCategoryDialogs.ts
autonomous: true
requirements: []

must_haves:
  truths:
    - "CategoriesSection is ~200 lines (down from ~491)"
    - "CategoryTree receives ~5 props (down from 15)"
    - "Row components consume action callbacks from context instead of props"
    - "Category tree still renders correctly with parents, children, ungrouped categories"
    - "All category actions still work: weight change, rename, delete, hide, badge dismiss, ungroup"
    - "Selection checkboxes still work on child and ungrouped rows"
    - "Search filtering still filters the tree correctly"
    - "Dialog flows (delete, move, ungroup) still work end-to-end"
  artifacts:
    - path: "frontend/src/hooks/useCategoryTree.ts"
      provides: "Tree building + search filtering hook"
      exports: ["useCategoryTree"]
    - path: "frontend/src/hooks/useCategoryDialogs.ts"
      provides: "Dialog state management hook"
      exports: ["useCategoryDialogs"]
    - path: "frontend/src/components/settings/CategoriesSection.tsx"
      provides: "Simplified categories section with context provider"
      contains: "CategoryTreeContext.Provider"
  key_links:
    - from: "frontend/src/components/settings/CategoriesSection.tsx"
      to: "frontend/src/hooks/useCategoryTree.ts"
      via: "import"
      pattern: "import.*useCategoryTree"
    - from: "frontend/src/components/settings/CategoriesSection.tsx"
      to: "frontend/src/hooks/useCategoryDialogs.ts"
      via: "import"
      pattern: "import.*useCategoryDialogs"
    - from: "frontend/src/components/settings/CategoryChildRow.tsx"
      to: "frontend/src/components/settings/CategoriesSection.tsx"
      via: "context consumption"
      pattern: "useCategoryTreeContext"
---

<objective>
Decompose CategoriesSection from ~491 lines into three focused units: a tree-building hook, a dialog state hook, and a React context for action callbacks. Reduce CategoryTree props from 15 to ~5 and row component props from 10-12 to 3-5.

Purpose: Make the most complex settings section maintainable by separating data logic, dialog state, and action wiring from the rendering orchestration (Theme B from 09.3 findings).
Output: Two new hooks, one React context, CategoriesSection simplified, row components using context.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09.4-settings-page-architecture-implementation/09.4-RESEARCH.md
@.planning/phases/09.4-settings-page-architecture-implementation/09.4-01-SUMMARY.md

@frontend/src/components/settings/CategoriesSection.tsx
@frontend/src/components/settings/CategoryTree.tsx
@frontend/src/components/settings/CategoryChildRow.tsx
@frontend/src/components/settings/CategoryParentRow.tsx
@frontend/src/components/settings/CategoryUngroupedRow.tsx
@frontend/src/hooks/useCategories.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract useCategoryTree and useCategoryDialogs hooks</name>
  <files>
    frontend/src/hooks/useCategoryTree.ts
    frontend/src/hooks/useCategoryDialogs.ts
  </files>
  <action>
**useCategoryTree.ts** — Extract the 4 useMemo computations and search state from CategoriesSection into a custom hook.

Input: `categories: Category[]`
Internal state: `searchQuery`, `setSearchQuery` (useState)
Computed values (useMemo):
1. Tree structure: `parents`, `childrenMap`, `ungroupedCategories` from flat Category[] using parent_id
2. `newCategoryIds`: Set of category IDs where `!is_seen && !is_hidden`
3. `hiddenCategories`: categories where `is_hidden === true`
4. Filtered tree: `filteredParents`, `filteredChildrenMap`, `filteredUngrouped` based on searchQuery

Return: `{ parents, childrenMap, ungroupedCategories, newCategoryIds, hiddenCategories, searchQuery, setSearchQuery }`

The return values use filtered versions (filteredParents etc.) as the primary names for cleaner consumer API. See RESEARCH.md Pattern 1.

**useCategoryDialogs.ts** — Extract the 4 dialog state objects and their open/close/confirm handlers from CategoriesSection.

This hook takes stable mutation `.mutate` references (not full mutation objects) as parameters to keep useCallback dependencies stable. Specifically it needs:
- `batchMove.mutate`, `batchDelete.mutate`, `deleteCategory.mutate`, `ungroupParent.mutate` (stable mutation functions)
- `selectedIds: Set<number>`, `clearSelection: () => void` (for batch operations)
- `childrenMap: Record<number, Category[]>` (for delete confirmation child count)

State to extract from CategoriesSection:
1. `moveDialogOpen` + `setMoveDialogOpen`
2. `deleteDialogState` + `setDeleteDialogState` (the unified single/bulk DeleteDialogState)
3. `ungroupConfirmCount` + `setUngroupConfirmCount` (batch ungroup count)
4. `ungroupParentConfirm` + `setUngroupParentConfirm` ({ id, name } | null for parent ungroup)

Handlers to extract:
- `handleDeleteCategory(id, name, childCount)` — opens delete dialog for single category
- `handleDeleteConfirm()` — executes delete (single or bulk)
- `handleUngroupParent(id, name)` — opens parent ungroup confirm
- `handleUngroupParentConfirm()` — executes parent ungroup
- `handleActionMoveToGroup()` — opens move dialog
- `handleMoveToGroup(parentId)` — executes batch move
- `handleCreateAndMove(name, parentId)` — creates category then moves
- `handleActionUngroup()` — opens ungroup confirm with count
- `handleUngroupConfirm()` — executes batch ungroup

Return all state values AND handler functions. See RESEARCH.md Pattern 2.

Per RESEARCH.md Open Question 2: pass `.mutate` stable references, not full mutation objects. Type the mutate parameters explicitly.
  </action>
  <verify>
TypeScript compiles: `cd frontend && bunx tsc --noEmit --pretty 2>&1 | head -30`
  </verify>
  <done>Both hooks exist, export named functions, TypeScript compiles cleanly</done>
</task>

<task type="auto">
  <name>Task 2: Create CategoryTreeContext and refactor CategoriesSection + row components</name>
  <files>
    frontend/src/components/settings/CategoriesSection.tsx
    frontend/src/components/settings/CategoryTree.tsx
    frontend/src/components/settings/CategoryChildRow.tsx
    frontend/src/components/settings/CategoryParentRow.tsx
    frontend/src/components/settings/CategoryUngroupedRow.tsx
  </files>
  <action>
**CategoryTreeContext** — Co-locate the context definition inside CategoriesSection.tsx (per RESEARCH.md Open Question 1: single consumer, co-locate initially).

Context shape (see RESEARCH.md Pattern 3):
```typescript
interface CategoryTreeContextValue {
  onWeightChange: (categoryId: number, weight: string) => void;
  onResetWeight: (categoryId: number) => void;
  onHide: (categoryId: number) => void;
  onBadgeDismiss: (categoryId: number) => void;
  onRename: (categoryId: number, newName: string) => void;
  onDelete: (categoryId: number) => void;
  onUngroup: (categoryId: number) => void;
  selectedIds: Set<number>;
  onToggleSelection: (id: number) => void;
  newCategoryIds: Set<number>;
}
```

Export `useCategoryTreeContext()` hook that reads from context with a throw guard.

**CategoriesSection.tsx refactoring:**
1. Replace the 4 useMemo blocks + searchQuery state with `useCategoryTree(categories)` call
2. Replace the 4 dialog state blocks + handlers with `useCategoryDialogs(...)` call
3. Wrap action callbacks in useCallback (they reference mutation.mutate which is stable)
4. Memoize the context value with useMemo (per RESEARCH.md Pitfall 1 — prevents spurious re-renders of context consumers)
5. Wrap the CategoryTree area in `<CategoryTreeContext.Provider value={contextValue}>`
6. Remove all the action callback props from the CategoryTree JSX — pass only: parents, childrenMap, ungroupedCategories, expandedParents, onToggleParent
7. The file should end up ~200 lines (from ~491)

**CategoryTree.tsx:**
- Remove all action callback props from the interface (onWeightChange, onResetWeight, onHide, etc.)
- Remove selectedIds, onToggleSelection, newCategoryIds from props
- Keep: parents, childrenMap, ungroupedCategories, expandedParents, onToggleParent
- For CategoryParentRow: compute `newChildCount` locally by reading `useCategoryTreeContext().newCategoryIds` and filtering children. Compute `onDismissNewChildren` locally (per RESEARCH.md Open Question 3). Pass these as local props to CategoryParentRow.
- Pass only data props to row components (category, weight, isOverridden, parentWeight for children; category, weight, childCount, isExpanded, onToggleExpand, newChildCount, onDismissNewChildren for parents)

**CategoryChildRow.tsx:**
- Remove action callback props (onWeightChange, onResetWeight, onHide, onBadgeDismiss, onRename, onDelete, onToggleSelection, isSelected, isNew)
- Consume context: `const ctx = useCategoryTreeContext()`
- Derive `isNew`, `isSelected` from context values + `category.id`
- Bind category.id to context handlers with useCallback (e.g., `const handleRename = useCallback((newName: string) => ctx.onRename(category.id, newName), [category.id, ctx.onRename])`)
- Keep data props: category, weight, isOverridden, parentWeight

**CategoryParentRow.tsx:**
- Remove action callback props that move to context (onHide, onBadgeDismiss, onRename, onDelete, onUngroup)
- Consume context for these actions
- Keep data props: category, weight, childCount, isExpanded, onToggleExpand, newChildCount, onDismissNewChildren

**CategoryUngroupedRow.tsx:**
- Same pattern as CategoryChildRow — remove action callbacks, consume from context
- Keep data props: category, weight

Ensure React.memo is preserved on all row components. Context consumption inside memo'd components is correct — memo checks props, context changes trigger re-renders independently (this is desired behavior per RESEARCH.md Pitfall 1).
  </action>
  <verify>
Run `cd frontend && bunx tsc --noEmit --pretty 2>&1 | head -40` for type check. Run `cd frontend && bun run lint 2>&1 | tail -20` for lint. Run `cd frontend && bun run build 2>&1 | tail -10` for production build. Count CategoriesSection lines: `wc -l frontend/src/components/settings/CategoriesSection.tsx` should be ~200 (+-50).
  </verify>
  <done>CategoriesSection reduced to ~200 lines. CategoryTree has ~5 props. Row components consume actions from context with 3-5 data-only props. All category operations (weight, rename, delete, hide, badge dismiss, ungroup, selection, search) still function. Build passes.</done>
</task>

</tasks>

<verification>
1. `cd frontend && bun run build` succeeds
2. `wc -l frontend/src/components/settings/CategoriesSection.tsx` shows ~200 lines (down from ~491)
3. CategoryTree.tsx prop interface has ~5 props (count the interface fields)
4. CategoryChildRow.tsx, CategoryUngroupedRow.tsx prop interfaces have 3-5 props each
5. `grep -c "useCategoryTreeContext" frontend/src/components/settings/Category*.tsx` shows context consumed in row components
</verification>

<success_criteria>
- CategoriesSection reduced from ~491 to ~200 lines via hook extraction and context (SC3)
- CategoryTree prop count reduced from 15 to ~5 (SC4)
- Row component prop count reduced from 10-12 to 3-5 (SC4)
- useCategoryTree hook extracts tree building, newCategoryIds, hiddenCategories, search (SC3)
- useCategoryDialogs hook extracts dialog state (SC3)
- CategoryTreeContext provides action callbacks to row components (SC3)
- No functional regressions (SC11)
</success_criteria>

<output>
After completion, create `.planning/phases/09.4-settings-page-architecture-implementation/09.4-02-SUMMARY.md`
</output>
