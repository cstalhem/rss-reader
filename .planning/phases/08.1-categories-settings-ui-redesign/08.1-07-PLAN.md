---
phase: 08.1-categories-settings-ui-redesign
plan: 07
type: execute
wave: 3
depends_on:
  - 08.1-06
files_modified:
  - frontend/src/components/settings/CategoriesSection.tsx
autonomous: true
gap_closure: true
requirements:
  - CATGRP-03
  - CATGRP-04

must_haves:
  truths:
    - "Weight changes appear immediately in the UI before server responds"
    - "Weight update success shows optional toast confirmation"
    - "Weight update failure shows error toast and reverts UI"
    - "UI state matches server state after mutation settles"
  artifacts:
    - path: "frontend/src/components/settings/CategoriesSection.tsx"
      provides: "Optimistic weight mutations with toast feedback"
      exports: ["categoryWeightMutation", "resetWeightMutation"]
  key_links:
    - from: "categoryWeightMutation onMutate"
      to: "queryClient.getQueryData + setQueryData"
      via: "snapshot cache, update immediately"
      pattern: "onMutate.*setQueryData"
    - from: "categoryWeightMutation onError"
      to: "queryClient.setQueryData + toaster"
      via: "revert to snapshot, show error toast"
      pattern: "onError.*snapshot"
---

<objective>
Add optimistic updates and toast feedback to weight mutations for immediate UI response.

Purpose: Resolve major gap (Gap 4) where weight changes feel slow and have no user feedback.
Output: Instant weight updates with proper error handling and user feedback via toasts.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08.1-categories-settings-ui-redesign/08.1-UAT.md
@frontend/src/components/settings/CategoriesSection.tsx
</context>

<tasks>

<task type="auto">
  <name>Add optimistic updates and toast feedback to weight mutations</name>
  <files>frontend/src/components/settings/CategoriesSection.tsx</files>
  <action>
**Gap 4 Fix — Optimistic weight updates with toast feedback**

Root cause: Lines 68-87 show categoryWeightMutation and resetWeightMutation wait for server response then invalidate queries. Need onMutate, onError, onSuccess, onSettled pattern.

**Step 1: Import toaster**
Add to imports at top:
```typescript
import { toaster } from "@/components/ui/toaster";
```

**Step 2: Update categoryWeightMutation (lines 68-75)**

Replace with:
```typescript
const categoryWeightMutation = useMutation({
  mutationFn: ({ category, weight }: { category: string; weight: string }) =>
    apiUpdateCategoryWeight(category, weight),
  onMutate: async ({ category, weight }) => {
    // Cancel outgoing refetches
    await queryClient.cancelQueries({ queryKey: ["preferences"] });
    await queryClient.cancelQueries({ queryKey: ["categoryGroups"] });

    // Snapshot current state
    const previousPreferences = queryClient.getQueryData(["preferences"]);
    const previousCategoryGroups = queryClient.getQueryData(["categoryGroups"]);

    // Optimistically update preferences cache
    queryClient.setQueryData(["preferences"], (old: any) => {
      if (!old) return old;
      return {
        ...old,
        topic_weights: {
          ...old.topic_weights,
          [category]: weight,
        },
      };
    });

    // Return snapshot for rollback
    return { previousPreferences, previousCategoryGroups };
  },
  onError: (err, variables, context) => {
    // Revert on error
    if (context?.previousPreferences) {
      queryClient.setQueryData(["preferences"], context.previousPreferences);
    }
    if (context?.previousCategoryGroups) {
      queryClient.setQueryData(["categoryGroups"], context.previousCategoryGroups);
    }

    // Show error toast
    toaster.create({
      title: "Failed to update weight",
      description: err instanceof Error ? err.message : "Unknown error",
      type: "error",
    });
  },
  onSuccess: () => {
    // Optional success toast (can be removed if feels noisy)
    toaster.create({
      title: "Weight updated",
      type: "success",
      duration: 2000,
    });
  },
  onSettled: () => {
    // Refetch to sync with server
    queryClient.invalidateQueries({ queryKey: ["preferences"] });
    queryClient.invalidateQueries({ queryKey: ["categoryGroups"] });
  },
});
```

**Step 3: Update resetWeightMutation (lines 77-87)**

Replace with:
```typescript
const resetWeightMutation = useMutation({
  mutationFn: (category: string) => {
    const currentWeights = { ...preferences?.topic_weights };
    delete currentWeights[category];
    return apiUpdatePreferences({ topic_weights: currentWeights });
  },
  onMutate: async (category) => {
    // Cancel outgoing refetches
    await queryClient.cancelQueries({ queryKey: ["preferences"] });
    await queryClient.cancelQueries({ queryKey: ["categoryGroups"] });

    // Snapshot current state
    const previousPreferences = queryClient.getQueryData(["preferences"]);
    const previousCategoryGroups = queryClient.getQueryData(["categoryGroups"]);

    // Optimistically remove weight from cache
    queryClient.setQueryData(["preferences"], (old: any) => {
      if (!old) return old;
      const newWeights = { ...old.topic_weights };
      delete newWeights[category];
      return {
        ...old,
        topic_weights: newWeights,
      };
    });

    // Return snapshot for rollback
    return { previousPreferences, previousCategoryGroups };
  },
  onError: (err, variables, context) => {
    // Revert on error
    if (context?.previousPreferences) {
      queryClient.setQueryData(["preferences"], context.previousPreferences);
    }
    if (context?.previousCategoryGroups) {
      queryClient.setQueryData(["categoryGroups"], context.previousCategoryGroups);
    }

    // Show error toast
    toaster.create({
      title: "Failed to reset weight",
      description: err instanceof Error ? err.message : "Unknown error",
      type: "error",
    });
  },
  onSuccess: () => {
    // Optional success toast
    toaster.create({
      title: "Weight reset",
      type: "success",
      duration: 2000,
    });
  },
  onSettled: () => {
    // Refetch to sync with server
    queryClient.invalidateQueries({ queryKey: ["preferences"] });
    queryClient.invalidateQueries({ queryKey: ["categoryGroups"] });
  },
});
```

**Note on toast strategy:**
- Error toasts: ALWAYS show (user needs to know it failed)
- Success toasts: Optional (can remove if feels noisy — the instant UI update is the primary feedback)
- Duration: 2000ms for success (brief), default for errors (dismissible)

**TypeScript notes:**
- The `(old: any)` type can be refined to match PreferencesResponse type if available
- Context typing can be refined: `context: { previousPreferences: PreferencesResponse | undefined, ... }`
- For now, `any` is acceptable for quick implementation
  </action>
  <verify>
Manual verification:
```bash
cd frontend
bun dev --port 3210
```

Test flow:
1. Navigate to Categories settings
2. Click a weight icon on any category
3. Verify: UI updates INSTANTLY (before network request completes)
4. Wait for toast (success or error)
5. Refresh page — verify weight persisted

Test error handling:
1. Stop backend server
2. Click weight icon
3. Verify: UI updates instantly, then reverts after ~2s with error toast
4. Restart backend
5. Click weight icon again — verify success

Test reset weight:
1. Set explicit weight on child category
2. Click reset button
3. Verify: weight strip immediately returns to inherited (50% opacity)
4. Toast shows "Weight reset"
  </verify>
  <done>
- categoryWeightMutation has onMutate, onError, onSuccess, onSettled
- resetWeightMutation has onMutate, onError, onSuccess, onSettled
- UI updates instantly before server responds
- Error toasts show on failure and revert cache
- Success toasts provide feedback (optional, can be removed if noisy)
- onSettled invalidates queries to sync with server
  </done>
</task>

</tasks>

<verification>
Run full UAT Test 4, 5 sequence:
1. Click weight icon — UI updates instantly
2. Observe toast notification (success)
3. Simulate backend failure — observe revert + error toast
4. Test reset weight on child — instant visual feedback
5. Refresh page — verify all changes persisted
</verification>

<success_criteria>
- [ ] categoryWeightMutation uses optimistic update pattern
- [ ] resetWeightMutation uses optimistic update pattern
- [ ] Weight changes appear instantly in UI
- [ ] Error toasts show on failure with cache rollback
- [ ] Success toasts provide feedback (or removed if noisy)
- [ ] onSettled invalidates queries for server sync
- [ ] All weight operations feel immediate and responsive
</success_criteria>

<output>
After completion, create `.planning/phases/08.1-categories-settings-ui-redesign/08.1-07-SUMMARY.md`
</output>
