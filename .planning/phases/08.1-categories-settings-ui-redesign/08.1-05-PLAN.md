---
phase: 08.1-categories-settings-ui-redesign
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/backend/main.py
  - frontend/src/lib/api.ts
autonomous: true
gap_closure: true
requirements:
  - CATGRP-02
  - CATGRP-05

must_haves:
  truths:
    - "Manually created categories appear in the tree immediately after creation"
    - "Renamed ungrouped categories update correctly without showing 'New' chip"
    - "Category names with special characters (e.g., AI/ML) work in all API operations"
    - "Deleting a parent category splits the group (parent and children become ungrouped)"
  artifacts:
    - path: "backend/src/backend/main.py"
      provides: "Fixed GET /api/categories, rename endpoint, delete behavior, request body routing"
      exports: ["get_categories", "rename_category", "delete_category"]
    - path: "frontend/src/lib/api.ts"
      provides: "Updated API client for request body category operations"
      exports: ["deleteCategory", "renameCategory"]
  key_links:
    - from: "frontend/src/components/settings/CategoriesSection.tsx"
      to: "GET /api/categories"
      via: "useCategories hook fetch"
      pattern: "fetch.*api/categories"
    - from: "frontend/src/lib/api.ts"
      to: "PATCH /api/categories/rename"
      via: "request body with old_name + new_name"
      pattern: "fetch.*rename.*body"
---

<objective>
Fix backend category API gaps that prevent categories from appearing after creation, break URL routing with special characters, and delete children unintentionally.

Purpose: Resolve blockers and majors (Gaps 8, 9, 10) that prevent core CRUD operations from working correctly.
Output: Working category creation, renaming, and deletion with proper URL handling.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08.1-categories-settings-ui-redesign/08.1-01-SUMMARY.md
@.planning/phases/08.1-categories-settings-ui-redesign/08.1-03-SUMMARY.md
@.planning/phases/08.1-categories-settings-ui-redesign/08.1-UAT.md
@backend/src/backend/main.py
@frontend/src/lib/api.ts
</context>

<tasks>

<task type="auto">
  <name>Fix backend category API endpoints (create discovery, rename persistence, delete behavior, URL routing)</name>
  <files>backend/src/backend/main.py</files>
  <action>
**Gap 8 Fix — GET /api/categories must return manually_created categories:**

Lines 644-663: Modify `get_categories()` endpoint:
1. After merging article categories (line 660), load UserPreferences and get category_groups
2. Add manually_created categories to `categories_seen` dict with proper casing preservation
3. Return sorted merged list

**Gap 9 Fix — Rename must update article.categories in database:**

Lines 1008-1053: Modify `rename_category()` endpoint:
1. After updating internal lists (current code at lines 1040-1047), add DB update:
   ```python
   # Update article.categories in database
   articles = session.exec(
       select(Article).where(Article.categories.contains([old_name]))
   ).all()
   for article in articles:
       if article.categories:
           article.categories = [
               new_name if c.lower() == old_name else c
               for c in article.categories
           ]
           session.add(article)
   session.commit()
   ```

**Gap 10 Fix — Change category API routing and delete behavior:**

Problem: FastAPI path parameter `{name}` cannot handle slashes (AI/ML → 404). Solution: Use request body instead of path params.

1. **DELETE /api/categories** (line 969):
   - Change signature from `DELETE /api/categories/{name}` to `DELETE /api/categories` (no path param)
   - Add Pydantic model: `class CategoryDelete(BaseModel): name: str`
   - Change function signature to accept `body: CategoryDelete`
   - Update to use `body.name` instead of path param `name`
   - Change behavior from "delete parent, release children" to "split group":
     - If category is parent: remove from children map (makes it ungrouped), keep in manually_created
     - If category is child: remove from parent's child list, keep as ungrouped
     - Do NOT delete from manually_created unless user explicitly requested delete (not split)

2. **PATCH /api/categories/rename** (line 1008):
   - Change signature from `PATCH /api/categories/{name}/rename` to `PATCH /api/categories/rename`
   - Update Pydantic model `CategoryRename` to include: `old_name: str, new_name: str`
   - Change function signature to accept only `body: CategoryRename`
   - Update to use `body.old_name` instead of path param `name`

**Gap 10 Fix — First child deletion bug:**

Lines 982-986: The delete logic looks correct (pop parent from children dict, filter child from all parent lists). This is likely a frontend cache issue, but add defensive check:
- After popping parent from children dict, verify the parent key no longer exists before filtering children from other parents' lists
- Add logging to track what gets deleted (use Python logging module, not print)

Add Pydantic models at top of file (near other models like CategoryWeightUpdate):
```python
class CategoryDelete(BaseModel):
    name: str

class CategoryRename(BaseModel):
    old_name: str
    new_name: str
```
  </action>
  <verify>
Backend tests:
```bash
cd backend
# Test 1: Create category, verify it appears in GET /api/categories
curl -X POST http://localhost:8912/api/categories/create -H 'Content-Type: application/json' -d '{"name":"test-category"}'
curl http://localhost:8912/api/categories | jq '.[] | select(. == "test-category")'

# Test 2: Rename ungrouped category, verify articles updated
curl -X PATCH http://localhost:8912/api/categories/rename -H 'Content-Type: application/json' -d '{"old_name":"test-category","new_name":"renamed-test"}'
# Verify in DB: sqlite3 data/rss_reader.db "SELECT categories FROM articles WHERE categories LIKE '%test%';"

# Test 3: Category with slash in name
curl -X POST http://localhost:8912/api/categories/create -H 'Content-Type: application/json' -d '{"name":"ai/ml"}'
curl -X DELETE http://localhost:8912/api/categories -H 'Content-Type: application/json' -d '{"name":"ai/ml"}'

# Test 4: Split parent group
# (requires setting up parent/child relationship first via frontend or direct DB)
```
  </verify>
  <done>
- Manually created categories appear in GET /api/categories response
- Renamed categories update article.categories in database
- Category operations work with special characters (AI/ML, etc.)
- Deleting a parent splits the group (parent becomes ungrouped, children released)
  </done>
</task>

<task type="auto">
  <name>Update frontend API client to use request body for category operations</name>
  <files>frontend/src/lib/api.ts</files>
  <action>
Update category API functions to match new backend endpoints:

**deleteCategory function** (currently around line 361):
Change from:
```typescript
export async function deleteCategory(name: string) {
  const res = await fetch(`${API_BASE}/api/categories/${encodeURIComponent(name)}`, {
    method: "DELETE",
  });
  // ...
}
```

To:
```typescript
export async function deleteCategory(name: string) {
  const res = await fetch(`${API_BASE}/api/categories`, {
    method: "DELETE",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ name }),
  });
  // ...
}
```

**renameCategory function** (find existing function):
Change from:
```typescript
export async function renameCategory(oldName: string, newName: string) {
  const res = await fetch(`${API_BASE}/api/categories/${encodeURIComponent(oldName)}/rename`, {
    method: "PATCH",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ new_name: newName }),
  });
  // ...
}
```

To:
```typescript
export async function renameCategory(oldName: string, newName: string) {
  const res = await fetch(`${API_BASE}/api/categories/rename`, {
    method: "PATCH",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ old_name: oldName, new_name: newName }),
  });
  // ...
}
```

No changes needed to frontend components — the function signatures remain the same, only internal fetch calls change.
  </action>
  <verify>
Frontend verification (after backend is running):
```bash
cd frontend
bun dev --port 3210
```

Test in browser:
1. Create category "test-slash/category" — should succeed
2. Rename it — should update correctly
3. Delete it — should work without 404
4. Create parent with children, delete parent — should split group (all become ungrouped)
  </verify>
  <done>
- Frontend category operations use request body instead of URL path params
- No 404 errors on categories with special characters
- Split group behavior works (parent delete releases all to root)
  </done>
</task>

</tasks>

<verification>
Run full UAT Test 9, 10, 12 sequence:
1. Create category "ai/ml-research" — appears immediately in tree
2. Rename ungrouped category — name updates, no 'New' chip appears
3. Delete parent with children — parent and children all become ungrouped (split)

Check logs for any deletion tracking output.
</verification>

<success_criteria>
- [ ] Manually created categories appear in GET /api/categories
- [ ] Renamed ungrouped categories update in DB and frontend shows correct name
- [ ] Categories with slashes and special chars work in all API operations
- [ ] Parent delete splits group (releases all to ungrouped) instead of deleting
- [ ] No 404 errors on category API operations
- [ ] First child deletion bug resolved (add logging to verify)
</success_criteria>

<output>
After completion, create `.planning/phases/08.1-categories-settings-ui-redesign/08.1-05-SUMMARY.md`
</output>
