---
phase: 08.1-categories-settings-ui-redesign
plan: 10
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/backend/main.py
  - frontend/src/hooks/useCategories.ts
  - frontend/src/components/settings/CategoriesSection.tsx
autonomous: true
requirements: [CATGRP-01, CATGRP-04, CATGRP-05]
gap_closure: true

must_haves:
  truths:
    - "Creating a duplicate category returns 409 and shows an error toast"
    - "Creating a new category shows a success toast"
    - "Weight changes reflect instantly with near-zero perceptible delay"
  artifacts:
    - path: "backend/src/backend/main.py"
      provides: "409 Conflict response on duplicate category creation"
      contains: "409"
    - path: "frontend/src/hooks/useCategories.ts"
      provides: "Toast notifications on category create success and error"
      contains: "toaster"
    - path: "frontend/src/components/settings/CategoriesSection.tsx"
      provides: "Parallel query cancellation in optimistic mutations"
      contains: "Promise.all"
  key_links:
    - from: "useCategories.ts"
      to: "backend main.py"
      via: "POST /api/categories/create returns 409 on duplicate"
      pattern: "409"
    - from: "CategoriesSection.tsx"
      to: "TanStack Query cache"
      via: "Promise.all for parallel cancelQueries before setQueryData"
      pattern: "Promise\\.all"
---

<objective>
Fix two functional gaps from UAT round 2: missing validation/toasts on category creation, and optimistic weight update latency from sequential query cancellation.

Purpose: Close functional gaps identified in UAT R2 tests 8 and 4.
Output: Category creation with proper duplicate detection and toast feedback, plus faster optimistic weight updates.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08.1-categories-settings-ui-redesign/08.1-07-SUMMARY.md
@backend/src/backend/main.py
@frontend/src/hooks/useCategories.ts
@frontend/src/components/settings/CategoriesSection.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add backend duplicate validation and frontend toast feedback for category creation</name>
  <files>
    backend/src/backend/main.py
    frontend/src/hooks/useCategories.ts
  </files>
  <action>
**backend/main.py — Duplicate category check (Gap 3):**

In the `create_category` endpoint (`@app.post("/api/categories/create")`), after normalizing the category name to kebab-case, add a duplicate check BEFORE any mutations:

1. Collect all existing category names: combine `seen_categories`, keys of `children` map, and all child values from `children` map into a single set (all lowercased for comparison)
2. If the normalized `cat_name` already exists in this set, raise `HTTPException(status_code=409, detail=f"Category '{cat_name}' already exists")`
3. This check goes after `cat_name = body.name.strip().lower().replace(" ", "-")` and before the `seen = list(...)` line

**frontend/useCategories.ts — Toast feedback (Gap 3):**

Add `onSuccess` and `onError` handlers to `createCategoryMutation`:

1. Import `toaster` from `@/components/ui/toaster` at top of file
2. Add to createCategoryMutation:
   ```
   onSuccess: () => {
     queryClient.invalidateQueries({ queryKey: ["categoryGroups"] });
     queryClient.invalidateQueries({ queryKey: ["categories"] });
     queryClient.invalidateQueries({ queryKey: ["categories", "new-count"] });
     toaster.create({
       title: "Category created",
       type: "success",
     });
   },
   onError: (err: Error) => {
     toaster.create({
       title: "Failed to create category",
       description: err.message,
       type: "error",
     });
   },
   ```
   Note: The existing onSuccess only had invalidation. Merge the toast into it.

Also add `onError` toast to `deleteCategoryMutation` and `renameCategoryMutation` for consistency (just error toasts, no success toasts for these — they are inline operations where the UI update is the feedback).
  </action>
  <verify>
Backend: `cd /Users/cstalhem/projects/rss-reader/backend && uv run python -c "from backend.main import app; print('OK')"` to verify import.
Frontend: `cd /Users/cstalhem/projects/rss-reader/frontend && npx tsc --noEmit` to verify no type errors.
Test: creating a duplicate category name should return HTTP 409 from backend.
  </verify>
  <done>
Backend returns 409 Conflict when creating a duplicate category. Frontend shows success toast on create, error toast on failure (including duplicate). Delete and rename mutations also show error toasts on failure.
  </done>
</task>

<task type="auto">
  <name>Task 2: Optimize optimistic weight update latency</name>
  <files>
    frontend/src/components/settings/CategoriesSection.tsx
  </files>
  <action>
**CategoriesSection.tsx — Parallel query cancellation (Gap 4):**

In both `categoryWeightMutation.onMutate` and `resetWeightMutation.onMutate`, the two `await queryClient.cancelQueries()` calls are sequential, adding ~500ms latency before the optimistic `setQueryData` executes.

Fix for `categoryWeightMutation.onMutate`:
Replace:
```
await queryClient.cancelQueries({ queryKey: ["preferences"] });
await queryClient.cancelQueries({ queryKey: ["categoryGroups"] });
```
With:
```
await Promise.all([
  queryClient.cancelQueries({ queryKey: ["preferences"] }),
  queryClient.cancelQueries({ queryKey: ["categoryGroups"] }),
]);
```

Apply the same fix to `resetWeightMutation.onMutate`.

**Deduplicate categoryGroups invalidation:**

In `handleCategoryWeightChange`, after calling `categoryWeightMutation.mutate()`, the function also calls `acknowledge([category])` which triggers `acknowledgeMutation` which invalidates `["categoryGroups"]`. But the weight mutation's `onSettled` ALSO invalidates `["categoryGroups"]`. This causes a double refetch.

Fix: Remove the `acknowledge` call from `handleCategoryWeightChange`. Instead, include category acknowledgment as part of the weight mutation itself — or simply don't auto-acknowledge on weight change since the user already has explicit badge dismiss functionality. The simplest fix: remove the `acknowledge` call from `handleCategoryWeightChange` since:
- The weight mutation already invalidates categoryGroups in onSettled
- Users can dismiss new/returned badges explicitly via the X icon
- This eliminates the secondary mutation + invalidation cycle

Update the `handleCategoryWeightChange` callback:
```
const handleCategoryWeightChange = useCallback(
  (category: string, weight: string) => {
    categoryWeightMutation.mutate({ category, weight });
  },
  [categoryWeightMutation]
);
```

Remove `newCategories`, `returnedCategories`, and `acknowledge` from the dependency array since they are no longer used in this callback.
  </action>
  <verify>
`cd /Users/cstalhem/projects/rss-reader/frontend && npx tsc --noEmit` — no type errors. Weight changes should feel noticeably faster with parallel cancellation and no dual invalidation.
  </verify>
  <done>
Query cancellation in onMutate runs in parallel via Promise.all. Dual categoryGroups invalidation eliminated by removing auto-acknowledge from weight change handler. Weight updates feel near-instant.
  </done>
</task>

</tasks>

<verification>
1. `cd /Users/cstalhem/projects/rss-reader/backend && uv run ruff check .` — no lint errors
2. `cd /Users/cstalhem/projects/rss-reader/frontend && npx tsc --noEmit` — no TypeScript errors
3. `cd /Users/cstalhem/projects/rss-reader/frontend && bun run build` — production build succeeds
4. Backend: POST duplicate category name returns 409 with descriptive error
5. Frontend: success toast on category create, error toast on duplicate or failure
6. Weight clicks update UI with minimal perceptible delay
</verification>

<success_criteria>
- Backend POST /api/categories/create returns 409 Conflict for duplicate category names
- Frontend shows success toast on category creation and error toast on failure
- Optimistic weight mutations use Promise.all for parallel query cancellation
- No dual categoryGroups invalidation on weight change
- No TypeScript, lint, or build errors
</success_criteria>

<output>
After completion, create `.planning/phases/08.1-categories-settings-ui-redesign/08.1-10-SUMMARY.md`
</output>
