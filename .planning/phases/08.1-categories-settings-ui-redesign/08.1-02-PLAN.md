---
phase: 08.1-categories-settings-ui-redesign
plan: 02
type: execute
wave: 2
depends_on: ["08.1-01"]
files_modified:
  - frontend/src/lib/types.ts
  - frontend/src/lib/api.ts
  - frontend/src/hooks/useCategories.ts
  - frontend/src/components/settings/CategoriesSection.tsx
  - frontend/src/components/settings/CategoryTree.tsx
  - frontend/src/components/settings/CategoryParentRow.tsx
  - frontend/src/components/settings/CategoryChildRow.tsx
autonomous: true
requirements:
  - CATGRP-03
  - CATGRP-04

must_haves:
  truths:
    - "Category tree renders with parent-child hierarchy sorted alphabetically"
    - "Parent categories show folder icon and bolder text"
    - "Child categories are indented with CSS connector lines (BranchIndentGuide)"
    - "Weight presets display on every row with inherited weights shown dimmer"
    - "Overridden child weights show full opacity with reset button"
    - "Ungrouped root-level categories render as leaf nodes in the tree"
  artifacts:
    - path: "frontend/src/lib/types.ts"
      provides: "Updated CategoryGroups interface with children map"
      contains: "children"
    - path: "frontend/src/hooks/useCategories.ts"
      provides: "Hook updated for new data structure"
    - path: "frontend/src/components/settings/CategoryTree.tsx"
      provides: "Chakra TreeView wrapper rendering the category hierarchy"
      contains: "TreeView"
    - path: "frontend/src/components/settings/CategoryParentRow.tsx"
      provides: "Parent category row with folder icon, bold text, weight presets"
      contains: "LuFolder"
    - path: "frontend/src/components/settings/CategoryChildRow.tsx"
      provides: "Child category row with indent, weight presets, inherited dimming"
  key_links:
    - from: "frontend/src/hooks/useCategories.ts"
      to: "/api/categories/groups"
      via: "fetchCategoryGroups query"
      pattern: "categoryGroups"
    - from: "frontend/src/components/settings/CategoriesSection.tsx"
      to: "frontend/src/components/settings/CategoryTree.tsx"
      via: "component composition"
      pattern: "CategoryTree"
    - from: "frontend/src/components/settings/CategoryTree.tsx"
      to: "useCategories hook"
      via: "data from hook passed as props"
      pattern: "children"
---

<objective>
Build the frontend tree view rendering with updated types, API client, and hook for the new parent-child category model.

Purpose: Replace the accordion-based group display with an always-expanded tree view using Chakra UI v3's TreeView component. This plan establishes the visual tree structure with weight display but does NOT include DnD, search, or CRUD interactions (those come in Plan 03 and 04).

Output: Working tree view displaying parent categories (bold, folder icon) and child categories (indented with connector lines) with weight presets on every row. Inherited weights shown dimmer than overridden.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08.1-categories-settings-ui-redesign/08.1-RESEARCH.md
@.planning/phases/08.1-categories-settings-ui-redesign/08.1-01-SUMMARY.md

@frontend/src/lib/types.ts
@frontend/src/lib/api.ts
@frontend/src/hooks/useCategories.ts
@frontend/src/components/settings/CategoriesSection.tsx
@frontend/src/components/settings/CategoryRow.tsx
@frontend/src/components/settings/WeightPresets.tsx
@frontend/src/components/settings/CategoryGroupAccordion.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update frontend types, API client, and useCategories hook</name>
  <files>
    frontend/src/lib/types.ts
    frontend/src/lib/api.ts
    frontend/src/hooks/useCategories.ts
  </files>
  <action>
**types.ts:**

Replace the `CategoryGroup` and `CategoryGroups` interfaces with the new structure:

```typescript
// Remove CategoryGroup interface entirely (no more group objects with UUID ids)

export interface CategoryGroups {
  children: Record<string, string[]>;  // parent -> child category names
  hidden_categories: string[];
  seen_categories: string[];
  returned_categories: string[];
  manually_created: string[];
}
```

**api.ts:**

Add three new API client functions:

```typescript
export async function createCategory(name: string): Promise<{ name: string }> {
  const response = await fetch(`${API_BASE_URL}/api/categories/create`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ name }),
  });
  if (!response.ok) {
    throw new Error(`Failed to create category: ${response.statusText}`);
  }
  return response.json();
}

export async function deleteCategory(name: string): Promise<{ ok: boolean }> {
  const response = await fetch(
    `${API_BASE_URL}/api/categories/${encodeURIComponent(name)}`,
    { method: "DELETE" }
  );
  if (!response.ok) {
    throw new Error(`Failed to delete category: ${response.statusText}`);
  }
  return response.json();
}

export async function renameCategory(
  name: string,
  newName: string
): Promise<{ old_name: string; new_name: string }> {
  const response = await fetch(
    `${API_BASE_URL}/api/categories/${encodeURIComponent(name)}/rename`,
    {
      method: "PATCH",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ new_name: newName }),
    }
  );
  if (!response.ok) {
    throw new Error(`Failed to rename category: ${response.statusText}`);
  }
  return response.json();
}
```

Remove the `CategoryGroup` import from api.ts if it was imported (it shouldn't be, but check).

**useCategories.ts:**

Add mutations for the three new endpoints:

```typescript
import {
  // ... existing imports ...
  createCategory as apiCreateCategory,
  deleteCategory as apiDeleteCategory,
  renameCategory as apiRenameCategory,
} from "@/lib/api";
```

Add mutation hooks inside `useCategories()`:

```typescript
const createCategoryMutation = useMutation({
  mutationFn: apiCreateCategory,
  onSuccess: () => {
    queryClient.invalidateQueries({ queryKey: ["categoryGroups"] });
    queryClient.invalidateQueries({ queryKey: ["categories"] });
    queryClient.invalidateQueries({ queryKey: ["categories", "new-count"] });
  },
});

const deleteCategoryMutation = useMutation({
  mutationFn: apiDeleteCategory,
  onSuccess: () => {
    queryClient.invalidateQueries({ queryKey: ["categoryGroups"] });
    queryClient.invalidateQueries({ queryKey: ["categories"] });
    queryClient.invalidateQueries({ queryKey: ["categories", "new-count"] });
    queryClient.invalidateQueries({ queryKey: ["preferences"] });
  },
});

const renameCategoryMutation = useMutation({
  mutationFn: ({ name, newName }: { name: string; newName: string }) =>
    apiRenameCategory(name, newName),
  onSuccess: () => {
    queryClient.invalidateQueries({ queryKey: ["categoryGroups"] });
    queryClient.invalidateQueries({ queryKey: ["categories"] });
    queryClient.invalidateQueries({ queryKey: ["preferences"] });
  },
});
```

Add to return object:
```typescript
createCategory: createCategoryMutation.mutate,
deleteCategory: deleteCategoryMutation.mutate,
renameCategory: renameCategoryMutation.mutate,
```

Remove any references to the old `CategoryGroup` type from the hook if present.
  </action>
  <verify>
Run `cd /Users/cstalhem/projects/rss-reader/frontend && npx tsc --noEmit 2>&1 | head -30` to check for TypeScript errors.

Check that the old `CategoryGroup` type is no longer referenced anywhere it shouldn't be:
`grep -r "CategoryGroup" frontend/src/lib/ frontend/src/hooks/` — should only appear in types.ts as the `CategoryGroups` interface.
  </verify>
  <done>
CategoryGroups type uses children map. Three new API functions exist. useCategories hook exposes createCategory, deleteCategory, renameCategory mutations. No TypeScript errors in types, api, or hooks.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build tree view components and rewrite CategoriesSection</name>
  <files>
    frontend/src/components/settings/CategoriesSection.tsx
    frontend/src/components/settings/CategoryTree.tsx
    frontend/src/components/settings/CategoryParentRow.tsx
    frontend/src/components/settings/CategoryChildRow.tsx
  </files>
  <action>
**IMPORTANT:** Before starting, use the Chakra UI MCP tool to look up TreeView component examples and props. The research doc has examples but verify the exact API. Run: `get_component_example("TreeView")` and `get_component_props("TreeView")`.

**CategoryTree.tsx** (NEW FILE):

Create a tree rendering component using Chakra TreeView:

```typescript
"use client";

import { useMemo } from "react";
import { TreeView } from "@chakra-ui/react";
import { CategoryParentRow } from "./CategoryParentRow";
import { CategoryChildRow } from "./CategoryChildRow";
```

Props interface:
```typescript
interface CategoryTreeProps {
  children: Record<string, string[]>;  // parent -> child names
  ungroupedCategories: string[];        // root-level categories not in any parent
  topicWeights: Record<string, string> | null;
  newCategories: Set<string>;
  returnedCategories: Set<string>;
  onWeightChange: (category: string, weight: string) => void;
  onResetWeight: (category: string) => void;
  onHide: (category: string) => void;
  onBadgeDismiss: (category: string) => void;
}
```

Build the tree data structure from `children` map and `ungroupedCategories`:
- Parents are entries in the `children` map (sorted alphabetically)
- Each parent's children are sorted alphabetically
- Ungrouped categories are leaf nodes at root level (sorted alphabetically, AFTER parents)
- Use `createTreeCollection` from Chakra if it works well. If TreeView.Root expects a `collection` prop, build one. Otherwise, render the tree manually using nested TreeView components.

**FALLBACK APPROACH:** If Chakra's TreeView component API is too rigid or conflicts with the custom row rendering needed (weight presets, badges, etc.), fall back to building the tree layout manually with Box/Stack components and CSS connector lines via `::before`/`::after` pseudo-elements. The research notes this as low risk since the CSS is straightforward. The key visual requirements are:
- Vertical line from parent down to last child
- Horizontal line from vertical line to each child
- Last child uses L-shaped connector (no line below)
- Use `border-left` and `border-bottom` CSS on pseudo-elements
- Indent children by ~24px

Render each tree node:
- Parent categories: `<CategoryParentRow />`
- Child categories: `<CategoryChildRow />` (indented, with connector lines)
- Ungrouped categories: Render as simple leaf rows (reuse `CategoryChildRow` without indentation, or a simpler variant)

**CategoryParentRow.tsx** (NEW FILE):

Parent category row component:
```typescript
"use client";

import { useState } from "react";
import { Flex, Text, Box } from "@chakra-ui/react";
import { LuFolder } from "react-icons/lu";
import { WeightPresets } from "./WeightPresets";
```

Props:
```typescript
interface CategoryParentRowProps {
  category: string;        // kebab-case name
  weight: string;          // from topic_weights or "normal" default
  childCount: number;
  isNew?: boolean;
  isReturned?: boolean;
  onWeightChange: (weight: string) => void;
  onBadgeDismiss?: () => void;
}
```

Render:
- `LuFolder` icon (size 16, color `fg.muted`)
- Category name in title case, `fontWeight="semibold"`, `fontSize="sm"`
- Child count in muted text: `(N)`
- New/Returned badges (same pattern as existing CategoryRow)
- `WeightPresets` (reuse existing component for now — hover-expand strip is Plan 04)
- Hover highlights matching existing pattern: `_hover={{ bg: "bg.muted" }}`
- Padding: `py={3} px={3}`

**CategoryChildRow.tsx** (NEW FILE):

Child category row component:
```typescript
"use client";

import { useState } from "react";
import { Flex, Text, Badge, Box } from "@chakra-ui/react";
import { LuGripVertical, LuX } from "react-icons/lu";
import { WeightPresets } from "./WeightPresets";
```

Props:
```typescript
interface CategoryChildRowProps {
  category: string;
  weight: string;            // effective weight (explicit or inherited from parent)
  isOverridden: boolean;     // true if explicit override exists in topic_weights
  parentWeight: string;      // parent's weight, for reference
  isNew?: boolean;
  isReturned?: boolean;
  onWeightChange: (weight: string) => void;
  onResetWeight?: () => void;
  onHide: () => void;
  onBadgeDismiss?: () => void;
}
```

Render:
- Drag handle (`LuGripVertical`, size 14) — present but non-functional for now (DnD comes in Plan 03)
- Category name in title case, `fontSize="sm"`
- New/Returned badges with hover-reveal X dismiss (same pattern as existing CategoryRow)
- `WeightPresets` with `isOverridden` prop — inherited weights at `opacity={0.5}`, overridden at full opacity
- Reset button when overridden (existing WeightPresets handles this)
- Hide button (`LuX`) with hover-reveal (same pattern as existing)
- Slightly more compact than parent row: `py={2} px={3}`

**CategoriesSection.tsx** (REWRITE):

Gut the existing CategoriesSection and rebuild around the tree:

1. Keep the hook usage: `useCategories()` and `usePreferences()`
2. Keep the weight mutation logic (categoryWeightMutation, resetWeightMutation)
3. Keep the new/returned badge computation
4. Remove ALL accordion, DnD, checkbox, and group-related code
5. Remove imports of: CategoryGroupAccordion, GroupNamePopover, DeleteGroupDialog, DndContext, DragOverlay, useDroppable, SortableContext, and all dnd-kit imports
6. Remove the UngroupedDroppable component

Compute ungrouped categories using new structure:
```typescript
const ungroupedCategories = useMemo(() => {
  if (!categoryGroups) return allCategories;
  const childSet = new Set(
    Object.values(categoryGroups.children).flat().map(c => c.toLowerCase())
  );
  const parentSet = new Set(
    Object.keys(categoryGroups.children).map(c => c.toLowerCase())
  );
  const hidden = new Set((categoryGroups.hidden_categories ?? []).map(c => c.toLowerCase()));
  return allCategories
    .filter(c => {
      const lower = c.toLowerCase();
      return !childSet.has(lower) && !parentSet.has(lower) && !hidden.has(lower);
    })
    .sort();
}, [categoryGroups, allCategories]);
```

Render structure:
```tsx
<Stack gap={6}>
  {/* Header with title and new badge */}
  <Flex alignItems="center" gap={2}>
    <Text fontSize="xl" fontWeight="semibold">Topic Categories</Text>
    {totalNew > 0 && <Badge ...>{totalNew} new</Badge>}
    <Box flex={1} />
    {/* Create category button placeholder — functional in Plan 04 */}
  </Flex>

  {/* Category tree */}
  <CategoryTree
    children={categoryGroups?.children ?? {}}
    ungroupedCategories={ungroupedCategories}
    topicWeights={preferences?.topic_weights ?? null}
    newCategories={newCategories}
    returnedCategories={returnedCategories}
    onWeightChange={handleCategoryWeightChange}
    onResetWeight={handleResetCategoryWeight}
    onHide={handleHideCategory}
    onBadgeDismiss={handleBadgeDismiss}
  />
</Stack>
```

Keep the loading skeleton and empty state unchanged.

**NOTE on group weight change handler:** In the old model, `handleGroupWeightChange` saved a group weight inside the groups array. In the new model, parent categories ARE regular categories with weights in `topic_weights`. So `handleCategoryWeightChange` already handles parent weight changes — no special handler needed. Remove `handleGroupWeightChange` and all group CRUD handlers (handleCreateGroup, handleRenameGroup, handleDeleteGroupRequest, handleDeleteGroupConfirm). These will be reimplemented as category operations in Plan 04.
  </action>
  <verify>
Run `cd /Users/cstalhem/projects/rss-reader/frontend && npx tsc --noEmit 2>&1 | head -40` to check for TypeScript errors.

Run `cd /Users/cstalhem/projects/rss-reader/frontend && bun run build 2>&1 | tail -20` to verify the build succeeds.

Visually inspect: Start dev server (`cd frontend && bun dev --port 3210`) and navigate to Settings > Categories. Verify:
1. Parent categories show with folder icon and bold text
2. Child categories are indented below parents with connector lines
3. Weight presets appear on all rows
4. Ungrouped categories appear as flat list after parents
5. No accordion, no checkboxes, no DnD interactions (expected — Plan 03 adds DnD)
  </verify>
  <done>
Tree view renders parent-child hierarchy. Parents show folder icon + semibold text. Children are indented with CSS connector lines. Weight presets on all rows with inherited dimming. Ungrouped categories listed at root. Build passes with no TypeScript errors.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. `bun run build` succeeds
3. Category tree renders hierarchically with parents and children
4. Weight presets display correctly with inherited dimming on children
5. No references to old CategoryGroup type remain in active components
6. Hook provides createCategory, deleteCategory, renameCategory mutations
</verification>

<success_criteria>
- Categories display as always-expanded tree with parent > child hierarchy
- Parent rows: folder icon, bold text, child count, weight presets
- Child rows: indented with connector lines, weight presets with inherited dimming
- Ungrouped categories render as leaf nodes at root level
- No DnD, no search, no CRUD UI (those are Plan 03 and 04)
- TypeScript compiles, production build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/08.1-categories-settings-ui-redesign/08.1-02-SUMMARY.md`
</output>
