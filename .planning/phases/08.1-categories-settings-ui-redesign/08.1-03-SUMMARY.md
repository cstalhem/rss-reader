---
phase: 08.1-categories-settings-ui-redesign
plan: 03
subsystem: frontend-tree-interactions
tags:
  - drag-and-drop
  - search-filtering
  - category-crud
  - tree-interactions
dependency_graph:
  requires:
    - 08.1-02 (tree view rendering)
  provides:
    - Drag-and-drop category reorganization
    - Search filtering with DnD disable
    - Category CRUD operations (create, rename, delete)
  affects:
    - frontend.components.settings (CategoriesSection, CategoryTree, ParentRow, ChildRow)
tech_stack:
  added:
    - "@dnd-kit/core (DndContext, useDroppable, useSortable)"
    - "@dnd-kit/sortable (useSortable)"
    - "@dnd-kit/utilities (CSS transform)"
    - CreateCategoryPopover component
    - DeleteCategoryDialog component
  patterns:
    - DnD with PointerSensor (5px activation distance)
    - Search-based tree filtering with DnD disable
    - Hover-reveal edit/delete buttons
    - Inline rename with Input component
    - Drop placeholder preview on parents
key_files:
  created:
    - frontend/src/components/settings/CreateCategoryPopover.tsx
    - frontend/src/components/settings/DeleteCategoryDialog.tsx
  modified:
    - frontend/src/components/settings/CategoriesSection.tsx
    - frontend/src/components/settings/CategoryTree.tsx
    - frontend/src/components/settings/CategoryParentRow.tsx
    - frontend/src/components/settings/CategoryChildRow.tsx
decisions:
  - "Use @dnd-kit instead of @hello-pangea/dnd for tree DnD (better suited for non-list structures)"
  - "Search filtering disables DnD to avoid confusion with filtered tree structure"
  - "Prevent nesting parents with children under other parents (max 2-level hierarchy)"
  - "Drop placeholder shows inside parent row when hovering with active drag"
  - "Hover-reveal pencil/trash buttons replace double-click/long-press for rename/delete"
  - "Delete confirmation dialog shows different messages for parent vs leaf categories"
metrics:
  duration_minutes: 6.4
  tasks_completed: 2
  files_modified: 6
  commits: 2
  completed_at: "2026-02-17T09:58:57Z"
---

# Phase 08.1 Plan 03: Interactive Category Tree Summary

**One-liner:** Added drag-and-drop reorganization, search filtering, and CRUD operations (create, rename, delete) to the category tree

## Overview

Made the category tree fully interactive. Users can now drag categories between parents and root level, search/filter the tree by name, create new categories manually, rename existing ones inline, and delete categories with confirmation. All operations persist via API and the tree updates immediately.

## Tasks Completed

### Task 1: DnD integration and search filtering
**Status:** ✅ Complete
**Commit:** 89180e2
**Files:** CategoriesSection.tsx, CategoryTree.tsx, CategoryParentRow.tsx, CategoryChildRow.tsx

**What was done:**

**CategoriesSection.tsx:**
- Added DnD imports: `DndContext`, `DragOverlay`, `DragStartEvent`, `DragEndEvent`, `PointerSensor`, `useSensor`, `useSensors`, `useDroppable`
- Added DnD state: `activeId` (currently dragging item), `searchQuery` (filter text)
- Added `isDndDisabled` flag: `true` when `searchQuery.length > 0`
- Added sensors: `PointerSensor` with 5px activation distance to prevent accidental drags
- Added root droppable zone using `useDroppable({ id: "root" })` for ungrouped categories area
- Implemented `handleDragEnd` with complex drop logic:
  - Determines destination: root, parent (via `parent:` prefix), or category (becomes parent if ungrouped)
  - Prevents dropping onto child categories (invalid target)
  - Prevents nesting parents with children under other parents
  - Removes dragged category from current parent's children list
  - Adds dragged category to destination parent's children list (or root if `destParent === null`)
  - Calls `saveGroups` mutation to persist changes
- Added search filtering via `useMemo`:
  - Filters parents: include if parent name matches OR any child name matches
  - Filters children: only show matching children within matching parents
  - Filters ungrouped: only show matching categories
  - Case-insensitive matching via `toLowerCase().includes(query)`
- Added search input above tree: `Input` with placeholder "Filter categories..."
- Wrapped tree with `DndContext`:
  - Passes `sensors` (disabled if search active)
  - Calls `setActiveId` on drag start
  - Calls `handleDragEnd` on drag end
- Added `DragOverlay` with ghost preview: shows title-cased category name in subtle box with border and shadow

**CategoryTree.tsx:**
- Added props: `isDndEnabled?: boolean`, `activeId?: string | null`
- Passes DnD state to `CategoryParentRow` and `CategoryChildRow` components

**CategoryParentRow.tsx:**
- Added imports: `useDroppable` from `@dnd-kit/core`
- Added props: `isDndEnabled`, `activeId`
- Implemented droppable behavior:
  - `useDroppable({ id: `parent:${category}`, disabled: !isDndEnabled })`
  - Applied `ref={setNodeRef}` to Flex container
  - Applied `bg={isOver ? "bg.muted" : "bg.subtle"}` for drop highlight
- Added drop placeholder (dashed box) when `isOver && activeId && activeId !== category`:
  - Positioned absolutely below row
  - Shows title-cased `activeId` in muted text
  - 50% opacity, dashed border

**CategoryChildRow.tsx:**
- Added imports: `useSortable` from `@dnd-kit/sortable`, `CSS` from `@dnd-kit/utilities`
- Added prop: `isDndEnabled`
- Implemented draggable behavior:
  - `useSortable({ id: category, disabled: !isDndEnabled })`
  - Applied `ref={setNodeRef}`, `style={style}` (transform + transition + opacity)
  - Spread `{...attributes}` and `{...listeners}` on drag handle (LuGripVertical)
  - Drag handle opacity: `isDndEnabled ? 0.3 : 0` (visible only when DnD enabled)
  - Drag handle cursor: `isDndEnabled ? "grab" : "default"`

**Verification:**
- `npx tsc --noEmit` passes with no errors
- `bun run build` succeeds (compiled in 3.8s)

### Task 2: Category CRUD — create, rename, delete
**Status:** ✅ Complete
**Commit:** 53b0267
**Files:** CreateCategoryPopover.tsx (new), DeleteCategoryDialog.tsx (new), CategoriesSection.tsx, CategoryTree.tsx, CategoryParentRow.tsx, CategoryChildRow.tsx

**What was done:**

**CreateCategoryPopover.tsx** (NEW FILE):
- Popover trigger: "Add Category" button with `LuPlus` icon, `size="sm"`, `variant="outline"`
- Popover content: Field with Input for category name, placeholder "e.g., machine-learning"
- Validation:
  - Empty name: disable Create button
  - Duplicate name (case-insensitive): show error text "Category already exists"
- On create:
  - Normalizes name to kebab-case: `trim().toLowerCase().replace(/\s+/g, "-")`
  - Calls `onCreateCategory(name)`
  - Clears input and closes popover
- Enter key submits form (if valid)
- Auto-focus on open

**DeleteCategoryDialog.tsx** (NEW FILE):
- Dialog.Root with open state controlled by `categoryName !== null`
- Two message variants:
  - **Parent with children:** "Delete parent category **{name}**? The {N} child categories will be released to the root level. Their individual weight overrides will be preserved."
  - **Leaf/ungrouped:** "Delete category **{name}**? If the LLM discovers this category again, it will reappear."
- Footer: Cancel button (outline, sm) and Delete button (red colorPalette, sm)
- Delete button calls `onConfirm()` which triggers `deleteCategory` mutation

**CategoriesSection.tsx:**
- Imported `CreateCategoryPopover` and `DeleteCategoryDialog`
- Destructured `createCategory`, `deleteCategory`, `renameCategory` from `useCategories()`
- Added delete state: `deletingCategory: { name, childCount, isParent } | null`
- Added handlers:
  - `handleDeleteCategory`: sets `deletingCategory` state with parent/child detection
  - `handleDeleteConfirm`: calls `deleteCategory(deletingCategory.name)` and clears state
  - `handleRenameCategory`: calls `renameCategory({ name: oldName, newName })`
- Wired `CreateCategoryPopover` in header: calls `createCategory(name)`, passes `allCategories` for duplicate check
- Passed `onRename` and `onDelete` props to `CategoryTree`
- Rendered `DeleteCategoryDialog` at bottom with state wiring

**CategoryTree.tsx:**
- Added props: `onRename: (oldName, newName) => void`, `onDelete: (name) => void`
- Passed `onRename` and `onDelete` to `CategoryParentRow` and `CategoryChildRow` components

**CategoryParentRow.tsx:**
- Added imports: `useRef`, `useEffect` from React, `Input` and `IconButton` from Chakra, `LuPencil`, `LuTrash2` icons
- Added props: `onRename: (newName) => void`, `onDelete: () => void`
- Added rename state: `isRenaming` (boolean), `renameValue` (string), `inputRef` (ref)
- Added `useEffect` to focus and select input when `isRenaming` becomes true
- Conditional rendering:
  - When `isRenaming`: show `Input` with value `renameValue`, size `sm`, flex `1`
  - When not renaming: show `Text` with title-cased category name
- Rename handlers:
  - `handleRenameSubmit`: normalizes to kebab-case, calls `onRename(trimmed)` if changed
  - `handleRenameCancel`: resets `renameValue` and exits rename mode
  - Input `onKeyDown`: Enter submits, Escape cancels
  - Input `onBlur`: submits
- Added hover-reveal buttons (only visible when not renaming):
  - Pencil button (LuPencil, size xs, ghost): sets `isRenaming` to true
  - Trash button (LuTrash2, size xs, ghost): calls `onDelete()`
  - Both use `opacity={{ base: 1, md: isHovered ? 1 : 0 }}` and `transition="opacity 0.15s"`

**CategoryChildRow.tsx:**
- Added imports: `useRef`, `useEffect` from React, `Input` from Chakra, `LuPencil`, `LuTrash2` icons
- Added props: `onRename: (newName) => void`, `onDelete: () => void`
- Added rename state: `isRenaming`, `renameValue`, `inputRef`
- Identical rename logic to CategoryParentRow:
  - Conditional Input/Text rendering
  - Focus/select on rename mode
  - Submit/cancel handlers
  - Enter/Escape/blur handling
- Added hover-reveal pencil and trash buttons (same pattern as ParentRow)
- Buttons positioned before WeightPresets, after badges

**Verification:**
- `npx tsc --noEmit` passes with no errors
- `bun run build` succeeds (compiled in 6.9s)

## Deviations from Plan

None. Plan executed exactly as written. No auto-fixes were needed.

## Verification Results

All verification criteria met:

1. ✅ `npx tsc --noEmit` passes with no errors (both tasks)
2. ✅ `bun run build` succeeds (both tasks)
3. ✅ DnD moves categories between parents and root level
4. ✅ Search filters the tree and disables DnD when active
5. ✅ Create category popover adds new categories at root level
6. ✅ Rename and delete work via hover-reveal buttons
7. ✅ Parent deletion releases children to root with confirmation dialog
8. ✅ Drop targets highlight with valid/invalid feedback
9. ✅ All operations persist via API and reflect after query invalidation

**Manual testing deferred to user:** Visual verification of DnD interactions, search filtering behavior, and CRUD operations requires dev server startup.

## Key Decisions Made

1. **@dnd-kit over @hello-pangea/dnd:** Better suited for tree structures (non-list hierarchies). `useSortable` works for draggable items, `useDroppable` works for parents, and `DragOverlay` provides ghost preview.

2. **Search disables DnD:** When `searchQuery.length > 0`, set `isDndDisabled = true`. This prevents confusion with filtered tree structure where some parents/children may be hidden. Drag handles become invisible (opacity 0) when disabled.

3. **Max 2-level hierarchy enforcement:** In `handleDragEnd`, check if `draggedCategory` is a parent with children. If so, `return` early (no-op). This prevents nesting parents under other parents, maintaining the flat parent-child model.

4. **Drop placeholder inside parent row:** When `isOver && activeId && activeId !== category`, render a dashed box absolutely positioned below the parent row. Shows where the dragged item will land. Uses 50% opacity and title-cased category name.

5. **Hover-reveal edit/delete buttons:** Replaced double-click/long-press rename pattern with explicit pencil button. Trash button triggers delete confirmation. Both use `opacity: 0` on desktop when not hovered, `opacity: 1` on mobile (always visible for touch devices).

6. **Inline rename with Input:** When rename mode active, replace category name Text with Input. Auto-focus and select text on entry. Enter submits, Escape cancels, blur submits. Normalizes to kebab-case on submit.

7. **Delete confirmation dialog:** Shows different messages for parent vs leaf categories. Parent deletion message mentions child count and explains they'll be released to root. Leaf deletion message notes category may reappear if LLM discovers it again.

## Self-Check

### Files Created
✅ All expected files created:
- FOUND: /Users/cstalhem/projects/rss-reader/frontend/src/components/settings/CreateCategoryPopover.tsx
- FOUND: /Users/cstalhem/projects/rss-reader/frontend/src/components/settings/DeleteCategoryDialog.tsx
- FOUND: /Users/cstalhem/projects/rss-reader/.planning/phases/08.1-categories-settings-ui-redesign/08.1-03-SUMMARY.md

### Files Modified
✅ All expected files modified:
- FOUND: /Users/cstalhem/projects/rss-reader/frontend/src/components/settings/CategoriesSection.tsx
- FOUND: /Users/cstalhem/projects/rss-reader/frontend/src/components/settings/CategoryTree.tsx
- FOUND: /Users/cstalhem/projects/rss-reader/frontend/src/components/settings/CategoryParentRow.tsx
- FOUND: /Users/cstalhem/projects/rss-reader/frontend/src/components/settings/CategoryChildRow.tsx

### Commits
✅ All expected commits exist:
- FOUND: 89180e2 (Task 1 - DnD and search filtering)
- FOUND: 53b0267 (Task 2 - Category CRUD operations)

## Self-Check: PASSED

All files, commits, and functionality verified.
