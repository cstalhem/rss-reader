# Phase 08.1: Categories Settings UI Redesign - Research

**Researched:** 2026-02-17
**Domain:** Tree view UI, drag-and-drop for hierarchical data, parent-child category model, CSS connector lines, animated weight presets, mobile swipe gestures
**Confidence:** HIGH

## Summary

Phase 08.1 replaces the accordion-based category group UI (which has fundamental DnD incompatibility with collapsed drop targets) with an always-expanded tree view. The core paradigm shift is from "groups contain categories" to "categories can contain categories" -- any category can become a parent by having children dragged onto it.

The strongest technical approach uses **Chakra UI v3's native TreeView component** (available since v3.22, installed at v3.32.0) for tree rendering, indent guides, filtering, and node mutation, combined with the **existing @dnd-kit library** (core 6.3.1 + sortable 10.0.0) for drag-and-drop between tree levels. Chakra's TreeView provides `createTreeCollection`, `BranchIndentGuide` (CSS connector lines), built-in filtering via `useFilter`, and node mutation APIs (`collection.remove()`, `collection.replace()`) -- eliminating the need for any third-party tree library. DnD must be layered on top since Chakra TreeView does not include built-in drag-and-drop support.

The data model change is straightforward: replace the `category_groups.groups` array with a `children` map keyed by parent category name, where each entry is an array of child category names. The three-tier weight resolution (explicit override > parent weight > default normal 1.0) maps cleanly to the existing `compute_composite_score` function with minimal changes.

**Primary recommendation:** Use Chakra UI v3 TreeView for the visual tree (connector lines, filtering, node rendering) and keep @dnd-kit for drag-and-drop. Build a custom tree layout rather than using a third-party tree library -- the existing Chakra+dnd-kit stack covers all needs.

<user_constraints>

## User Constraints (from CONTEXT.md)

### Locked Decisions

**Layout paradigm:**
- Tree view with always-expanded parent-child hierarchy (no collapse)
- CSS-drawn connector lines between parent and children (vertical + horizontal lines, not ASCII characters)
- Parent categories distinguished by a folder icon + slightly bolder text
- Child categories indented with tree connector lines (similar to `|--` and `L--` visual pattern but rendered via CSS borders/pseudo-elements)
- Maximum 2 levels of nesting for now (parent > child), but design data model to support deeper nesting later
- All categories sorted alphabetically within their level

**Data model change:**
- Categories-as-parents: Remove the separate "group" concept entirely. Categories can have child categories
- Any ungrouped (root-level) category can become a parent by having children dragged onto it
- Parent categories have their own score weight AND act as the default weight for children
- Child categories inherit parent weight unless explicitly overridden
- Three-tier weight resolution remains: explicit override > parent weight > default normal (1.0)
- Inherited weights displayed slightly dimmer than overridden weights on child categories

**Weight presets interaction:**
- Collapsed by default: Each row shows only the currently selected weight (as an icon)
- Hover expands: On hover, the full set of weight icons slides in from the right, with the active icon smoothly moving to its correct position in the set
- Desktop: Weight icons have hover tooltips spelling out the weight name
- Mobile: Weight icons show text labels alongside them (since no hover)
- Research needed: exact icon choices for block/reduce/normal/boost/max

**Category assignment (DnD):**
- Drag-and-drop for moving categories between parents, kept as the primary interaction
- Drop targets: root level (ungrouped area), existing parent categories (categories that already have children), and any ungrouped root-level category (which becomes a parent upon receiving a child)
- Cannot drop onto a leaf category that is already a child of a parent -- must first drag it to root level to make it eligible as a parent
- Children can be moved directly between existing parents
- Drop feedback: valid targets get a highlight, ghost preview shows where the category would land in the tree
- DnD disabled when search filter is active
- DnD library: Research needed

**Category management:**
- Manual category creation: Header action button opens popover/dialog to name a new category. Created at root level as an ungrouped leaf
- Renaming: Desktop hover reveals edit button; mobile uses right-to-left swipe gesture to reveal edit button. No reserved space for hidden icons
- Deleting a parent: Children become ungrouped (released to root level). Confirmation dialog shows impact
- Deleting any category: Both LLM-discovered and manually-created categories can be deleted. No blocklisting -- deleted categories may return if the LLM discovers them again
- New category badges: Existing "new" category marking behavior preserved
- LLM auto-assignment: New categories discovered by the LLM can be automatically assigned to a parent based on the existing hierarchy (LLM categorization prompt includes the tree structure)

**Seeded base categories:**
- 8-10 broad top-level parent categories seeded on new installs (e.g., Technology, Science, Business, Entertainment, etc.)
- Seeded before any LLM scoring -- categories exist even on a fresh install
- LLM can assign discovered categories as children of seeded parents

**Density & scrolling:**
- Full page scroll for settings content -- no fixed-height container for the tree
- Sidebar remains fixed/visible at all times (existing behavior, enforce across all settings pages)
- Child rows slightly more compact than parent rows, with spacing easy to adjust
- Search bar at the top of the category tree for filtering by name. DnD disabled while search is active

### Claude's Discretion

- DnD library selection (evaluate options during research phase)
- Code architecture and component composition patterns
- Exact icon choices for weight presets (block/reduce/normal/boost/max)
- Exact seeded category list (8-10 broad parents)
- CSS implementation details for tree connector lines
- Swipe gesture library/approach for mobile edit reveal
- Weight icon slide-in animation implementation details
- Search bar placement and filter behavior details

### Deferred Ideas (OUT OF SCOPE)

- Deeper nesting beyond 2 levels -- design data model to support it, but don't implement deeper nesting in this phase
- Collapsible tree nodes -- may be needed later for very long category lists, but keeping always-expanded for now
- Context menu / right-click "Move to..." as DnD alternative -- possible future enhancement for accessibility

</user_constraints>

<phase_requirements>

## Phase Requirements

| ID | Description | Research Support |
|----|-------------|-----------------|
| CATGRP-01 | User can create named category groups (now: parent categories) | Manual creation via popover + any ungrouped category becomes parent when child dragged to it. Data model: `children` map in `category_groups` JSON |
| CATGRP-02 | User can drag existing categories into groups via tree UI | @dnd-kit with `useDroppable` on parent rows and root area. Drop targets: existing parents, root-level categories, ungrouped area |
| CATGRP-03 | User can set a weight on a group that cascades to all child categories | Parent weight stored in `topic_weights`. Children inherit via three-tier resolution in `compute_composite_score` |
| CATGRP-04 | User can override the cascaded weight for individual categories within a group | Explicit entry in `topic_weights` overrides parent weight. Visual indicator (dimmer for inherited, full opacity for overridden) + reset-to-inherited action |
| CATGRP-05 | Scoring pipeline resolves effective weight: explicit override > group default > 1.0 | Update `compute_composite_score` to look up parent weight from `children` map instead of `groups` array. Same three-tier logic, different data source |

</phase_requirements>

## Standard Stack

### Core (Already Installed)

| Library | Version | Purpose | Why Standard |
|---------|---------|---------|--------------|
| @chakra-ui/react | 3.32.0 | TreeView component, `createTreeCollection`, `BranchIndentGuide`, `useFilter`, `Highlight` | Native tree rendering with built-in indent guides (CSS connector lines), collection mutation, filtering. Eliminates need for third-party tree library |
| @dnd-kit/core | 6.3.1 | Drag-and-drop primitives (`DndContext`, `useDroppable`, `DragOverlay`, `PointerSensor`) | Already installed, proven in this codebase for category DnD. Hooks-based API works well alongside Chakra TreeView |
| @dnd-kit/sortable | 10.0.0 | `useSortable` for draggable category rows | Already installed, used for within-container sorting |
| react-swipeable | 7.0.2 | Mobile swipe-to-reveal edit button gesture | Already installed in project. Provides `useSwipeable` hook for detecting left/right swipe gestures |
| react-icons/lu | (via react-icons 5.5.0) | Lucide icons for weight presets, folder icons, edit/delete actions | Already used throughout the project |

### Supporting (No New Dependencies Needed)

| Library | Version | Purpose | When to Use |
|---------|---------|---------|-------------|
| @emotion/react | 11.14.0 | `keyframes` for weight icon slide-in animation | Already installed. Use for the expand/collapse animation on weight preset hover |
| @tanstack/react-query | 5.90.20 | Server state for categories, preferences, mutations | Already wired up in `useCategories` and `usePreferences` hooks |

### Alternatives Considered

| Instead of | Could Use | Tradeoff |
|------------|-----------|----------|
| Chakra TreeView + @dnd-kit | react-arborist | react-arborist has built-in DnD + tree rendering but uses react-window for virtualization (overkill for ~50-200 categories), has its own styling system that conflicts with Chakra, and adds a new dependency. Chakra TreeView is native to the existing stack |
| @dnd-kit | @hello-pangea/dnd | Already tried and reverted (Quick 11). Collapsed accordion drop targets were incompatible. While accordion is being removed, hello-pangea still has worse tree layout support than dnd-kit's hooks-based approach |
| Custom CSS connectors | Chakra TreeView.BranchIndentGuide | BranchIndentGuide provides built-in CSS connector lines matching the exact `|--` / `L--` pattern requested. No custom CSS needed |
| react-swipeable | Custom touch handlers | react-swipeable is already a dependency and provides clean `onSwipedLeft`/`onSwipedRight` hooks. No reason to hand-roll |

**Installation:** No new packages needed. All libraries are already installed.

## Architecture Patterns

### Recommended Component Structure

```
frontend/src/components/settings/
  CategoriesSection.tsx        # Main container: search, tree, DnD context, create popover
  CategoryTree.tsx             # Chakra TreeView wrapper with DnD integration
  CategoryParentRow.tsx        # Branch node: folder icon, bold text, weight, edit/delete
  CategoryChildRow.tsx         # Leaf node: indented, lighter weight display, drag handle
  CategoryRow.tsx              # (REPLACED - current file, can be removed or repurposed)
  WeightIcon.tsx               # Single weight icon component with tooltip
  WeightPresetStrip.tsx        # Hover-expand strip of weight icons (replaces WeightPresets.tsx)
  SwipeableRow.tsx             # Mobile swipe-to-reveal wrapper using react-swipeable
  CreateCategoryPopover.tsx    # Popover for manual category creation (replaces GroupNamePopover.tsx)
  DeleteCategoryDialog.tsx     # Confirmation dialog for deleting parent/child (replaces DeleteGroupDialog.tsx)
  CategoryGroupAccordion.tsx   # (REMOVED - accordion replaced by tree)
  GroupNamePopover.tsx         # (REMOVED - replaced by CreateCategoryPopover.tsx)
  DeleteGroupDialog.tsx        # (REMOVED - replaced by DeleteCategoryDialog.tsx)
```

### Pattern 1: Chakra TreeView with Custom DnD Layer

**What:** Use Chakra's `TreeView.Root` + `createTreeCollection` for tree structure rendering, and wrap individual nodes with @dnd-kit `useSortable`/`useDroppable` for drag-and-drop.

**When to use:** Whenever rendering the category tree.

**Key insight:** Chakra TreeView handles tree structure, indent guides, filtering, and node rendering. @dnd-kit handles the drag interactions. These are layered together -- the TreeView.Node render function returns components wrapped with dnd-kit hooks.

**Example:**
```typescript
// Source: Chakra UI v3 TreeView docs + @dnd-kit docs
import { TreeView, createTreeCollection, useFilter } from "@chakra-ui/react";
import { DndContext, useDroppable, DragOverlay } from "@dnd-kit/core";
import { useSortable } from "@dnd-kit/sortable";

interface CategoryNode {
  id: string;        // kebab-case category name
  name: string;      // display name (title case)
  children?: CategoryNode[];
  weight?: string;   // explicit weight override, if any
}

// Build collection from category_groups data
function buildCollection(categoryGroups, allCategories, topicWeights) {
  const rootChildren: CategoryNode[] = [];
  // ... transform flat categories + children map into tree nodes
  return createTreeCollection<CategoryNode>({
    nodeToValue: (node) => node.id,
    nodeToString: (node) => node.name,
    rootNode: { id: "ROOT", name: "", children: rootChildren },
  });
}

// In the TreeView.Node render function, wrap with dnd-kit:
function DraggableCategoryNode({ node, nodeState }) {
  const { attributes, listeners, setNodeRef, transform, isDragging } = useSortable({ id: node.id });
  // ... render with drag handle
}
```

### Pattern 2: Data Model -- Children Map

**What:** Replace `category_groups.groups` array with a `children` map for the parent-child model.

**When to use:** Backend data storage and weight resolution.

**Example:**
```typescript
// Current structure (groups-based):
{
  groups: [
    { id: "uuid", name: "Programming", weight: "boost", categories: ["python", "rust"] }
  ],
  hidden_categories: ["sports"],
  seen_categories: ["python", "rust", "sports"],
  returned_categories: []
}

// New structure (parent-child):
{
  children: {
    "technology": ["cybersecurity", "web-development"],
    "science": ["climate", "space"],
    "programming": ["python", "rust"]
  },
  hidden_categories: ["sports"],
  seen_categories: ["python", "rust", "sports"],
  returned_categories: [],
  manually_created: ["custom-topic"]  // Track which categories user created manually
}

// Weight resolution in compute_composite_score:
// 1. topic_weights["python"] exists? Use it (explicit override)
// 2. Find parent of "python" -> "programming". topic_weights["programming"] exists? Use it (parent weight)
// 3. Default to "normal" (1.0)
```

### Pattern 3: Weight Preset Strip with Hover Expand Animation

**What:** Collapsed state shows only the active weight icon. On hover, all 5 icons slide in from the right, with the active icon moving to its correct position.

**When to use:** Every category row (parent and child).

**Example:**
```typescript
// Source: Emotion keyframes + Chakra responsive patterns
import { keyframes } from "@emotion/react";

const WEIGHT_ICONS = [
  { value: "block", icon: LuBan, label: "Block", color: "red" },
  { value: "reduce", icon: LuChevronDown, label: "Reduce", color: "orange" },
  { value: "normal", icon: LuMinus, label: "Normal", color: "gray" },
  { value: "boost", icon: LuChevronUp, label: "Boost", color: "green" },
  { value: "max", icon: LuChevronsUp, label: "Max", color: "accent" },
];

// Desktop: collapsed pill -> hover expands all icons
// Active icon starts at right, slides to correct position
// Use CSS max-width transition for expand/collapse
// Mobile: always show all icons with text labels (no hover on touch)
```

### Pattern 4: Swipe-to-Reveal on Mobile

**What:** On mobile, swiping a category row left reveals an edit button. No reserved space for the button -- it slides in from the right edge.

**When to use:** Category rows on mobile (base breakpoint).

**Example:**
```typescript
// Source: react-swipeable docs
import { useSwipeable } from "react-swipeable";

function SwipeableRow({ children, onEditReveal }) {
  const [revealed, setRevealed] = useState(false);
  const handlers = useSwipeable({
    onSwipedLeft: () => setRevealed(true),
    onSwipedRight: () => setRevealed(false),
    trackMouse: false,
  });

  return (
    <Box {...handlers} overflow="hidden" position="relative">
      <Box transform={revealed ? "translateX(-60px)" : "translateX(0)"} transition="transform 0.2s">
        {children}
      </Box>
      {revealed && (
        <IconButton position="absolute" right={0} top={0} onClick={onEditReveal} />
      )}
    </Box>
  );
}
```

### Anti-Patterns to Avoid

- **Don't use Accordion for tree:** The entire motivation for this phase is that accordion collapse creates zero-dimension drop targets. Always-expanded tree eliminates this problem entirely.
- **Don't nest DndContext providers:** Use a single DndContext at the top of CategoriesSection. Multiple nested contexts cause event propagation issues with @dnd-kit.
- **Don't store tree structure in both frontend and backend separately:** The `category_groups` JSON column is the single source of truth. Frontend derives the tree collection from this data on each render.
- **Don't use `collection.filter()` during DnD:** Filtering changes the collection's node IDs, which invalidates dnd-kit's tracked items. Disable DnD when search is active (user decision).
- **Don't mutate JSON columns in-place:** SQLAlchemy won't detect changes. Always reassign the full `category_groups` dict.

## Don't Hand-Roll

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Tree connector lines | Custom CSS `::before`/`::after` pseudo-elements | `TreeView.BranchIndentGuide` | Chakra's built-in indent guide already renders the exact `|--` / `L--` pattern with CSS. Handles depth, last-child, and theme colors |
| Tree collection management | Custom tree data structure with add/remove/move operations | `createTreeCollection` + `collection.remove()`, `collection.replace()` | Handles immutable updates, index path tracking, branch detection, filtering |
| Text filtering with locale awareness | Custom string matching | `useFilter` from `@chakra-ui/react` | Provides `contains()`, `startsWith()`, `endsWith()` with locale sensitivity |
| Search result highlighting | Custom regex-based text highlighting | `Highlight` component from Chakra | Renders matched substrings with custom styles |
| Mobile swipe detection | Custom touch event handlers with threshold calculations | `useSwipeable` from react-swipeable | Handles touch/pointer events, direction detection, velocity thresholds, prevents scroll interference |

**Key insight:** Chakra UI v3.32.0 provides nearly everything needed for the tree UI out of the box. The only missing piece is drag-and-drop, which @dnd-kit already handles.

## Common Pitfalls

### Pitfall 1: DnD + TreeView Node Identity Mismatch

**What goes wrong:** @dnd-kit tracks items by ID. If the Chakra TreeView collection is rebuilt with different node IDs mid-drag, dnd-kit loses track of the dragged item.
**Why it happens:** Search filtering, real-time data updates, or optimistic UI updates can trigger collection rebuilds.
**How to avoid:** (1) Disable DnD when search filter is active (already a user decision). (2) Use stable category kebab-case names as IDs (they don't change). (3) Don't rebuild the collection during an active drag -- gate collection updates behind `!isDragging`.
**Warning signs:** Dragged item "snaps back" unexpectedly, or drop targets don't highlight.

### Pitfall 2: Circular Parent-Child Relationships

**What goes wrong:** A category is both a parent and a child of another category, creating infinite loops in weight resolution and tree rendering.
**Why it happens:** Drag operations that allow dropping a parent onto one of its own descendants.
**How to avoid:** In the `onDragEnd` handler, validate that the drop target is not a descendant of the dragged item. With 2-level nesting limit, this simplifies to: a child cannot become a parent while still being a child.
**Warning signs:** Infinite render loops, stack overflow in weight resolution.

### Pitfall 3: Migration from Groups to Children Map

**What goes wrong:** Existing users with `category_groups.groups` data lose their groupings after the model change.
**Why it happens:** The backend migration doesn't convert old group data to the new children map format.
**How to avoid:** Write a database migration function in `database.py` that converts `groups` array to `children` map. Each group's categories become children of a new parent category named after the group. Preserve `hidden_categories`, `seen_categories`, `returned_categories`.
**Warning signs:** Categories appear ungrouped after upgrade despite having been in groups.

### Pitfall 4: Weight Icon Animation Performance

**What goes wrong:** The hover-expand animation on weight preset icons causes layout thrashing or janky scrolling.
**Why it happens:** Width changes trigger layout recalculation on every frame. Many rows animating simultaneously compounds the problem.
**How to avoid:** Use `transform` and `opacity` for animations (GPU-composited, no layout). Use `max-width` with `overflow: hidden` for the expand/collapse rather than `width`. Debounce hover state if needed.
**Warning signs:** Visible jank when hovering weight icons while scrolling, or when many rows are visible.

### Pitfall 5: Seeded Categories Conflicting with User Data

**What goes wrong:** Seeded base categories (Technology, Science, etc.) clash with LLM-discovered categories that have similar but different names.
**Why it happens:** LLM might generate "tech" or "computer-science" alongside the seeded "technology".
**How to avoid:** Seed categories use the exact same kebab-case names that the LLM categorization prompt already includes in `DEFAULT_CATEGORIES`. The LLM is instructed to reuse existing categories. The seeded parents are a subset of `DEFAULT_CATEGORIES` with pre-built hierarchy.
**Warning signs:** Duplicate near-synonym categories appearing at root level.

### Pitfall 6: SQLAlchemy JSON Column Mutation (Existing Known Issue)

**What goes wrong:** Changes to `category_groups` dict are silently lost.
**Why it happens:** SQLAlchemy doesn't detect in-place mutations to JSON columns.
**How to avoid:** Always reassign the entire dict: `preferences.category_groups = {**new_data}`. This is already the pattern used in all existing category endpoints.
**Warning signs:** Saved changes don't persist after page refresh.

## Code Examples

### Chakra TreeView with BranchIndentGuide

```typescript
// Source: Chakra UI v3 TreeView component docs (tree-view-basic example)
import { TreeView, createTreeCollection } from "@chakra-ui/react";
import { LuFolder, LuTag } from "react-icons/lu";

interface CategoryNode {
  id: string;
  name: string;
  children?: CategoryNode[];
}

const collection = createTreeCollection<CategoryNode>({
  nodeToValue: (node) => node.id,
  nodeToString: (node) => node.name,
  rootNode: {
    id: "ROOT",
    name: "",
    children: [
      {
        id: "technology",
        name: "Technology",
        children: [
          { id: "cybersecurity", name: "Cybersecurity" },
          { id: "web-development", name: "Web Development" },
        ],
      },
      { id: "sports", name: "Sports" },
    ],
  },
});

function CategoryTree() {
  return (
    <TreeView.Root collection={collection}>
      <TreeView.Label srOnly>Category Tree</TreeView.Label>
      <TreeView.Tree>
        <TreeView.Node
          indentGuide={<TreeView.BranchIndentGuide />}
          render={({ node, nodeState }) =>
            nodeState.isBranch ? (
              <TreeView.BranchControl>
                <LuFolder />
                <TreeView.BranchText fontWeight="semibold">
                  {node.name}
                </TreeView.BranchText>
              </TreeView.BranchControl>
            ) : (
              <TreeView.Item>
                <LuTag />
                <TreeView.ItemText>{node.name}</TreeView.ItemText>
              </TreeView.Item>
            )
          }
        />
      </TreeView.Tree>
    </TreeView.Root>
  );
}
```

### TreeView Filtering with useFilter

```typescript
// Source: Chakra UI v3 TreeView tree-view-with-filter example
import { TreeView, createTreeCollection, useFilter, Input, Highlight, Stack } from "@chakra-ui/react";

function FilterableTree({ initialCollection }) {
  const [collection, setCollection] = useState(initialCollection);
  const [expanded, setExpanded] = useState<string[]>([]);
  const [query, setQuery] = useState("");
  const { contains } = useFilter({ sensitivity: "base" });

  const search = (searchTerm: string) => {
    setQuery(searchTerm);
    const filtered = initialCollection.filter((node) =>
      contains(node.name, searchTerm)
    );
    setCollection(filtered);
    setExpanded(filtered.getBranchValues());
  };

  return (
    <Stack gap={3}>
      <Input
        size="sm"
        placeholder="Filter categories..."
        onChange={(e) => search(e.target.value)}
      />
      <TreeView.Root
        collection={collection}
        expandedValue={expanded}
        onExpandedChange={(e) => setExpanded(e.expandedValue)}
      >
        {/* ... node rendering with Highlight for matched text */}
      </TreeView.Root>
    </Stack>
  );
}
```

### TreeView Collection Mutation (Add/Remove Nodes)

```typescript
// Source: Chakra UI v3 TreeView tree-view-mutation example
const [collection, setCollection] = useState(initialCollection);

// Remove a node
const removeNode = (indexPath: number[]) => {
  setCollection(collection.remove([indexPath]));
};

// Add a child to a branch node
const addChild = (node: CategoryNode, indexPath: number[]) => {
  const children = [
    { id: newCategoryId, name: newCategoryName },
    ...(node.children || []),
  ];
  setCollection(collection.replace(indexPath, { ...node, children }));
};
```

### DnD useDroppable on Tree Nodes

```typescript
// Source: @dnd-kit docs, adapted from existing CategoriesSection.tsx patterns
import { useDroppable } from "@dnd-kit/core";

function DroppableParentRow({ categoryId, children }) {
  const { setNodeRef, isOver } = useDroppable({ id: `parent:${categoryId}` });
  return (
    <Box
      ref={setNodeRef}
      bg={isOver ? "bg.muted" : undefined}
      borderRadius="sm"
      transition="background 0.15s"
    >
      {children}
    </Box>
  );
}
```

## Discretion Recommendations

### DnD Library: Keep @dnd-kit (RECOMMENDED)

**Decision:** Keep the existing @dnd-kit (core 6.3.1 + sortable 10.0.0).

**Rationale:**
1. Already installed and proven in this codebase for cross-container category DnD
2. The accordion collapse problem (Quick 11 revert reason) is eliminated by switching to always-expanded tree -- the fundamental DnD incompatibility was with accordion, not with @dnd-kit itself
3. Hooks-based API (`useDroppable`, `useSortable`) integrates cleanly with Chakra TreeView's render function pattern
4. @hello-pangea/dnd was already tried and reverted; its render-props pattern is heavier than dnd-kit's hooks
5. @dnd-kit/react v1.0 (next-gen) is still at 0.3.0 pre-release -- not production-ready
6. react-arborist has built-in DnD but brings its own rendering/styling system that conflicts with Chakra

### Weight Preset Icons (RECOMMENDED)

Using Lucide icons from react-icons/lu (already installed):

| Weight | Icon | Lucide Name | Rationale |
|--------|------|-------------|-----------|
| Block | LuBan | `ban` | Universal "blocked/forbidden" symbol (circle with line) |
| Reduce | LuArrowDown | `arrow-down` | Downward arrow = lower priority |
| Normal | LuMinus | `minus` | Neutral/dash = baseline |
| Boost | LuArrowUp | `arrow-up` | Upward arrow = higher priority |
| Max | LuChevronsUp | `chevrons-up` | Double upward chevron = maximum |

These are simple, immediately recognizable, and maintain consistent visual metaphor (directional arrows for weight magnitude, with block as special case).

### Seeded Base Categories (RECOMMENDED)

8 broad top-level parents, chosen to match common RSS feed topic distributions:

1. **technology** -- cybersecurity, web-development, ai-ml, programming
2. **science** -- climate, space
3. **business** -- finance, startups
4. **entertainment** -- gaming, film, music
5. **culture** -- philosophy, history, design
6. **health** -- (no default children)
7. **politics** -- law
8. **education** -- (no default children)

These are all already in `DEFAULT_CATEGORIES`. The seeded hierarchy assigns existing default categories as children of new parent categories. The remaining defaults (`sports`, `food`, `travel`) stay ungrouped at root level.

**Implementation:** A new `DEFAULT_CATEGORY_HIERARCHY` dict in `prompts.py` defines the seeded parent-child relationships. On fresh install (or migration), this is used to populate `category_groups.children`.

### CSS Tree Connector Implementation

**Use Chakra TreeView.BranchIndentGuide.** This renders CSS-based connector lines automatically. The component uses CSS borders/pseudo-elements to create the `|--` and `L--` visual pattern. It handles:
- Vertical connector lines from parent to last child
- Horizontal connector lines from vertical to each child node
- Proper `last-child` handling (L-shaped connector for last item)
- Theme-aware colors via Chakra's token system

The `--tree-indentation` CSS variable controls indent width (default is appropriate for our use case).

### Mobile Swipe Gesture

**Use react-swipeable** (already installed at v7.0.2). The `useSwipeable` hook provides:
- `onSwipedLeft` callback to reveal edit button
- `onSwipedRight` to dismiss
- Configurable velocity and distance thresholds
- Does not interfere with vertical scrolling

Wrap each category row in a `SwipeableRow` component that manages the reveal state and renders the edit button positioned absolutely at the right edge.

### Weight Icon Slide-In Animation

**Approach:** Use CSS `max-width` transition with `overflow: hidden`.

1. **Default state:** Container shows only the active icon (fixed width ~28px)
2. **Hover state:** Container expands to show all 5 icons (max-width transitions from ~28px to ~140px)
3. **Active icon:** Has accent color/solid background. Other icons are ghost/muted
4. **Transition:** `max-width 0.2s ease-out, opacity 0.15s`
5. **Mobile:** No hover state. Always show all icons with text labels

Use `@emotion/react` `keyframes` only if the basic CSS transition isn't smooth enough. Start with pure CSS transitions (simpler, more performant).

### Search Bar Placement

Place the search `Input` directly above the tree, below the section header and "Create Category" button. When search has text, show a clear button. DnD is disabled (drag handles hidden or non-functional) while search is active.

## State of the Art

| Old Approach (Phase 08) | New Approach (Phase 08.1) | Why Changed |
|--------------------------|---------------------------|-------------|
| Accordion groups with collapse | Always-expanded tree view | Collapsed accordions create zero-dimension drop targets, breaking DnD |
| `groups` array with UUID-identified group objects | `children` map keyed by parent category name | Categories ARE the hierarchy, not separate group containers |
| WeightPresets as always-visible button row | Collapsed icon strip, hover-expand | Reduces visual noise in dense tree layout |
| Checkbox multi-select + "Group selected" button | Drag-and-drop to assign children | More intuitive for tree organization |
| No manual category creation | Popover for creating categories | Users can pre-create categories before LLM discovers them |
| No seeded hierarchy | 8 broad parent categories seeded | New users see meaningful structure immediately |

**Deprecated/outdated:**
- `CategoryGroupAccordion.tsx` -- entire accordion pattern replaced by tree
- `GroupNamePopover.tsx` -- group creation replaced by category creation
- `DeleteGroupDialog.tsx` -- group deletion replaced by category deletion
- `Accordion.Root`/`Accordion.Item` usage in categories -- no longer needed

## Open Questions

1. **Chakra TreeView + @dnd-kit integration depth**
   - What we know: Both libraries work independently. TreeView.Node's render function can return dnd-kit-wrapped components.
   - What's unclear: Whether TreeView's internal DOM structure (aria-tree, aria-treeitem roles) conflicts with dnd-kit's element tracking. BranchIndentGuide positioning with DragOverlay.
   - Recommendation: Build a minimal prototype in the first plan to validate the integration. If TreeView's DOM structure causes DnD issues, fall back to a custom tree layout using plain Chakra Box/Flex components with manual CSS connector lines. This is LOW risk because the connector CSS is straightforward.

2. **LLM auto-assignment to parent categories**
   - What we know: The categorization prompt currently lists all existing categories. We need to include hierarchy information so the LLM can assign new categories as children.
   - What's unclear: The exact prompt format for communicating hierarchy to the LLM. Whether adding hierarchy info degrades categorization quality.
   - Recommendation: Include hierarchy in the prompt as `parent > child1, child2` format. Test with a few articles before finalizing. This is a backend-only change to `build_categorization_prompt()`.

3. **Migration safety for existing users**
   - What we know: Current users have `category_groups.groups` format. New format uses `children` map.
   - What's unclear: Whether any users have deeply customized group structures that don't map cleanly.
   - Recommendation: Migration converts each group to a parent category with its group name. Since group names were user-chosen display names (not kebab-case), the migration must kebab-case them and ensure no collision with existing category names. Add the migration function to `database.py` startup sequence.

## Sources

### Primary (HIGH confidence)
- Chakra UI v3 TreeView component MCP tool -- full API, examples (createTreeCollection, BranchIndentGuide, useFilter, mutation, context menu, controlled expansion, filtering)
- Chakra UI v3 TreeView props MCP tool -- all Root, Node, Branch, Item props documented
- @dnd-kit Context7 docs (/websites/next_dndkit, /websites/dndkit) -- DndContext, useSortable, useDroppable, DragOverlay patterns
- Existing codebase: `CategoriesSection.tsx`, `CategoryRow.tsx`, `CategoryGroupAccordion.tsx`, `WeightPresets.tsx` -- current implementation patterns
- Existing codebase: `scoring.py` `compute_composite_score()`, `is_blocked()` -- current weight resolution logic
- Existing codebase: `database.py` -- migration pattern with `ALTER TABLE` + data conversion functions

### Secondary (MEDIUM confidence)
- @hello-pangea/dnd Context7 docs (/hello-pangea/dnd) -- multi-list DnD, combining, evaluated but not recommended
- react-arborist Context7 docs (/brimdata/react-arborist) -- tree component with built-in DnD, evaluated but not recommended (styling conflicts with Chakra)
- Lucide icons website -- icon naming and availability for weight presets
- CSS tree connector techniques (iamkate.com, gist.github.com) -- pure CSS patterns, though Chakra BranchIndentGuide is preferred

### Tertiary (LOW confidence)
- @dnd-kit/react 0.3.0 (next-gen) -- pre-release, not recommended for production use
- dnd-kit-sortable-tree npm package -- community package wrapping dnd-kit for tree DnD, not verified for current dnd-kit versions

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH -- all libraries already installed and proven in codebase. Chakra TreeView confirmed available at v3.32.0
- Architecture: HIGH -- data model change is well-defined, component structure follows existing patterns, weight resolution logic is a minor update
- Pitfalls: HIGH -- based on direct experience with the codebase (Quick 11 revert, SQLAlchemy JSON mutation, accordion DnD issues)
- DnD+TreeView integration: MEDIUM -- the combination is not a standard pattern; may need fallback to custom tree layout if Chakra TreeView DOM conflicts with dnd-kit
- Animation/gesture details: MEDIUM -- implementation approach is clear but exact CSS values need tuning during development

**Research date:** 2026-02-17
**Valid until:** 2026-03-17 (stable libraries, no expected breaking changes)
