---
status: diagnosed
phase: 08.1-categories-settings-ui-redesign
source: 08.1-01-SUMMARY.md, 08.1-02-SUMMARY.md, 08.1-03-SUMMARY.md, 08.1-04-SUMMARY.md
started: 2026-02-17T16:00:00Z
updated: 2026-02-17T18:00:00Z
---

## Current Test
<!-- OVERWRITE each test - shows where we are -->

[testing complete]

## Tests

### 1. Category Tree Structure
expected: Open Settings sidebar, navigate to Categories section. Tree shows parent categories with folder icon, semibold name, and child count. Child categories appear indented with connector lines. Ungrouped categories appear flat at root level.
result: issue
reported: "1. The last child should have a └── looking end line, not the same ├── line. The lines can also be a little bit more pronounced visually. 2. The count should be next to the group name, not aligned right as it currently is."
severity: cosmetic

### 2. Weight Inheritance Display
expected: Parent categories and child categories both show weight icons. Children that inherit their parent's weight display the weight strip at 50% opacity (dimmed). Children with explicit weight overrides show at full opacity.
result: issue
reported: "1. Weight icons should be smaller and less visually distinct — use accent color on icon/border of selected weight instead of accent background. 2. Use chevrons instead of up/down arrows. 3. Row layout should be: Parent: folder, name, count, flex space, weight group, edit/delete group. Child: line, drag handle, name, flex space, weight group, reset/edit/delete group. Don't reserve space for button groups when not hovered. 4. Include hover tooltips on all row buttons on desktop."
severity: cosmetic

### 3. Weight Preset Strip — Desktop Hover
expected: On desktop, each category row shows only the active weight icon (collapsed). Hover over the weight area — the strip smoothly expands to reveal all 5 weight options (block, reduce, normal, boost, max) with tooltips.
result: issue
reported: "The icon group simply appears, no smooth animation. Want buttons to 'grow' out smoothly. Will revisit after other tests for possible additional feedback."
severity: cosmetic

### 4. Set Category Weight
expected: Click a different weight icon on any category. The icon updates immediately to reflect the new weight. Refresh the page — the weight persists.
result: issue
reported: "Weight update is very slow, not immediate. Should be optimistic — update UI instantly, show toast on server success/fail, revert on failure."
severity: major

### 5. Override Child Weight
expected: Find a child category inheriting its parent's weight (50% opacity strip). Click a different weight on that child. The strip becomes full opacity (overridden). A reset button should appear to revert to inherited weight.
result: pass
note: "Functionally works. Visual styling issues from Tests 2-4 (icon styling, optimistic updates) apply here too."

### 6. Drag Category into Parent
expected: Drag an ungrouped category (or child from another parent) onto a parent row. The parent highlights as a drop target. On drop, the category appears as a child of that parent with connector lines.
result: issue
reported: "1. Drag performance is horrible, barely usable — priority fix. 2. Don't use placeholder item — animate highlight on the entire group (not just parent row). 3. Dragging ungrouped onto ungrouped to create new parent/child has no visual indicator — highlight parent row and add a distinct line underneath at child width. 4. BUG: Dropping ungrouped row back to its initial position creates a group with itself."
severity: blocker

### 7. Drag Category to Root
expected: Drag a child category from inside a parent to the root area (below the tree). The category becomes ungrouped and appears at root level without indentation.
result: issue
reported: "Not possible to drag a child to become ungrouped. It always selects another ungrouped row and sets it as a parent instead."
severity: major

### 8. Search / Filter Categories
expected: Type in the "Filter categories..." input above the tree. The tree filters to show only matching categories (case-insensitive). Drag handles disappear while search is active. Clear the search — full tree returns with drag handles.
result: issue
reported: "Filtering works functionally (pass) but typing the first character in search triggers a React console error: 'The final argument passed to useEffect changed size between renders' — the sensors array passed to DndContext changes size when toggling between DnD enabled/disabled (PointerSensor only vs PointerSensor+KeyboardSensor)."
severity: minor

### 9. Create New Category
expected: Click the "Add Category" button. A popover opens with an input field. Type a name (e.g., "machine-learning") and click Create. The new category appears at root level in the tree. Entering a duplicate name shows an error.
result: issue
reported: "Creating a new category seems to succeed but it does not show up in the list even after a page reload. Also needs success/fail toast messages."
severity: major

### 10. Rename Category
expected: Hover over any category row — a pencil icon appears. Click it. The name becomes an editable input. Change the name and press Enter. The category name updates in the tree and persists after refresh.
result: issue
reported: "Renaming parents and children of parents works. BUG: Renaming an ungrouped category does not update the name — instead a 'New' chip is rendered. Also from Test 9: duplicate name check not working when creating categories."
severity: major

### 11. Delete Leaf Category
expected: Hover over an ungrouped or child category — a trash icon appears. Click it. A confirmation dialog appears mentioning the category may reappear if the LLM discovers it again. Click Delete. The category is removed from the tree.
result: pass

### 12. Delete Parent Category
expected: Hover over a parent category with children — click the trash icon. Confirmation dialog mentions child count and that children will be released to root level. Click Delete. The parent disappears and its former children appear at root level.
result: issue
reported: "1. BUG: Deleting a parent also deletes the first child of the group. 2. Change behavior: parent action should be 'Split' group (all categories including parent become ungrouped) instead of deleting the parent — user may want to keep the category even without it being a parent. 3. BUG: Category names with special chars (e.g. AI/ML) break URL routing — 'DELETE /api/categories/ai/ml' returns 404. Categories need a URL-safe slug/id for API operations and a separate display name/label for the frontend."
severity: blocker

## Summary

total: 12
passed: 2
issues: 10
pending: 0
skipped: 0

## Gaps

- truth: "Category tree shows correct connector lines with L-shape for last child and child count positioned next to group name"
  status: diagnosed
  reason: "User reported: 1. The last child should have a └── looking end line, not the same ├── line. The lines can also be a little bit more pronounced visually. 2. The count should be next to the group name, not aligned right as it currently is."
  severity: cosmetic
  test: 1
  root_cause: "Three CSS issues: (1) _after pseudo-element (lines 121-132) masks vertical line with bg color instead of proper L-shape — should stop vertical line at 50% height. (2) Connector lines are 1px with border.subtle — too thin and subtle. (3) CategoryParentRow name has flex={1} (line 103), pushing child count right."
  artifacts:
    - "CategoryTree.tsx:121-132 (_after bg mask instead of proper L-shape)"
    - "CategoryTree.tsx:98,118 (1px width, border.subtle color)"
    - "CategoryParentRow.tsx:103 (flex={1} pushes count right)"
  missing:
    - "Stop vertical _before line at 50% for last child instead of masking"
    - "Increase line width to 2px, use stronger color token"
    - "Remove flex={1} from name, keep count adjacent"

- truth: "Weight icons are compact with accent-colored selection, chevron icons, clean row layout with proper element ordering, and hover tooltips on all buttons"
  status: diagnosed
  reason: "User reported: 1. Weight icons too visually heavy — use accent color on icon/border instead of background. 2. Use chevrons not up/down arrows. 3. Reorganize row layout: Parent=folder,name,count,flex,weights,edit/delete; Child=line,drag,name,flex,weights,reset/edit/delete. Don't reserve space for unhovered button groups. 4. Add hover tooltips on all row buttons on desktop."
  severity: cosmetic
  test: 2
  root_cause: "Multiple styling issues: (1) WeightPresetStrip uses LuArrowDown/LuArrowUp (lines 8,10) not chevrons. (2) Active weight uses variant='solid' + colorPalette='accent' (lines 68-69) — too heavy. (3) Row layout order wrong: edit/delete at lines 114-141 before WeightPresetStrip at line 144 in ParentRow. Same in ChildRow. (4) No Tooltip wrappers on edit/delete/hide buttons. (5) Buttons reserve space via opacity transition instead of conditional rendering."
  artifacts:
    - "WeightPresetStrip.tsx:8,10 (LuArrowDown/LuArrowUp imports)"
    - "WeightPresetStrip.tsx:68-69 (solid variant + accent background)"
    - "CategoryParentRow.tsx:112-144 (wrong element order)"
    - "CategoryChildRow.tsx:193-230 (wrong element order)"
    - "CategoryParentRow.tsx:114-140 (no tooltips on buttons)"
    - "CategoryChildRow.tsx:195-244 (no tooltips on buttons)"
  missing:
    - "Change LuArrowDown→LuChevronDown, LuArrowUp→LuChevronUp"
    - "Change active to variant='outline' with accent border+icon color"
    - "Reorder: weights before edit/delete buttons"
    - "Add Tooltip wrappers on all row buttons"
    - "Don't reserve layout space for hidden buttons"

- truth: "Weight preset strip expands smoothly with animation when hovering on desktop"
  status: diagnosed
  reason: "User reported: The icon group simply appears, no smooth animation. Want buttons to 'grow' out smoothly."
  severity: cosmetic
  test: 3
  root_cause: "WeightPresetStrip uses display property toggle (flex/none, lines 53-56) for showing/hiding inactive icons. CSS display is NOT animatable — transitions have no effect on it. Need max-width-based animation instead."
  artifacts:
    - "WeightPresetStrip.tsx:53-56 (display toggle, not animatable)"
    - "WeightPresetStrip.tsx:76 (transition='all 0.2s' has no effect on display)"
  missing:
    - "Replace display toggle with max-width/overflow:hidden approach"
    - "Animate from max-width:0 to max-width:28px per icon over ~200ms"

- truth: "Weight changes reflect immediately in the UI with optimistic update and toast feedback"
  status: diagnosed
  reason: "User reported: Weight update is very slow, not immediate. Should be optimistic — update UI instantly, show toast on server success/fail, revert on failure."
  severity: major
  test: 4
  root_cause: "categoryWeightMutation (lines 68-75) and resetWeightMutation (lines 77-87) in CategoriesSection.tsx wait for server response then invalidate queries. No onMutate optimistic cache update, no onError rollback, no toast feedback."
  artifacts:
    - "CategoriesSection.tsx:68-75 (categoryWeightMutation — no optimistic update)"
    - "CategoriesSection.tsx:77-87 (resetWeightMutation — no optimistic update)"
  missing:
    - "Add onMutate: snapshot + immediate cache update"
    - "Add onError: revert cache + error toast"
    - "Add onSuccess: optional success toast"
    - "Add onSettled: invalidate queries for fresh data"

- truth: "Drag-and-drop into parents is performant with clear visual feedback and no self-grouping bug"
  status: diagnosed
  reason: "User reported: 1. Drag performance is horrible, barely usable — priority fix. 2. Don't use placeholder item — animate highlight on entire group. 3. Dragging ungrouped onto ungrouped to create new parent/child has no visual indicator — highlight parent row and add distinct line at child width. 4. BUG: Dropping ungrouped row back to initial position creates a group with itself."
  severity: blocker
  test: 6
  root_cause: "Four issues: (1) Self-grouping bug — no guard for draggedCategory===overId before line 200 in handleDragEnd. (2) Performance — no React.memo on any row component, all rows re-render on every drag movement; hover state in each row adds more re-renders; WeightPresetStrip hover expansion during drag. (3) No visual indicator for ungrouped-to-ungrouped — CategoryChildRow uses useSortable which doesn't provide isOver state. (4) Placeholder item instead of group highlight."
  artifacts:
    - "CategoriesSection.tsx:189-206 (no self-drop guard)"
    - "CategoryTree.tsx:24-184 (no React.memo)"
    - "CategoryParentRow.tsx:38 (hover state re-renders)"
    - "CategoryChildRow.tsx:48,53-63 (hover state + useSortable overhead)"
    - "WeightPresetStrip.tsx:36-42 (hover expansion during drag)"
  missing:
    - "Add guard: if (draggedCategory === overId) return"
    - "Add React.memo to CategoryParentRow, CategoryChildRow, WeightPresetStrip"
    - "Use CSS :hover instead of JS hover state where possible"
    - "Add useDroppable to ungrouped rows for drop feedback"
    - "Replace placeholder with group highlight animation"

- truth: "Dragging a child category to the root area ungroups it"
  status: diagnosed
  reason: "User reported: Not possible to drag a child to become ungrouped. It always selects another ungrouped row and sets it as a parent instead."
  severity: major
  test: 7
  root_cause: "Root droppable zone (lines 166-169, 379) is a Box wrapping the entire CategoryTree. All ungrouped category rows have useSortable droppables that overlap the root zone. Drop always lands on a nearby ungrouped row (becomes parent) instead of root zone. handleDragEnd lines 184-206 have no path to destParent=null when dropping onto ungrouped categories."
  artifacts:
    - "CategoriesSection.tsx:166-169 (root droppable zone setup)"
    - "CategoriesSection.tsx:379 (root ref wraps entire tree)"
    - "CategoriesSection.tsx:184-206 (no path to root when over ungrouped)"
  missing:
    - "Add explicit 'Drop here to ungroup' zone below tree"
    - "OR change droppable strategy so empty space hits root"
    - "Ensure handleDragEnd can reach destParent=null path"

- truth: "Search filtering works without console errors"
  status: diagnosed
  reason: "User reported: Filtering works but typing first character triggers React useEffect error — sensors array passed to DndContext changes size between renders when toggling DnD enabled/disabled."
  severity: minor
  test: 8
  root_cause: "Line 373: sensors={isDndDisabled ? undefined : sensors} alternates between array and undefined when isDndDisabled toggles. DndContext internal useEffect dependency array changes size between renders."
  artifacts:
    - "CategoriesSection.tsx:373 (conditional sensors prop)"
    - "CategoriesSection.tsx:57-59 (sensors definition)"
  missing:
    - "Always pass sensors to DndContext, rely on disabled prop on droppables/draggables"

- truth: "Newly created category appears in the tree immediately and persists after reload"
  status: diagnosed
  reason: "User reported: Creating a new category seems to succeed but it does not show up in the list even after a page reload. Also needs success/fail toast messages."
  severity: major
  test: 9
  note: "Also: duplicate name check not working — no error shown when creating category with existing name"
  root_cause: "Backend POST /api/categories/create (lines 935-966) adds to manually_created and seen_categories, but GET /api/categories (lines 644-663) only returns categories from DEFAULT_CATEGORIES and article.categories. manually_created categories are never discoverable by the frontend."
  artifacts:
    - "backend/main.py:935-966 (create adds to manually_created only)"
    - "backend/main.py:644-663 (GET doesn't include manually_created)"
    - "CategoriesSection.tsx:105-122 (ungroupedCategories from allCategories)"
  missing:
    - "GET /api/categories must merge in manually_created categories"
    - "Add toast messages for create success/fail"
    - "Fix duplicate name validation in CreateCategoryPopover"

- truth: "Renaming ungrouped categories updates the name correctly; duplicate name validation works on create"
  status: diagnosed
  reason: "User reported: Renaming ungrouped category does not update name, renders 'New' chip instead. Also duplicate name check not working when creating categories."
  severity: major
  test: 10
  root_cause: "Backend PATCH /api/categories/{name}/rename (lines 1008-1053) updates internal lists (seen_categories, manually_created) but does NOT update article.categories in DB. GET /api/categories still returns old name from articles. After rename: old name in allCategories, removed from seen_categories → frontend marks it as 'New'."
  artifacts:
    - "backend/main.py:1008-1053 (rename updates lists, not article data)"
    - "backend/main.py:644-663 (GET returns old name from articles)"
    - "CategoriesSection.tsx:90-97 (newCategories check: in allCategories but not in seen_categories)"
  missing:
    - "Rename endpoint must update article.categories in DB"
    - "OR maintain a name→display_name mapping and use it in GET"
    - "Fix duplicate name validation"

- truth: "Deleting a parent releases all children to root without data loss; category API operations work with special characters in names"
  status: diagnosed
  reason: "User reported: 1. BUG: Deleting parent also deletes first child. 2. Change behavior to 'Split' group (all categories including parent become ungrouped) instead of delete. 3. BUG: Category names with special chars (AI/ML) break URL routing — need slug/id for API, separate display name for frontend."
  severity: blocker
  test: 12
  root_cause: "Three issues: (1) First child deletion may be frontend cache/state sync issue — backend logic (lines 982-986) appears correct but needs reproduction. (2) URL routing: FastAPI {name} path param can't handle slashes — ai/ml becomes two path segments, returning 404. encodeURIComponent converts / to %2F but FastAPI doesn't decode in path params. (3) Behavior change: current code deletes parent entirely, user wants 'split' (parent becomes ungrouped, children released)."
  artifacts:
    - "backend/main.py:969 (DELETE route with {name} path param)"
    - "backend/main.py:981-989 (delete + release vs requested split behavior)"
    - "frontend/api.ts:361 (encodeURIComponent doesn't help with slashes)"
  missing:
    - "Use {name:path} or switch to request body for category identification"
    - "OR add slug/id system for URL-safe API operations"
    - "Change parent delete to 'Split group' — keep parent as ungrouped"
    - "Reproduce and fix first child deletion bug"
