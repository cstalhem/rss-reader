---
phase: 08.1-categories-settings-ui-redesign
plan: 06
type: execute
wave: 2
depends_on:
  - 08.1-05
files_modified:
  - frontend/src/components/settings/CategoriesSection.tsx
  - frontend/src/components/settings/CategoryTree.tsx
  - frontend/src/components/settings/CategoryParentRow.tsx
  - frontend/src/components/settings/CategoryChildRow.tsx
  - frontend/src/components/settings/WeightPresetStrip.tsx
autonomous: true
gap_closure: true
requirements:
  - CATGRP-02

must_haves:
  truths:
    - "Dragging categories is smooth and performant without lag"
    - "Dragging a child to the ungroup zone releases it to root level"
    - "Search filtering works without React console errors"
    - "Dropping a category on itself does not create a self-group"
    - "Ungrouped-to-ungrouped drops show clear visual feedback"
  artifacts:
    - path: "frontend/src/components/settings/CategoriesSection.tsx"
      provides: "Self-drop guard, sensors fix, ungroup drop zone"
      exports: ["CategoriesSection"]
    - path: "frontend/src/components/settings/CategoryTree.tsx"
      provides: "React.memo wrapper for performance"
      exports: ["CategoryTree"]
    - path: "frontend/src/components/settings/CategoryParentRow.tsx"
      provides: "React.memo wrapper, CSS :hover optimization"
      exports: ["CategoryParentRow"]
    - path: "frontend/src/components/settings/CategoryChildRow.tsx"
      provides: "React.memo wrapper, useDroppable for drop feedback"
      exports: ["CategoryChildRow"]
    - path: "frontend/src/components/settings/WeightPresetStrip.tsx"
      provides: "React.memo wrapper"
      exports: ["WeightPresetStrip"]
  key_links:
    - from: "CategoriesSection handleDragEnd"
      to: "self-drop guard"
      via: "if (draggedCategory === overId) return"
      pattern: "draggedCategory === overId"
    - from: "CategoryChildRow"
      to: "useDroppable"
      via: "provides isOver state for visual feedback"
      pattern: "useDroppable.*ungrouped"
    - from: "CategoriesSection"
      to: "DndContext sensors"
      via: "always pass sensors array, never undefined"
      pattern: "sensors={sensors}"
---

<objective>
Fix drag-and-drop performance issues, enable ungrouping via drag, and resolve sensor array error.

Purpose: Address blocker (Gap 5) and major (Gaps 6, 7) DnD issues that make the tree barely usable.
Output: Smooth, performant drag-and-drop with all use cases working correctly.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08.1-categories-settings-ui-redesign/08.1-03-SUMMARY.md
@.planning/phases/08.1-categories-settings-ui-redesign/08.1-UAT.md
@frontend/src/components/settings/CategoriesSection.tsx
@frontend/src/components/settings/CategoryTree.tsx
@frontend/src/components/settings/CategoryParentRow.tsx
@frontend/src/components/settings/CategoryChildRow.tsx
@frontend/src/components/settings/WeightPresetStrip.tsx
</context>

<tasks>

<task type="auto">
  <name>Add React.memo to all row components and optimize hover states for DnD performance</name>
  <files>
frontend/src/components/settings/CategoryTree.tsx
frontend/src/components/settings/CategoryParentRow.tsx
frontend/src/components/settings/CategoryChildRow.tsx
frontend/src/components/settings/WeightPresetStrip.tsx
  </files>
  <action>
**Gap 5 Fix — DnD performance optimization**

Root causes: (1) No React.memo on row components — all re-render on every drag move. (2) JS hover state causes re-renders. (3) WeightPresetStrip hover expansion during drag.

**CategoryTree.tsx:**
Wrap entire CategoryTree export with React.memo at bottom of file:
```typescript
export const CategoryTree = React.memo(CategoryTreeComponent);
```

Also import React at top: `import React from "react";`

**CategoryParentRow.tsx:**
1. Convert from:
```typescript
export function CategoryParentRow({ ... }) {
```
To:
```typescript
const CategoryParentRowComponent = ({ ... }) => {
  // ... existing implementation
};

export const CategoryParentRow = React.memo(CategoryParentRowComponent);
```

2. Find JS hover state (around line 38): `const [isHovered, setIsHovered] = useState(false);`
3. Replace with CSS :hover pseudo-class for button visibility:
   - Remove useState for hover
   - Remove onMouseEnter/onMouseLeave props from Flex
   - Update edit/delete button visibility from `opacity={isHovered ? 1 : 0}` to CSS class
   - Add to Button props: `css={{ opacity: 0, _groupHover: { opacity: 1 } }}`
   - Ensure parent Flex has `role="group"` for Chakra's _groupHover to work

**CategoryChildRow.tsx:**
1. Wrap with React.memo (same pattern as ParentRow)
2. Replace JS hover state with CSS :hover (lines 48, 53-63)
3. Add `useDroppable` hook for ungrouped rows to show drop feedback:
```typescript
const { setNodeRef: dropRef, isOver } = useDroppable({
  id: `ungrouped-${category}`,
  data: { type: 'ungrouped', category },
  disabled: isDndDisabled,
});
```
4. Combine refs: `ref={combineRefs(setActivatorNodeRef, sortableRef, dropRef)}`
5. Add isOver visual feedback: `bg={isOver ? 'accent.subtle' : undefined}`

Note: May need to import `combineRefs` utility from a helper or create inline.

**WeightPresetStrip.tsx:**
1. Wrap with React.memo
2. Add early return if `isCollapsed && !isHovered` to skip rendering hidden icons during drag
   (this prevents hover expansion calculation during drag operations)

Import React at top of all modified files: `import React from "react";`
  </action>
  <verify>
Performance verification:
```bash
cd frontend
bun dev --port 3210
```

Open browser, navigate to Categories settings:
1. Open React DevTools Profiler
2. Start profiling
3. Drag a category slowly across the tree
4. Stop profiling
5. Check that only the dragged element and drop target re-render (not all rows)

Visual verification:
1. Drag ungrouped category over another ungrouped category — should see highlight
2. Hover over rows — buttons should still appear (CSS :hover working)
  </verify>
  <done>
- React.memo applied to CategoryTree, CategoryParentRow, CategoryChildRow, WeightPresetStrip
- JS hover state replaced with CSS :hover for button visibility
- useDroppable added to ungrouped rows for drop feedback
- Drag performance is smooth (verified in DevTools Profiler)
  </done>
</task>

<task type="auto">
  <name>Fix sensors array error, add self-drop guard, and create ungroup drop zone</name>
  <files>frontend/src/components/settings/CategoriesSection.tsx</files>
  <action>
**Gap 7 Fix — Sensors array useEffect error:**

Line 373 currently has: `sensors={isDndDisabled ? undefined : sensors}`

Change to always pass sensors, disable droppables/draggables instead:
```typescript
<DndContext sensors={sensors} ...>
```

The `isDndDisabled` prop is already passed to child components (CategoryTree, rows) and used to disable individual draggables/droppables. Remove the conditional at DndContext level.

**Gap 5 Fix — Self-drop guard:**

In `handleDragEnd` function (around line 189-206), add guard at the very beginning:
```typescript
function handleDragEnd(event: DragEndEvent) {
  const { active, over } = event;
  setActiveId(null);

  if (!over) return;

  const draggedCategory = active.id as string;
  const overId = over.id as string;

  // Guard: prevent self-grouping
  if (draggedCategory === overId) {
    return;
  }

  // ... rest of existing logic
}
```

**Gap 6 Fix — Explicit ungroup drop zone:**

Problem: Root droppable zone (lines 166-169, ref at line 379) wraps entire tree, causing drops to hit ungrouped rows instead of root.

Solution: Add dedicated ungroup drop zone below the tree.

1. After the CategoryTree component (around line 380, before closing `</Box>`), add:
```typescript
{/* Explicit ungroup drop zone */}
<Box
  ref={setRootDroppableRef}
  py={3}
  px={4}
  borderWidth="2px"
  borderStyle="dashed"
  borderColor={isOverRoot ? "accent.solid" : "border.subtle"}
  borderRadius="md"
  bg={isOverRoot ? "accent.subtle" : "transparent"}
  textAlign="center"
  fontSize="sm"
  color="fg.muted"
  transition="all 0.2s"
>
  Drop here to ungroup
</Box>
```

2. Update useDroppable hook (line 166-169) to use specific ID:
```typescript
const { setNodeRef: setRootDroppableRef, isOver: isOverRoot } = useDroppable({
  id: "ungroup-zone",
  disabled: isDndDisabled,
});
```

3. In handleDragEnd, update logic to handle "ungroup-zone" overId (around line 200):
```typescript
// Check if dropping into root/ungroup zone
if (overId === "ungroup-zone" || overId === "root-droppable") {
  // Ungroup: set parent to null
  const updatedChildren = { ...categoryGroups.children };

  // Remove from all parent lists
  for (const parent in updatedChildren) {
    updatedChildren[parent] = updatedChildren[parent].filter(
      (c) => c.toLowerCase() !== draggedCategory.toLowerCase()
    );
  }

  await saveGroups({ children: updatedChildren });
  return;
}
```

Remove the root droppable Box wrapper around CategoryTree (line 379) since we have dedicated zone now. Keep CategoryTree in a plain Box without droppable ref.
  </action>
  <verify>
Test all DnD scenarios:
1. Search filtering: Type in search box — no React console error
2. Self-drop: Drag ungrouped category, drop back on itself — nothing happens (no self-group)
3. Ungroup: Drag child from parent to "Drop here to ungroup" zone — child becomes ungrouped
4. Ungrouped-to-ungrouped: Drag ungrouped over another ungrouped — shows highlight feedback
5. Performance: Drag is smooth without lag

Check browser console for errors during all operations.
  </verify>
  <done>
- DndContext always receives sensors array (no conditional undefined)
- Self-drop guard prevents creating group with itself
- Explicit "Drop here to ungroup" zone below tree works correctly
- Ungrouped rows show drop feedback via useDroppable
- No React useEffect console errors during search filtering
  </done>
</task>

</tasks>

<verification>
Run full UAT Test 5, 6, 7, 8 sequence:
1. Drag performance is smooth (no lag)
2. Drag child to ungroup zone — becomes ungrouped
3. Drop category on itself — no action taken
4. Drag ungrouped onto ungrouped — shows visual highlight
5. Type in search box — no console errors
6. Use React DevTools Profiler to verify only necessary components re-render during drag
</verification>

<success_criteria>
- [ ] All row components wrapped with React.memo
- [ ] CSS :hover replaces JS hover state where possible
- [ ] useDroppable added to ungrouped rows for drop feedback
- [ ] Sensors always passed to DndContext (not conditionally undefined)
- [ ] Self-drop guard prevents draggedCategory === overId
- [ ] Explicit ungroup drop zone below tree
- [ ] Drag performance is smooth (verified in DevTools Profiler)
- [ ] All DnD use cases working without console errors
</success_criteria>

<output>
After completion, create `.planning/phases/08.1-categories-settings-ui-redesign/08.1-06-SUMMARY.md`
</output>
