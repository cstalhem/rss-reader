---
phase: 08.2-category-data-model-refactor
plan: 01
subsystem: database
tags: [sqlmodel, sqlalchemy, sqlite, migration, python-slugify, many-to-many]

# Dependency graph
requires:
  - phase: 08.1-categories-settings-ui-redesign
    provides: "Category grouping JSON blob structure (children map, topic_weights, seen/hidden/manually_created)"
provides:
  - "Category SQLModel table with id, display_name, slug, parent_id, weight, is_hidden, is_seen, is_manually_created"
  - "ArticleCategoryLink junction table for many-to-many Article <-> Category"
  - "Idempotent JSON-to-relational migration with database backup"
  - "smart_case/kebab_to_display helpers for display name conversion"
  - "Default category hierarchy seeding for fresh installs"
affects: [08.2-02, 08.2-03, 08.2-04, 08.2-05, scoring-pipeline, api-endpoints, frontend-types]

# Tech tracking
tech-stack:
  added: [python-slugify]
  patterns: [SQLModel many-to-many via link_model, self-referential parent/children relationships, idempotent startup migration with backup]

key-files:
  created: []
  modified:
    - backend/src/backend/models.py
    - backend/src/backend/database.py
    - backend/pyproject.toml
    - backend/uv.lock

key-decisions:
  - "ArticleCategoryLink defined before Category/Article in models.py for forward reference resolution"
  - "Self-referential Category relationships use sa_relationship_kwargs with string-based remote_side/foreign_keys"
  - "Migration reads old JSON columns via raw SQL before model changes take effect"
  - "Two-pass category creation: first pass creates rows without parent_id, second pass resolves parent_id from slug lookup"
  - "INSERT OR IGNORE for article-category links to handle potential duplicates safely"
  - "Fresh install detected by absence of any JSON data, seeds from DEFAULT_CATEGORY_HIERARCHY"

patterns-established:
  - "SMART_CASE_MAP dictionary for known acronym/brand casing (AI, iOS, macOS, etc.)"
  - "kebab_to_display() for converting kebab-case slugs to human-readable display names"
  - "Database backup before destructive migration via shutil.copy2"

requirements-completed: [CATGRP-01, CATGRP-03, CATGRP-04]

# Metrics
duration: 3.7min
completed: 2026-02-17
---

# Phase 08.2 Plan 01: Schema & Migration Summary

**Category and ArticleCategoryLink SQLModel tables with idempotent JSON-to-relational migration, database backup, and old column drops**

## Performance

- **Duration:** 3.7 min
- **Started:** 2026-02-17T18:37:04Z
- **Completed:** 2026-02-17T18:40:47Z
- **Tasks:** 2
- **Files modified:** 4

## Accomplishments
- Category model with self-referential parent/children relationships and ArticleCategoryLink junction table for many-to-many
- Idempotent migration that reads all JSON blob data (article categories, topic_weights, category_groups) and creates relational Category + link rows
- Smart casing helpers (SMART_CASE_MAP, kebab_to_display) for converting kebab-case slugs to human-readable display names
- Database backup before migration, old JSON columns dropped after migration

## Task Commits

Each task was committed atomically:

1. **Task 1: Add Category and ArticleCategoryLink models, install python-slugify** - `60c6d5b` (feat)
2. **Task 2: Implement idempotent data migration with backup and column drops** - `5cbd249` (feat)

## Files Created/Modified
- `backend/src/backend/models.py` - Added Category, ArticleCategoryLink models; removed Article.categories JSON field and UserPreferences.topic_weights/category_groups; added categories_rel relationship on Article
- `backend/src/backend/database.py` - Added _backup_database, smart_case/kebab_to_display, _migrate_json_to_relational, _seed_categories_from_hierarchy, _drop_old_json_columns; removed 5 old migration functions; updated create_db_and_tables ordering
- `backend/pyproject.toml` - Added python-slugify dependency
- `backend/uv.lock` - Updated lockfile with python-slugify and text-unidecode

## Decisions Made
- Used `from __future__ import annotations` in models.py for clean forward references between Category, Article, and ArticleCategoryLink
- Self-referential relationships on Category use `sa_relationship_kwargs` with string-based `remote_side` and `foreign_keys` to avoid SQLAlchemy ambiguous FK errors
- Migration uses raw SQL via `text()` to read old JSON columns since the model fields no longer exist
- Two-pass approach for parent_id: create all categories first, then update parent references (avoids FK ordering issues)
- `INSERT OR IGNORE` for article-category links to safely handle duplicate category assignments in articles
- Weight name migration (blocked->block, low->reduce, etc.) happens inline during category creation

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered
None.

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- Category and ArticleCategoryLink tables are created and populated with migrated data
- Old JSON columns are dropped
- Ready for Plan 02 (scoring pipeline update) to use get_or_create_category pattern and write to junction table
- Ready for Plan 03 (API endpoints) to query from Category table with eager loading

## Self-Check: PASSED

- [x] models.py exists with Category and ArticleCategoryLink
- [x] database.py exists with migration functions
- [x] SUMMARY.md created
- [x] Commit 60c6d5b found (Task 1)
- [x] Commit 5cbd249 found (Task 2)

---
*Phase: 08.2-category-data-model-refactor*
*Completed: 2026-02-17*
