---
phase: 08.2-category-data-model-refactor
plan: 07
subsystem: frontend-categories-settings, frontend-article-reader
tags: [bug-fix, uat-gap-closure, dnd, optimistic-ui]
completed: 2026-02-17
duration_minutes: 1.7

dependency_graph:
  requires:
    - 08.2-06-PLAN (Settings Panel UI Gap Closure)
    - 08.2-UAT (UAT findings report)
  provides:
    - Working DnD ungroup via ungroup-zone
    - Instant visual feedback for article reader weight changes
    - Single-fire weight selection event handling
  affects:
    - Category management UX (ungroup gesture now works)
    - Article reading flow (weight changes immediately visible)

tech_stack:
  added: []
  patterns:
    - Disabled droppable on dragged item to prevent self-intercept
    - Optimistic local state for instant UI feedback before server refetch
    - Single RadioItemGroup handler instead of dual onSelect + onValueChange

key_files:
  created: []
  modified:
    - frontend/src/components/settings/CategoryChildRow.tsx
    - frontend/src/components/settings/CategoriesSection.tsx (verified only)
    - frontend/src/components/article/TagChip.tsx
    - frontend/src/components/article/ArticleReader.tsx

decisions:
  - what: Disable droppable on dragged item
    why: Prevents the dragged item's own droppable from intercepting drops intended for other targets
    alternatives: [Adjust collision detection, Add drop zone priority]
    chosen_because: Simplest fix with no side effects
  - what: Optimistic local state for weight display
    why: Server refetch + parent re-render takes time, user needs instant feedback
    alternatives: [Optimistic cache update, Wait for server response]
    chosen_because: Minimal complexity, self-healing on refetch

metrics:
  tasks_completed: 2
  tasks_total: 2
  files_modified: 3
  tests_added: 0
  commits: 2
---

# Phase 08.2 Plan 07: DnD Ungroup and Article Reader Weight Change Fixes

**One-liner:** Fixed DnD ungroup self-intercept bug and TagChip double-fire with optimistic weight updates for instant article reader feedback.

## Overview

Resolved two critical UAT-reported gaps in the category management system: (1) DnD ungroup not working because the dragged child's own droppable intercepts the drop, and (2) article reader tag chip weight changes having no visible effect.

**Problem 1 - DnD ungroup broken:**
When dragging a child category to the ungroup zone, the user's own droppable (with id `drop:${category.id}`) followed the cursor and intercepted the drop event, causing `over.id` to resolve to the category's own ID. The handleDragEnd early return at line 166 of CategoriesSection then aborted the operation.

**Problem 2 - Weight changes invisible:**
TagChip had two event handlers (`Menu.Root onSelect` + `RadioItemGroup onValueChange`) that both fired, causing duplicate mutations. Even fixing that, the ArticleReader showed no immediate feedback because the article's embedded category data only updated after the articles query refetch completed.

## Implementation

### Task 1: Fix DnD Ungroup

**Root cause:** CategoryChildRow's `useDroppable` hook remained active even when the row was being dragged, causing self-intercept.

**Fix:** Added `|| isDragging` to the `useDroppable` disabled condition. The `useSortable` hook already provides `isDragging` state, so we simply pass it through to disable the droppable when this row is being dragged.

**Verification of CategoriesSection logic:**
Reviewed `handleDragEnd` flow to confirm correct handling once self-intercept is fixed:
1. `rawOverId = "ungroup-zone"` (dragged item's droppable now disabled)
2. Strips `drop:` prefix (no prefix on "ungroup-zone")
3. Hits `overId === "ungroup-zone"` branch at line 171
4. Sets `destParentId = null`
5. Calls `updateCategory(draggedCat.id, { parent_id: -1 })`

No changes needed to CategoriesSection — the fix in CategoryChildRow was sufficient.

**Commit:** `acc13eb`

### Task 2: Fix TagChip Double-Fire and Add Optimistic Updates

**TagChip fix:**
Removed the `Menu.Root onSelect` handler, keeping only the `RadioItemGroup onValueChange` handler. This is the appropriate handler for radio items and fires exactly once per selection.

**ArticleReader optimistic updates:**
Added local state `optimisticWeights: Record<number, string>` to track weight overrides before server refetch. The pattern:
1. User clicks weight preset → `setOptimisticWeights` + `mutate`
2. TagChip immediately displays new weight via `optimisticWeights[cat.id] ?? cat.effective_weight`
3. Mutation invalidates articles query → parent refetches → drawer re-renders with server data
4. Optimistic state harmless (same value as server data)

Also added `['categories', 'new-count']` invalidation to the mutation's `onSuccess` for badge consistency.

**Commit:** `b3bed6b`

## Verification

- [x] TypeScript compiles with zero errors
- [x] Production build succeeds
- [x] CategoryChildRow droppable disabled when `isDragging`
- [x] TagChip Menu.Root has no onSelect handler
- [x] ArticleReader uses optimistic local state for weight display
- [x] ArticleReader mutation invalidates new-count query

## Deviations from Plan

None - plan executed exactly as written.

## Testing Notes

**Manual testing required:**
1. Create a parent category with at least one child
2. Drag the child to the ungroup zone → verify it moves to root level
3. Open an article in the reader drawer
4. Click a weight preset on a category tag chip
5. Verify the chip updates immediately (before server refetch completes)
6. Verify no duplicate mutations fire (check network tab)

## Known Issues / Future Work

None. Both UAT gaps fully resolved.

## Self-Check: PASSED

Verified all modified files exist:
- [x] frontend/src/components/settings/CategoryChildRow.tsx
- [x] frontend/src/components/article/TagChip.tsx
- [x] frontend/src/components/article/ArticleReader.tsx

Verified all commits exist:
- [x] acc13eb (Task 1: DnD ungroup fix)
- [x] b3bed6b (Task 2: TagChip and ArticleReader fixes)
