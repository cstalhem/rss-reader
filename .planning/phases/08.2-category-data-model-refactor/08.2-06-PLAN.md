---
phase: 08.2-category-data-model-refactor
plan: 06
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/components/settings/WeightPresetStrip.tsx
  - frontend/src/hooks/useCategories.ts
  - frontend/src/components/settings/CategoryChildRow.tsx
  - frontend/src/components/settings/CategoryParentRow.tsx
autonomous: true
gap_closure: true
requirements: [CATGRP-01, CATGRP-04]

must_haves:
  truths:
    - "Weight preset button changes visual state (ghost→outline) in the same frame as the click via local optimistic state"
    - "Rename and delete buttons appear on category row hover (React state-driven, not _groupHover CSS)"
    - "Changing a category weight auto-dismisses the new-category badge"
    - "Badge X icon appears on category row hover (React state-driven, not _groupHover CSS)"
  artifacts:
    - path: "frontend/src/components/settings/WeightPresetStrip.tsx"
      provides: "Local optimistic state (localValue) for instant visual feedback on weight click, synced from value prop via useEffect"
    - path: "frontend/src/hooks/useCategories.ts"
      provides: "Auto-acknowledge on weight change (is_seen: true) + new-count invalidation in onSettled"
    - path: "frontend/src/components/settings/CategoryChildRow.tsx"
      provides: "React state-driven hover reveal for rename/delete/hide buttons + badge X icon (replaces broken _groupHover)"
    - path: "frontend/src/components/settings/CategoryParentRow.tsx"
      provides: "React state-driven hover reveal for rename/delete buttons (replaces broken _groupHover)"
  key_links:
    - from: "useCategories.ts:updateCategoryMutation.onMutate"
      to: "CategoryTree re-render"
      via: "setQueryData with new array reference"
      pattern: "setQueryData.*categories.*map"
    - from: "useCategories.ts:updateCategoryMutation.onSettled"
      to: "new-count badge refresh"
      via: "invalidateQueries for ['categories', 'new-count']"
      pattern: "invalidateQueries.*new-count"
---

<objective>
Fix three UAT-reported gaps in the categories settings UI: (1) slow optimistic weight updates, (2) undiscoverable hover-reveal rename/delete buttons, and (3) badge dismiss not working on weight change.

Purpose: Users reported weight changes feeling slow, being unable to find rename/delete buttons, and badge not dismissing. These are the most impactful settings panel bugs from UAT.
Output: Settings panel with instant weight feedback, always-visible action buttons, and proper badge lifecycle.
</objective>

<execution_context>
@./.claude/agents/gsd-executor.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08.2-category-data-model-refactor/08.2-05-SUMMARY.md
@.planning/phases/08.2-category-data-model-refactor/08.2-UAT.md

Key files:
@frontend/src/hooks/useCategories.ts
@frontend/src/components/settings/CategoryChildRow.tsx
@frontend/src/components/settings/CategoryParentRow.tsx
@frontend/src/components/settings/CategoryTree.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Local optimistic weight state, auto-acknowledge, and new-count invalidation</name>
  <files>
    frontend/src/components/settings/WeightPresetStrip.tsx
    frontend/src/hooks/useCategories.ts
  </files>
  <action>
Fix three issues: (A) weight button visual delay, (B) missing auto-acknowledge, (C) missing new-count invalidation.

**Issue A: Weight button does not change visual state immediately**

Root cause: WeightPresetStrip's button visual state (`variant="outline"` vs `variant="ghost"`)
depends on the `value` prop, which flows from the query cache. On click:
1. `onChange("boost")` fires synchronously
2. → `handleWeightChange` → `updateCategory` → `mutate()`
3. `onMutate` is async (`await cancelQueries`) — `setQueryData` runs after an async gap
4. React re-render propagates through CategoriesSection → useMemo → CategoryTree → CategoryParentRow → WeightPresetStrip
5. Only THEN does the `value` prop update and the button visual change

The button must own its immediate visual state. Add local optimistic state to WeightPresetStrip:

```tsx
// WeightPresetStrip.tsx — add local optimistic state
const [localValue, setLocalValue] = useState(value);

// Sync with prop when server data arrives (or on revert)
useEffect(() => {
  setLocalValue(value);
}, [value]);

// In the button onClick:
onClick={(e) => {
  e.stopPropagation();
  setLocalValue(option.value);  // instant visual update — same frame
  onChange(option.value);         // triggers mutation chain
}}

// Use localValue instead of value for rendering:
const isActive = localValue === option.value;
```

Also update the `maxW` calculation on inactive buttons to use `localValue`:
```tsx
// Line 86 — inactive buttons expand on hover. The active check:
maxW={{ base: "24px", md: isExpanded ? "24px" : "0" }}
// remains unchanged — it only needs `isExpanded` and the active check now uses `localValue`
```

This ensures the button switches variant in the exact same frame as the click, before any
async work. When the server response arrives via the prop, `useEffect` syncs silently (same value).

If the mutation fails, `useCategories.ts` already has `onError` that reverts the cache via
`context.previous`, which updates the prop back to the old value, and `useEffect` syncs
`localValue` back — so the button reverts. The error toast is also already wired in `onError`.

**Issue B: Weight change does not auto-acknowledge the category**

In `useCategories.ts`, modify the `updateCategory` wrapper to auto-inject `is_seen: true`
when a weight change is present:

```typescript
updateCategory: (id: number, data: ...) => {
  // Auto-acknowledge when changing weight
  const payload = data.weight !== undefined ? { ...data, is_seen: true } : data;
  updateCategoryMutation.mutate({ id, data: payload });
}
```

**Issue C: onSettled missing new-count invalidation**

In `updateCategoryMutation.onSettled`, add:
```typescript
queryClient.invalidateQueries({ queryKey: ["categories", "new-count"] });
```
  </action>
  <verify>
1. `cd /Users/cstalhem/projects/rss-reader/frontend && npx tsc --noEmit` passes
2. Read WeightPresetStrip.tsx to confirm: (a) `localValue` state exists, (b) `setLocalValue` called in onClick before onChange, (c) `useEffect` syncs from `value` prop, (d) `isActive` uses `localValue`
3. Read useCategories.ts to confirm: (a) onSettled includes `["categories", "new-count"]` invalidation, (b) updateCategory wrapper auto-includes `is_seen: true` when weight is present
  </verify>
  <done>
WeightPresetStrip button changes visual state instantly on click via local optimistic state. Weight changes auto-acknowledge categories (is_seen: true). onSettled invalidates new-count query. Error path reverts visual state and shows toast.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix hover-reveal for rename/delete buttons and badge X icon</name>
  <files>
    frontend/src/components/settings/CategoryChildRow.tsx
    frontend/src/components/settings/CategoryParentRow.tsx
  </files>
  <action>
Fix two UI discoverability issues. The current `_groupHover` CSS approach is not reliably triggering.
Replace it with the React state-driven hover pattern used by WeightPresetStrip (which works correctly).

**Reference pattern (WeightPresetStrip.tsx):**
```tsx
const [isExpanded, setIsExpanded] = useState(false);
<Flex onMouseEnter={() => setIsExpanded(true)} onMouseLeave={() => setIsExpanded(false)}>
  <Box maxW={{ md: isExpanded ? "24px" : "0" }} transition="max-width 0.2s ease-out" overflow="hidden">
```

**Issue A: Rename/delete buttons hidden — _groupHover not triggering**

In `CategoryChildRow.tsx` (lines 183-234), the action buttons Flex wrapper uses:
```
maxW={{ base: "auto", md: "0" }}
_groupHover={{ maxW: "110px" }}
```

**Fix:** Add `isHovered` state to the component. Attach `onMouseEnter`/`onMouseLeave` to the
outer row Flex (the one with `role="group"` at line 102-113). Replace `_groupHover` with the
state-driven maxW:

```tsx
const [isHovered, setIsHovered] = useState(false);

// On the outer Flex:
<Flex
  ref={setNodeRef}
  role="group"
  style={style}
  onMouseEnter={() => setIsHovered(true)}
  onMouseLeave={() => setIsHovered(false)}
  ...
>

// On the action buttons wrapper (line 183):
<Flex
  overflow="hidden"
  maxW={{ base: "auto", md: isHovered ? "110px" : "0" }}
  transition="max-width 0.2s ease-out"
>
```

Remove the `_groupHover` prop entirely. Keep `transition` for smooth animation.

Apply the same pattern in `CategoryParentRow.tsx` — add `isHovered` state, attach mouse
handlers to the outer Flex, replace `_groupHover={{ maxW: "80px" }}` with
`maxW={{ base: "auto", md: isHovered ? "80px" : "0" }}`.

**Issue B: Badge X icon hidden — same _groupHover issue**

In `CategoryChildRow.tsx` (lines 148-172), the badge X icon uses:
```tsx
<Box maxW="0" overflow="hidden" _groupHover={{ maxW: "20px", pr: 1 }}>
```

**Fix:** Use the same `isHovered` state (already added above):
```tsx
<Box
  display="flex"
  alignItems="center"
  maxW={{ base: "20px", md: isHovered ? "20px" : "0" }}
  overflow="hidden"
  transition="max-width 0.15s, padding 0.15s"
  pr={isHovered ? 1 : 0}
>
  <LuX size={14} />
</Box>
```
  </action>
  <verify>
1. `cd /Users/cstalhem/projects/rss-reader/frontend && npx tsc --noEmit` passes
2. Read CategoryChildRow.tsx and CategoryParentRow.tsx to confirm `_groupHover` patterns replaced with `isHovered` state
3. Confirm `onMouseEnter`/`onMouseLeave` attached to outer row Flex in both components
4. `cd /Users/cstalhem/projects/rss-reader/frontend && bun run build` succeeds
  </verify>
  <done>
Rename, delete, and hide buttons use React state-driven hover reveal (matching WeightPresetStrip pattern) on both CategoryChildRow and CategoryParentRow. Badge X icon uses the same isHovered state. All _groupHover patterns replaced.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles with zero errors
2. Production build succeeds
3. No `_groupHover` patterns on action button wrappers or badge X icon in CategoryChildRow or CategoryParentRow — replaced with `isHovered` React state
4. useCategories updateCategory wrapper includes `is_seen: true` when weight is in payload
5. useCategories onSettled invalidates `["categories", "new-count"]`
</verification>

<success_criteria>
- Weight preset button flips visual state instantly on click (local optimistic state in WeightPresetStrip)
- Error reverts button state and shows toast (existing onError path)
- Weight change in settings panel includes is_seen auto-acknowledge
- New-count badge refreshes after weight changes
- Rename/delete buttons appear on row hover via React state (matching WeightPresetStrip pattern)
- Badge X icon appears on row hover via React state
- Zero TypeScript errors, production build passes
</success_criteria>

<output>
After completion, create `.planning/phases/08.2-category-data-model-refactor/08.2-06-SUMMARY.md`
</output>
