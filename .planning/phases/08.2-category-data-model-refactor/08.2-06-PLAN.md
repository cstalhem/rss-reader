---
phase: 08.2-category-data-model-refactor
plan: 06
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/hooks/useCategories.ts
  - frontend/src/components/settings/CategoryChildRow.tsx
  - frontend/src/components/settings/CategoryParentRow.tsx
autonomous: true
gap_closure: true
requirements: [CATGRP-01, CATGRP-04]

must_haves:
  truths:
    - "Category weight change in settings updates the UI immediately (sub-200ms perceived)"
    - "Rename and delete buttons are visible on category rows without requiring hover"
    - "Changing a category weight auto-dismisses the new-category badge"
    - "Badge X icon is visible without requiring row hover"
  artifacts:
    - path: "frontend/src/hooks/useCategories.ts"
      provides: "Optimistic update that triggers re-render + auto-acknowledge on weight change + new-count invalidation"
    - path: "frontend/src/components/settings/CategoryChildRow.tsx"
      provides: "Always-visible rename/delete/hide buttons + always-visible badge X icon"
    - path: "frontend/src/components/settings/CategoryParentRow.tsx"
      provides: "Always-visible rename/delete buttons"
  key_links:
    - from: "useCategories.ts:updateCategoryMutation.onMutate"
      to: "CategoryTree re-render"
      via: "setQueryData with new array reference"
      pattern: "setQueryData.*categories.*map"
    - from: "useCategories.ts:updateCategoryMutation.onSettled"
      to: "new-count badge refresh"
      via: "invalidateQueries for ['categories', 'new-count']"
      pattern: "invalidateQueries.*new-count"
---

<objective>
Fix three UAT-reported gaps in the categories settings UI: (1) slow optimistic weight updates, (2) undiscoverable hover-reveal rename/delete buttons, and (3) badge dismiss not working on weight change.

Purpose: Users reported weight changes feeling slow, being unable to find rename/delete buttons, and badge not dismissing. These are the most impactful settings panel bugs from UAT.
Output: Settings panel with instant weight feedback, always-visible action buttons, and proper badge lifecycle.
</objective>

<execution_context>
@./.claude/agents/gsd-executor.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08.2-category-data-model-refactor/08.2-05-SUMMARY.md
@.planning/phases/08.2-category-data-model-refactor/08.2-UAT.md

Key files:
@frontend/src/hooks/useCategories.ts
@frontend/src/components/settings/CategoryChildRow.tsx
@frontend/src/components/settings/CategoryParentRow.tsx
@frontend/src/components/settings/CategoryTree.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix optimistic update propagation and auto-acknowledge on weight change</name>
  <files>frontend/src/hooks/useCategories.ts</files>
  <action>
Fix three issues in useCategories.ts:

**Issue A: Optimistic update may not trigger re-renders through React.memo**

The `onMutate` in `updateCategoryMutation` correctly calls `setQueryData` with a new array via `.map()`. However, `CategoryTree`, `CategoryParentRow`, and `CategoryChildRow` are all wrapped in `React.memo`. The memo comparison checks prop references. Since the `categories` array from `useQuery` IS replaced by `setQueryData`, the tree-building `useMemo` in `CategoriesSection` WILL recompute (it depends on `categories`). The parent/children/ungrouped arrays produced by useMemo are new references each time, so memo'd components SHOULD re-render.

Investigate the actual root cause: the `weight` field in the optimistic update uses `Partial<Pick<Category, ...>>` which includes `weight` as `string | null`. When the mutation payload has `{ weight: "boost" }`, the spread `{ ...cat, ...data }` correctly updates it. The issue may be that the `updateCategory` wrapper function at line 159 passes `data` which TypeScript types as `Partial<Pick<Category, "display_name" | "parent_id" | "weight" | "is_hidden" | "is_seen">>`. The `weight` field on Category is typed as `string | null`, but the weight preset strip passes a string like "boost". Verify this path works.

If the optimistic path IS working but the delay is perceived, it could be that `onSettled` immediately fires `invalidateQueries` which triggers a refetch that briefly shows stale data. To improve this: keep the optimistic update as-is but ensure the `onSettled` refetch doesn't cause a visible flicker.

**Issue B: Weight change does not auto-acknowledge the category**

In `updateCategoryMutation.onSettled`, add invalidation of `['categories', 'new-count']`. This ensures the badge count refreshes after weight changes.

Additionally, in the `updateCategory` wrapper function, when the mutation data includes a `weight` field, automatically include `is_seen: true` in the payload so that changing a weight also acknowledges the category. This matches the Phase 08.1 decision: "Auto-acknowledge categories on weight or group weight change for seamless badge dismissal."

Modify the wrapper at line 159:
```typescript
updateCategory: (id: number, data: ...) => {
  // Auto-acknowledge when changing weight
  const payload = data.weight !== undefined ? { ...data, is_seen: true } : data;
  updateCategoryMutation.mutate({ id, data: payload });
}
```

**Issue C: onSettled missing new-count invalidation**

In `updateCategoryMutation.onSettled`, add:
```typescript
queryClient.invalidateQueries({ queryKey: ["categories", "new-count"] });
```
  </action>
  <verify>
1. `cd /Users/cstalhem/projects/rss-reader/frontend && npx tsc --noEmit` passes
2. Read useCategories.ts to confirm: (a) onSettled includes `["categories", "new-count"]` invalidation, (b) updateCategory wrapper auto-includes `is_seen: true` when weight is present
  </verify>
  <done>
Weight changes through the settings panel include is_seen: true in the mutation payload, and onSettled invalidates the new-count query. Optimistic update path confirmed working.
  </done>
</task>

<task type="auto">
  <name>Task 2: Make rename/delete buttons always visible and badge X icon discoverable</name>
  <files>
    frontend/src/components/settings/CategoryChildRow.tsx
    frontend/src/components/settings/CategoryParentRow.tsx
  </files>
  <action>
Fix two UI discoverability issues:

**Issue A: Rename/delete buttons hidden behind hover-reveal**

In `CategoryChildRow.tsx` (lines 183-234), the action buttons Flex wrapper has:
```
maxW={{ base: "auto", md: "0" }}
_groupHover={{ maxW: "110px" }}
```
This makes buttons invisible on desktop until row hover. User could not find them.

**Fix:** Remove the hover-reveal pattern. Make buttons always visible at a small, non-intrusive size. Change the Flex wrapper to:
```tsx
<Flex overflow="hidden" gap={0}>
```
Remove `maxW`, `_groupHover`, and `transition` props. The buttons are already `size="xs"` and `variant="ghost"` so they are visually subtle when not hovered.

Apply the same fix in `CategoryParentRow.tsx` (lines 109-143) which has the same pattern:
```
maxW={{ base: "auto", md: "0" }}
_groupHover={{ maxW: "80px" }}
```
Change to a simple `<Flex gap={0}>` wrapper with no max-width animation.

**Issue B: Badge X icon hidden behind hover-reveal**

In `CategoryChildRow.tsx` (lines 148-172), the badge "New" has an X icon wrapped in:
```tsx
<Box maxW="0" overflow="hidden" _groupHover={{ maxW: "20px", pr: 1 }}>
```
This X icon only appears on row hover, making it undiscoverable.

**Fix:** Make the X icon always visible. Change the Box wrapper to always show the icon:
```tsx
<Box display="flex" alignItems="center" pr={1}>
  <LuX size={14} />
</Box>
```
Remove `maxW`, `overflow`, `transition`, and `_groupHover` props.
  </action>
  <verify>
1. `cd /Users/cstalhem/projects/rss-reader/frontend && npx tsc --noEmit` passes
2. Read CategoryChildRow.tsx and CategoryParentRow.tsx to confirm no `maxW: "0"` patterns remain on action button wrappers
3. `cd /Users/cstalhem/projects/rss-reader/frontend && bun run build` succeeds
  </verify>
  <done>
Rename, delete, and hide buttons are always visible on both CategoryChildRow and CategoryParentRow. Badge X icon is always visible next to the "New" text. No hover-reveal patterns remain on action buttons.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles with zero errors
2. Production build succeeds
3. No `maxW: "0"` + `_groupHover` patterns on action button wrappers in CategoryChildRow or CategoryParentRow
4. useCategories updateCategory wrapper includes `is_seen: true` when weight is in payload
5. useCategories onSettled invalidates `["categories", "new-count"]`
</verification>

<success_criteria>
- Weight change in settings panel includes is_seen auto-acknowledge
- New-count badge refreshes after weight changes
- Rename/delete buttons visible without hover on both parent and child rows
- Badge X icon visible without hover
- Zero TypeScript errors, production build passes
</success_criteria>

<output>
After completion, create `.planning/phases/08.2-category-data-model-refactor/08.2-06-SUMMARY.md`
</output>
