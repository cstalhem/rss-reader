---
phase: 08.2-category-data-model-refactor
plan: 04
type: execute
wave: 3
depends_on: [08.2-02, 08.2-03]
files_modified:
  - frontend/src/lib/types.ts
  - frontend/src/lib/api.ts
  - frontend/src/hooks/useCategories.ts
  - frontend/src/hooks/usePreferences.ts
autonomous: true
requirements: [CATGRP-01, CATGRP-02, CATGRP-03, CATGRP-04]
must_haves:
  truths:
    - "Frontend Category type has numeric id, display_name, slug, weight, parent_id, article_count fields"
    - "Frontend Article type has categories as rich objects (not string arrays)"
    - "API client functions call new endpoints with numeric IDs"
    - "useCategories hook returns Category objects and exposes ID-based mutations"
    - "usePreferences no longer exposes topic_weights or category_groups"
  artifacts:
    - path: "frontend/src/lib/types.ts"
      provides: "Category, ArticleCategory interfaces, updated Article interface"
      contains: "interface Category"
    - path: "frontend/src/lib/api.ts"
      provides: "New API client functions for ID-based category endpoints"
      contains: "fetchCategories.*Category"
    - path: "frontend/src/hooks/useCategories.ts"
      provides: "Hook returning Category objects with ID-based mutations"
      contains: "Category"
    - path: "frontend/src/hooks/usePreferences.ts"
      provides: "Simplified preferences hook without category fields"
      contains: "usePreferences"
  key_links:
    - from: "frontend/src/hooks/useCategories.ts"
      to: "frontend/src/lib/api.ts"
      via: "Calls new category API functions"
      pattern: "fetchCategories|updateCategory|deleteCategory|mergeCategories"
    - from: "frontend/src/lib/api.ts"
      to: "backend/src/backend/main.py"
      via: "HTTP requests to /api/categories endpoints with numeric IDs"
      pattern: "/api/categories"
---

<objective>
Update frontend TypeScript types, API client, and hooks to match the new backend API contract with numeric IDs and rich category objects.

Purpose: The data layer must be updated before components can render the new category model. Types, API functions, and hooks form the bridge between backend and UI.
Output: Complete frontend data layer matching the new relational API contract.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08.2-category-data-model-refactor/08.2-CONTEXT.md
@.planning/phases/08.2-category-data-model-refactor/08.2-RESEARCH.md
@.planning/phases/08.2-category-data-model-refactor/08.2-03-SUMMARY.md
@frontend/src/lib/types.ts
@frontend/src/lib/api.ts
@frontend/src/hooks/useCategories.ts
@frontend/src/hooks/usePreferences.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update TypeScript types and API client for new category model</name>
  <files>frontend/src/lib/types.ts, frontend/src/lib/api.ts</files>
  <action>
**types.ts changes:**

1. Add `ArticleCategory` interface (embedded in article responses):
   ```typescript
   export interface ArticleCategory {
     id: number;
     display_name: string;
     slug: string;
     effective_weight: string;
     parent_display_name: string | null;
   }
   ```

2. Add `Category` interface (full category for settings):
   ```typescript
   export interface Category {
     id: number;
     display_name: string;
     slug: string;
     weight: string | null;
     parent_id: number | null;
     is_hidden: boolean;
     is_seen: boolean;
     is_manually_created: boolean;
     article_count: number;
   }
   ```

3. Update `Article` interface:
   - Change `categories: string[] | null` to `categories: ArticleCategory[] | null`

4. Update `UserPreferences` interface:
   - Remove `topic_weights: Record<string, string> | null`
   - Remove `category_groups: CategoryGroups | null`
   - Keep `interests`, `anti_interests`, `updated_at`

5. Remove `CategoryGroups` interface entirely

6. Remove the import/export of `CategoryGroups` from anywhere

**api.ts changes:**

1. Update imports: Add `Category`, `ArticleCategory`. Remove `CategoryGroups`.

2. **Replace `fetchCategories(): Promise<string[]>`** with:
   ```typescript
   export async function fetchCategories(): Promise<Category[]> {
     const response = await fetch(`${API_BASE_URL}/api/categories`);
     if (!response.ok) throw new Error(`Failed to fetch categories: ${response.statusText}`);
     return response.json();
   }
   ```

3. **Replace `updateCategoryWeight(category, weight)`** with:
   ```typescript
   export async function updateCategory(
     id: number,
     data: { display_name?: string; parent_id?: number | null; weight?: string | null; is_hidden?: boolean; is_seen?: boolean }
   ): Promise<Category> {
     const response = await fetch(`${API_BASE_URL}/api/categories/${id}`, {
       method: "PATCH",
       headers: { "Content-Type": "application/json" },
       body: JSON.stringify(data),
     });
     if (!response.ok) throw new Error(`Failed to update category: ${response.statusText}`);
     return response.json();
   }
   ```

4. **Replace `createCategory(name)`** with:
   ```typescript
   export async function createCategory(
     displayName: string,
     parentId?: number | null
   ): Promise<Category> {
     const response = await fetch(`${API_BASE_URL}/api/categories`, {
       method: "POST",
       headers: { "Content-Type": "application/json" },
       body: JSON.stringify({ display_name: displayName, parent_id: parentId }),
     });
     if (!response.ok) {
       const body = await response.json().catch(() => null);
       throw new Error(body?.detail ?? `Failed to create category: ${response.statusText}`);
     }
     return response.json();
   }
   ```

5. **Replace `deleteCategory(name)`** with:
   ```typescript
   export async function deleteCategory(id: number): Promise<{ ok: boolean }> {
     const response = await fetch(`${API_BASE_URL}/api/categories/${id}`, {
       method: "DELETE",
     });
     if (!response.ok) throw new Error(`Failed to delete category: ${response.statusText}`);
     return response.json();
   }
   ```

6. **Add mergeCategories:**
   ```typescript
   export async function mergeCategories(
     sourceId: number,
     targetId: number
   ): Promise<{ ok: boolean; articles_moved: number }> {
     const response = await fetch(`${API_BASE_URL}/api/categories/merge`, {
       method: "POST",
       headers: { "Content-Type": "application/json" },
       body: JSON.stringify({ source_id: sourceId, target_id: targetId }),
     });
     if (!response.ok) throw new Error(`Failed to merge categories: ${response.statusText}`);
     return response.json();
   }
   ```

7. **Replace `fetchNewCategoryCount()`** — endpoint stays same but response shape may change:
   ```typescript
   export async function fetchNewCategoryCount(): Promise<{ count: number }> {
     const response = await fetch(`${API_BASE_URL}/api/categories/new-count`);
     if (!response.ok) throw new Error(`Failed to fetch new category count: ${response.statusText}`);
     return response.json();
   }
   ```
   Note: `returned_count` is removed from the response.

8. **Replace `acknowledgeCategories(categories: string[])`** with:
   ```typescript
   export async function acknowledgeCategories(categoryIds: number[]): Promise<{ ok: boolean }> {
     const response = await fetch(`${API_BASE_URL}/api/categories/acknowledge`, {
       method: "POST",
       headers: { "Content-Type": "application/json" },
       body: JSON.stringify({ category_ids: categoryIds }),
     });
     if (!response.ok) throw new Error(`Failed to acknowledge categories: ${response.statusText}`);
     return response.json();
   }
   ```

9. **Replace `hideCategory(name)` / `unhideCategory(name)`** with ID-based versions:
   ```typescript
   export async function hideCategory(id: number): Promise<Category> {
     const response = await fetch(`${API_BASE_URL}/api/categories/${id}/hide`, { method: "PATCH" });
     if (!response.ok) throw new Error(`Failed to hide category: ${response.statusText}`);
     return response.json();
   }

   export async function unhideCategory(id: number): Promise<Category> {
     const response = await fetch(`${API_BASE_URL}/api/categories/${id}/unhide`, { method: "PATCH" });
     if (!response.ok) throw new Error(`Failed to unhide category: ${response.statusText}`);
     return response.json();
   }
   ```

10. **Remove**: `renameCategory`, `saveCategoryGroups`, `fetchCategoryGroups` functions entirely. Rename is now done via `updateCategory(id, { display_name: newName })`. Groups are now implicit via parent_id.

11. **Update `updatePreferences`**: Remove any reference to `topic_weights` in the type. The function stays the same but the body will no longer include topic_weights.
  </action>
  <verify>
`cd frontend && npx tsc --noEmit 2>&1 | head -30` — expect type errors in hooks and components (those files still use old types). types.ts and api.ts themselves should have no internal errors.
  </verify>
  <done>TypeScript types match new backend API contract. API client functions use numeric IDs. CategoryGroups type removed. Article.categories is now ArticleCategory[]. Old string-based API functions replaced.</done>
</task>

<task type="auto">
  <name>Task 2: Update useCategories and usePreferences hooks</name>
  <files>frontend/src/hooks/useCategories.ts, frontend/src/hooks/usePreferences.ts</files>
  <action>
**useCategories.ts — Full rewrite:**

The hook now works with Category objects (numeric IDs) instead of string names and CategoryGroups JSON.

```typescript
"use client";

import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import {
  fetchCategories,
  fetchNewCategoryCount,
  updateCategory as apiUpdateCategory,
  createCategory as apiCreateCategory,
  deleteCategory as apiDeleteCategory,
  hideCategory as apiHideCategory,
  unhideCategory as apiUnhideCategory,
  acknowledgeCategories as apiAcknowledgeCategories,
  mergeCategories as apiMergeCategories,
} from "@/lib/api";
import { Category } from "@/lib/types";
import { toaster } from "@/components/ui/toaster";
```

Return type should include:
- `categories: Category[]` — all categories
- `newCount: number` — unseen count
- `isLoading: boolean`
- `updateCategory(id: number, data: Partial<Category>) => void` — PATCH
- `createCategory(displayName: string, parentId?: number) => void` — POST
- `deleteCategory(id: number) => void` — DELETE
- `hideCategory(id: number) => void`
- `unhideCategory(id: number) => void`
- `acknowledge(categoryIds: number[]) => void`
- `mergeCategories(sourceId: number, targetId: number) => void`

Key changes from old hook:
- No more `categoryGroups` query (groups are implicit via parent_id)
- No more `saveGroups` mutation
- No more `renameCategory` — use `updateCategory` with `display_name`
- All mutations invalidate `["categories"]` query key
- `newCountQuery` now returns `{ count: number }` (no returned_count)
- Optimistic updates for weight changes: `queryClient.setQueryData(["categories"], ...)` to update the weight field on the category in the cache
- Error toasts on mutation failure

Mutations with optimistic updates (for responsiveness):
- `updateCategory` — optimistically update the category in the cached list
  - `onMutate`: cancel queries, snapshot, update cache
  - `onError`: rollback from snapshot, show toast
  - `onSettled`: invalidate to refetch

Simple mutations (no optimistic update needed):
- `createCategory`, `deleteCategory`, `hideCategory`, `unhideCategory`, `acknowledge`, `mergeCategories` — just invalidate on success, toast on error

Remove all references to:
- `fetchCategoryGroups`, `saveCategoryGroups` (deleted from api.ts)
- `renameCategory` (now `updateCategory` with display_name)
- `returnedCount` (removed)
- `allCategories` as string[] (now Category[])

**usePreferences.ts changes:**

- The `UserPreferences` type no longer has `topic_weights` or `category_groups`
- No code changes needed in the hook itself beyond what the type change enforces
- Verify that no component that imports `usePreferences` tries to access `preferences.topic_weights` or `preferences.category_groups` — those will be compile errors caught by TypeScript
  </action>
  <verify>
`cd frontend && npx tsc --noEmit 2>&1 | head -50` — expect remaining errors only in component files (CategoriesSection, CategoryTree, etc.) that still reference old types. The hooks themselves should compile cleanly.
  </verify>
  <done>useCategories returns Category objects with ID-based mutations. Optimistic updates for weight changes. No more CategoryGroups or string-based operations. usePreferences cleaned of category fields.</done>
</task>

</tasks>

<verification>
- types.ts defines Category, ArticleCategory interfaces
- api.ts has all new endpoint functions with numeric IDs
- useCategories.ts compiles and exports Category-based return type
- `cd frontend && npx tsc --noEmit 2>&1 | grep -c "error"` shows errors only in component files (not in types, api, or hooks)
</verification>

<success_criteria>
- Article.categories typed as ArticleCategory[] (rich objects)
- Category type has all fields from backend CategoryResponse
- API client uses numeric IDs in all category endpoints
- useCategories returns Category[] and exposes ID-based mutations with optimistic updates
- CategoryGroups type and all related API functions removed
- UserPreferences type no longer includes topic_weights or category_groups
</success_criteria>

<output>
After completion, create `.planning/phases/08.2-category-data-model-refactor/08.2-04-SUMMARY.md`
</output>
