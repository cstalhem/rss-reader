---
phase: 08.2-category-data-model-refactor
plan: 05
type: execute
wave: 3
depends_on: [08.2-03, 08.2-04]
files_modified:
  - frontend/src/components/settings/CategoriesSection.tsx
  - frontend/src/components/settings/CategoryTree.tsx
  - frontend/src/components/settings/CategoryParentRow.tsx
  - frontend/src/components/settings/CategoryChildRow.tsx
  - frontend/src/components/settings/CategoryRow.tsx
  - frontend/src/components/settings/CreateCategoryPopover.tsx
  - frontend/src/components/settings/DeleteCategoryDialog.tsx
  - frontend/src/components/article/ArticleRow.tsx
  - frontend/src/components/article/ArticleReader.tsx
  - frontend/src/components/article/TagChip.tsx
autonomous: true
requirements: [CATGRP-01, CATGRP-02, CATGRP-03, CATGRP-04]
must_haves:
  truths:
    - "CategoriesSection renders categories from Category objects with display_name instead of kebab-case strings"
    - "CategoryTree builds parent-child tree from flat Category list using parent_id"
    - "Weight changes call updateCategory with numeric ID"
    - "ArticleRow renders category.display_name from rich ArticleCategory objects"
    - "ArticleReader renders category.display_name with effective_weight from embedded objects"
    - "TagChip displays display_name and uses effective_weight for styling"
    - "All components compile without TypeScript errors"
  artifacts:
    - path: "frontend/src/components/settings/CategoriesSection.tsx"
      provides: "Category tree UI using Category objects"
      contains: "useCategories"
    - path: "frontend/src/components/article/ArticleRow.tsx"
      provides: "Article row with rich category display"
      contains: "display_name"
  key_links:
    - from: "frontend/src/components/settings/CategoriesSection.tsx"
      to: "frontend/src/hooks/useCategories.ts"
      via: "Consumes Category objects and ID-based mutations"
      pattern: "useCategories"
    - from: "frontend/src/components/article/ArticleRow.tsx"
      to: "frontend/src/lib/types.ts"
      via: "Renders ArticleCategory.display_name"
      pattern: "ArticleCategory|display_name"
---

<objective>
Update all frontend components to work with Category objects (numeric IDs, display_name) instead of kebab-case strings and JSON blobs.

Purpose: The UI must render human-readable display names, use numeric IDs for mutations, and build the tree from the flat Category list.
Output: Fully functional frontend with no TypeScript errors, rendering display names and using relational API contract.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08.2-category-data-model-refactor/08.2-CONTEXT.md
@.planning/phases/08.2-category-data-model-refactor/08.2-04-SUMMARY.md
@frontend/src/lib/types.ts
@frontend/src/hooks/useCategories.ts
@frontend/src/components/settings/CategoriesSection.tsx
@frontend/src/components/settings/CategoryTree.tsx
@frontend/src/components/settings/CategoryParentRow.tsx
@frontend/src/components/settings/CategoryChildRow.tsx
@frontend/src/components/settings/CreateCategoryPopover.tsx
@frontend/src/components/settings/DeleteCategoryDialog.tsx
@frontend/src/components/article/ArticleRow.tsx
@frontend/src/components/article/ArticleReader.tsx
@frontend/src/components/article/TagChip.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update CategoriesSection and CategoryTree for Category objects</name>
  <files>frontend/src/components/settings/CategoriesSection.tsx, frontend/src/components/settings/CategoryTree.tsx, frontend/src/components/settings/CategoryParentRow.tsx, frontend/src/components/settings/CategoryChildRow.tsx, frontend/src/components/settings/CategoryRow.tsx, frontend/src/components/settings/CreateCategoryPopover.tsx, frontend/src/components/settings/DeleteCategoryDialog.tsx</files>
  <action>
**CategoriesSection.tsx — Major refactor:**

The component currently works with string-based categories and reads `preferences.topic_weights` directly. It needs to switch to Category objects from `useCategories`.

Key changes:
1. Remove `usePreferences` import — no longer needed for topic_weights
2. Remove imports for `apiUpdateCategoryWeight` and `apiUpdatePreferences` — weight lives on Category now
3. Remove `categoryWeightMutation` and `resetWeightMutation` — these are replaced by `updateCategory` from the hook
4. From `useCategories`, use the new return shape: `categories` (Category[]), `newCount`, `updateCategory`, `createCategory`, `deleteCategory`, `hideCategory`, `acknowledge`
5. Build the tree in `useMemo` from the flat Category array:
   - Build `childrenMap: Record<number, Category[]>` by grouping categories by parent_id (where parent_id is not null)
   - `parentIds`: Set of all IDs that appear as someone's parent_id
   - Parents: categories where `parent_id === null` AND `id` is in parentIds
   - Ungrouped: categories where `parent_id === null` AND `id` is NOT in parentIds AND `is_hidden === false`
   - Filter out hidden categories
6. `newCategories` set: categories where `is_seen === false && is_hidden === false`, as `Set<number>` of IDs
7. Weight change handler: call `updateCategory(categoryId, { weight })` instead of `apiUpdateCategoryWeight(name, weight)`
8. Reset weight handler: call `updateCategory(categoryId, { weight: null })` to clear (inherit from parent). The backend PATCH endpoint needs to handle null weight to mean "remove override, inherit from parent". Use a convention: sending `weight: null` in the JSON body means "clear explicit weight". Note: JSON null is distinct from missing key.
9. Rename handler: call `updateCategory(categoryId, { display_name: newName })` instead of `renameCategory`
10. Delete handler: call `deleteCategory(categoryId)` instead of `deleteCategory(name)`. Update DeleteCategoryDialog to accept numeric ID.
11. Hide handler: call `hideCategory(categoryId)` instead of `hideCategory(name)`
12. Badge dismiss handler: call `acknowledge([categoryId])` instead of `acknowledge([name])`
13. Create handler: call `createCategory(displayName)` instead of `createCategory(name)`. Update CreateCategoryPopover if it validates against existing names — now validate against display_name.
14. DnD handler: on drag end, call `updateCategory(draggedCategoryId, { parent_id: targetParentId })` or `updateCategory(draggedCategoryId, { parent_id: null })` for ungrouping. No more `saveGroups` with the entire children map. Parse stringified IDs from DnD events back to numbers.
15. Search filtering: filter on `category.display_name` instead of kebab-case strings
16. Remove `toTitleCase()` helper — display names are already human-readable
17. DragOverlay: show the dragged category's `display_name` (look it up from categories array by ID)

**CategoryTree.tsx changes:**

Props now use Category objects instead of strings:
```typescript
interface CategoryTreeProps {
  parents: Category[];
  childrenMap: Record<number, Category[]>;
  ungroupedCategories: Category[];
  newCategoryIds: Set<number>;
  onWeightChange: (categoryId: number, weight: string) => void;
  onResetWeight: (categoryId: number) => void;
  onHide: (categoryId: number) => void;
  onBadgeDismiss: (categoryId: number) => void;
  isDndEnabled?: boolean;
  activeId?: string | null;
  onRename: (categoryId: number, newName: string) => void;
  onDelete: (categoryId: number) => void;
}
```

- Iterate over `parents` array instead of `Object.keys(children)`
- Get child categories from `childrenMap[parent.id] ?? []`
- `getEffectiveWeight`: if `category.weight !== null` return it, else if parent exists and parent.weight !== null return parent.weight, else "normal"
- `isOverridden`: `category.weight !== null`
- Display `category.display_name` everywhere

**CategoryParentRow.tsx changes:**
- Props change from `category: string` to `category: Category`
- Display `category.display_name`
- Callback args change from string name to numeric ID
- DnD IDs: use `parent:${category.id}` format
- Weight from `category.weight ?? "normal"`

**CategoryChildRow.tsx changes:**
- Props change from `category: string` to `category: Category`
- Display `category.display_name`
- Callback args change from string name to numeric ID
- DnD IDs: use `category.id.toString()`
- `isOverridden` based on `category.weight !== null`
- `isNew` based on `newCategoryIds.has(category.id)`

**CategoryRow.tsx** (if used): Update similarly.

**CreateCategoryPopover.tsx changes:**
- `existingCategories` prop changes from `string[]` to `Category[]`
- Duplicate check: compare against `category.display_name` (case-insensitive) instead of raw strings
- On submit: pass the user-entered display_name to the parent's create handler

**DeleteCategoryDialog.tsx changes:**
- `categoryName` prop stays as `string | null` (display_name for UI text) — no change needed if it just shows the name
- Or if it passes data back, ensure it works with IDs. The parent (CategoriesSection) already tracks the category to delete.
  </action>
  <verify>
`cd frontend && npx tsc --noEmit 2>&1 | grep -c "error"` — all settings component errors should be resolved.
  </verify>
  <done>CategoriesSection, CategoryTree, CategoryParentRow, CategoryChildRow, CreateCategoryPopover, DeleteCategoryDialog all work with Category objects. Display names rendered. Weight changes use numeric IDs. DnD reparents via PATCH /api/categories/:id. Search filters on display_name.</done>
</task>

<task type="auto">
  <name>Task 2: Update article components for rich category embeds</name>
  <files>frontend/src/components/article/ArticleRow.tsx, frontend/src/components/article/ArticleReader.tsx, frontend/src/components/article/TagChip.tsx</files>
  <action>
**ArticleRow.tsx changes:**

The component renders `article.categories` which is now `ArticleCategory[] | null` instead of `string[] | null`.

1. Update the categories rendering section:
   - Instead of `article.categories.slice(0, 3).map((category, index) => <TagChip key={index} label={category} />)`
   - Use: `article.categories.slice(0, 3).map((cat) => <TagChip key={cat.id} label={cat.display_name} />)`
2. The `+N more` count logic stays the same, just checking `.length`

**ArticleReader.tsx changes:**

The reader displays categories with interactive weight controls via TagChip.

1. Categories are now `ArticleCategory[]` objects with `effective_weight` already computed
2. Instead of looking up `preferences.topic_weights[category]` for the current weight, use `cat.effective_weight` directly from the article response
3. For weight change mutation:
   - Old: `apiUpdateCategoryWeight(category_name, weight)`
   - New: import `updateCategory` from `@/lib/api` and call `updateCategory(cat.id, { weight })`
   - Update the mutation function signature from `({ category, weight })` to `({ categoryId, weight }: { categoryId: number; weight: string })`
4. Remove `usePreferences` import if it was only used for topic_weights lookup
5. Render `cat.display_name` instead of the raw category string
6. TagChip `label` prop gets `cat.display_name`
7. TagChip `currentWeight` prop gets `cat.effective_weight`

**TagChip.tsx changes:**

1. The `label` prop already accepts a string — now receives `display_name` instead of kebab-case. No code change needed for the label.
2. Update the weight styling map to use new names (with old names as aliases):
   ```typescript
   const weightColors = {
     block: { bg: "red.subtle", color: "red.fg", textDecoration: "line-through" },
     reduce: { bg: "bg.emphasized", color: "fg.muted" },
     normal: { bg: "bg.emphasized", color: "fg.default" },
     boost: { bg: "accent.subtle", color: "accent.fg" },
     max: { bg: "accent.emphasized", color: "accent.contrast" },
     // Old names as aliases
     blocked: { bg: "red.subtle", color: "red.fg", textDecoration: "line-through" },
     low: { bg: "bg.emphasized", color: "fg.muted" },
     neutral: { bg: "bg.emphasized", color: "fg.default" },
     medium: { bg: "accent.subtle", color: "accent.fg" },
     high: { bg: "accent.emphasized", color: "accent.contrast" },
   };
   ```
3. Update `weightOptions` to use new names:
   ```typescript
   const weightOptions = [
     { value: "max", label: "Max" },
     { value: "boost", label: "Boost" },
     { value: "normal", label: "Normal" },
     { value: "reduce", label: "Reduce" },
     { value: "block", label: "Block" },
   ];
   ```
4. Remove `textTransform="lowercase"` from the Badge — display names should render as-is (they're already properly cased)

**Final checks:** Search the entire frontend for any remaining references to:
- `CategoryGroups` type
- `topic_weights` on preferences
- `category_groups` on preferences
- `article.categories` used as `string[]`
Fix any remaining TypeScript errors.

Run: `cd frontend && npx tsc --noEmit` — should have zero errors.
Run: `cd frontend && bun run build` — should succeed.
Run: `cd frontend && bun run lint` — should pass.
  </action>
  <verify>
`cd frontend && npx tsc --noEmit` passes with zero errors. `cd frontend && bun run build` succeeds. `cd frontend && bun run lint` passes.
  </verify>
  <done>All frontend components render display_name instead of kebab strings. ArticleRow and ArticleReader use rich ArticleCategory objects. TagChip uses new weight names. Zero TypeScript errors. Build succeeds.</done>
</task>

</tasks>

<verification>
- `cd frontend && npx tsc --noEmit` — zero errors
- `cd frontend && bun run build` — success
- `cd frontend && bun run lint` — passes
- All category-related components render display_name
- No references to CategoryGroups type remain
- No references to topic_weights or category_groups on preferences remain in components
</verification>

<success_criteria>
- CategoriesSection builds tree from flat Category array using parent_id
- Category display names shown throughout UI (not kebab-case)
- Weight operations use numeric category IDs
- DnD reparenting calls PATCH /api/categories/:id with parent_id
- Article list shows display_name tags
- Article reader shows display_name with effective_weight
- TypeScript compiles with zero errors
- Production build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/08.2-category-data-model-refactor/08.2-05-SUMMARY.md`
</output>
