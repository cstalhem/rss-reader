---
phase: 08.2-category-data-model-refactor
plan: 03
subsystem: api
tags: [fastapi, pydantic, sqlalchemy, selectinload, rest-api, category-crud]

# Dependency graph
requires:
  - phase: 08.2-category-data-model-refactor
    plan: 01
    provides: "Category and ArticleCategoryLink SQLModel tables with relational data"
provides:
  - "Complete category CRUD API with numeric IDs (GET/POST/PATCH/DELETE)"
  - "Category merge endpoint (POST /api/categories/merge)"
  - "Category hide/unhide endpoints with numeric IDs"
  - "Category new-count and acknowledge endpoints using relational queries"
  - "Rich article category embeds with effective_weight and parent_display_name"
  - "ArticleResponse Pydantic model with eager-loaded categories"
  - "get_effective_weight helper in scoring.py"
affects: [08.2-04, 08.2-05, frontend-types, frontend-api, frontend-hooks]

# Tech tracking
tech-stack:
  added: []
  patterns: [selectinload with joinedload chain for eager loading many-to-many + parent, ArticleResponse model for enriched article serialization]

key-files:
  created: []
  modified:
    - backend/src/backend/main.py
    - backend/src/backend/scoring.py

key-decisions:
  - "Used selectinload(categories_rel).joinedload(parent) chain for eager loading categories and their parents in article queries"
  - "ArticleResponse Pydantic model replaces direct Article model serialization to include rich category embeds"
  - "CategoryUpdate uses parent_id=-1 as sentinel to move to root, None means no change"
  - "Weight value 'inherit' in PATCH sets weight to None (inherit from parent)"
  - "Merge endpoint deletes source links and creates new target links (composite PK can't be updated)"

patterns-established:
  - "_article_to_response helper converts Article+loaded categories_rel into ArticleResponse with embeds"
  - "_category_to_response helper converts Category to CategoryResponse with article_count via JOIN"
  - "VALID_WEIGHTS set constant for weight validation across category endpoints"

requirements-completed: [CATGRP-01, CATGRP-02, CATGRP-03, CATGRP-04]

# Metrics
duration: 6.0min
completed: 2026-02-17
---

# Phase 08.2 Plan 03: Category API Endpoints Summary

**Complete REST API with numeric-ID category CRUD, merge, hide/unhide, and rich article category embeds with effective_weight resolution**

## Performance

- **Duration:** 6.0 min
- **Started:** 2026-02-17T18:43:38Z
- **Completed:** 2026-02-17T18:49:38Z
- **Tasks:** 2
- **Files modified:** 2

## Accomplishments
- Replaced ~15 old JSON-based category endpoints with 9 clean relational endpoints using numeric IDs
- Article list/detail/update now return rich category objects with effective_weight and parent_display_name
- Eager loading via selectinload chain prevents N+1 queries on article-category relationships
- PreferencesResponse cleaned of category data (topic_weights, category_groups removed)

## Task Commits

Each task was committed atomically:

1. **Task 1: Add new Pydantic models and rewrite category endpoints** - `7b6b878` (feat)
2. **Task 2: Update article list and detail endpoints to embed rich category objects** - `a88c315` (feat)

## Files Created/Modified
- `backend/src/backend/main.py` - Rewrote all category endpoints to relational queries, added ArticleResponse/ArticleCategoryEmbed models, updated article endpoints with selectinload
- `backend/src/backend/scoring.py` - Added get_effective_weight helper for three-tier weight resolution (already had get_or_create_category from Plan 02 parallel execution)

## Decisions Made
- Used `selectinload(Article.categories_rel).joinedload(Category.parent)` chain to eagerly load both the many-to-many categories and each category's parent in a single query strategy
- Created `_article_to_response` helper that converts Article model + loaded relationships into a clean Pydantic response, keeping serialization logic centralized
- For PATCH category updates, `parent_id: -1` serves as sentinel to move to root (since `None` means "don't change")
- For weight updates, string value `"inherit"` sets weight to `None` to distinguish from "don't change weight"
- Merge endpoint handles composite PK constraint by deleting old links and creating new ones rather than trying to UPDATE the link table

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Added get_effective_weight to scoring.py**
- **Found during:** Task 1 (pre-work for Task 2)
- **Issue:** Plan references importing get_effective_weight from scoring.py, but the function did not exist
- **Fix:** Added get_effective_weight function implementing three-tier weight resolution (explicit > parent > normal)
- **Files modified:** backend/src/backend/scoring.py
- **Verification:** Function importable and used in _article_to_response
- **Committed in:** 7b6b878 (part of scoring.py changes from parallel execution)

---

**Total deviations:** 1 auto-fixed (1 blocking)
**Impact on plan:** Essential dependency for Task 2. No scope creep.

## Issues Encountered
- scoring.py was being modified by a parallel Plan 02 execution, which added get_or_create_category and updated compute_composite_score. Worked with the resulting state without conflict.

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- All category CRUD operations use numeric IDs in URL path params
- Categories returned as flat list with parent_id (frontend builds tree)
- Article counts computed via JOIN (no cached column)
- Merge endpoint moves associations and deletes source
- Article list/detail includes rich category embeds with effective_weight
- Ready for Plan 04 (frontend type/API updates) to consume the new API contract
- Ready for Plan 05 (frontend component updates) to render rich category objects

## Self-Check: PASSED

- [x] main.py exists with new category endpoints
- [x] scoring.py exists with get_effective_weight
- [x] SUMMARY.md created
- [x] Commit 7b6b878 found (Task 1)
- [x] Commit a88c315 found (Task 2)

---
*Phase: 08.2-category-data-model-refactor*
*Completed: 2026-02-17*
