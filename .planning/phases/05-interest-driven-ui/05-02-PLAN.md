---
phase: 05-interest-driven-ui
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - frontend/src/components/article/ScoreBadge.tsx
  - frontend/src/components/article/SortSelect.tsx
  - frontend/src/components/article/ArticleRow.tsx
  - frontend/src/components/article/ArticleList.tsx
  - frontend/src/components/article/ArticleReader.tsx
autonomous: true

must_haves:
  truths:
    - "Each scored article row displays a numeric score badge with color coding (>=15 accent, >=8 neutral, <8 muted)"
    - "High-scored rows (>=15) have a subtle accent background tint"
    - "User can select from 4 sort options via a dropdown: Highest score, Lowest score, Newest first, Oldest first"
    - "Sort selection persists across sessions via localStorage"
    - "Filter bar shows Unread | All | Scoring (N) | Blocked (N) tabs"
    - "Scoring and Blocked tabs are disabled when their count is 0"
    - "Scoring tab shows pulsing dot for queued, spinner for scoring articles"
    - "Blocked articles are hidden from Unread and All views"
    - "Score badge in ArticleRow shows tooltip with exact score on hover"
    - "ArticleReader displays exact score with one decimal"
  artifacts:
    - path: "frontend/src/components/article/ScoreBadge.tsx"
      provides: "Score badge component with color tiers and tooltip"
      exports: ["ScoreBadge"]
    - path: "frontend/src/components/article/SortSelect.tsx"
      provides: "Sort dropdown with 4 options using Chakra Select"
      exports: ["SortSelect"]
    - path: "frontend/src/components/article/ArticleList.tsx"
      provides: "Updated article list with extended filter bar and sort dropdown"
      contains: "SortSelect"
    - path: "frontend/src/components/article/ArticleRow.tsx"
      provides: "Updated article row with ScoreBadge and accent tint"
      contains: "ScoreBadge"
    - path: "frontend/src/components/article/ArticleReader.tsx"
      provides: "Updated reader with ScoreBadge in header"
      contains: "ScoreBadge"
  key_links:
    - from: "frontend/src/components/article/ArticleList.tsx"
      to: "frontend/src/hooks/useSortPreference.ts"
      via: "useSortPreference hook for sort state"
      pattern: "useSortPreference"
    - from: "frontend/src/components/article/ArticleList.tsx"
      to: "frontend/src/hooks/useArticles.ts"
      via: "useArticles with sort/filter params from parseSortOption"
      pattern: "parseSortOption"
    - from: "frontend/src/components/article/ArticleRow.tsx"
      to: "frontend/src/components/article/ScoreBadge.tsx"
      via: "ScoreBadge component import"
      pattern: "ScoreBadge"
    - from: "frontend/src/components/article/SortSelect.tsx"
      to: "frontend/src/lib/types.ts"
      via: "SortOption type import"
      pattern: "SortOption"
---

<objective>
Build the visual UI components for interest-driven article presentation: score badges, sort dropdown, extended filter tabs, and integrate them into the article list, rows, and reader.

Purpose: This is the user-facing half of the phase. Score badges provide at-a-glance relevance signals. The sort dropdown gives control over article ordering. The extended filter bar (Unread | All | Scoring | Blocked) separates content by state so the main views stay clean.

Output: ScoreBadge and SortSelect components, updated ArticleRow/ArticleList/ArticleReader with all visual enhancements.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-interest-driven-ui/05-CONTEXT.md
@.planning/phases/05-interest-driven-ui/05-RESEARCH.md
@.planning/phases/05-interest-driven-ui/05-01-SUMMARY.md

@frontend/src/components/article/ArticleList.tsx
@frontend/src/components/article/ArticleRow.tsx
@frontend/src/components/article/ArticleReader.tsx
@frontend/src/components/article/TagChip.tsx
@frontend/src/lib/types.ts
@frontend/src/hooks/useSortPreference.ts
@frontend/src/hooks/useArticles.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: ScoreBadge and SortSelect components</name>
  <files>
    frontend/src/components/article/ScoreBadge.tsx
    frontend/src/components/article/SortSelect.tsx
  </files>
  <action>
**ScoreBadge.tsx**: Create a score badge component for article rows and reader.

Props: `score: number | null`, `scoringState: string`, `size?: "sm" | "md"` (sm for rows, md for reader).

Behavior:
- If `scoringState !== "scored"` or `score === null`: return null (don't render anything — the scoring state indicators in the row handle queued/scoring/unscored).
- If scored with a score:
  - `score >= 15`: accent-colored badge (use `colorPalette="accent"`, `variant="solid"`)
  - `score >= 8`: neutral badge (use `colorPalette="gray"`, `variant="subtle"`)
  - `score < 8`: muted badge (use `colorPalette="gray"`, `variant="outline"` or very faded)
  - Display score with one decimal: `score.toFixed(1)`
  - Wrap in a Chakra `Tooltip` with content `Score: {score.toFixed(1)}` for hover details

Use Chakra `Badge` component. Import `Tooltip` from `@chakra-ui/react` for the hover tooltip per user decision. Match the existing TagChip pattern for consistency (similar Badge usage).

**SortSelect.tsx**: Create a sort dropdown component.

Props: `value: SortOption`, `onChange: (value: SortOption) => void`.

Per user decision: use Chakra **custom Select** (not NativeSelect) to match the dark theme. Use `SelectRoot`, `SelectTrigger`, `SelectValueText`, `SelectContent`, `SelectItem` from Chakra UI v3 (the `@chakra-ui/react` Select components).

4 options per user decision:
- `score_desc`: "Highest score"
- `score_asc`: "Lowest score"
- `date_desc`: "Newest first"
- `date_asc`: "Oldest first"

Size: `sm`. Width: `auto` (or a sensible min-width like 160px so it doesn't jump around). The trigger should show the selected label plus a directional arrow icon — Chakra Select includes a built-in indicator, so this should work by default.

Use `SelectRoot` with `collection` prop from Chakra v3 createListCollection pattern:
```typescript
import { createListCollection } from "@chakra-ui/react";
const sortOptions = createListCollection({
  items: [
    { label: "Highest score", value: "score_desc" },
    { label: "Lowest score", value: "score_asc" },
    { label: "Newest first", value: "date_desc" },
    { label: "Oldest first", value: "date_asc" },
  ],
});
```

Handle the onChange by extracting the selected value from the Select's onValueChange callback (which provides `{ value: string[] }` in Chakra v3) and calling `onChange(value[0] as SortOption)`.
  </action>
  <verify>
Run `cd /Users/cstalhem/projects/rss-reader/frontend && npx tsc --noEmit` to verify no type errors.
  </verify>
  <done>
ScoreBadge renders colored numeric badge with tooltip for scored articles, returns null for unscored. SortSelect renders a Chakra custom Select dropdown with 4 sort options. Both components compile without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: ArticleRow, ArticleList, and ArticleReader integration</name>
  <files>
    frontend/src/components/article/ArticleRow.tsx
    frontend/src/components/article/ArticleList.tsx
    frontend/src/components/article/ArticleReader.tsx
  </files>
  <action>
**ArticleRow.tsx**: Replace the existing inline score display (the `<Box fontSize="xs" color="fg.muted">` block with manual scoring_state checks) with the new `ScoreBadge` component. The ScoreBadge handles all the logic internally.

Keep the existing scoring state indicators (Spinner for "scoring", LuClock for "queued") but move them alongside the badge: show the scoring indicator when state is queued/scoring, show ScoreBadge when state is scored. For "unscored" and "failed", keep the existing dash and red X indicators.

Add a subtle accent background tint for high-scored rows (>=15): add a conditional `bg` prop on the outer Flex: if `article.scoring_state === "scored" && article.composite_score !== null && article.composite_score >= 15`, set `bg="accent.subtle"` at very low opacity. Implementation: use Chakra's `bg` token — try `bg="rgba(var(--chakra-colors-accent-500-rgb, 255, 140, 50), 0.03)"` or simpler: conditionally apply `bg="accent.subtle"` and override with a low `opacity` wrapper. Simplest approach: use a CSS `background` with the accent color at 2-3% opacity via `css={{ background: "color-mix(in srgb, var(--chakra-colors-accent-solid) 3%, transparent)" }}`. If that doesn't work cleanly, just use `bg="accent.subtle"` — the semantic token is already very subtle in dark mode.

The hover state should still work: `_hover={{ bg: "bg.subtle" }}` should override the tint on hover.

**ArticleList.tsx**: This is the most complex update. Several changes:

1. **Import and use useSortPreference**: Get `sortOption` and `setSortOption` from the hook. Use `parseSortOption(sortOption)` (from types.ts) to derive `sort_by` and `order` for `useArticles`.

2. **Extended filter bar**: Replace the current two-button (Unread/All) toggle with a four-tab filter bar:
   - "Unread" — existing behavior (is_read=false, no scoring_state filter, hide blocked)
   - "All" — existing behavior (no is_read filter, no scoring_state filter, hide blocked)
   - "Scoring" — shows pending articles (scoring_state="pending")
   - "Blocked" — shows blocked articles (scoring_state="blocked")

   The Unread and All tabs should pass `scoring_state="scored_or_unfiltered"` to exclude blocked/pending articles. Actually, simpler approach: for Unread and All, don't pass scoring_state at all — the backend should handle this by default. But blocked articles need to be hidden from these views. The cleanest approach: add a backend default behavior where Unread/All views exclude blocked articles (composite_score=0 AND scoring_state="scored") unless explicitly requesting them.

   REVISED APPROACH: Keep it simple on the backend. The filter tabs manage which `scoring_state` value gets passed to useArticles:
   - Unread/All: don't pass scoring_state (backend returns all scored+unscored, frontend already sorts by score)
   - Scoring: pass scoring_state="pending"
   - Blocked: pass scoring_state="blocked"

   But the user decision says "Blocked-category articles are hidden from main views (Unread, All Articles)." To implement this, the backend needs to exclude blocked articles from the default view. This should be handled in Plan 01's backend task — but if not, add a `exclude_blocked` boolean param to useArticles that defaults to true for Unread/All tabs, and pass `exclude_blocked=true` as a query param. The backend filters out articles where composite_score == 0 AND scoring_state == "scored" when exclude_blocked is true.

   Wait — let me keep this simpler. The backend in Plan 01 already handles scoring_state filters. For the "hide blocked from main views" requirement: pass `exclude_blocked: true` as a query param for Unread/All views. Update api.ts to support this param. The backend should exclude articles with composite_score=0 and scoring_state="scored" when exclude_blocked=true. **Add this param to both the backend (Plan 01) and frontend (this task).** Since Plan 01 runs first, note in the verification that this param needs to work end-to-end.

   ACTUALLY — to avoid cross-plan file conflicts, handle the `exclude_blocked` backend addition here since ArticleList is where the requirement lives. Add `exclude_blocked: bool = True` as a default-true param to the backend list_articles endpoint. When true, exclude articles where composite_score == 0 and scoring_state == "scored". Override to false when scoring_state filter is "blocked" (so the blocked tab can see them).

   For the filter tabs:
   - Use the existing Button-based toggle pattern (accent solid for selected, ghost for others)
   - "Scoring (N)" — show count of articles with scoring_state in (unscored, queued, scoring). Disable and hide count when 0.
   - "Blocked (N)" — show count of articles with composite_score=0 and scoring_state="scored". Disable and hide count when 0.
   - Fetch counts via a new API endpoint or a separate useQuery. Simplest: add counts to the existing `/api/scoring/status` endpoint which already returns counts by state. For blocked count, the frontend can use the "scored" count filtered client-side, or add a "blocked" count to the endpoint.

   SIMPLEST APPROACH for counts: Use two additional useQuery calls:
   - `useQuery({ queryKey: ["articles", "scoring-count"], queryFn: () => fetchArticles({ scoring_state: "pending", limit: 0 }) })` — but limit=0 won't work for counting.

   Better: use the existing `/api/scoring/status` endpoint. It returns `{ unscored, queued, scoring, scored, failed }`. The "Scoring" tab count = unscored + queued + scoring. For "Blocked" count, add a `blocked` field to the scoring status endpoint that counts articles with composite_score=0 and scoring_state="scored".

   Add a `useScoringStatus` hook that fetches `/api/scoring/status` and derives the tab counts. Refresh it alongside articles (same staleTime).

3. **Sort dropdown**: Place the `SortSelect` component in the top bar, to the right of the filter tabs (before the article count text). Wrap the filter tabs and sort select in a Flex with gap.

4. **Active filter state**: Track which tab is selected with a `filter` state variable: `"unread" | "all" | "scoring" | "blocked"`. The `showAll` boolean becomes derived from this:
   - `filter === "unread"` → showAll=false, no scoringState
   - `filter === "all"` → showAll=true, no scoringState
   - `filter === "scoring"` → showAll=true, scoringState="pending"
   - `filter === "blocked"` → showAll=true, scoringState="blocked"

5. **Empty states**: Update empty state messages based on active filter:
   - Scoring tab empty: "No articles awaiting scoring."
   - Blocked tab empty: "No blocked articles."
   - Unread empty: existing "No unread articles. You're all caught up!"
   - All empty: existing "No articles yet. Add some feeds to get started."

6. **Mark all read button**: Only show for Unread/All tabs (not Scoring/Blocked).

7. **Scoring tab article states**: When viewing the Scoring tab, articles should show their state visually — the existing ArticleRow already shows spinner for "scoring" and clock for "queued". For "unscored", show a small pulsing dot instead of the dash. Add a simple CSS pulsing animation using Chakra's `animation` or `css` prop: `css={{ animation: "pulse 2s ease-in-out infinite" }}` with a keyframe. Use the `keyframes` helper from `@emotion/react` or inline CSS.

**ArticleReader.tsx**: Replace the inline score display section (the `<Box mt={3}>` block with Score: {value}/20) with the `ScoreBadge` component at size="md". Keep the existing quality score and reasoning text underneath. Place the ScoreBadge in the metadata row (near the date/author line) for a cleaner layout, or keep it in its current position — user decision says "Reader panel also displays exact score" so the current placement is fine, just swap in ScoreBadge for visual consistency.

**Additional backend change**: Update `/api/scoring/status` in `backend/src/backend/main.py` to include a `blocked` count: articles where composite_score == 0 AND scoring_state == "scored". Also add `exclude_blocked: bool = True` default param to `list_articles`.

**Additional frontend files**:
- `frontend/src/lib/api.ts`: Add `exclude_blocked` to FetchArticlesParams and fetchArticles. Add `fetchScoringStatus` function.
- `frontend/src/hooks/useScoringStatus.ts`: New hook wrapping useQuery for /api/scoring/status.
  </action>
  <verify>
Run `cd /Users/cstalhem/projects/rss-reader/frontend && npx tsc --noEmit` to verify no type errors. Visually inspect that all components render without crash by checking the dev server if running.
  </verify>
  <done>
ArticleRow shows ScoreBadge with color-coded tiers and accent tint on high-scored rows. ArticleList has 4-tab filter bar (Unread/All/Scoring/Blocked) with counts, SortSelect dropdown, and updated empty states. ArticleReader shows ScoreBadge in header. Blocked articles hidden from main views. Scoring tab shows pulsing/spinner states.
  </done>
</task>

</tasks>

<verification>
- TypeScript compilation passes (npx tsc --noEmit)
- ScoreBadge renders with accent color for >=15, gray for >=8, muted for <8
- SortSelect shows 4 options and fires onChange
- Filter bar shows Unread | All | Scoring (N) | Blocked (N)
- Scoring/Blocked tabs disabled when count is 0
- High-scored rows have subtle accent background tint
- Sort preference persists across page refreshes
- Blocked articles do not appear in Unread or All views
</verification>

<success_criteria>
The article list visually presents articles by relevance. Score badges are visible on every scored article. The sort dropdown allows switching between score and date ordering. The filter bar separates content by state (main views, scoring queue, blocked). The visual hierarchy is clear: high-scored articles stand out via accent badge + subtle row tint, while medium and low scores use neutral and muted styling.
</success_criteria>

<output>
After completion, create `.planning/phases/05-interest-driven-ui/05-02-SUMMARY.md`
</output>
