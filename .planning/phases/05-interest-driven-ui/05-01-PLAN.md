---
phase: 05-interest-driven-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/backend/main.py
  - frontend/src/lib/api.ts
  - frontend/src/lib/types.ts
  - frontend/src/hooks/useSortParams.ts
  - frontend/src/hooks/useArticles.ts
autonomous: true

must_haves:
  truths:
    - "Backend accepts sort_by and order query params and returns articles in the requested order"
    - "Unscored articles (NULL composite_score) appear last when sorting by score"
    - "Frontend data layer passes sort/order params through to the API"
    - "Changing sort params in URL triggers a new TanStack Query fetch"
  artifacts:
    - path: "backend/src/backend/main.py"
      provides: "list_articles endpoint with sort_by and order query params"
      contains: "sort_by.*composite_score"
    - path: "frontend/src/lib/api.ts"
      provides: "fetchArticles with sort_by and order params"
      contains: "sort_by"
    - path: "frontend/src/lib/types.ts"
      provides: "SortOption and SortOrder type definitions"
      contains: "SortOption"
    - path: "frontend/src/hooks/useSortParams.ts"
      provides: "Hook for reading/writing sort URL params"
      contains: "useSearchParams"
    - path: "frontend/src/hooks/useArticles.ts"
      provides: "useArticles with sortBy and order in queryKey"
      contains: "sort_by.*sortBy"
  key_links:
    - from: "frontend/src/hooks/useSortParams.ts"
      to: "URL search params"
      via: "useSearchParams from next/navigation"
      pattern: "useSearchParams"
    - from: "frontend/src/hooks/useArticles.ts"
      to: "frontend/src/lib/api.ts"
      via: "fetchArticles call with sort params"
      pattern: "sort_by.*sortBy"
    - from: "frontend/src/lib/api.ts"
      to: "backend/src/backend/main.py"
      via: "HTTP query params sort_by and order"
      pattern: "sort_by"
---

<objective>
Add server-side sorting to the articles API and wire it through the frontend data layer.

Purpose: Enable sorted article retrieval by score or date, which is the data foundation for the interest-driven UI.
Output: Working sort_by/order API params, frontend sort state hook, and updated data fetching.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-interest-driven-ui/05-RESEARCH.md
@backend/src/backend/main.py
@frontend/src/lib/api.ts
@frontend/src/lib/types.ts
@frontend/src/hooks/useArticles.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add sort_by and order query params to backend list_articles endpoint</name>
  <files>backend/src/backend/main.py</files>
  <action>
Update the `list_articles` endpoint in `main.py` to accept two new optional query parameters:
- `sort_by: str = "published_at"` — accepts "published_at" or "composite_score"
- `order: str = "desc"` — accepts "asc" or "desc"

Replace the hardcoded `.order_by(Article.published_at.desc())` with dynamic sorting logic:

1. Import `desc` and `nulls_last` from `sqlalchemy` at the top of the file (alongside existing imports).
2. If `sort_by == "composite_score"`:
   - Use `nulls_last(desc(Article.composite_score))` for desc order
   - Use `nulls_last(Article.composite_score.asc())` for asc order
   - This ensures unscored articles (NULL composite_score) always sort to the end
3. If `sort_by == "published_at"` (default):
   - Use `desc(Article.published_at)` for desc order
   - Use `Article.published_at.asc()` for asc order
4. Add a secondary sort by `Article.id` for stable ordering when primary values are equal.

Apply the filter conditions (is_read, feed_id) and pagination (offset, limit) AFTER the ORDER BY clause, same as current behavior.

Ignore any invalid sort_by values — fall back to `published_at` desc if an unrecognized value is passed.
  </action>
  <verify>
Run the backend tests to ensure nothing is broken:
```
cd backend && python -m pytest
```
Then manually test with curl:
```
curl "http://localhost:8912/api/articles?sort_by=composite_score&order=desc&limit=5"
curl "http://localhost:8912/api/articles?sort_by=published_at&order=asc&limit=5"
```
Verify: score-sorted response has highest scored articles first (NULLs at end), date-sorted asc has oldest first.
  </verify>
  <done>
list_articles endpoint accepts sort_by and order params. Sorting by composite_score pushes NULLs to end. Default behavior (published_at desc) is unchanged when no params provided.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire sort params through frontend data layer and create useSortParams hook</name>
  <files>
    frontend/src/lib/types.ts
    frontend/src/lib/api.ts
    frontend/src/hooks/useSortParams.ts
    frontend/src/hooks/useArticles.ts
  </files>
  <action>
**types.ts** — Add sort-related types at the end of the file:
```typescript
export type SortOption = "published_at" | "composite_score";
export type SortOrder = "desc" | "asc";
```

**api.ts** — Extend `FetchArticlesParams` interface with two new optional fields:
- `sort_by?: string`
- `order?: string`

In `fetchArticles`, add the same pattern as other params: if `params.sort_by !== undefined`, set the search param; same for `params.order`.

**useSortParams.ts** — Create a new hook (new file) that manages sort state via URL search params:
- Use `useSearchParams` and `useRouter` from `next/navigation`, and `usePathname`.
- Read `sort` param (default "composite_score") and `order` param (default "desc") from URL.
  Note: default is score desc because the purpose of this phase is interest-driven — show highest-scored articles first by default.
- Provide a `setSortParams(sort: SortOption, order: SortOrder)` callback (wrapped in useCallback) that updates URL params via `router.push`.
- Also provide a convenience `sortValue` string that combines sort+order (e.g. "score_desc", "score_asc", "date_desc", "date_asc") for use as a select value, and a `setSortValue(value: string)` that parses it back into sort+order and calls setSortParams.
- Export the hook as a named export.

**useArticles.ts** — Add `sortBy` and `order` to the `UseArticlesOptions` interface (both optional strings). Update the hook:
- Destructure `sortBy = "composite_score"` and `order = "desc"` from options (matching the useSortParams defaults).
- Add `sort_by: sortBy` and `order` to the queryKey object.
- Pass `sort_by: sortBy` and `order` to the `fetchArticles` call.
- All other logic (polling, loadMore, hasMore) remains unchanged.
  </action>
  <verify>
Run TypeScript type checking:
```
cd frontend && npx tsc --noEmit
```
Verify no type errors. Then verify in the browser that the article list loads with score-sorted articles by default (if scores exist). Check that adding `?sort=published_at&order=desc` to the URL changes the sort.
  </verify>
  <done>
Frontend data layer passes sort_by and order to the API. useSortParams hook reads/writes URL search params. useArticles includes sort params in queryKey so TanStack Query refetches on change. Default sort is composite_score desc (interest-driven).
  </done>
</task>

</tasks>

<verification>
1. Backend: `curl "http://localhost:8912/api/articles?sort_by=composite_score&order=desc&limit=3"` returns articles sorted by score (highest first, NULLs last)
2. Backend: `curl "http://localhost:8912/api/articles?limit=3"` returns articles sorted by published_at desc (unchanged default behavior when sort params omitted... wait, the frontend now sends composite_score by default, but the backend default is published_at — this is correct, the backend default preserves backward compatibility for direct API callers)
3. Frontend: `npx tsc --noEmit` passes with no errors
4. Browser: Article list loads sorted by score by default
5. Browser: URL shows `?sort=composite_score&order=desc` (or no params if defaults match)
</verification>

<success_criteria>
- Backend list_articles accepts sort_by (published_at|composite_score) and order (asc|desc) query params
- NULL composite_score values sort to the end regardless of sort direction
- Frontend useArticles hook includes sort params in queryKey
- useSortParams hook reads and writes URL search params
- TypeScript compilation passes
</success_criteria>

<output>
After completion, create `.planning/phases/05-interest-driven-ui/05-01-SUMMARY.md`
</output>
