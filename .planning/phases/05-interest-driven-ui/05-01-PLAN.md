---
phase: 05-interest-driven-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/backend/main.py
  - frontend/src/lib/api.ts
  - frontend/src/lib/types.ts
  - frontend/src/hooks/useArticles.ts
  - frontend/src/hooks/useSortPreference.ts
autonomous: true

must_haves:
  truths:
    - "Backend accepts sort_by and order query params and returns articles sorted accordingly"
    - "Backend accepts scoring_state filter and returns only articles matching that state"
    - "Backend pushes NULL composite_score to end of results when sorting by score"
    - "Frontend useArticles hook passes sort/filter params to backend and includes them in queryKey"
    - "Sort preference persists in localStorage across sessions"
  artifacts:
    - path: "backend/src/backend/main.py"
      provides: "Updated list_articles endpoint with sort_by, order, scoring_state params"
      contains: "nulls_last"
    - path: "frontend/src/lib/api.ts"
      provides: "Updated fetchArticles with sort_by, order, scoring_state params"
      contains: "sort_by"
    - path: "frontend/src/hooks/useSortPreference.ts"
      provides: "Hook wrapping useLocalStorage for sort preference persistence"
      exports: ["useSortPreference"]
    - path: "frontend/src/hooks/useArticles.ts"
      provides: "Updated hook accepting sortBy, order, scoringState params in queryKey"
      contains: "sort_by"
  key_links:
    - from: "frontend/src/hooks/useArticles.ts"
      to: "frontend/src/lib/api.ts"
      via: "fetchArticles call with sort/filter params"
      pattern: "fetchArticles.*sort_by"
    - from: "frontend/src/lib/api.ts"
      to: "backend/src/backend/main.py"
      via: "HTTP query params sort_by, order, scoring_state"
      pattern: "sort_by.*order"
    - from: "frontend/src/hooks/useSortPreference.ts"
      to: "frontend/src/hooks/useLocalStorage.ts"
      via: "useLocalStorage import"
      pattern: "useLocalStorage"
---

<objective>
Add server-side sorting and filtering to the articles API and wire up the frontend data layer.

Purpose: The backend must support sorting by composite_score (with NULL handling) and date, plus filtering by scoring_state (for Scoring/Blocked tabs). The frontend data layer must pass these params through and persist the user's sort preference in localStorage.

Output: Updated backend endpoint, updated frontend API client, new useSortPreference hook, updated useArticles hook.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-interest-driven-ui/05-CONTEXT.md
@.planning/phases/05-interest-driven-ui/05-RESEARCH.md

@backend/src/backend/main.py
@backend/src/backend/models.py
@frontend/src/lib/api.ts
@frontend/src/lib/types.ts
@frontend/src/hooks/useArticles.ts
@frontend/src/hooks/useLocalStorage.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Backend sort and filter params on /api/articles</name>
  <files>backend/src/backend/main.py</files>
  <action>
Update the `list_articles` endpoint to accept three new query parameters:

1. `sort_by: str = "composite_score"` — allowed values: `"composite_score"`, `"published_at"`. Default is `composite_score` per user decision (score-first is the default view).

2. `order: str = "desc"` — allowed values: `"desc"`, `"asc"`.

3. `scoring_state: str | None = None` — optional filter. When provided, filter articles to only those matching this scoring_state value. This enables the "Scoring" tab (scoring_state in ["unscored", "queued", "scoring"]) and "Blocked" tab. For the blocked filter, use a special value `"blocked"` that filters to articles where scoring_state == "scored" AND composite_score == 0 (blocked categories auto-score 0 per Phase 4 decision). For the scoring filter, use value `"pending"` that filters to scoring_state IN ("unscored", "queued", "scoring").

Replace the current hardcoded `.order_by(Article.published_at.desc())` with dynamic sorting:

- When `sort_by == "composite_score"`:
  - Primary sort: `composite_score` in requested order, using `nulls_last()` wrapper to push NULLs to end regardless of sort direction.
  - Secondary sort (tiebreaker): `published_at ASC` (oldest first — per user decision for "catch up" workflow).

- When `sort_by == "published_at"`:
  - Primary sort: `published_at` in requested order.
  - Secondary sort: `Article.id` for stable ordering.

Import `desc, nulls_last` from `sqlalchemy`. These are already available — the project uses SQLAlchemy 2.0+ via SQLModel.

Also: when `scoring_state == "pending"`, override the default sort to `published_at ASC` (oldest first) if sort_by is still the default, since the scoring tab should show oldest-first by default per the fallback behavior decision. Only override if user hasn't explicitly chosen a sort.

Keep all existing filters (is_read, feed_id) and pagination (skip, limit) unchanged.
  </action>
  <verify>
Run the backend: `cd /Users/cstalhem/projects/rss-reader && python -c "from backend.main import app; print('Import OK')"` to verify no import errors. Then verify with curl or similar that the endpoint accepts the new params without error (dry run with a syntax check).
  </verify>
  <done>
/api/articles accepts sort_by, order, scoring_state params. Sorting by composite_score uses nulls_last. Scoring and blocked filters return the correct subset of articles.
  </done>
</task>

<task type="auto">
  <name>Task 2: Frontend data layer — API client, types, sort hook, useArticles update</name>
  <files>
    frontend/src/lib/api.ts
    frontend/src/lib/types.ts
    frontend/src/hooks/useSortPreference.ts
    frontend/src/hooks/useArticles.ts
  </files>
  <action>
**types.ts**: Add a `SortOption` type:
```typescript
export type SortOption = "score_desc" | "score_asc" | "date_desc" | "date_asc";
```
This encodes both sort_by and order in a single value for the dropdown. Map these to backend params in the API layer.

**api.ts**: Update `FetchArticlesParams` to add `sort_by?: string`, `order?: string`, `scoring_state?: string`. In `fetchArticles`, append these as query params when defined (same pattern as existing params).

**useSortPreference.ts**: Create a new hook that wraps the existing `useLocalStorage` hook:
```typescript
import { useLocalStorage } from "./useLocalStorage";
import { SortOption } from "@/lib/types";

export function useSortPreference() {
  const [sortOption, setSortOption] = useLocalStorage<SortOption>(
    "rss-sort-preference",
    "score_desc"
  );
  return { sortOption, setSortOption };
}
```
Default is `"score_desc"` per user decision (composite_score descending is default).

**useArticles.ts**: Update `UseArticlesOptions` to add `sortBy?: string`, `order?: string`, `scoringState?: string`. Pass these through to `fetchArticles` and include them in the `queryKey` array. This is critical — if sort/filter params are not in queryKey, TanStack Query will return stale cached data when params change.

The hook signature should accept the raw backend params (sort_by, order) so the component layer handles the SortOption-to-params mapping. Add a helper function (or export from types.ts) that maps SortOption to {sort_by, order}:
```typescript
export function parseSortOption(option: SortOption): { sort_by: string; order: string } {
  switch (option) {
    case "score_desc": return { sort_by: "composite_score", order: "desc" };
    case "score_asc": return { sort_by: "composite_score", order: "asc" };
    case "date_desc": return { sort_by: "published_at", order: "desc" };
    case "date_asc": return { sort_by: "published_at", order: "asc" };
  }
}
```
Put this helper in types.ts next to the SortOption type.
  </action>
  <verify>
Run `cd /Users/cstalhem/projects/rss-reader/frontend && npx tsc --noEmit` to verify TypeScript compilation passes with no errors related to the changed files.
  </verify>
  <done>
fetchArticles sends sort_by, order, scoring_state to the backend. useArticles includes all params in queryKey. useSortPreference persists sort choice in localStorage with "score_desc" default. parseSortOption maps dropdown values to backend params.
  </done>
</task>

</tasks>

<verification>
- Backend starts without import errors
- TypeScript compilation passes (npx tsc --noEmit)
- fetchArticles signature includes sort_by, order, scoring_state
- useArticles queryKey includes sort/filter params
- useSortPreference reads/writes from localStorage
</verification>

<success_criteria>
The data pipeline from localStorage sort preference through useArticles hook to the backend is complete. Changing sort preference triggers a new query with correct params. Backend returns articles sorted by composite_score with NULLs at end by default, or by date when requested. Scoring_state filter narrows results for Scoring/Blocked tabs.
</success_criteria>

<output>
After completion, create `.planning/phases/05-interest-driven-ui/05-01-SUMMARY.md`
</output>
