---
phase: 09.6-llm-providers-settings-refresh
plan: 02
type: execute
wave: 2
depends_on: ["09.6-01"]
files_modified:
  - frontend/src/components/settings/LLMProvidersSection.tsx
  - frontend/src/components/settings/ProviderPillBar.tsx
  - frontend/src/components/settings/AddProviderDialog.tsx
  - frontend/src/components/settings/OllamaProviderPanel.tsx
  - frontend/src/components/settings/OllamaHealthBadge.tsx
  - frontend/src/components/settings/ModelManagement.tsx
  - frontend/src/app/settings/llm-providers/page.tsx
autonomous: true
requirements:
  - OLLAMA-01
  - OLLAMA-03
  - OLLAMA-04

must_haves:
  truths:
    - "When no providers are configured, page shows EmptyState with 'Add Provider' button"
    - "Configured providers appear as pills (logo + name) in a horizontal bar"
    - "Clicking 'Add Provider' opens a dialog with provider cards -- only Ollama is selectable, others show 'Coming soon' badge"
    - "Adding Ollama creates the provider config row and auto-expands its settings panel"
    - "Clicking a pill toggles its settings panel (only one open at a time)"
    - "Ollama provider panel shows editable host/port, health status on pill icon, model library, and disconnect button"
    - "Disconnecting Ollama removes the pill and shows empty state (or remaining providers)"
    - "System prompts section renders below provider panels (unchanged, provider-agnostic)"
  artifacts:
    - path: "frontend/src/components/settings/LLMProvidersSection.tsx"
      provides: "Top-level page orchestrator replacing OllamaSection"
    - path: "frontend/src/components/settings/ProviderPillBar.tsx"
      provides: "Pill bar with configured providers + Add Provider button"
    - path: "frontend/src/components/settings/AddProviderDialog.tsx"
      provides: "Dialog with provider cards and Coming soon badges"
    - path: "frontend/src/components/settings/OllamaProviderPanel.tsx"
      provides: "Expandable Ollama settings: host/port, model library, disconnect"
  key_links:
    - from: "frontend/src/components/settings/LLMProvidersSection.tsx"
      to: "frontend/src/hooks/useProviders.ts"
      via: "useProviders() for provider list"
      pattern: "useProviders"
    - from: "frontend/src/components/settings/AddProviderDialog.tsx"
      to: "/api/ollama/config"
      via: "saveOllamaConfig with defaults to create provider row"
      pattern: "saveOllamaConfig"
    - from: "frontend/src/components/settings/OllamaProviderPanel.tsx"
      to: "frontend/src/components/settings/ModelManagement.tsx"
      via: "renders ModelManagement inside provider panel"
      pattern: "ModelManagement"
    - from: "frontend/src/app/settings/llm-providers/page.tsx"
      to: "frontend/src/components/settings/LLMProvidersSection.tsx"
      via: "renders LLMProvidersSection"
      pattern: "LLMProvidersSection"
---

<objective>
Build the multi-provider UI layout: LLMProvidersSection orchestrator, provider pill bar with add/toggle behavior, Add Provider dialog with Coming Soon cards, and OllamaProviderPanel with host/port + model library + health + disconnect.

Purpose: Replaces the monolithic OllamaSection with a composable multi-provider architecture. Users see pills for configured providers, can add providers via dialog, and expand per-provider settings panels.
Output: Working provider management UI with Ollama as the only functional provider. Empty state, add flow, pill toggle, and disconnect all functional.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09.6-llm-providers-settings-refresh/09.6-CONTEXT.md
@.planning/phases/09.6-llm-providers-settings-refresh/09.6-RESEARCH.md
@.planning/phases/09.6-llm-providers-settings-refresh/09.6-01-SUMMARY.md

@frontend/src/components/settings/OllamaSection.tsx
@frontend/src/components/settings/OllamaHealthBadge.tsx
@frontend/src/components/settings/ModelManagement.tsx
@frontend/src/components/settings/ModelSelector.tsx
@frontend/src/components/settings/SystemPrompts.tsx
@frontend/src/components/settings/SettingsPanel.tsx
@frontend/src/components/settings/SettingsPageHeader.tsx
@frontend/src/components/settings/SettingsPanelHeading.tsx
@frontend/src/hooks/useOllamaHealth.ts
@frontend/src/hooks/useOllamaModels.ts
@frontend/src/hooks/useOllamaConfig.ts
@frontend/src/hooks/useModelPull.ts
@frontend/src/hooks/useProviders.ts
@frontend/src/components/settings/ProviderLogos.tsx
@frontend/src/lib/constants.ts
@frontend/src/lib/api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: LLMProvidersSection orchestrator + ProviderPillBar + AddProviderDialog</name>
  <files>
    frontend/src/components/settings/LLMProvidersSection.tsx
    frontend/src/components/settings/ProviderPillBar.tsx
    frontend/src/components/settings/AddProviderDialog.tsx
    frontend/src/app/settings/llm-providers/page.tsx
  </files>
  <action>
**LLMProvidersSection.tsx** — New file, replaces OllamaSection as the top-level orchestrator. Structure (top to bottom per CONTEXT.md decisions):

1. `SettingsPageHeader title="LLM Providers"` (no health badge in header -- health moves to pill icon)
2. Content area that branches on provider state:
   - If `useProviders()` returns no enabled providers: render EmptyState with `LuBot` icon, "No providers configured" message, and "Add Provider" button
   - If providers exist: render the three sections below
3. **Model selector placeholder** — For now, render the existing `ModelSelector` pattern temporarily (Plan 03 replaces with Combobox). Include the save/rescore logic from current OllamaSection.
4. **ProviderPillBar** — Renders configured providers as pills + "Add Provider" button
5. **Per-provider settings panel** — Uses `expandedProvider` state (`string | null`). Conditionally renders `OllamaProviderPanel` when `expandedProvider === "ollama"` (conditional rendering, NOT display:none per project patterns/Quick 13).
6. **SystemPrompts** — At the bottom, inside a SettingsPanel (unchanged from current OllamaSection)

State management:
- `const [expandedProvider, setExpandedProvider] = useState<string | null>(null)` for pill toggle
- `const [showAddDialog, setShowAddDialog] = useState(false)` for dialog
- When a provider is added, auto-expand its panel: `setExpandedProvider(providerId)`
- Reuse existing hooks: `useOllamaHealth`, `useOllamaModels`, `useOllamaConfig`, `useModelPull`

Keep the `localEdits` / `useReducer` pattern from current OllamaSection for config editing.

**ProviderPillBar.tsx** — New file:
- Props: `providers: ProviderListItem[]`, `expandedProvider: string | null`, `onToggle: (id: string) => void`, `onAddClick: () => void`, `ollamaHealth?: OllamaHealth`
- Render a `Flex gap={2} wrap="wrap" alignItems="center">` with:
  - For each enabled provider: `Button size="sm"` with `variant={expandedProvider === p.provider ? "subtle" : "outline"}`. Content: `<ProviderLogo provider={p.provider} />` + provider label (look up from PROVIDER_CATALOG). For Ollama: add native `title` attribute with health status text (e.g., "Connected" / "Disconnected"). Use `colorPalette="accent"` on the active pill.
  - "Add Provider" button: `Button size="sm" variant="ghost"` with `<LuPlus />` + "Add Provider" text

Ollama health indicator on pill: use the ProviderLogo with a color on its parent Box. Connected = `fg.success`, disconnected = `fg.error`, loading = `fg.muted`. Do NOT use Chakra Tooltip (per skill: use native `title` for small element sets).

**AddProviderDialog.tsx** — New file:
- Props: `open: boolean`, `onOpenChange: (details: { open: boolean }) => void`, `onAdd: (providerId: string) => void`, `existingProviders: string[]`
- Uses `Dialog.Root` (no Portal wrapper -- Dialog handles its own portal per skill).
- Dialog content: Grid of provider cards from PROVIDER_CATALOG
- Each card: `Box` with border, padding. Shows `ProviderLogo`, provider label, hint text.
  - If `available && !existingProviders.includes(id)`: clickable, onClick calls `onAdd(id)` and closes dialog
  - If `available && existingProviders.includes(id)`: dimmed with "Already added" text
  - If `!available`: dimmed card with absolute-positioned `Badge` overlay showing "Coming soon"
- Dialog title: "Add Provider"

**page.tsx** — Update `llm-providers/page.tsx` to import and render `LLMProvidersSection` instead of `OllamaSection`.

**Important:** Do NOT delete `OllamaSection.tsx` yet -- keep it as reference. It will be cleaned up in Plan 03.
  </action>
  <verify>
    <automated>cd /Users/cstalhem/projects/worktrees/rss-reader/great-lehmann/frontend && bun run build 2>&1 | tail -20</automated>
    <manual>Navigate to /settings/llm-providers. Verify empty state shows if no providers. Click "Add Provider", verify dialog shows 5 cards with only Ollama selectable.</manual>
  </verify>
  <done>LLMProvidersSection renders with SettingsPageHeader, branches on provider state (empty vs configured), ProviderPillBar shows pills with toggle behavior, AddProviderDialog shows provider cards with Coming Soon badges on unavailable providers, page.tsx renders LLMProvidersSection</done>
</task>

<task type="auto">
  <name>Task 2: OllamaProviderPanel with host/port, health, model library, and disconnect</name>
  <files>
    frontend/src/components/settings/OllamaProviderPanel.tsx
    frontend/src/components/settings/OllamaHealthBadge.tsx
    frontend/src/components/settings/ModelManagement.tsx
  </files>
  <action>
**OllamaProviderPanel.tsx** — New file. Renders inside LLMProvidersSection when `expandedProvider === "ollama"`.

Props:
- `config: OllamaConfig` (the effective config with local edits)
- `savedConfig: OllamaConfig`
- `onConfigChange: (config: OllamaConfig) => void`
- `models: OllamaModel[]`
- `pullHook` (from useModelPull)
- `onDisconnect: () => void`

Layout (inside a SettingsPanel):
1. **Connection section** — Editable host/port fields (extract from current ModelSelector's Endpoint sub-section). Grid with base_url input and port input. Use the same handlers as current ModelSelector (handleBaseUrlChange, handlePortChange).

2. **Model Library section** — Render existing `ModelManagement` component with same props as current OllamaSection passes it. The model library section now lives INSIDE the Ollama provider panel (moved from top-level). Add a `SettingsPanelHeading` "Model Library" above it.

3. **Disconnect button** — At the bottom of the panel: `Button variant="outline" colorPalette="red" size="sm"` with "Disconnect Ollama" text. onClick calls `onDisconnect`. Per CONTEXT.md: "Disconnect button lives inside the provider's expanded settings panel (not on the pill itself)."

Wire disconnect in LLMProvidersSection:
- When disconnect clicked: call `disconnectMutation.mutate("ollama")` from `useProviders`
- On success: collapse the panel (`setExpandedProvider(null)`), invalidate ollama queries

**OllamaHealthBadge.tsx** — Keep for backward compatibility but it's no longer used in the page header. The health indicator is now on the pill icon (handled in ProviderPillBar). If OllamaHealthBadge is imported elsewhere, keep the file. Otherwise mark it for cleanup in Plan 03.

**ModelManagement.tsx** — No functional changes needed. It already receives models, config, pullHook, and onConfigChange as props. Just verify it works when nested inside OllamaProviderPanel rather than directly in OllamaSection.

Light visual refresh of ModelManagement per CONTEXT.md ("light visual refresh to align with new card/pill aesthetic"): This is discretionary. If the component already uses SettingsPanel patterns, leave it. If it has outdated styling, apply minimal updates to spacing/borders to match the new panel layout.
  </action>
  <verify>
    <automated>cd /Users/cstalhem/projects/worktrees/rss-reader/great-lehmann/frontend && bun run build 2>&1 | tail -20</automated>
    <manual>Add Ollama via dialog, verify pill appears. Click pill to expand panel. Verify host/port fields, model library, and disconnect button are visible. Click disconnect, verify pill disappears.</manual>
  </verify>
  <done>OllamaProviderPanel renders connection settings, model library, and disconnect button inside expandable panel. Health indicator shows on the Ollama pill. Disconnect sets provider to disabled and collapses panel.</done>
</task>

</tasks>

<verification>
1. `bun run build` passes with no type errors
2. Empty state shows when no providers configured
3. Add Provider dialog shows 5 cards, only Ollama selectable
4. Adding Ollama creates pill, auto-expands panel
5. Pill click toggles panel visibility
6. Ollama panel shows host/port, model library, disconnect
7. Disconnect removes pill, shows empty state
8. System prompts render at bottom regardless of provider state
</verification>

<success_criteria>
- LLMProvidersSection replaces OllamaSection as the page component
- Provider pill bar renders with toggle behavior
- Add Provider dialog functional with Coming Soon badges
- Ollama provider panel contains host/port + model library + disconnect
- Health status visible on Ollama pill icon
- Full add/configure/disconnect lifecycle works
- System prompts section unchanged at bottom
</success_criteria>

<output>
After completion, create `.planning/phases/09.6-llm-providers-settings-refresh/09.6-02-SUMMARY.md`
</output>
