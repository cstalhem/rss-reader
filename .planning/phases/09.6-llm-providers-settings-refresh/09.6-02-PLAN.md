---
phase: 09.6-llm-providers-settings-refresh
plan: 02
type: execute
wave: 2
depends_on: ["09.6-01"]
files_modified:
  - frontend/src/components/settings/LLMProvidersSection.tsx
  - frontend/src/components/settings/ProviderPillBar.tsx
  - frontend/src/components/settings/AddProviderDialog.tsx
  - frontend/src/components/settings/providers/ollama/OllamaProviderPanel.tsx
  - frontend/src/components/settings/providers/ollama/index.ts
  - frontend/src/components/settings/ModelManagement.tsx
  - frontend/src/app/settings/llm-providers/page.tsx
autonomous: true
requirements:
  - OLLAMA-01
  - OLLAMA-03
  - OLLAMA-04

must_haves:
  truths:
    - "When no providers are configured, page shows EmptyState with 'Add Provider' button"
    - "Configured providers appear as pills (logo + name) in a horizontal bar"
    - "Clicking 'Add Provider' opens a dialog with provider cards -- only Ollama is selectable, others show 'Coming soon' badge"
    - "Adding a provider is a frontend-only state change -- no backend call until user saves"
    - "Pending (unsaved) providers show in the pill bar alongside saved providers"
    - "Clicking a pill toggles its settings panel (only one open at a time)"
    - "Ollama provider panel is self-contained: calls its own hooks (useOllamaConfig, useOllamaHealth, useOllamaModels, useModelPull)"
    - "New provider panel (isNew=true) shows defaults and Save + Cancel buttons"
    - "Existing provider panel shows current config and Save + Disconnect buttons"
    - "Cancelling setup removes the pending provider from the pill bar"
    - "Saving a new provider creates the LLMProviderConfig row via PUT /api/providers/{provider}/config"
    - "Disconnect uses ConfirmDialog that communicates model assignments will be cleared and provider config will be deleted (re-add starts fresh)"
    - "OllamaProviderPanel lives inside the providers/ollama/ plugin module"
    - "System prompts section renders below provider panels (unchanged, provider-agnostic)"
    - "LLMProvidersSection does NOT import any provider-specific components or hooks directly"
  artifacts:
    - path: "frontend/src/components/settings/LLMProvidersSection.tsx"
      provides: "Top-level page orchestrator -- provider-agnostic"
    - path: "frontend/src/components/settings/ProviderPillBar.tsx"
      provides: "Pill bar with configured + pending providers + Add Provider button"
    - path: "frontend/src/components/settings/AddProviderDialog.tsx"
      provides: "Dialog with provider cards and Coming soon badges"
    - path: "frontend/src/components/settings/providers/ollama/OllamaProviderPanel.tsx"
      provides: "Self-contained Ollama settings: setup mode + edit mode"
    - path: "frontend/src/components/settings/providers/ollama/index.ts"
      provides: "Updated Ollama plugin export with Panel reference"
  key_links:
    - from: "frontend/src/components/settings/LLMProvidersSection.tsx"
      to: "frontend/src/hooks/useProviders.ts"
      via: "useProviders() for server-side provider list and disconnect"
      pattern: "useProviders"
    - from: "frontend/src/components/settings/LLMProvidersSection.tsx"
      to: "frontend/src/components/settings/providers/registry.ts"
      via: "PROVIDER_REGISTRY to resolve Panel components dynamically"
      pattern: "PROVIDER_REGISTRY"
    - from: "frontend/src/components/settings/AddProviderDialog.tsx"
      to: "frontend/src/components/settings/providers/registry.ts"
      via: "PROVIDER_REGISTRY for provider card data and logos"
      pattern: "PROVIDER_REGISTRY"
    - from: "frontend/src/components/settings/ProviderPillBar.tsx"
      to: "frontend/src/components/settings/providers/registry.ts"
      via: "PROVIDER_REGISTRY to look up Logo and label"
      pattern: "PROVIDER_REGISTRY"
    - from: "frontend/src/components/settings/providers/ollama/OllamaProviderPanel.tsx"
      to: "/api/providers/ollama/config"
      via: "saveProviderConfig on first save (creates row) and subsequent saves (updates)"
      pattern: "saveProviderConfig"
    - from: "frontend/src/components/settings/providers/ollama/OllamaProviderPanel.tsx"
      to: "frontend/src/components/settings/ModelManagement.tsx"
      via: "renders ModelManagement inside provider panel"
      pattern: "ModelManagement"
    - from: "frontend/src/app/settings/llm-providers/page.tsx"
      to: "frontend/src/components/settings/LLMProvidersSection.tsx"
      via: "renders LLMProvidersSection"
      pattern: "LLMProvidersSection"
---

<objective>
Build the multi-provider UI layout: LLMProvidersSection orchestrator, provider pill bar with add/toggle behavior, Add Provider dialog with Coming Soon cards, and OllamaProviderPanel (self-contained inside the Ollama plugin module) with setup mode + edit mode.

Key design decisions:
- Adding a provider is a frontend-only state change. No backend call until the user explicitly saves.
- Each provider panel is self-contained -- calls its own hooks, manages its own state.
- The orchestrator is provider-agnostic -- resolves panels dynamically from PROVIDER_REGISTRY.

Purpose: Replaces the monolithic OllamaSection with a composable multi-provider architecture.
Output: Working provider management UI with Ollama as the only functional provider. Empty state, add flow, setup flow, edit flow, and disconnect all functional.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09.6-llm-providers-settings-refresh/09.6-CONTEXT.md
@.planning/phases/09.6-llm-providers-settings-refresh/09.6-RESEARCH.md
@.planning/phases/09.6-llm-providers-settings-refresh/09.6-01-SUMMARY.md

@frontend/src/components/settings/OllamaSection.tsx
@frontend/src/components/settings/OllamaHealthBadge.tsx
@frontend/src/components/settings/ModelManagement.tsx
@frontend/src/components/settings/ModelSelector.tsx
@frontend/src/components/settings/SystemPrompts.tsx
@frontend/src/components/settings/SettingsPanel.tsx
@frontend/src/components/settings/SettingsPageHeader.tsx
@frontend/src/components/settings/SettingsPanelHeading.tsx
@frontend/src/hooks/useOllamaHealth.ts
@frontend/src/hooks/useOllamaModels.ts
@frontend/src/hooks/useOllamaConfig.ts
@frontend/src/hooks/useModelPull.ts
@frontend/src/hooks/useProviders.ts
@frontend/src/hooks/useModelAssignments.ts
@frontend/src/components/settings/providers/types.ts
@frontend/src/components/settings/providers/registry.ts
@frontend/src/components/settings/providers/ollama/index.ts
@frontend/src/lib/api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: LLMProvidersSection orchestrator + ProviderPillBar + AddProviderDialog</name>
  <files>
    frontend/src/components/settings/LLMProvidersSection.tsx
    frontend/src/components/settings/ProviderPillBar.tsx
    frontend/src/components/settings/AddProviderDialog.tsx
    frontend/src/app/settings/llm-providers/page.tsx
  </files>
  <action>
**LLMProvidersSection.tsx** -- New file, replaces OllamaSection as the top-level orchestrator. This component is entirely provider-agnostic -- it never imports Ollama-specific hooks or components directly.

Structure (top to bottom per CONTEXT.md decisions):

1. `SettingsPageHeader title="LLM Providers"` (no health badge in header -- health is per-provider inside the panel)
2. Content area that branches on provider state:
   - If no saved providers AND no pending providers: render EmptyState with `LuBot` icon, "No providers configured" message, and "Add Provider" button
   - If any providers exist (saved or pending): render the sections below
3. **Model selector placeholder** -- Render nothing for now. Plan 03 adds `TopLevelModelSelector` using `useModelAssignments`. No temporary component needed since model selection is fully decoupled.
4. **ProviderPillBar** -- Renders configured + pending providers as pills + "Add Provider" button
5. **Per-provider settings panel** -- Uses `expandedProvider` state (`string | null`). Resolve the panel dynamically from the plugin registry:
   ```tsx
   const plugin = PROVIDER_REGISTRY.find(p => p.id === expandedProvider);
   const isPending = pendingProviders.has(expandedProvider);
   {plugin?.Panel && (
     <plugin.Panel
       onDisconnect={() => handleDisconnect(expandedProvider)}
       isNew={isPending}
       onCancelSetup={isPending ? () => handleCancelSetup(expandedProvider) : undefined}
     />
   )}
   ```
   The orchestrator only passes `ProviderPanelProps` -- panels are self-contained.
6. **SystemPrompts** -- At the bottom, inside a SettingsPanel (unchanged from current OllamaSection)

State management (minimal):
- `const [expandedProvider, setExpandedProvider] = useState<string | null>(null)` for pill toggle
- `const [showAddDialog, setShowAddDialog] = useState(false)` for dialog
- `const [pendingProviders, setPendingProviders] = useState<Set<string>>(new Set())` for unsaved providers

Handlers:
- `handleAdd(providerId)`: Add to pendingProviders, expand panel, close dialog
- `handleCancelSetup(providerId)`: Remove from pendingProviders, collapse panel
- `handleDisconnect(providerId)`: Call `disconnectMutation.mutate(providerId)` (DELETE -- deletes provider row and task routes), collapse panel on success. Re-adding the same provider always starts fresh through the Add Provider flow.
- On successful save inside a panel: `useProviders` invalidation adds the provider to the server list. To clear from pendingProviders, listen for the provider appearing in the server list (e.g., via a `useEffect` that diffs server list against pendingProviders and removes matches). Or: the panel calls `onCancelSetup()` after successful save -- since the provider is now in the server list, removing it from pending is correct.

**ProviderPillBar.tsx** -- New file:
- Props: `providers: ProviderListItem[]`, `pendingProviders: Set<string>`, `expandedProvider: string | null`, `onToggle: (id: string) => void`, `onAddClick: () => void`
- Merge server providers and pending providers for display. Pending pills could have a visual distinction (e.g., dashed border) to indicate unsaved state -- use executor discretion.
- Import `PROVIDER_REGISTRY` from `providers/registry` to look up each provider's Logo and label.
- Render a `Flex gap={2} wrap="wrap" alignItems="center">` with:
  - For each provider (saved + pending): look up plugin from `PROVIDER_REGISTRY`. `Button size="sm"` with `variant={expandedProvider === id ? "subtle" : "outline"}`. Content: `<plugin.Logo />` + `plugin.label`. Use `colorPalette="accent"` on the active pill.
  - "Add Provider" button: `Button size="sm" variant="ghost"` with `<LuPlus />` + "Add Provider" text

**AddProviderDialog.tsx** -- New file:
- Props: `open: boolean`, `onOpenChange: (details: { open: boolean }) => void`, `onAdd: (providerId: string) => void`, `existingProviders: string[]` (includes both saved and pending)
- Uses `Dialog.Root` (no Portal wrapper -- Dialog handles its own portal per skill).
- Import `PROVIDER_REGISTRY` from `providers/registry` for card data and logos.
- Dialog content: Grid of provider cards from `PROVIDER_REGISTRY`
- Each card: `Box` with border, padding. Shows `<plugin.Logo />`, `plugin.label`, `plugin.hint`.
  - If `available && !existingProviders.includes(id)`: clickable, onClick calls `onAdd(id)` and closes dialog
  - If `available && existingProviders.includes(id)`: dimmed with "Already added" text
  - If `!available`: dimmed card with absolute-positioned `Badge` overlay showing "Coming soon"
- Dialog title: "Add Provider"

**page.tsx** -- Update `llm-providers/page.tsx` to import and render `LLMProvidersSection` instead of `OllamaSection`.

**Important:** Do NOT delete `OllamaSection.tsx` yet -- keep it as reference. It will be cleaned up in Plan 03.
  </action>
  <verify>
    <automated>cd /Users/cstalhem/projects/worktrees/rss-reader/great-lehmann/frontend && bun run build 2>&1 | tail -20</automated>
    <manual>Navigate to /settings/llm-providers. Verify empty state shows if no providers. Click "Add Provider", verify dialog shows 5 cards with logos, only Ollama selectable. Click Ollama, verify pill appears and panel expands -- no backend call made yet.</manual>
  </verify>
  <done>LLMProvidersSection renders provider-agnostically with dynamic panel resolution from PROVIDER_REGISTRY. Pending provider state tracks unsaved providers. ProviderPillBar merges saved + pending. AddProviderDialog is frontend-only. Orchestrator has zero provider-specific imports or state.</done>
</task>

<task type="auto">
  <name>Task 2: OllamaProviderPanel -- self-contained with setup + edit modes</name>
  <files>
    frontend/src/components/settings/providers/ollama/OllamaProviderPanel.tsx
    frontend/src/components/settings/providers/ollama/index.ts
    frontend/src/components/settings/ModelManagement.tsx
  </files>
  <action>
**OllamaProviderPanel.tsx** -- New file inside the Ollama plugin module (`providers/ollama/`). This panel is fully self-contained -- it calls its own hooks and manages its own state.

Props: `ProviderPanelProps` from `providers/types.ts`:
```typescript
{ onDisconnect: () => void; isNew?: boolean; onCancelSetup?: () => void }
```

Internal hook calls:
```typescript
const { config, saveMutation } = useOllamaConfig();
const { health } = useOllamaHealth();
const { models } = useOllamaModels();
const pullHook = useModelPull();
```

**Two modes based on `isNew` prop:**

**Setup mode (`isNew === true`):**
- Initialize local state with Ollama defaults (e.g., `localhost`, `11434`)
- Do NOT fetch config from server (no row exists yet -- `useOllamaConfig` returns undefined, which is fine)
- Show editable host/port fields pre-filled with defaults
- Model Library section hidden or disabled (no connection yet -- can't list models until saved)
- Health status: show "Not connected" placeholder
- Buttons: **Save** (creates the provider row via `PUT /api/providers/ollama/config`) + **Cancel** (calls `onCancelSetup()`)
- On save success: `useProviders` invalidation makes the pill "real". `onCancelSetup()` clears pending state. Panel transitions to edit mode on next render (isNew will become false because orchestrator detects provider in server list).

**Edit mode (`isNew` falsy):**
- Initialize local state from `config` (fetched by `useOllamaConfig`)
- Show editable host/port fields with current values
- Model Library section: render existing `ModelManagement` component. Add `SettingsPanelHeading` "Model Library" above it.
- Health status: show connection state inline (fg.success/fg.error color, or status text)
- Buttons: **Save** (updates config, disabled when not dirty) + **Disconnect** (with ConfirmDialog)
- Disconnect uses `ConfirmDialog` (from `@/components/ui/confirm-dialog`):
  - Confirm message: "Disconnecting will delete the provider configuration and remove any model assignments using Ollama. You'll need to set it up again if you re-add it."
  - Confirm action label: "Disconnect"
  - On confirm: calls `onDisconnect()` (which triggers DELETE /api/providers/ollama -- row is deleted, not disabled)

Layout (inside a SettingsPanel):
1. **Connection section** -- Editable host/port fields in a Grid
2. **Model Library section** -- `ModelManagement` component (edit mode only)
3. **Action buttons** -- Save + Cancel (setup) or Save + Disconnect (edit)

**providers/ollama/index.ts** -- Update to export the Panel:
```typescript
import { OllamaProviderPanel } from "./OllamaProviderPanel";

export const ollamaProvider: ProviderPlugin = {
  // ... existing metadata and Logo
  Panel: OllamaProviderPanel,
};
```

**ModelManagement.tsx** -- No functional changes needed. Just verify it works when nested inside OllamaProviderPanel.

Light visual refresh of ModelManagement per CONTEXT.md ("light visual refresh to align with new card/pill aesthetic"): Discretionary. If it already uses SettingsPanel patterns, leave it.
  </action>
  <verify>
    <automated>cd /Users/cstalhem/projects/worktrees/rss-reader/great-lehmann/frontend && bun run build 2>&1 | tail -20</automated>
    <manual>
1. Start fresh (no providers). Click "Add Provider", add Ollama.
2. Verify panel shows in setup mode: default host/port, no model library, Save + Cancel buttons.
3. Click Cancel -- verify pill disappears, empty state returns.
4. Add Ollama again, click Save -- verify provider persists (pill stays after page reload).
5. Click pill to expand -- verify edit mode: current host/port, model library visible, Save + Disconnect buttons.
6. Click Disconnect -- verify ConfirmDialog warns about provider deletion and model assignments. Confirm, verify pill disappears.
    </manual>
  </verify>
  <done>OllamaProviderPanel is fully self-contained in providers/ollama/. Supports setup mode (defaults, Save+Cancel) and edit mode (server config, Save+Disconnect with ConfirmDialog). Calls its own hooks, manages its own state.</done>
</task>

</tasks>

<verification>
1. `bun run build` passes with no type errors
2. Empty state shows when no providers configured
3. Add Provider dialog shows 5 cards with logos from plugin modules, only Ollama selectable
4. Adding Ollama is frontend-only -- no backend call until Save
5. Setup mode: defaults, Save + Cancel buttons, no model library
6. Cancel removes pending provider from pill bar
7. Save creates provider row, transitions to edit mode
8. Edit mode: current config, model library, Save + Disconnect
9. Disconnect ConfirmDialog communicates provider deletion and model assignment clearing
10. System prompts render at bottom regardless of provider state
11. LLMProvidersSection has ZERO provider-specific imports
</verification>

<success_criteria>
- LLMProvidersSection replaces OllamaSection as the page component (provider-agnostic)
- Adding a provider is frontend-only state until user saves
- Provider panels are self-contained -- call own hooks, manage own state
- Setup mode and edit mode work correctly with appropriate buttons
- Provider pill bar renders saved + pending providers
- Add Provider dialog functional with Coming Soon badges, data from PROVIDER_REGISTRY
- Full add/setup/save/edit/disconnect lifecycle works
- Disconnect clearly communicates that provider config is deleted and model assignments are cleared (re-add starts fresh)
- System prompts section unchanged at bottom
</success_criteria>

<output>
After completion, create `.planning/phases/09.6-llm-providers-settings-refresh/09.6-02-SUMMARY.md`
</output>
