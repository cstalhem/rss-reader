---
phase: 09.6-llm-providers-settings-refresh
plan: 01
subsystem: api, ui
tags: [fastapi, tanstack-query, multi-provider, plugin-architecture, alembic]

# Dependency graph
requires:
  - phase: 09.5-main-view-ux-typography
    provides: "Stable frontend/backend codebase, settings page architecture"
provides:
  - "Backend endpoints: GET/DELETE /api/providers, PUT /api/providers/{provider}/config"
  - "Backend endpoints: GET/PUT /api/task-routes, GET /api/models (aggregated)"
  - "Frontend ProviderPlugin interface and PROVIDER_REGISTRY with 5 providers"
  - "Frontend hooks: useProviders, useModelAssignments, useAvailableModels"
  - "Frontend API functions and types for provider/task-route/models endpoints"
  - "Provider-agnostic use_separate_models in UserPreferences"
affects: [09.6-02-PLAN, 09.6-03-PLAN]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Provider plugin module pattern: per-provider directory with Logo + index.ts"
    - "Provider-agnostic URL pattern: /api/providers/{provider}/config"
    - "Model assignments decoupled from provider config via /api/task-routes"
    - "Aggregated models endpoint: /api/models collects from all configured providers"

key-files:
  created:
    - "backend/alembic/versions/1c3cc7f7d174_rename_use_separate_models_drop_legacy_.py"
    - "frontend/src/components/settings/providers/types.ts"
    - "frontend/src/components/settings/providers/registry.ts"
    - "frontend/src/components/settings/providers/ollama/index.ts"
    - "frontend/src/hooks/useProviders.ts"
    - "frontend/src/hooks/useModelAssignments.ts"
    - "frontend/src/hooks/useAvailableModels.ts"
  modified:
    - "backend/src/backend/routers/ollama.py"
    - "backend/src/backend/schemas.py"
    - "backend/src/backend/models.py"
    - "backend/src/backend/deps.py"
    - "backend/src/backend/database.py"
    - "frontend/src/lib/types.ts"
    - "frontend/src/lib/api.ts"
    - "frontend/src/lib/queryKeys.ts"

key-decisions:
  - "Provider-agnostic URL PUT /api/providers/{provider}/config replaces PUT /api/ollama/config"
  - "Disconnect deletes LLMProviderConfig row and all LLMTaskRoute rows in single transaction"
  - "use_separate_models lives in UserPreferences (provider-agnostic), accessed via task-route endpoints"
  - "GET /api/models aggregates from all providers, skips failing ones gracefully"
  - "First Alembic migration guarded to handle fresh installs where legacy columns never existed"

patterns-established:
  - "Provider plugin: directory per provider with Logo component + index.ts exporting ProviderPlugin"
  - "Provider-agnostic URL pattern: /api/providers/{provider}/config dispatches by provider name"
  - "Task routes independent from provider config: separate endpoints, separate hooks"

requirements-completed: [OLLAMA-01, OLLAMA-02]

# Metrics
duration: 10min
completed: 2026-02-25
---

# Phase 09.6 Plan 01: Data Layer Foundation Summary

**Backend provider/task-route/models endpoints with frontend ProviderPlugin module structure, PROVIDER_REGISTRY, and provider-agnostic hooks for multi-provider LLM settings**

## Performance

- **Duration:** 10 min
- **Started:** 2026-02-25T21:45:17Z
- **Completed:** 2026-02-25T21:55:30Z
- **Tasks:** 2
- **Files modified:** 27

## Accomplishments
- Backend endpoints for provider management (list, disconnect, config), task routes, and aggregated models
- Frontend provider plugin module structure mirroring backend's llm_providers/ pattern with 5 providers
- Three new hooks (useProviders, useModelAssignments, useAvailableModels) fully decoupled from provider-specific config
- Legacy UserPreferences columns removed via Alembic migration (ollama_categorization_model, ollama_scoring_model, ollama_thinking, active_llm_provider)

## Task Commits

Each task was committed atomically:

1. **Task 1: Backend provider, config, and task-route endpoints** - `07fe6d3` (feat)
2. **Task 2: Frontend provider plugin modules, data layer, and hooks** - `16207e7` (feat)

## Files Created/Modified

**Backend:**
- `backend/src/backend/routers/ollama.py` - New provider, task-route, and models endpoints; old PUT /api/ollama/config removed
- `backend/src/backend/schemas.py` - New schemas: ProviderListItem, AvailableModel, TaskRouteItem, TaskRoutesResponse, TaskRoutesUpdate
- `backend/src/backend/models.py` - UserPreferences: legacy columns removed, ollama_use_separate_models renamed to use_separate_models
- `backend/src/backend/deps.py` - Removed _build_legacy_ollama_config, resolve_ollama_models; cleaned legacy column references
- `backend/src/backend/database.py` - Stopped v2 migration from adding ollama_thinking on fresh installs
- `backend/alembic/versions/1c3cc7f7d174_rename_use_separate_models_drop_legacy_.py` - Migration: rename column, drop legacy columns
- `backend/alembic/versions/dff7a4c52b3c_llm_providers_task_routes.py` - Guards for fresh installs where legacy columns don't exist
- `backend/tests/test_ollama_config_router.py` - Updated to use new PUT /api/providers/ollama/config URL
- `backend/tests/test_migrations.py` - Updated assertions for removed columns

**Frontend:**
- `frontend/src/components/settings/providers/types.ts` - ProviderPlugin interface and ProviderPanelProps
- `frontend/src/components/settings/providers/registry.ts` - PROVIDER_REGISTRY with 5 providers
- `frontend/src/components/settings/providers/ollama/` - Ollama plugin module with Logo placeholder
- `frontend/src/components/settings/providers/openai/` - OpenAI plugin module (coming soon)
- `frontend/src/components/settings/providers/anthropic/` - Anthropic plugin module (coming soon)
- `frontend/src/components/settings/providers/google/` - Google plugin module (coming soon)
- `frontend/src/components/settings/providers/openrouter/` - OpenRouter plugin module (coming soon)
- `frontend/src/hooks/useProviders.ts` - Provider list query + disconnect mutation
- `frontend/src/hooks/useModelAssignments.ts` - Task routes query + save/rescore mutations
- `frontend/src/hooks/useAvailableModels.ts` - Aggregated models query (provider-agnostic)
- `frontend/src/lib/types.ts` - New types for provider/model/task-route responses
- `frontend/src/lib/api.ts` - New API functions + updated saveOllamaConfig URL
- `frontend/src/lib/queryKeys.ts` - New keys: providers.all, models.available, taskRoutes.all

## Decisions Made
- Provider-agnostic URL `PUT /api/providers/{provider}/config` replaces `PUT /api/ollama/config` -- extensible to future providers
- Disconnect deletes LLMProviderConfig + LLMTaskRoute rows atomically -- re-adding starts fresh (no disabled state)
- `use_separate_models` stored in UserPreferences (provider-agnostic) rather than per-provider config
- GET /api/models aggregates from all configured providers, gracefully skips failing ones
- First Alembic migration updated with column-existence guards for fresh installs where legacy columns were never created

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Guarded first Alembic migration for fresh installs**
- **Found during:** Task 1 (running tests after model changes)
- **Issue:** `create_db_and_tables()` creates table from current model (no legacy columns), then first Alembic migration tries to SELECT legacy columns -- fails on fresh installs
- **Fix:** Added `_column_exists` guards around legacy column reads in dff7a4c migration, plus guard on `active_llm_provider` add/update operations
- **Files modified:** `backend/alembic/versions/dff7a4c52b3c_llm_providers_task_routes.py`
- **Verification:** Full test suite passes on fresh DB
- **Committed in:** 07fe6d3 (Task 1 commit)

**2. [Rule 3 - Blocking] Stopped database.py v2 migration from adding removed column**
- **Found during:** Task 1 (migration sequencing analysis)
- **Issue:** database.py v2 migration adds `ollama_thinking` column, but the model no longer defines it -- creating unnecessary column that Alembic then drops
- **Fix:** Removed `ollama_thinking` add from v2 migration (it was historical and the column is now dropped by Alembic)
- **Files modified:** `backend/src/backend/database.py`
- **Verification:** Clean startup with no orphan columns
- **Committed in:** 07fe6d3 (Task 1 commit)

**3. [Rule 1 - Bug] Updated test_ollama_config_router URL and test_migrations assertions**
- **Found during:** Task 1 (test verification)
- **Issue:** Tests referenced old PUT /api/ollama/config URL and asserted active_llm_provider column exists after migration
- **Fix:** Updated URL to PUT /api/providers/ollama/config; changed migration test to verify legacy columns are removed
- **Files modified:** `backend/tests/test_ollama_config_router.py`, `backend/tests/test_migrations.py`
- **Verification:** 45 tests pass (6 pre-existing failures in test_api.py unrelated to changes)
- **Committed in:** 07fe6d3 (Task 1 commit)

---

**Total deviations:** 3 auto-fixed (1 bug, 2 blocking)
**Impact on plan:** All fixes necessary for correctness on fresh installs and test compatibility. No scope creep.

## Issues Encountered
- 6 pre-existing test failures in test_api.py (test_root tests GET / which doesn't exist, article fixture tests have data issues) -- not caused by this plan, logged as out-of-scope

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- All backend endpoints ready for Plan 02 (Ollama provider panel) and Plan 03 (page composition)
- Frontend data layer complete: hooks, types, API functions, query keys
- Provider plugin structure ready for Plan 02 to implement OllamaPanel component
- PROVIDER_REGISTRY ready for Plan 03 to render provider pills and Add Provider dialog

## Self-Check: PASSED

All 12 key files verified present. Both task commits (07fe6d3, 16207e7) verified in git log.

---
*Phase: 09.6-llm-providers-settings-refresh*
*Completed: 2026-02-25*
