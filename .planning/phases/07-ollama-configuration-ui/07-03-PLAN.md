---
phase: 07-ollama-configuration-ui
plan: 03
type: execute
wave: 2
depends_on: ["07-02"]
files_modified:
  - frontend/src/hooks/useModelPull.ts
  - frontend/src/components/settings/ModelManagement.tsx
  - frontend/src/components/settings/ModelPullProgress.tsx
  - frontend/src/components/settings/OllamaSection.tsx
  - frontend/src/components/settings/SettingsSidebar.tsx
autonomous: true

must_haves:
  truths:
    - "User sees a curated list of 5 recommended models with name, size, and 'Installed' badge for already-downloaded models"
    - "User can enter a custom model name in a text input to pull any model"
    - "Clicking Pull starts a download with an inline progress bar showing percentage and speed"
    - "User can cancel an active download via a Cancel button"
    - "User can delete installed models with a confirmation dialog"
    - "User can navigate away from settings and return to see current download progress"
    - "A subtle download indicator appears on the Ollama sidebar tab when a download is in progress"
  artifacts:
    - path: "frontend/src/hooks/useModelPull.ts"
      provides: "Hook managing SSE streaming for model pulls, cancel, and download-status polling"
    - path: "frontend/src/components/settings/ModelManagement.tsx"
      provides: "Curated model list, custom input, installed badges, delete with confirmation"
    - path: "frontend/src/components/settings/ModelPullProgress.tsx"
      provides: "Inline progress bar with percentage, speed, and cancel button"
  key_links:
    - from: "frontend/src/hooks/useModelPull.ts"
      to: "/api/ollama/models/pull"
      via: "fetch() with ReadableStream for SSE consumption (not EventSource -- POST endpoint)"
      pattern: "getReader"
    - from: "frontend/src/hooks/useModelPull.ts"
      to: "/api/ollama/download-status"
      via: "TanStack Query polling for navigate-away resilience"
      pattern: "download-status"
    - from: "frontend/src/components/settings/SettingsSidebar.tsx"
      to: "frontend/src/hooks/useModelPull.ts"
      via: "Download status indicator on Ollama tab"
      pattern: "download.*active"
---

<objective>
Build the model download/delete management UI with streaming progress. Extends the Ollama settings section with curated model suggestions, pull with SSE progress, cancel, and delete with confirmation.

Purpose: Covers OLLAMA-03 (model downloads with progress indication). Users can discover, download, and remove Ollama models entirely from the settings UI.

Output: Model management component with curated suggestions, inline progress bar, and delete functionality. Download indicator on settings sidebar.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-ollama-configuration-ui/07-RESEARCH.md
@.planning/phases/07-ollama-configuration-ui/07-CONTEXT.md
@.planning/phases/07-ollama-configuration-ui/07-01-SUMMARY.md
@.planning/phases/07-ollama-configuration-ui/07-02-SUMMARY.md
@frontend/src/lib/api.ts
@frontend/src/lib/types.ts
@frontend/src/hooks/useOllamaModels.ts
@frontend/src/components/settings/OllamaSection.tsx
@frontend/src/components/settings/SettingsSidebar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Model pull hook with SSE streaming and download status</name>
  <files>
    frontend/src/hooks/useModelPull.ts
  </files>
  <action>
    Create `frontend/src/hooks/useModelPull.ts` that manages model downloading.

    **State:**
    - `progress: { status: string, completed: number, total: number, percentage: number, speed: string } | null`
    - `isDownloading: boolean`
    - `error: string | null`

    **Core: `startPull(model: string)`**
    Use `fetch()` with POST to `/api/ollama/models/pull` (NOT EventSource -- POST endpoint). Read the SSE stream via `response.body.getReader()` and `TextDecoder`. Parse SSE lines (`data: {...}\n\n` format) with a buffer to handle partial chunks.

    For each parsed event:
    - Update progress state with status, completed, total
    - Calculate percentage: `Math.round((completed / total) * 100)` (guard against total=0)
    - Calculate speed: track bytes received over a rolling 2-second window. Format as "X.X MB/s" or "X.X KB/s"

    Use an `AbortController` stored in a ref so the fetch can be cancelled.

    **Cancel: `cancelPull()`**
    1. Abort the AbortController (closes the SSE connection, which should cause the backend generator to terminate)
    2. Also call POST `/api/ollama/models/pull/cancel` as a safety net
    3. Clear progress state

    **Navigate-away resilience:**
    On mount, check `fetchDownloadStatus()` (from api.ts). If `active: true`, populate progress state from the status response and start polling (via `useQuery` with `refetchInterval: 1000` while active). This way, if the user navigates away and returns, they see the current download progress via polling (not SSE -- the SSE stream is gone).

    When polling detects `active: false`, stop polling, invalidate `["ollama-models"]` query (so the model list refreshes), and clear progress.

    **On successful completion** (SSE stream ends naturally or poll shows active=false):
    - Invalidate `["ollama-models"]` query to refresh the model list
    - Clear progress state after a short delay (500ms) so the user sees 100%

    **Return:** `{ progress, isDownloading, error, startPull, cancelPull }`

    **Important:** Use `fetch()` with ReadableStream, NOT `EventSource` (which only supports GET). The pattern from research:
    ```typescript
    const response = await fetch(url, { method: "POST", headers: {"Content-Type": "application/json"}, body: JSON.stringify({ model }), signal });
    const reader = response.body!.getReader();
    const decoder = new TextDecoder();
    let buffer = "";
    while (true) {
      const { done, value } = await reader.read();
      if (done) break;
      buffer += decoder.decode(value, { stream: true });
      const lines = buffer.split("\n\n");
      buffer = lines.pop() || "";
      for (const line of lines) {
        if (line.startsWith("data: ")) {
          const data = JSON.parse(line.slice(6));
          // update progress
        }
      }
    }
    ```
  </action>
  <verify>
    Run `cd /Users/cstalhem/projects/rss-reader/frontend && npx tsc --noEmit` to confirm no type errors.
    Run `cd /Users/cstalhem/projects/rss-reader/frontend && bun run lint` to confirm no lint errors.
  </verify>
  <done>
    useModelPull hook exists with startPull (SSE via fetch ReadableStream), cancelPull (AbortController + backend cancel endpoint), and navigate-away resilience (download-status polling on mount). Speed calculation and progress percentage work. TypeScript compiles.
  </done>
</task>

<task type="auto">
  <name>Task 2: Model management UI and download indicator</name>
  <files>
    frontend/src/components/settings/ModelManagement.tsx
    frontend/src/components/settings/ModelPullProgress.tsx
    frontend/src/components/settings/OllamaSection.tsx
    frontend/src/components/settings/SettingsSidebar.tsx
  </files>
  <action>
    **Create `frontend/src/components/settings/ModelPullProgress.tsx`:**
    Props: `progress: { status: string, completed: number, total: number, percentage: number, speed: string }`, `onCancel: () => void`.

    Layout: replaces the Pull button inline when a download is active.
    - Progress bar: Chakra `ProgressBar` or a custom bar with `bg="accent.solid"` fill on a `bg.subtle` track. Height ~6px, borderRadius full.
    - Text line below: percentage (e.g., "45%"), speed (e.g., "2.3 MB/s"), status text (e.g., "pulling llama3.2:3b").
    - Cancel button: small, text-only or outline style, "Cancel" label. Calls `onCancel`.
    Use Chakra `Progress.Root` / `Progress.Track` / `Progress.Range` components if available in v3, otherwise build with Box.

    **Create `frontend/src/components/settings/ModelManagement.tsx`:**
    Props: `models: OllamaModel[]` (currently installed), `isConnected: boolean`, `pullHook: ReturnType<typeof useModelPull>`.

    **Curated model suggestions list** (hardcoded):
    ```typescript
    const CURATED_MODELS = [
      { name: "qwen3:1.7b", size: "~1.0 GB", description: "Smallest, fast on CPU" },
      { name: "qwen3:4b", size: "~2.5 GB", description: "Good balance" },
      { name: "qwen3:8b", size: "~4.9 GB", description: "Strong accuracy" },
      { name: "gemma3:4b", size: "~3.3 GB", description: "Google, good at classification" },
      { name: "llama3.2:3b", size: "~2.0 GB", description: "Meta, efficient" },
    ];
    ```

    Layout:
    - Section header: "Model Library" or "Available Models"
    - List of curated models, each as a row:
      - Model name + approximate size + description
      - If already installed (name matches an entry in `models`): show "Installed" badge (accent/green) instead of Pull button
      - If not installed: "Pull" button
      - If this model is currently being pulled (pullHook.isDownloading and matches): show `ModelPullProgress` instead of the button
    - Below the list: "Custom model" text input + "Pull" button for arbitrary model names. Input placeholder: "e.g., mistral:7b"
    - Below installed models (or in the same list): for each installed model that is NOT being used as the active categorization/scoring model, show a "Delete" icon button (trash icon). Clicking opens a confirmation dialog (Chakra `Dialog.Root`/`Dialog.Content` or a simple confirm pattern). On confirm, call `deleteOllamaModel(name)` from api.ts, then invalidate `["ollama-models"]`.

    When `!isConnected`: show disabled state with message.

    **Update `frontend/src/components/settings/OllamaSection.tsx`:**
    Import and render `ModelManagement` below `ModelSelector`. Pass the `useModelPull()` hook instance and the models list. The section layout becomes:
    1. Header + HealthBadge
    2. ModelSelector (selection + save)
    3. ModelManagement (download/delete)
    4. SystemPrompts (collapsible)

    **Update `frontend/src/components/settings/SettingsSidebar.tsx`:**
    Add a subtle download indicator on the "Ollama" tab item. Import `fetchDownloadStatus` from api.ts and use a `useQuery` hook (with `refetchInterval: 3000` -- poll every 3s to keep it lightweight, only when sidebar is mounted).

    When download is active, show a small pulsing dot or a small spinner icon next to the "Ollama" label. Keep it subtle -- just enough to indicate activity. Could be a tiny animated circle (`@keyframes pulse` with Emotion `keyframes` helper -- per AGENTS.md, must use `keyframes` tagged template, not inline) or a static colored dot that appears/disappears.

    Note: The SettingsSidebar is always mounted when the settings page is shown, so this polling naturally runs whenever the user is on any settings tab. The interval of 3s is a good balance between responsiveness and overhead.
  </action>
  <verify>
    Run `cd /Users/cstalhem/projects/rss-reader/frontend && npx tsc --noEmit` to confirm no type errors.
    Run `cd /Users/cstalhem/projects/rss-reader/frontend && bun run lint` to confirm no lint errors.
    Run `cd /Users/cstalhem/projects/rss-reader/frontend && bun run build` to confirm the build succeeds.
  </verify>
  <done>
    ModelManagement shows 5 curated models with Installed badges for downloaded ones, Pull buttons for available ones, inline progress bar during download with cancel. Custom model input allows pulling arbitrary models. Delete with confirmation dialog works. OllamaSection integrates ModelManagement. SettingsSidebar shows download indicator on Ollama tab. Build succeeds with no errors.
  </done>
</task>

</tasks>

<verification>
1. `cd /Users/cstalhem/projects/rss-reader/frontend && npx tsc --noEmit` -- no TypeScript errors
2. `cd /Users/cstalhem/projects/rss-reader/frontend && bun run lint` -- no ESLint errors
3. `cd /Users/cstalhem/projects/rss-reader/frontend && bun run build` -- production build succeeds
4. Verify useModelPull uses fetch+ReadableStream (not EventSource) for POST SSE
5. Verify curated models list has 5 entries matching research recommendations
6. Verify SettingsSidebar has download status polling and indicator
</verification>

<success_criteria>
- Curated list of 5 models displayed with name, size, description
- Already-installed models show "Installed" badge (not hidden)
- Pull button starts download, replaced by inline progress bar
- Progress bar shows percentage and speed
- Cancel button aborts download
- Custom model name input allows pulling any model
- Delete button with confirmation dialog removes models
- Navigate away and return: download progress restored via polling
- Subtle download indicator on Ollama sidebar tab when download is active
- TypeScript compiles, lint passes, build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/07-ollama-configuration-ui/07-03-SUMMARY.md`
</output>
