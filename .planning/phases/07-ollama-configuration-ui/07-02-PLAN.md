---
phase: 07-ollama-configuration-ui
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - frontend/src/lib/types.ts
  - frontend/src/lib/api.ts
  - frontend/src/hooks/useOllamaHealth.ts
  - frontend/src/hooks/useOllamaModels.ts
  - frontend/src/hooks/useOllamaConfig.ts
  - frontend/src/components/settings/OllamaSection.tsx
  - frontend/src/components/settings/OllamaHealthBadge.tsx
  - frontend/src/components/settings/ModelSelector.tsx
  - frontend/src/components/settings/SystemPrompts.tsx
  - frontend/src/components/settings/RescoreButton.tsx
  - frontend/src/app/settings/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can see Ollama connection status (connected/disconnected) with latency and version in the Ollama settings section"
    - "Health badge auto-refreshes every 20 seconds while Ollama section is visible and stops when navigating away"
    - "User can select a model from a dropdown of locally available models showing name + size"
    - "Single model selector by default; 'Use separate models' toggle appears only when 2+ models are available"
    - "When using separate models, a RAM warning is displayed"
    - "Models currently loaded in Ollama memory show a small badge/indicator"
    - "Model changes require clicking an explicit Save button"
    - "When Ollama is disconnected, dropdowns are disabled with 'Connect to Ollama to manage models' message"
    - "User can view current system prompts in read-only text areas"
    - "User can trigger re-evaluation of unread articles via a button that is inactive until settings have changed"
    - "Re-score button sends correct rescore_mode: 'full' if categorization model changed, 'score_only' if only scoring model changed"
  artifacts:
    - path: "frontend/src/components/settings/OllamaSection.tsx"
      provides: "Main Ollama settings section replacing OllamaPlaceholder"
    - path: "frontend/src/components/settings/OllamaHealthBadge.tsx"
      provides: "Connection status badge with latency and version"
    - path: "frontend/src/components/settings/ModelSelector.tsx"
      provides: "Model dropdown(s) with single/split toggle, save button, RAM warning"
    - path: "frontend/src/components/settings/SystemPrompts.tsx"
      provides: "Read-only collapsible prompt display"
    - path: "frontend/src/components/settings/RescoreButton.tsx"
      provides: "Re-evaluate unread articles button with changed-state detection"
    - path: "frontend/src/hooks/useOllamaHealth.ts"
      provides: "TanStack Query hook polling /api/ollama/health"
    - path: "frontend/src/hooks/useOllamaModels.ts"
      provides: "TanStack Query hook fetching /api/ollama/models"
    - path: "frontend/src/hooks/useOllamaConfig.ts"
      provides: "TanStack Query hook for fetching/saving /api/ollama/config"
  key_links:
    - from: "frontend/src/hooks/useOllamaHealth.ts"
      to: "/api/ollama/health"
      via: "TanStack Query with conditional refetchInterval"
      pattern: "refetchInterval.*20000"
    - from: "frontend/src/components/settings/ModelSelector.tsx"
      to: "/api/ollama/config"
      via: "useOllamaConfig hook save mutation"
      pattern: "useMutation"
    - from: "frontend/src/components/settings/RescoreButton.tsx"
      to: "/api/ollama/config"
      via: "save with rescore=true triggers backend re-scoring enqueue"
      pattern: "rescore.*true"
    - from: "frontend/src/app/settings/page.tsx"
      to: "frontend/src/components/settings/OllamaSection.tsx"
      via: "import replacing OllamaPlaceholder"
      pattern: "OllamaSection"
---

<objective>
Build the Ollama settings UI: health badge, model selector with single/split toggle, system prompt display, and re-score button. Replaces OllamaPlaceholder with a fully functional settings section.

Purpose: Covers OLLAMA-01 (health status), OLLAMA-02 (model selection), OLLAMA-04 (system prompts), and OLLAMA-05 (re-scoring). This is the main user-facing configuration interface.

Output: OllamaSection component with health monitoring, model selection, prompt display, and re-scoring. Three new hooks for data fetching. Updated settings page import.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-ollama-configuration-ui/07-RESEARCH.md
@.planning/phases/07-ollama-configuration-ui/07-CONTEXT.md
@.planning/phases/07-ollama-configuration-ui/07-01-SUMMARY.md
@frontend/src/lib/api.ts
@frontend/src/lib/types.ts
@frontend/src/hooks/useScoringStatus.ts
@frontend/src/components/settings/OllamaPlaceholder.tsx
@frontend/src/components/settings/SettingsSidebar.tsx
@frontend/src/app/settings/page.tsx
@frontend/src/theme/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Types, API functions, and data hooks</name>
  <files>
    frontend/src/lib/types.ts
    frontend/src/lib/api.ts
    frontend/src/hooks/useOllamaHealth.ts
    frontend/src/hooks/useOllamaModels.ts
    frontend/src/hooks/useOllamaConfig.ts
  </files>
  <action>
    **Add types to `frontend/src/lib/types.ts`:**
    ```typescript
    export interface OllamaHealth {
      connected: boolean;
      version: string | null;
      latency_ms: number | null;
    }

    export interface OllamaModel {
      name: string;
      size: number;
      parameter_size: string | null;
      quantization_level: string | null;
      is_loaded: boolean;
    }

    export interface OllamaConfig {
      categorization_model: string;
      scoring_model: string;
      use_separate_models: boolean;
    }

    export interface OllamaPrompts {
      categorization_prompt: string;
      scoring_prompt: string;
    }

    export interface OllamaConfigSaveResult extends OllamaConfig {
      rescore_queued: number;
    }
    ```

    **Add API functions to `frontend/src/lib/api.ts`:**
    - `fetchOllamaHealth(): Promise<OllamaHealth>` -- GET /api/ollama/health
    - `fetchOllamaModels(): Promise<OllamaModel[]>` -- GET /api/ollama/models
    - `fetchOllamaConfig(): Promise<OllamaConfig>` -- GET /api/ollama/config
    - `saveOllamaConfig(data: OllamaConfig & { rescore: boolean }): Promise<OllamaConfigSaveResult>` -- PUT /api/ollama/config
    - `fetchOllamaPrompts(): Promise<OllamaPrompts>` -- GET /api/ollama/prompts
    - `deleteOllamaModel(name: string): Promise<void>` -- DELETE /api/ollama/models/{name} (needed by Plan 03 but add the API function now)
    - `fetchDownloadStatus(): Promise<{active: boolean, model: string|null, completed: number, total: number, status: string|null}>` -- GET /api/ollama/download-status (needed by Plan 03 but add now)

    Follow the existing pattern in api.ts: throw on !response.ok, use API_BASE_URL prefix.

    **Create `frontend/src/hooks/useOllamaHealth.ts`:**
    TanStack Query hook that polls `/api/ollama/health`. Accept a parameter `enabled: boolean` (defaults to true). Use `refetchInterval: 20_000` (20 seconds) but ONLY when `enabled` is true. When `enabled` is false, set `refetchInterval: false` to stop polling. Use `staleTime: 10_000`.

    **Create `frontend/src/hooks/useOllamaModels.ts`:**
    TanStack Query hook that fetches `/api/ollama/models`. Accept `enabled: boolean` parameter. Use `staleTime: 30_000`. Refetch on window focus. No polling -- models don't change frequently.

    **Create `frontend/src/hooks/useOllamaConfig.ts`:**
    Export a hook that provides:
    - `config` (query data from GET /api/ollama/config)
    - `isLoading`
    - `saveMutation` (useMutation wrapping PUT /api/ollama/config that invalidates the config query on success, and also invalidates `["ollama-models"]` and `["scoring-status"]` queries)
    The hook should also return `savedConfig` (the config as it was when last fetched from server) for dirty detection.
  </action>
  <verify>
    Run `cd /Users/cstalhem/projects/rss-reader/frontend && npx tsc --noEmit` to confirm no type errors.
    Run `cd /Users/cstalhem/projects/rss-reader/frontend && bun run lint` to confirm no lint errors.
  </verify>
  <done>
    All Ollama types exist in types.ts. All 7 API functions exist in api.ts. Three hooks (useOllamaHealth, useOllamaModels, useOllamaConfig) are implemented with correct polling/caching behavior. TypeScript compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Ollama settings UI components</name>
  <files>
    frontend/src/components/settings/OllamaSection.tsx
    frontend/src/components/settings/OllamaHealthBadge.tsx
    frontend/src/components/settings/ModelSelector.tsx
    frontend/src/components/settings/SystemPrompts.tsx
    frontend/src/components/settings/RescoreButton.tsx
    frontend/src/app/settings/page.tsx
  </files>
  <action>
    **Create `frontend/src/components/settings/OllamaHealthBadge.tsx`:**
    Shows Ollama connection status. Props: `health: OllamaHealth | undefined`, `isLoading: boolean`.
    - Connected: green dot + "Connected" + latency (e.g., "23ms") + version (e.g., "v0.9.1")
    - Disconnected: red dot + "Disconnected"
    - Loading: gray dot + "Checking..."
    Use Chakra `Badge` or `Flex` with colored circle (`Box` with borderRadius="full", w/h=2). Use semantic tokens (green.solid for connected, red.solid for disconnected, fg.subtle for loading). Keep it compact -- single line, inline.

    **Create `frontend/src/components/settings/ModelSelector.tsx`:**
    Props: `models: OllamaModel[]`, `config: OllamaConfig`, `savedConfig: OllamaConfig`, `isConnected: boolean`, `onConfigChange: (config: OllamaConfig) => void`, `onSave: (rescore: boolean) => void`, `isSaving: boolean`.

    Layout:
    - If `!isConnected`: show disabled state with message "Connect to Ollama to manage models" (per user decision).
    - Single model dropdown by default. Shows model name + formatted size (e.g., "qwen3:8b -- 4.9 GB"). Use Chakra `NativeSelect` (simpler than Select.Root for this use case -- just a list of options).
    - "Use separate models" toggle (`Switch` component): only visible when `models.length >= 2`. When toggled on, show two dropdowns (Categorization Model, Scoring Model) plus a RAM warning text in orange/amber.
    - Models that are currently loaded in Ollama memory (`is_loaded: true`): append a small "(loaded)" text or a small green dot indicator next to their name in the dropdown option.
    - **Save button**: Chakra `Button` with `colorPalette="accent"`. Disabled when config hasn't changed from `savedConfig` (compare by JSON.stringify). Label: "Save". When saving, show loading spinner.
    - Below the Save button: the `RescoreButton` component (see below).

    Format model sizes as human-readable: bytes to "X.X GB" or "X.X MB".

    **Create `frontend/src/components/settings/RescoreButton.tsx`:**
    Props: `currentConfig: OllamaConfig`, `savedConfig: OllamaConfig`, `onRescore: () => void`, `isRescoring: boolean`.

    - Label: "Re-evaluate unread articles"
    - Disabled when `currentConfig` matches `savedConfig` (i.e., no changes have been saved since page load that would warrant re-scoring). The button becomes active after a save that changed models.
    - Track internally: after a save completes (detected by savedConfig changing and differing from initial load), enable the button. After clicking, disable again.
    - Actually, simpler approach per research: the PUT /api/ollama/config endpoint accepts `rescore: true`. So the RescoreButton should trigger a save with `rescore=true`. It should be enabled when savedConfig differs from the config that was loaded on initial page mount. Use a `useRef` to capture the initial config on first load.
    - When scoring is active (useScoringStatus shows queued > 0), show an informational message: "Model change will take effect after current batch completes."

    **Create `frontend/src/components/settings/SystemPrompts.tsx`:**
    Fetches prompts from `/api/ollama/prompts` via a simple useQuery call (inline, no separate hook -- it's only used here). Displays two collapsible sections:
    - "Categorization Prompt" (collapsed by default)
    - "Scoring Prompt" (collapsed by default)
    Each section: clickable header with chevron icon that toggles open/closed. Content: `Textarea` or `Box` with `fontFamily="mono"`, `fontSize="sm"`, `whiteSpace="pre-wrap"`, `bg="bg.subtle"`, `p={4}`, `borderRadius="md"`. Read-only (no editing). Use Chakra's `Collapsible.Root` / `Collapsible.Content` if available in v3, otherwise simple state toggle with conditional rendering.

    **Create `frontend/src/components/settings/OllamaSection.tsx`:**
    The main section component that replaces `OllamaPlaceholder`. Accepts a prop `isVisible: boolean` to control health polling.

    Layout (vertical stack):
    1. Section header: "Ollama" title + `OllamaHealthBadge` on the same line
    2. `ModelSelector` with model selection UI
    3. `SystemPrompts` collapsible section
    4. Divider or spacing

    Uses hooks:
    - `useOllamaHealth(isVisible)` -- polls only when section is visible
    - `useOllamaModels(health?.connected)` -- fetches only when connected
    - `useOllamaConfig()` -- fetches config and provides save mutation

    Manages local form state for config (initialized from server config). Passes `onConfigChange` to ModelSelector to update local state. Passes `onSave` that calls the save mutation.

    **Update `frontend/src/app/settings/page.tsx`:**
    - Replace `import { OllamaPlaceholder }` with `import { OllamaSection }`
    - Replace `<OllamaPlaceholder />` with `<OllamaSection isVisible={activeSection === "ollama"} />`
    - In the mobile stacked view, pass `isVisible={true}` (always visible on mobile)
  </action>
  <verify>
    Run `cd /Users/cstalhem/projects/rss-reader/frontend && npx tsc --noEmit` to confirm no type errors.
    Run `cd /Users/cstalhem/projects/rss-reader/frontend && bun run lint` to confirm no lint errors.
    Run `cd /Users/cstalhem/projects/rss-reader/frontend && bun run build` to confirm the build succeeds.
  </verify>
  <done>
    OllamaSection replaces OllamaPlaceholder in settings page. Health badge shows connected/disconnected with latency and version, polling every 20s when visible. Model selector shows models with name + size, single/split toggle with RAM warning, explicit Save button. System prompts display in collapsible read-only sections. Re-score button enables after config changes. Build succeeds with no type or lint errors.
  </done>
</task>

</tasks>

<verification>
1. `cd /Users/cstalhem/projects/rss-reader/frontend && npx tsc --noEmit` -- no TypeScript errors
2. `cd /Users/cstalhem/projects/rss-reader/frontend && bun run lint` -- no ESLint errors
3. `cd /Users/cstalhem/projects/rss-reader/frontend && bun run build` -- production build succeeds
4. Verify OllamaPlaceholder is no longer imported in settings/page.tsx
5. Verify OllamaSection receives isVisible prop for conditional polling
</verification>

<success_criteria>
- OllamaPlaceholder replaced with functional OllamaSection in settings page
- Health badge shows connected/disconnected + latency + version, auto-refreshes every 20s when visible
- Model selector shows dropdown with name + size, loaded indicator on active models
- Single model by default, split toggle only when 2+ models, RAM warning when split
- Save button disabled when config unchanged, enabled when modified
- System prompts shown in collapsible read-only sections with mono font
- Re-score button triggers save with rescore=true, inactive until settings have changed
- Dropdowns disabled with message when Ollama disconnected
- All types, API functions, and hooks implemented
- TypeScript compiles, lint passes, build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/07-ollama-configuration-ui/07-02-SUMMARY.md`
</output>
