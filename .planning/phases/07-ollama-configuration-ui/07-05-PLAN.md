---
phase: 07-ollama-configuration-ui
plan: 05
type: execute
wave: 2
depends_on: [07-04]
files_modified:
  - frontend/src/hooks/useModelPull.ts
  - frontend/src/components/settings/ModelManagement.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Progress bar remains visible when navigating away from settings and back during active download"
    - "Recommended model progress shows full-width below model row, matching custom model layout"
  artifacts:
    - path: frontend/src/hooks/useModelPull.ts
      provides: "Explicit refetchInterval state that forces polling restart"
      contains: "const [intervalMs, setIntervalMs]"
    - path: frontend/src/components/settings/ModelManagement.tsx
      provides: "Full-width progress bar for recommended models"
      contains: "curated model progress rendering"
  key_links:
    - from: frontend/src/hooks/useModelPull.ts
      to: "TanStack Query refetchInterval"
      via: "explicit interval state variable"
      pattern: "refetchInterval: intervalMs"
    - from: frontend/src/components/settings/ModelManagement.tsx
      to: "useModelPull progress state"
      via: "conditional progress bar rendering"
      pattern: "pullHook\\.progress"
---

<objective>
Fix progress bar persistence across navigation and standardize progress bar layout for all model types.

Purpose: Addresses Gap 3 (major) and Gap 4 (minor) — ensures download progress is never lost when navigating and provides consistent UX for all model downloads.
Output: Progress bars persist across navigation and use consistent full-width layout.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-ollama-configuration-ui/07-02-SUMMARY.md
@.planning/phases/07-ollama-configuration-ui/07-04-SUMMARY.md
@.planning/debug/model-download-progress-disappears.md

Gap 3 root cause: TanStack Query's refetchInterval doesn't restart when its value changes from false to a number after remount. On remount with isDownloading=false, refetchInterval=false is set. When download-status returns active=true, useEffect sets isDownloading=true, but the polling timer is already stopped and won't restart.

Fix: Use explicit state variable for refetchInterval that forces TanStack Query to reinitialize.

Gap 4: Currently recommended model progress shows in a 160px Box inline to the right. Should match custom model's full-width layout below the row.
</context>

<tasks>

<task type="auto">
  <name>Fix progress bar persistence with explicit refetchInterval state</name>
  <files>frontend/src/hooks/useModelPull.ts</files>
  <action>
In useModelPull hook (line 52 has the bug):

Current code:
```typescript
refetchInterval: isDownloading ? 1000 : false
```

Replace with explicit state variable approach:

1. Add state: `const [intervalMs, setIntervalMs] = useState<number | false>(false)`
2. Replace refetchInterval with: `refetchInterval: intervalMs`
3. In useEffect that watches download status (lines ~100-110), update interval state:
   ```typescript
   useEffect(() => {
     if (downloadStatus?.active) {
       setIsDownloading(true);
       setIntervalMs(1000); // Start polling
     } else if (!downloadStatus?.active && isDownloading) {
       setIsDownloading(false);
       setIntervalMs(false); // Stop polling
     }
   }, [downloadStatus, isDownloading]);
   ```

This ensures that when the component remounts during an active download, the refetchInterval transitions from false → 1000 triggers TanStack Query to restart the polling timer.

Reference debug session: .planning/debug/model-download-progress-disappears.md (lines 15-45 explain the root cause).
  </action>
  <verify>
1. Start a model download from Settings > Ollama > Model Management (use a small model like qwen3:1.7b for faster testing)
2. While download is in progress (progress bar showing), navigate to Articles page
3. Navigate back to Settings > Ollama
4. Expected: Progress bar immediately reappears with current progress percentage and download speed
5. Progress bar continues updating in real-time
6. Download completes successfully with toast notification
  </verify>
  <done>Progress bar persists across navigation — navigating away and back during active download shows current progress state immediately</done>
</task>

<task type="auto">
  <name>Standardize progress bar layout for recommended models</name>
  <files>frontend/src/components/settings/ModelManagement.tsx</files>
  <action>
Current layout (line ~160-180): Recommended model progress shows in a 160px Box positioned inline to the right of the model row.

Change to match custom model layout:

1. Remove the inline 160px Box containing progress for curated models
2. Move progress rendering below the model row in a full-width layout
3. Structure should match custom model progress layout (lines ~300-320):
   - Full-width Flex container below the row
   - Progress bar with percentage on left, speed on right
   - Cancel button aligned to right
   - Same spacing and styling as custom model progress

This creates visual consistency: all model downloads (curated and custom) show progress in the same full-width format below the trigger element.

Preserve existing logic:
- Progress only shows when pullHook.progress exists for this model
- Other Pull buttons remain disabled during download
- Cancel button calls pullHook.cancelPull()
  </action>
  <verify>
1. Navigate to Settings > Ollama > Model Management
2. Find a curated model that's not installed (e.g., if qwen3:8b is not installed)
3. Click "Pull" button
4. Expected: Progress bar appears full-width BELOW the model name/description row
5. Progress bar shows: "[percentage]% -- [speed] MB/s" on left, Cancel button on right
6. Layout matches custom model progress bar exactly
7. Verify progress updates correctly and download completes or can be cancelled
  </verify>
  <done>Recommended model progress bars show full-width below model row, matching custom model layout</done>
</task>

</tasks>

<verification>
1. Download progress persists across page navigation (gap closed)
2. All model downloads (curated and custom) use consistent full-width progress layout (gap closed)
3. Progress updates continue in real-time
4. Cancel functionality works for all model types
5. Multiple navigation back-and-forth during download maintains progress state
</verification>

<success_criteria>
- Navigating away from and back to Ollama settings during active download shows current progress immediately
- Progress bar polling continues after remount
- Curated model progress bars use same full-width layout as custom models
- Visual consistency across all download types
- No regression in existing download, progress, or cancel functionality
</success_criteria>

<output>
After completion, create `.planning/phases/07-ollama-configuration-ui/07-05-SUMMARY.md`
</output>
