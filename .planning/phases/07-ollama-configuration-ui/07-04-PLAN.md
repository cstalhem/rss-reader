---
phase: 07-ollama-configuration-ui
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/backend/ollama_service.py
  - backend/src/backend/main.py
  - frontend/src/hooks/useModelPull.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Pulling a non-existent model shows an error message instead of a progress bar"
    - "Re-evaluate button triggers re-scoring of unread articles with toast confirmation"
    - "Already scored unread articles are re-queued when re-evaluate is clicked"
  artifacts:
    - path: backend/src/backend/ollama_service.py
      provides: "Error detection in SSE stream from Ollama pull"
      contains: "if 'error' in chunk"
    - path: backend/src/backend/main.py
      provides: "Unconditional re-queue logic when rescore=true"
      contains: "rescore_mode = rescore_mode or 'full'"
    - path: frontend/src/hooks/useModelPull.ts
      provides: "Error field parsing in SSE chunks"
      contains: "error:"
  key_links:
    - from: backend/src/backend/ollama_service.py
      to: "SSE stream chunks"
      via: "yield chunk inspection"
      pattern: "if.*error.*in chunk"
    - from: backend/src/backend/main.py
      to: "article re-queueing"
      via: "unconditional rescore when rescore=true"
      pattern: "rescore_mode = .* or 'full'"
---

<objective>
Fix backend error handling for model downloads and unconditional re-scoring when user explicitly requests re-evaluation.

Purpose: Addresses two blockers (Gap 7 and Gap 8) preventing proper error feedback and re-evaluation functionality.
Output: Backend correctly surfaces Ollama errors and always re-queues when rescore=true.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-ollama-configuration-ui/07-02-SUMMARY.md
@.planning/phases/07-ollama-configuration-ui/07-03-SUMMARY.md
@.planning/debug/ollama-pull-error-display.md
@.planning/debug/re-evaluate-button-not-working.md

Debug sessions provide root cause analysis:
- Gap 7: Ollama returns errors in SSE data field {"error": "..."}, not HTTP errors. Neither backend nor frontend checks for error field.
- Gap 8: Backend compares incoming config against stored config. When re-evaluate sends same config, no diff detected, rescore_mode=None, skips re-queueing.
</context>

<tasks>

<task type="auto">
  <name>Add error detection to Ollama pull stream in backend</name>
  <files>backend/src/backend/ollama_service.py</files>
  <action>
In `pull_model_stream()` (lines 95-135), add error field checking before yielding chunks. After parsing each chunk from the SSE stream:

1. Check if chunk contains an "error" key
2. If error exists, yield a special error chunk format: `{"error": chunk["error"]}`
3. Stop streaming after error chunk (don't continue processing)

This ensures errors from Ollama (e.g., "pull model manifest: file does not exist") are surfaced to the frontend instead of being silently passed through as normal progress chunks.

Reference debug session: .planning/debug/ollama-pull-error-display.md
  </action>
  <verify>
Start backend server. In another terminal, trigger a pull for a non-existent model via curl:

```bash
curl -X POST http://localhost:8912/api/ollama/pull \
  -H "Content-Type: application/json" \
  -d '{"model_name": "definitely-does-not-exist:latest"}'
```

Expected: Response stream includes `{"error": "pull model manifest: file does not exist"}` chunk.
  </verify>
  <done>Backend ollama_service.py detects error field in Ollama SSE chunks and yields error chunks to frontend</done>
</task>

<task type="auto">
  <name>Parse error chunks in frontend useModelPull hook</name>
  <files>frontend/src/hooks/useModelPull.ts</files>
  <action>
In the SSE parser section (lines 127-154):

1. Add error field parsing alongside existing status/completed/total/digest parsing
2. When error field is detected, set pullHook.error state with the error message
3. Stop processing further chunks after error is detected
4. Clear isDownloading state when error occurs

This ensures the frontend displays Ollama errors in the existing error UI (already present in ModelManagement.tsx at line ~250: `{pullHook.error && <Text color="red.500"...}`)

Reference debug session: .planning/debug/ollama-pull-error-display.md
  </action>
  <verify>
With backend running, attempt to pull a non-existent model from the UI (Settings > Ollama > Model Management > Custom model input > enter "fake-model:latest" > Pull).

Expected: Error message appears in red below the input: "pull model manifest: file does not exist" (or similar Ollama error text). No progress bar shown.
  </verify>
  <done>Frontend useModelPull.ts parses error field from SSE chunks and surfaces error message in UI</done>
</task>

<task type="auto">
  <name>Implement unconditional re-queue when rescore=true</name>
  <files>backend/src/backend/main.py</files>
  <action>
In PUT /api/ollama/config endpoint (lines 841-875):

Current logic: Only re-queues when rescore_mode is determined from model config diff. When re-evaluate sends the same config that's already saved, rescore_mode stays None and re-queueing is skipped.

Fix:
1. After determining rescore_mode from config diff (line ~860)
2. Add fallback: `if update.rescore and rescore_mode is None: rescore_mode = "full"`
3. This ensures when user explicitly clicks re-evaluate (rescore=true), articles are always re-queued even if no model config changed

This makes the re-evaluate button's intent clear: "re-score regardless of config changes."

Reference debug session: .planning/debug/re-evaluate-button-not-working.md
  </action>
  <verify>
Start backend and frontend. Navigate to Settings > Ollama. Without changing any model config, click "Re-evaluate unread articles" button.

Expected:
1. Toast appears: "X articles queued for re-evaluation"
2. Check backend logs for re-queue operations
3. Navigate to Articles page, verify articles enter scoring state

Test both scenarios:
- Re-evaluate without config change (should still re-queue)
- Re-evaluate after config change (should re-queue as before)
  </verify>
  <done>Backend unconditionally re-queues articles when rescore=true, defaulting rescore_mode to 'full' when no config diff detected</done>
</task>

</tasks>

<verification>
1. Pull non-existent model from UI → error message shown, no progress bar
2. Pull valid model → progress bar works as before
3. Click re-evaluate without changing config → toast shown, articles re-queued
4. Click re-evaluate after changing config → toast shown, articles re-queued
5. Backend logs confirm error detection and unconditional re-queue behavior
</verification>

<success_criteria>
- Non-existent model pulls display error messages from Ollama instead of fake progress
- Re-evaluate button always triggers re-scoring and shows toast, regardless of whether config changed
- Both backend and frontend handle Ollama error responses correctly
- Existing progress bar and cancel functionality remain unaffected
</success_criteria>

<output>
After completion, create `.planning/phases/07-ollama-configuration-ui/07-04-SUMMARY.md`
</output>
