---
phase: 09.5-refine-main-view-ux-and-typography
plan: 04
subsystem: ui
tags: [html-react-parser, dompurify, reader, inline-reader, chakra-ui]

# Dependency graph
requires:
  - "09.5-01: ArticleListItem schema with summary_preview and score_reasoning"
  - "09.5-02: Headerless layout shell with sidebar"
provides:
  - "Inline ArticleReader component replacing drawer-based reader"
  - "ArticleContent component with html-react-parser + DOMPurify sanitization"
  - "READER_CONTENT_STYLES constant for reader typography (single source of truth)"
  - "Conditional list/reader rendering in ArticleList with scroll position preservation"
affects: [09.5-05]

# Tech tracking
tech-stack:
  added: [html-react-parser, isomorphic-dompurify]
  patterns:
    - "Inline reader replacing article list (not drawer overlay)"
    - "DOMPurify.sanitize + parse pipeline for safe HTML rendering"
    - "READER_CONTENT_STYLES exported constant for reader content CSS-in-JS"

key-files:
  created:
    - frontend/src/components/article/ArticleContent.tsx
  modified:
    - frontend/src/components/article/ArticleReader.tsx
    - frontend/src/components/article/ArticleList.tsx
    - frontend/src/theme/typography.ts
    - frontend/src/hooks/useCompletingArticles.ts

key-decisions:
  - "READER_CONTENT_STYLES as exported constant in typography.ts (defineTextStyles can't handle deeply nested selectors)"
  - "Conditional early return in ArticleList for reader view (simpler than dual JSX branches)"
  - "requestAnimationFrame for scroll restore to ensure DOM has rendered list before scrolling"

patterns-established:
  - "DOMPurify.sanitize -> parse(html, options) pipeline for RSS content rendering"
  - "Scroll position save/restore via useRef + window.scrollY for view transitions"

requirements-completed: []

# Metrics
duration: 6.9min
completed: 2026-02-22
---

# Phase 09.5 Plan 04: Inline Reader and Content Rendering Summary

**Replaced drawer-based ArticleReader with inline reader using html-react-parser + DOMPurify for sanitized content, sticky header with navigation, and scroll position preservation**

## Performance

- **Duration:** 6.9 min
- **Started:** 2026-02-22T20:31:48Z
- **Completed:** 2026-02-22T20:38:46Z
- **Tasks:** 2
- **Files modified:** 5

## Accomplishments
- Created ArticleContent component with DOMPurify sanitization and html-react-parser for safe HTML rendering with custom element replacements (lazy images, external links)
- Rewrote ArticleReader from Drawer overlay to inline component with sticky header (truncated title, open original, prev/next nav, close)
- Updated ArticleList to conditionally render list or reader, saving and restoring scroll position on transitions
- Extracted reader content styles to READER_CONTENT_STYLES constant in typography.ts as single source of truth
- Content max-width increased from 680px to 800px per CONTEXT.md decision

## Task Commits

Each task was committed atomically:

1. **Task 1: ArticleContent component with html-react-parser + DOMPurify** - `465aa22` (feat)
2. **Task 2: Rewrite ArticleReader as inline component** - `05cc2f6` (feat)

## Files Created/Modified
- `frontend/src/components/article/ArticleContent.tsx` - New component: DOMPurify + html-react-parser pipeline with img/link replacements
- `frontend/src/components/article/ArticleReader.tsx` - Complete rewrite: drawer removed, inline Box with sticky header and ArticleContent
- `frontend/src/components/article/ArticleList.tsx` - Conditional rendering (list vs reader), scroll position save/restore
- `frontend/src/theme/typography.ts` - Added READER_CONTENT_STYLES exported constant for reader content CSS
- `frontend/src/hooks/useCompletingArticles.ts` - Fixed Article-to-ArticleListItem type mismatch (pre-existing bug)

## Decisions Made
- Used READER_CONTENT_STYLES as exported constant rather than Chakra textStyle because deeply nested selectors (& pre code, & :not(pre) > code) don't work in defineTextStyles
- Conditional early return pattern in ArticleList for reader view (cleaner than wrapping both branches in ternary)
- requestAnimationFrame for scroll restore ensures the list DOM has rendered before attempting to scroll

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] Fixed Article/ArticleListItem type mismatch in useCompletingArticles**
- **Found during:** Task 1 (build verification)
- **Issue:** Pre-existing type error: `fetchArticle` returns `Article` (missing `summary_preview`) but was being set into `Map<number, ArticleListItem>` state
- **Fix:** Map Article response to ArticleListItem shape with explicit field mapping and `summary_preview: null`
- **Files modified:** `frontend/src/hooks/useCompletingArticles.ts`
- **Verification:** `bun run build` passes with no type errors
- **Committed in:** 465aa22 (Task 1 commit)

---

**Total deviations:** 1 auto-fixed (1 bug)
**Impact on plan:** Essential fix for build to pass. Pre-existing issue from Plan 01's addition of summary_preview. No scope creep.

## Issues Encountered
- Stale Next.js build lock file required removal before builds could proceed (recurring issue, not code-related)
- Parallel Plan 03 had uncommitted changes in ArticleList.tsx; coordinated by only staging files modified by this plan

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- Inline reader fully functional with sanitized content rendering
- Ready for Plan 05 (keyboard shortcuts, final polish)
- ArticleContent component available for any future content rendering needs

## Self-Check: PASSED

All 5 modified files verified on disk. Both task commits (465aa22, 05cc2f6) verified in git log.

---
*Phase: 09.5-refine-main-view-ux-and-typography*
*Completed: 2026-02-22*
