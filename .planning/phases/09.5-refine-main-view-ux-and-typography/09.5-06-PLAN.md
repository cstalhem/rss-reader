---
phase: 09.5-refine-main-view-ux-and-typography
plan: 06
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/components/layout/AppShell.tsx
  - frontend/src/components/article/ArticleList.tsx
  - frontend/src/components/article/ArticleRow.tsx
  - backend/src/backend/ollama_client.py
  - backend/src/backend/scoring.py
  - backend/src/backend/ollama_service.py
  - backend/src/backend/main.py
autonomous: false
requirements: []
gap_closure: true

must_haves:
  truths:
    - "Controls bar is always sticky (position='sticky' top={0}), not conditionally sticky"
    - "AppShell main container uses height='100vh' (not minHeight) making it the true scroll container"
    - "Inline reader opens below selected article row via Collapsible unfold pattern (not full-page replacement)"
    - "Selection choreography: scroll-to-top via scrollIntoView + scrollend event (400ms fallback), then expand"
    - "Close handler: isReaderOpen=false triggers Collapsible animation, onExitComplete clears article or chains to pending"
    - "pendingOpenRef enables switching between articles (close first, then open new)"
    - "ArticleRow uses React.forwardRef for row ref management"
    - "ArticleRow content reordered: Title > Meta/Categories > Summary"
    - "IntersectionObserver uses root: mainRef.current (scroll container, not viewport)"
    - "Escape key closes reader"
    - "Ollama AsyncClient uses lazy singleton pattern — no per-call client instantiation"
    - "Ollama client closed in lifespan shutdown"
  artifacts:
    - path: "frontend/src/components/layout/AppShell.tsx"
      provides: "Fixed-height main scroll container (height=100vh), mainRef passed to ArticleList"
      contains: "height.*100vh"
    - path: "frontend/src/components/article/ArticleList.tsx"
      provides: "Collapsible inline reader, scroll-to-top choreography, pendingOpenRef, always-sticky controls bar, row ref Map"
      contains: "Collapsible"
    - path: "frontend/src/components/article/ArticleRow.tsx"
      provides: "forwardRef wrapper, reordered content (Title > Meta > Summary)"
      contains: "forwardRef"
    - path: "backend/src/backend/ollama_client.py"
      provides: "Lazy singleton get_ollama_client(host) and close_ollama_client()"
      contains: "get_ollama_client"
    - path: "backend/src/backend/scoring.py"
      provides: "Uses singleton client instead of per-call AsyncClient"
      contains: "get_ollama_client"
    - path: "backend/src/backend/ollama_service.py"
      provides: "Uses singleton client for list_models, pull_model_stream, delete_model"
      contains: "get_ollama_client"
    - path: "backend/src/backend/main.py"
      provides: "close_ollama_client() in lifespan shutdown"
      contains: "close_ollama_client"
  key_links:
    - from: "frontend/src/components/layout/AppShell.tsx"
      to: "frontend/src/components/article/ArticleList.tsx"
      via: "mainRef prop forwarded from AppShell to ArticleList"
      pattern: "mainRef"
    - from: "frontend/src/components/article/ArticleList.tsx"
      to: "main scroll container"
      via: "IntersectionObserver root: mainRef.current"
      pattern: "root.*mainRef"
    - from: "backend/src/backend/scoring.py"
      to: "backend/src/backend/ollama_client.py"
      via: "get_ollama_client(host) import"
      pattern: "get_ollama_client"
---

<objective>
Inline unfold reader with scroll-to-top + expand animation, plus backend Ollama client FD leak fix.

Purpose: Three UAT failures (Test 7 sticky controls, Test 9 inline reader animation, Test 10 reader sticky header) share the same root cause: `<main>` uses `minHeight="100vh"` which allows infinite growth, so sticky positioning fails. The fix changes to `height="100vh"` and restructures ArticleList to use a Collapsible inline expansion pattern instead of full-page replacement. Additionally, an unrelated backend issue was fixed: the Ollama AsyncClient was being instantiated per-call, leaking file descriptors.

Output: AppShell with fixed scroll container, always-sticky controls bar, Collapsible unfold inline reader with scroll-to-top choreography, ArticleRow with forwardRef and reordered content, and a singleton Ollama client with proper lifecycle management.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09.5-refine-main-view-ux-and-typography/09.5-CONTEXT.md
@frontend/src/components/layout/AppShell.tsx
@frontend/src/components/article/ArticleList.tsx
@frontend/src/components/article/ArticleRow.tsx
@backend/src/backend/ollama_client.py
@backend/src/backend/scoring.py
@backend/src/backend/ollama_service.py
@backend/src/backend/main.py
</context>

<tasks>

<task type="manual">
  <name>Part 1: Backend — Ollama AsyncClient FD Leak Fix</name>
  <files>
    backend/src/backend/ollama_client.py
    backend/src/backend/scoring.py
    backend/src/backend/ollama_service.py
    backend/src/backend/main.py
  </files>
  <action>
**Problem:** Each call to scoring or model management created a new `AsyncClient(host=host, timeout=timeout)`, leaking file descriptors since the client was never explicitly closed.

**Fix:**

1. Created `backend/src/backend/ollama_client.py` — lazy singleton module:
   - `get_ollama_client(host)` returns a cached `AsyncClient`, creating it on first call
   - `close_ollama_client()` closes the cached client and resets the singleton

2. Updated `scoring.py`:
   - Replaced `AsyncClient(host=host, timeout=timeout)` with `get_ollama_client(host)`
   - Removed local timeout variable (singleton handles its own config)

3. Updated `ollama_service.py`:
   - Same singleton pattern for `list_models`, `pull_model_stream`, `delete_model`

4. Updated `main.py`:
   - Added `close_ollama_client()` call in lifespan shutdown to clean up the singleton on app exit
  </action>
  <verify>
`cd /Users/cstalhem/projects/rss-reader/backend && uv run ruff check .` — zero new errors.
`cd /Users/cstalhem/projects/rss-reader/backend && uv run pytest` — 31 pass, 6 pre-existing failures unchanged.
  </verify>
  <done>
Ollama AsyncClient uses lazy singleton pattern. No per-call instantiation. Client properly closed on app shutdown via lifespan hook.
  </done>
</task>

<task type="manual">
  <name>Part 2A: AppShell scroll container fix and mainRef</name>
  <files>
    frontend/src/components/layout/AppShell.tsx
  </files>
  <action>
**Fix in AppShell.tsx:**

- Changed `<main>` from `minHeight="100vh"` to `height="100vh"`, making it the true scroll container
- Added `mainRef = useRef<HTMLDivElement>(null)` and attached to the main element
- Passed `mainRef` to `ArticleList` as a new prop

This single change resolves the root cause of Tests 7, 9, and 10: sticky positioning now works because `<main>` is a fixed-height scroll container.
  </action>
  <verify>
`cd /Users/cstalhem/projects/rss-reader/frontend && bun run build` — no TypeScript errors.
  </verify>
  <done>
`<main>` is fixed-height (100vh) and scrolls internally. mainRef forwarded to ArticleList.
  </done>
</task>

<task type="manual">
  <name>Part 2B: ArticleRow forwardRef and content reorder</name>
  <files>
    frontend/src/components/article/ArticleRow.tsx
  </files>
  <action>
**Changes to ArticleRow.tsx:**

1. Wrapped component with `React.forwardRef` to enable parent ref management for scroll-to-row behavior
2. Reordered content within each row: Title > Meta/Categories > Summary (was Title > Summary > Meta)

The forwardRef is needed by ArticleList's row ref Map (`useRef<Map<number, HTMLElement>>()`) for scrollIntoView targeting during the unfold choreography.
  </action>
  <verify>
`cd /Users/cstalhem/projects/rss-reader/frontend && bun run build` — no TypeScript errors.
  </verify>
  <done>
ArticleRow wrapped with forwardRef. Content reordered to Title > Meta/Categories > Summary.
  </done>
</task>

<task type="manual">
  <name>Part 2C: ArticleList — Collapsible inline reader with scroll-to-top choreography</name>
  <files>
    frontend/src/components/article/ArticleList.tsx
  </files>
  <action>
**Major rework of ArticleList.tsx:**

1. **Accepts `mainRef` prop** from AppShell for scroll container targeting.

2. **Removed early-return reader pattern** — the old approach replaced the entire article list with `<ArticleReader>` when an article was selected. Now the list is always rendered.

3. **Added Collapsible inline expansion** — the reader opens below the selected article row using Chakra `Collapsible.Root` + `Collapsible.Content`. This gives the accordion-style unfold animation.

4. **Selection choreography:**
   - On article select: scroll the selected row to the top of the scroll container via `scrollIntoView({ block: "start", behavior: "smooth" })`
   - Wait for scroll to complete via `scrollend` event listener (with 400ms fallback timeout for browsers that don't fire it reliably)
   - Then expand the Collapsible to reveal the reader

5. **Close handler:**
   - `isReaderOpen = false` triggers the Collapsible close animation
   - `onExitComplete` callback either clears the selected article or chains to a pending article (for article-to-article navigation)

6. **`pendingOpenRef`** — enables switching between articles without jarring jumps: close current reader first, then open new one on exit complete.

7. **Row ref management** — `useRef<Map<number, HTMLElement>>()` stores refs to each ArticleRow (via forwardRef) for scroll targeting.

8. **Controls bar always sticky** — `position="sticky"` unconditionally (removed the `isScrolled` ternary).

9. **IntersectionObserver** — uses `root: mainRef.current` instead of viewport (`root: null`).

10. **Escape key** closes the reader.
  </action>
  <verify>
`cd /Users/cstalhem/projects/rss-reader/frontend && bun run build` — zero TypeScript errors.
`cd /Users/cstalhem/projects/rss-reader/frontend && bun run lint` — zero ESLint errors on changed files.
  </verify>
  <done>
ArticleList uses Collapsible inline reader with scroll-to-top choreography, pendingOpenRef for article switching, always-sticky controls bar, and mainRef-based IntersectionObserver. Early-return reader pattern removed entirely.
  </done>
</task>

</tasks>

<verification>
1. `cd /Users/cstalhem/projects/rss-reader/frontend && bun run build` — zero TypeScript errors
2. `cd /Users/cstalhem/projects/rss-reader/frontend && bun run lint` — zero ESLint errors on changed files
3. `cd /Users/cstalhem/projects/rss-reader/backend && uv run ruff check .` — zero new errors
4. `cd /Users/cstalhem/projects/rss-reader/backend && uv run pytest` — 31 pass, 6 pre-existing failures unchanged
</verification>

<success_criteria>
- `<main>` uses `height="100vh"` (not minHeight), making it the true scroll container
- Controls bar is always sticky (position: sticky, not conditional)
- Inline reader opens via Collapsible below the selected row (not full-page replacement)
- Scroll-to-top choreography: scrollIntoView + scrollend event + 400ms fallback
- pendingOpenRef enables close-then-open for article switching
- ArticleRow uses forwardRef for row ref Map
- ArticleRow content order: Title > Meta/Categories > Summary
- IntersectionObserver uses root: mainRef.current
- Escape key closes reader
- Ollama AsyncClient singleton — no per-call instantiation, closed on shutdown
</success_criteria>

<output>
After completion, create `/Users/cstalhem/projects/rss-reader/.planning/phases/09.5-refine-main-view-ux-and-typography/09.5-06-SUMMARY.md`
</output>
