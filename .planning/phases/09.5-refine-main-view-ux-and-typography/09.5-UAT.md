---
status: diagnosed
phase: 09.5-refine-main-view-ux-and-typography
source: [09.5-01-SUMMARY.md, 09.5-02-SUMMARY.md, 09.5-03-SUMMARY.md, 09.5-04-SUMMARY.md]
started: 2026-02-22T21:00:00Z
updated: 2026-02-22T21:30:00Z
---

## Current Test

[testing complete]

## Tests

### 1. Sidebar Layout
expected: Sidebar spans full viewport height from top. Three zones: logo/brand at top, scrollable feed list in middle, settings icon (with dot badge) + theme toggle + collapse button pinned at bottom. No header bar.
result: issue
reported: "The button and text for the theme switcher is not aligned with the other icons and texts on the sidebar. All other items are pass."
severity: cosmetic

### 2. Sidebar Collapsed State
expected: Clicking the collapse button shrinks sidebar to icon-only width. RSS icon for logo, each feed shows a circle with the first letter of feed name, settings/theme/expand icons at bottom. Expanding restores full sidebar.
result: pass

### 3. Article Row Summary Preview
expected: Each article row shows a 1-2 line preview below the title. If the article has been scored, it shows score_reasoning with a sparkle icon prefix. Otherwise shows a text-only RSS summary. Text is truncated at 2 lines.
result: pass
note: "User suggests reordering row layout to Header > Metadata > Summary/reasoning"

### 4. Article Row Read/Unread Styling
expected: Unread articles have semibold title, subtle background tint, and a filled accent dot (clickable to toggle). Read articles have normal weight title, no background, and no dot at all (no empty space where dot would be). No opacity difference between read/unread.
result: pass

### 5. Article Row Context Menu
expected: Hovering over a read article reveals a three-dot menu icon on the far right. Clicking it shows a menu with "Mark unread", "Open original", and "Rescore" options. Mark unread toggles article back to unread state. Open original opens article URL in new tab.
result: issue
reported: "The context menu should be visible on hover on all articles. For unread articles, the 'Mark unread' option should say 'Mark read' instead"
severity: minor

### 6. Filter Dropdown
expected: Filter is a dropdown/select (not individual buttons) with options: Unread, All, Scoring, Blocked — each showing a count. Disabled options when count is 0. Selecting a filter updates the article list.
result: pass
note: "User notes: 'All' should be at bottom and not show total count. When 'All' is selected, the Unread count disappears from dropdown."

### 7. Feed Heading + Sticky Toolbar
expected: "Articles" heading shown at top when viewing All Articles, specific feed name when a feed is selected. Scrolling down causes the heading to scroll out and the controls bar becomes sticky at the top with the feed name shown inline (smaller text) alongside the filter and mark-all-read.
result: issue
reported: "The header does not stick. I want the Feed name to animate down to the smaller size/up to the larger one when I scroll."
severity: major

### 8. Mark All Read
expected: Mark-all-read icon (double checkmark) is always visible in the toolbar. For a specific feed: marks that feed's articles as read. For All Articles view: shows a confirmation dialog before marking all unread articles across all feeds as read.
result: issue
reported: "The cancel button on the confirmation dialogue should be next to the confirm button."
severity: cosmetic

### 9. Inline Reader
expected: Clicking an article replaces the article list with an inline reader view (not a drawer overlay). The sidebar remains visible. The reader fills the content area with a sticky header bar at the top.
result: issue
reported: "Clicking on an article should animate the inline reader view open like an accordion component. At the moment it simply takes over and fills the entire content area."
severity: minor

### 10. Reader Sticky Header
expected: Reader has a sticky header showing truncated article title on the left, and on the right: open-original icon, up/down navigation arrows (disabled when at first/last article), and close X button.
result: issue
reported: "Fail, the header is not sticky."
severity: major

### 11. Reader Keyboard Shortcuts
expected: With an article open: pressing Escape closes the reader (returns to list). Pressing J navigates to the next article. Pressing K navigates to the previous article. Shortcuts don't fire when typing in an input field.
result: pass

### 12. Reader Content + Typography
expected: Article content is rendered safely (no raw HTML visible). Images are responsive and lazy-loaded, links open in new tab. Content area max-width is ~800px. A "Read on [feed name]" link appears at the bottom of the content.
result: issue
reported: "Console error: 'In HTML, <a> cannot be a descendant of <a>'. ArticleContent wraps images in <a> links but some source HTML already has images inside <a> tags, creating invalid nested anchors."
severity: major

### 13. Scroll Position Restore
expected: Scroll partway down the article list, open an article (reader shows). Close the reader — the article list returns to the same scroll position you were at before opening.
result: pass

### 14. Mobile Layout
expected: At narrow viewport width, a hamburger icon appears in the content area. Tapping it opens the mobile sidebar drawer with logo heading, feed list, settings link, and theme toggle.
result: pass

## Summary

total: 14
passed: 7
issues: 8 (3 resolved by 09.5-06, 5 remaining)
pending: 0
skipped: 0

## Gaps

- truth: "Theme toggle button and text aligned with other sidebar icons and texts"
  status: failed
  reason: "User reported: The button and text for the theme switcher is not aligned with the other icons and texts on the sidebar."
  severity: cosmetic
  test: 1
  artifacts:
    - file: frontend/src/components/layout/Sidebar.tsx
      lines: "346-358"
      issue: >
        The ThemeToggle wrapper Flex uses py={0} while the Settings link above uses py={1.5}.
        More importantly, ThemeToggle renders an IconButton (which has built-in padding) inside
        a Flex, so the icon itself sits differently than the LuSettings icon which is rendered
        as a raw SVG inside its own Flex with px/py controlled manually. The ThemeToggle
        IconButton adds its own internal vertical padding (size="sm" = ~8px), making the
        toggle sit higher/differently than the bare icon above it. Additionally, when expanded,
        the "Theme" Text sits at icon baseline while the Settings "text sits at Flex center
        because the Settings Flex wraps both icon and text with alignItems="center" and explicit
        gap={3} and py={1.5}, while the Theme row's Flex also has gap={3} but py={0}.
    - file: frontend/src/components/ui/color-mode.tsx
      lines: "51-76"
      issue: >
        ThemeToggle renders as an IconButton with built-in size="sm" padding. This adds
        ~4px top/bottom internal padding that raw icon elements don't have, causing the
        icon to sit at a different vertical position than the bare LuSettings SVG above it.
  missing:
    - "Replace ThemeToggle Flex wrapper approach: render the theme icon and text using the
       same pattern as Settings (a plain Flex with alignItems='center', gap={3}, px, py={1.5},
       borderRadius='md', _hover) but with onClick={toggleColorMode} and the ColorModeIcon
       as a raw icon, matching the Settings row structure exactly."

- truth: "Context menu visible on hover for all articles, with read/unread-appropriate label"
  status: failed
  reason: "User reported: The context menu should be visible on hover on all articles. For unread articles, the 'Mark unread' option should say 'Mark read' instead"
  severity: minor
  test: 5
  artifacts:
    - file: frontend/src/components/article/ArticleRow.tsx
      lines: "204-210"
      issue: >
        Line 204: `{isHovered && article.is_read && onRescore && (` — the guard
        `article.is_read` prevents the context menu from appearing on unread articles.
        Removing `article.is_read` from the condition would show the menu on all articles
        on hover.
    - file: frontend/src/components/article/ArticleRowContextMenu.tsx
      lines: "38-41"
      issue: >
        The menu item is hardcoded as "Mark unread" with icon LuMailOpen. It doesn't
        check whether the article is read or unread. For unread articles the label
        should be "Mark read" and ideally use a different icon (e.g. LuMailCheck).
        The prop is named `onMarkUnread` which is also misleading for the toggle case.
  missing:
    - "In ArticleRow.tsx line 204: remove `article.is_read &&` from the render condition."
    - "Pass article.is_read as a prop to ArticleRowContextMenu so it can show the
       correct label ('Mark read' vs 'Mark unread') and icon."
    - "In ArticleRowContextMenu.tsx: rename prop to onToggleRead, accept isRead boolean,
       conditionally render label and icon based on isRead."

- truth: "Filter dropdown shows correct counts for all options regardless of active selection"
  status: failed
  reason: "User reported: 'All' should be at bottom and not show total count. When 'All' is selected, the Unread count disappears from dropdown."
  severity: minor
  test: 6
  artifacts:
    - file: frontend/src/components/article/ArticleList.tsx
      lines: "176-189"
      issue: >
        The filterCollection is built with two problems:
        1. Order: "All" is second in the items array; user wants it last (after Blocked).
        2. Count logic: `unreadCount = filter === 'unread' ? articleCount : undefined` —
           the unread count is only shown when the filter IS 'unread'. When filter='all',
           unreadCount is undefined so Unread shows no count. The counts should come from
           stable sources (feed sidebar aggregate unread / scoringStatus counts), not from
           the currently-loaded article list which is filter-dependent.
        3. "All" showing total count: `allCount = filter === 'all' ? articleCount : undefined`
           — user wants "All" to never show a count.
  missing:
    - "Reorder items array: [Unread, Scoring, Blocked, All]."
    - "Source unread count from feeds aggregate (totalUnread is already computed in Sidebar;
       expose it or re-derive from useFeeds in ArticleList) rather than from articleCount."
    - "Remove allCount from the 'All' label — always render it as just 'All' with no count."
    - "Scoring and Blocked counts already use scoringStatus which is stable — no change needed
       for those two."

- truth: "Controls bar becomes sticky on scroll with animated feed name size transition"
  status: resolved
  resolved: true
  resolved_by: "09.5-06"
  reason: "User reported: The header does not stick. I want the Feed name to animate down to the smaller size/up to the larger one when I scroll."
  resolution: >
    Fixed by Plan 06. Root cause was `minHeight="100vh"` on `<main>` in AppShell.tsx — changed
    to `height="100vh"` making it the true scroll container. Controls bar is now always sticky
    (`position="sticky" top={0}`, no conditional). IntersectionObserver updated to use
    `root: mainRef.current` (scroll container, not viewport).
  severity: major
  test: 7

- truth: "Confirmation dialog cancel button positioned next to confirm button"
  status: failed
  reason: "User reported: The cancel button on the confirmation dialogue should be next to the confirm button."
  severity: cosmetic
  test: 8
  artifacts:
    - file: frontend/src/components/ui/confirm-dialog.tsx
      lines: "33-40"
      issue: >
        Dialog.Footer renders: Dialog.CloseTrigger (Cancel) first, then Button (Confirm).
        Chakra UI Dialog.Footer uses `display: flex; justify-content: flex-end` by default,
        which places both buttons on the right — but the CloseTrigger wraps the Cancel button
        in an extra element, which may cause spacing or ordering to differ from expected.
        The user expects both buttons to be visually adjacent (side by side). Likely the
        Dialog.CloseTrigger wrapper is adding a block-level element or gap that separates
        them. The fix is to ensure both buttons are direct siblings inside Dialog.Footer
        with consistent gap.
  missing:
    - "Inspect Dialog.Footer default styles. If Dialog.CloseTrigger renders as block or adds
       unwanted margin, wrap the Cancel button differently. Most likely solution: add explicit
       gap to Dialog.Footer (e.g., gap={3}) or use a Flex wrapper inside Footer with gap."
    - "Alternatively, render Cancel as a plain Button with onClick={() => onOpenChange({open:false})}
       as a direct sibling to the Confirm button, removing Dialog.CloseTrigger to avoid its
       wrapper element interfering with layout."

- truth: "Inline reader opens with accordion-style animation transition"
  status: resolved
  resolved: true
  resolved_by: "09.5-06"
  reason: "User reported: Clicking on an article should animate the inline reader view open like an accordion component. At the moment it simply takes over and fills the entire content area."
  resolution: >
    Fixed by Plan 06. Removed the early-return reader pattern (full-page replacement) and
    replaced with Collapsible inline expansion below the selected article row. Selection
    choreography: scroll row to top via scrollIntoView + scrollend event (400ms fallback),
    then expand Collapsible. Close uses onExitComplete to chain animations. pendingOpenRef
    enables seamless article-to-article switching.
  severity: minor
  test: 9

- truth: "Reader header bar is sticky at top of content area while scrolling"
  status: resolved
  resolved: true
  resolved_by: "09.5-06"
  reason: "User reported: Fail, the header is not sticky."
  resolution: >
    Fixed by Plan 06. Same root cause as Test 7: `minHeight="100vh"` on `<main>` prevented
    it from being the true scroll container. Changed to `height="100vh"` with `overflowY="auto"`,
    making `<main>` the definitive scroll ancestor. The reader header's existing
    `position="sticky" top={0}` now works correctly relative to the `<main>` scroll container.
  severity: major
  test: 10

- truth: "Article content renders without nested <a> tag errors"
  status: failed
  reason: "User reported: Console error 'In HTML, <a> cannot be a descendant of <a>'. ArticleContent wraps images in <a> links but source HTML already has images inside <a> tags, creating invalid nested anchors."
  severity: major
  test: 12
  artifacts:
    - file: frontend/src/components/article/ArticleContent.tsx
      lines: "20-38"
      issue: >
        The `img` replace handler wraps every image in `<a href={src}>`. The `a` replace
        handler (lines 41-50) recursively processes children via `domToReact(..., parserOptions)`.
        When the source HTML contains `<a><img/></a>`, the parser encounters the `<a>` node
        first, calls the `a` handler, which calls `domToReact` on its children, which
        encounters the `<img>` node and wraps it in another `<a>`. The result is
        `<a><a><img/></a></a>` — a nested anchor, which is invalid HTML and causes the
        React console warning. The `img` handler has no awareness that it may already be
        inside an anchor element.
  missing:
    - "In the `img` replace handler, check whether the img's parent node is already an
       anchor element. If `domNode.parent` is an Element with name === 'a', skip the `<a>`
       wrapper and return just the `<img>` element (no wrapping anchor)."
    - "Concretely: add `if (domNode.parent instanceof Element && domNode.parent.name === 'a')`
       at the top of the img branch and return the bare img without the anchor wrapper."

## Additional Fixes (non-UAT)

- fix: "Backend Ollama AsyncClient FD leak"
  resolved_by: "09.5-06"
  description: >
    Per-call `AsyncClient(host=host, timeout=timeout)` in scoring.py and ollama_service.py
    was never closed, leaking file descriptors. Fixed by creating a lazy singleton module
    (`backend/src/backend/ollama_client.py`) with `get_ollama_client(host)` and
    `close_ollama_client()`. Shutdown cleanup added to FastAPI lifespan in main.py.
