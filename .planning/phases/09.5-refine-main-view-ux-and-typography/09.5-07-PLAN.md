---
phase: 09.5-refine-main-view-ux-and-typography
plan: 07
type: execute
wave: 2
depends_on: ["09.5-06"]
files_modified:
  - frontend/src/components/layout/Sidebar.tsx
  - frontend/src/components/article/ArticleRow.tsx
  - frontend/src/components/article/ArticleRowContextMenu.tsx
  - frontend/src/components/article/ArticleList.tsx
  - frontend/src/components/ui/confirm-dialog.tsx
  - frontend/src/components/article/ArticleContent.tsx
autonomous: true
requirements: []
gap_closure: true

must_haves:
  truths:
    - "Theme toggle icon and text aligned with Settings icon and text in sidebar"
    - "Context menu appears on hover for all articles (read and unread)"
    - "Context menu label says 'Mark read' for unread articles and 'Mark unread' for read articles"
    - "Filter dropdown order is: Unread, Scoring, Blocked, All"
    - "Unread count in filter dropdown is always visible regardless of active filter"
    - "'All' option never shows a count"
    - "Confirm dialog Cancel button is adjacent to Confirm button (side by side)"
    - "No nested <a> HTML errors in ArticleContent when source contains image-inside-anchor"
  artifacts:
    - path: "frontend/src/components/layout/Sidebar.tsx"
      provides: "Theme toggle rendered as plain Flex row matching Settings row structure"
      contains: "toggleColorMode"
    - path: "frontend/src/components/article/ArticleRowContextMenu.tsx"
      provides: "Toggle-aware context menu with isRead prop"
      contains: "isRead"
    - path: "frontend/src/components/article/ArticleList.tsx"
      provides: "Filter collection with stable unread count from feeds data"
      contains: "Unread.*Scoring.*Blocked.*All"
    - path: "frontend/src/components/ui/confirm-dialog.tsx"
      provides: "Footer with buttons side-by-side via gap"
      contains: "gap"
    - path: "frontend/src/components/article/ArticleContent.tsx"
      provides: "img handler checks for parent anchor before wrapping"
      contains: "domNode.parent"
  key_links:
    - from: "frontend/src/components/article/ArticleRow.tsx"
      to: "frontend/src/components/article/ArticleRowContextMenu.tsx"
      via: "isRead prop passed from ArticleListItem.is_read"
      pattern: "isRead.*article.is_read"
---

<objective>
Fix five independent cosmetic and minor UAT gaps in a single plan.

Purpose: These fixes are unrelated to each other and to Plan 06's scroll container work. Grouping them avoids five tiny one-task plans. Each fix is self-contained, targets a single file (or pair), and is straightforward. Plans 06 and 07 can execute in parallel (Wave 1) since they touch different files.

Output: Corrected sidebar theme toggle alignment, context menu visible on all articles with correct label, fixed filter order and stable counts, confirm dialog buttons side by side, and no nested anchor HTML error.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/09.5-refine-main-view-ux-and-typography/09.5-CONTEXT.md
@frontend/src/components/layout/Sidebar.tsx
@frontend/src/components/article/ArticleRow.tsx
@frontend/src/components/article/ArticleRowContextMenu.tsx
@frontend/src/components/article/ArticleList.tsx
@frontend/src/components/ui/confirm-dialog.tsx
@frontend/src/components/article/ArticleContent.tsx
@frontend/src/components/ui/color-mode.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Sidebar theme toggle alignment, context menu fix, filter order and counts, confirm dialog layout</name>
  <files>
    frontend/src/components/layout/Sidebar.tsx
    frontend/src/components/article/ArticleRow.tsx
    frontend/src/components/article/ArticleRowContextMenu.tsx
    frontend/src/components/article/ArticleList.tsx
    frontend/src/components/ui/confirm-dialog.tsx
  </files>
  <action>
**1. Sidebar theme toggle alignment (Sidebar.tsx lines 346-358)**

The current `ThemeToggle` renders an `IconButton` inside a `Flex`. The `IconButton` has its own internal padding (`size="sm"` = ~8px vertical), causing the icon to sit differently from the bare `LuSettings` SVG above it.

Replace the `<ThemeToggle>` wrapper approach with the same pattern used by the Settings link: a plain `Flex` row with `onClick={toggleColorMode}` and a raw `ColorModeIcon` icon, using `ClientOnly` + `Skeleton` fallback for SSR safety.

Import `useColorMode` and `ColorModeIcon` from `@/components/ui/color-mode` (already exported there). Import `ClientOnly` and `Skeleton` from `@chakra-ui/react`.

Replace the Theme toggle section:
```tsx
{/* Theme toggle */}
<ClientOnly fallback={<Skeleton h="8" borderRadius="md" />}>
  <Flex
    as="button"
    alignItems="center"
    justifyContent={isCollapsed ? "center" : "flex-start"}
    gap={3}
    px={isCollapsed ? 0 : 2}
    py={1.5}
    borderRadius="md"
    color="fg.muted"
    _hover={{ bg: "bg.subtle", color: "fg" }}
    cursor="pointer"
    w="full"
    onClick={toggleColorMode}
    aria-label="Toggle color mode"
  >
    <ColorModeIcon />
    {!isCollapsed && (
      <Text fontSize="sm" color="fg.muted">
        Theme
      </Text>
    )}
  </Flex>
</ClientOnly>
```

Add `const { toggleColorMode } = useColorMode();` near the top of the `Sidebar` component (alongside the existing hook calls). Import `useColorMode, ColorModeIcon` from `@/components/ui/color-mode`.

Remove the `ThemeToggle` import from Sidebar.tsx since it is no longer used.

**2. Context menu on all articles with correct toggle label (ArticleRow.tsx + ArticleRowContextMenu.tsx)**

In `ArticleRow.tsx` line 204, remove `article.is_read &&` from the render condition so the menu shows on all hovered articles:
```tsx
// was:
{isHovered && article.is_read && onRescore && (
// fix:
{isHovered && onRescore && (
```

Pass `isRead={article.is_read}` to `ArticleRowContextMenu`. Update the `onMarkUnread` prop to a more accurate name `onToggleRead`:
```tsx
<ArticleRowContextMenu
  article={article}
  isRead={article.is_read}
  onToggleRead={() => onToggleRead(article)}
  onRescore={() => onRescore(article)}
/>
```

In `ArticleRowContextMenu.tsx`, update the interface and conditionally render the label and icon:
```tsx
import { LuMailOpen, LuMailCheck, LuExternalLink, LuRefreshCw } from "react-icons/lu";

interface ArticleRowContextMenuProps {
  article: ArticleListItem;
  isRead: boolean;
  onToggleRead: () => void;
  onRescore: () => void;
}

// In the menu item:
<Menu.Item value="toggle-read" onClick={onToggleRead}>
  {isRead ? <LuMailOpen /> : <LuMailCheck />}
  {isRead ? "Mark unread" : "Mark read"}
</Menu.Item>
```

**3. Filter dropdown order and stable counts (ArticleList.tsx lines 177-189)**

Three changes to the `filterCollection` useMemo:
- Reorder items: `[Unread, Scoring, Blocked, All]`
- Source unread count from the feeds data (stable, not filter-dependent): use `useFeeds` which is already imported. Compute `totalUnread` from feeds: `feeds?.reduce((sum, f) => sum + f.unread_count, 0) ?? 0`. If the Feed type doesn't include `unread_count`, check `lib/types.ts` — if it doesn't exist, use `articleCount` only when filter is 'unread' as current (note: a fallback, the primary fix is the order and removing allCount).
- Remove `allCount` — "All" label is always just "All" with no count.

```tsx
const totalUnreadFromFeeds = useMemo(
  () => feeds?.reduce((sum, f) => sum + (f.unread_count ?? 0), 0) ?? 0,
  [feeds]
);

const filterCollection = useMemo(() => {
  const unreadDisplay = totalUnreadFromFeeds > 0 ? ` (${totalUnreadFromFeeds})` : "";
  return createListCollection({
    items: [
      { label: `Unread${unreadDisplay}`, value: "unread" },
      { label: `Scoring${scoringCount > 0 ? ` (${scoringCount})` : ""}`, value: "scoring", disabled: scoringCount === 0 },
      { label: `Blocked${blockedCount > 0 ? ` (${blockedCount})` : ""}`, value: "blocked", disabled: blockedCount === 0 },
      { label: "All", value: "all" },
    ],
  });
}, [totalUnreadFromFeeds, scoringCount, blockedCount]);
```

Check `lib/types.ts` for the `Feed` type to confirm the field name for unread count. If the feed type uses a different field name (e.g., `unread_articles_count`), use that.

**4. Confirm dialog buttons side by side (confirm-dialog.tsx lines 33-40)**

The `Dialog.CloseTrigger` wraps Cancel in an extra element that can break flex sibling layout. Replace it with a plain `Button` with an explicit close handler, adding `gap={3}` to `Dialog.Footer`:

```tsx
<Dialog.Footer gap={3}>
  <Button variant="ghost" onClick={() => onOpenChange({ open: false })}>
    Cancel
  </Button>
  <Button colorPalette={confirmColorPalette} onClick={onConfirm}>
    {confirmLabel}
  </Button>
</Dialog.Footer>
```

Remove `Dialog.CloseTrigger` from the import if it's no longer used elsewhere in the file.
  </action>
  <verify>
`cd /Users/cstalhem/projects/rss-reader/frontend && bun run build` — no TypeScript or build errors. Dev server:
- Sidebar: theme icon row visually aligned with settings icon row (same height, same text baseline).
- Article list: hover any article (read or unread) — three-dot menu appears. Menu shows "Mark read" for unread, "Mark unread" for read.
- Filter dropdown: order is Unread, Scoring, Blocked, All. "All" shows no count. Switching to "All" filter keeps the Unread count visible.
- Mark all read on All Articles view: dialog has Cancel and Confirm buttons side by side.
  </verify>
  <done>
Theme toggle row matches Settings row layout pixel-for-pixel. Context menu appears on hover for all articles with correct toggle label. Filter dropdown order is Unread, Scoring, Blocked, All. "All" has no count. Unread count sourced from feeds data (stable across filter changes). Cancel/Confirm buttons are direct flex siblings with gap.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix nested anchor error in ArticleContent</name>
  <files>
    frontend/src/components/article/ArticleContent.tsx
  </files>
  <action>
**Problem:** When source HTML contains `<a><img/></a>`, the `img` replace handler wraps the image in another `<a href={src}>`, producing `<a><a><img/></a></a>` — invalid HTML causing a React console warning.

**Fix:** In the `img` branch of `parserOptions.replace`, check whether the image's parent node is already an anchor element. If so, skip the `<a>` wrapper and return just the `<img>`:

```tsx
if (domNode.name === "img") {
  const src = domNode.attribs.src;
  const alt = domNode.attribs.alt || "";

  // If already inside an anchor, don't wrap again (avoids nested <a> error)
  const isInsideAnchor =
    domNode.parent instanceof Element && domNode.parent.name === "a";

  const imgEl = (
    <img
      src={src}
      alt={alt}
      loading="lazy"
      style={{
        maxWidth: "100%",
        height: "auto",
        borderRadius: "8px",
        marginTop: "1rem",
        marginBottom: "1rem",
      }}
    />
  );

  if (isInsideAnchor) {
    return imgEl;
  }

  return (
    <a href={src} target="_blank" rel="noopener noreferrer">
      {imgEl}
    </a>
  );
}
```

`Element` is already imported from `html-react-parser`. No new imports needed.
  </action>
  <verify>
`cd /Users/cstalhem/projects/rss-reader/frontend && bun run build` — no errors. Dev server: open an article that contains images. Browser console shows no "In HTML, &lt;a&gt; cannot be a descendant of &lt;a&gt;" warning. Images still render with lazy loading and rounded corners.
  </verify>
  <done>
`img` replace handler checks `domNode.parent instanceof Element && domNode.parent.name === 'a'` before wrapping. Images already inside anchors render without the extra `<a>` wrapper. No nested anchor HTML errors in console.
  </done>
</task>

</tasks>

<verification>
1. `cd /Users/cstalhem/projects/rss-reader/frontend && bun run build` — zero errors
2. `cd /Users/cstalhem/projects/rss-reader/frontend && bun run lint` — zero errors
3. Dev server: sidebar theme icon aligned with settings icon
4. Dev server: context menu on all hovered articles, correct read/unread label
5. Dev server: filter order Unread, Scoring, Blocked, All; "All" no count; Unread count stable across filters
6. Dev server: confirm dialog Cancel+Confirm side by side
7. Dev server: no nested anchor console errors when viewing articles with images
</verification>

<success_criteria>
- Theme toggle in sidebar matches Settings row visual structure exactly (same padding, same icon size, same text alignment)
- Context menu appears on hover for unread articles (was only read articles)
- Menu label is "Mark read" (LuMailCheck) for unread, "Mark unread" (LuMailOpen) for read
- Filter order: Unread first, All last
- Unread count shown regardless of active filter tab
- "All" option has no count suffix
- Confirm dialog footer buttons are side-by-side flex siblings
- No nested `<a>` HTML errors from ArticleContent
</success_criteria>

<output>
After completion, create `/Users/cstalhem/projects/rss-reader/.planning/phases/09.5-refine-main-view-ux-and-typography/09.5-07-SUMMARY.md`
</output>
