---
phase: 09.5-refine-main-view-ux-and-typography
plan: 06
subsystem: ui, api
tags: [collapsible, scroll-choreography, sticky, ollama, singleton, forwardRef]

# Dependency graph
requires:
  - "09.5-04: Inline ArticleReader component and ArticleContent"
  - "09.5-05: Keyboard shortcuts and reader refinements"
provides:
  - "Fixed scroll container (height=100vh) in AppShell making sticky positioning reliable"
  - "Collapsible inline unfold reader pattern replacing full-page reader replacement"
  - "Scroll-to-top choreography (scrollIntoView + scrollend + fallback)"
  - "pendingOpenRef for close-then-open article switching"
  - "ArticleRow forwardRef for parent ref management"
  - "Ollama AsyncClient lazy singleton with proper lifecycle"
affects: [09.5-07]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Collapsible inline expansion below selected row (unfold pattern)"
    - "Scroll-to-top choreography: scrollIntoView + scrollend event + 400ms fallback"
    - "pendingOpenRef for close-then-open article navigation"
    - "Lazy singleton AsyncClient with lifespan shutdown cleanup"
    - "Row ref Map via useRef<Map<number, HTMLElement>> + forwardRef"

key-files:
  created:
    - backend/src/backend/ollama_client.py
  modified:
    - frontend/src/components/layout/AppShell.tsx
    - frontend/src/components/article/ArticleList.tsx
    - frontend/src/components/article/ArticleRow.tsx
    - backend/src/backend/scoring.py
    - backend/src/backend/ollama_service.py
    - backend/src/backend/main.py

key-decisions:
  - "height=100vh instead of minHeight=100vh to make <main> the true scroll container (root cause of Tests 7, 9, 10)"
  - "Collapsible unfold pattern instead of basic accordion — scroll row to top first, then expand reader below"
  - "scrollend event with 400ms fallback timeout for cross-browser scroll completion detection"
  - "onExitComplete callback for close sequencing — clears article or chains to pendingOpenRef"
  - "Lazy singleton Ollama client instead of per-call instantiation to prevent FD leaks"

patterns-established:
  - "Scroll-to-top + expand choreography: scrollIntoView -> scrollend/timeout -> setIsReaderOpen(true)"
  - "pendingOpenRef for seamless article-to-article switching (close -> onExitComplete -> open next)"
  - "Row ref Map pattern: useRef<Map<number, HTMLElement>> populated via forwardRef callbacks"
  - "Lazy singleton with get/close lifecycle for long-lived async clients"

requirements-completed: []

# Metrics
duration: manual
completed: 2026-02-22
---

# Phase 09.5 Plan 06: Inline Unfold Reader and Ollama Client Fix Summary

**Fixed scroll container root cause (height=100vh), replaced full-page reader with Collapsible unfold pattern with scroll-to-top choreography, added ArticleRow forwardRef and content reorder, and fixed backend Ollama AsyncClient FD leak via lazy singleton**

## Performance

- **Duration:** Manual execution (not executor agent)
- **Completed:** 2026-02-22
- **Tasks:** 4 (1 backend, 3 frontend)
- **Files created:** 1
- **Files modified:** 6

## Accomplishments
- Fixed root cause of three UAT failures (Tests 7, 9, 10): changed AppShell `<main>` from `minHeight="100vh"` to `height="100vh"`, establishing it as the true scroll container
- Replaced full-page reader replacement with Collapsible inline expansion below the selected article row
- Implemented scroll-to-top choreography: `scrollIntoView` + `scrollend` event listener with 400ms fallback timeout
- Added `pendingOpenRef` pattern for seamless article-to-article switching (close current, open next on exit complete)
- Made controls bar always sticky (removed conditional `position` ternary)
- Updated IntersectionObserver to use `root: mainRef.current` (scroll container, not viewport)
- Added `React.forwardRef` to ArticleRow for row ref management via `useRef<Map<number, HTMLElement>>`
- Reordered ArticleRow content: Title > Meta/Categories > Summary
- Created `ollama_client.py` with lazy singleton `get_ollama_client(host)` and `close_ollama_client()`
- Updated `scoring.py` and `ollama_service.py` to use the singleton client
- Added `close_ollama_client()` to FastAPI lifespan shutdown

## Files Created/Modified
- `backend/src/backend/ollama_client.py` - New: lazy singleton with `get_ollama_client(host)` and `close_ollama_client()`
- `backend/src/backend/scoring.py` - Replaced per-call `AsyncClient(host, timeout)` with `get_ollama_client(host)`
- `backend/src/backend/ollama_service.py` - Same singleton pattern for `list_models`, `pull_model_stream`, `delete_model`
- `backend/src/backend/main.py` - Added `close_ollama_client()` in lifespan shutdown
- `frontend/src/components/layout/AppShell.tsx` - Changed `minHeight="100vh"` to `height="100vh"`, added `mainRef`, passed to ArticleList
- `frontend/src/components/article/ArticleList.tsx` - Major rework: Collapsible inline reader, scroll-to-top choreography, pendingOpenRef, always-sticky controls bar, row ref Map, Escape key close
- `frontend/src/components/article/ArticleRow.tsx` - Added `React.forwardRef`, reordered content to Title > Meta/Categories > Summary

## Decisions Made
- `height=100vh` over `minHeight=100vh` to make `<main>` the definitive scroll container — this is the root cause fix for all sticky positioning failures
- Collapsible unfold with scroll-to-top choreography over basic accordion — the row scrolls to top before expanding, giving a clean reading experience
- `scrollend` event with 400ms fallback over fixed-delay timeout — `scrollend` is more reliable but not universally fired, so the fallback ensures the choreography always completes
- `onExitComplete` over `setTimeout(300)` for close sequencing — the original plan used a fixed timeout to match animation duration, but `onExitComplete` is animation-aware and more robust
- Lazy singleton over connection pool for Ollama client — single-user app only needs one connection

## Deviations from Plan

### Major: Full unfold pattern instead of basic accordion
- **Original plan:** Basic Collapsible accordion insertion below the selected row, no scroll-to-top, `setTimeout(300)` for close sequencing
- **Actual implementation:** Full choreography with scroll-to-top (scrollIntoView + scrollend), `onExitComplete` for close sequencing, `pendingOpenRef` for article-to-article switching, row ref Map for scroll targeting
- **Reason:** Basic accordion left the selected row at its current scroll position, which often meant the reader opened partially off-screen. Scrolling the row to the top first creates a much better reading experience.

### Addition: Backend Ollama FD leak fix
- **Original plan:** Frontend-only (scroll container + accordion)
- **Actual implementation:** Also fixed a backend FD leak in Ollama client instantiation
- **Reason:** Discovered during the session. Per-call `AsyncClient` was never closed, leaking file descriptors. Low-risk singleton fix with proper shutdown cleanup.

### Addition: ArticleRow forwardRef and content reorder
- **Original plan:** No changes to ArticleRow
- **Actual implementation:** Added `forwardRef` for row ref management and reordered content (Title > Meta > Summary)
- **Reason:** forwardRef needed for scroll-to-row targeting. Content reorder follows UAT Test 3 user feedback.

## Issues Encountered

None blocking.

## Plan 07 Compatibility

Plan 07 touches `ArticleRow.tsx` (context menu visibility condition) and `ArticleList.tsx` (filter reorder). Our changes shift line numbers in both files but the logical edits remain valid:
- ArticleRow: removing `article.is_read &&` from context menu condition still applies despite forwardRef wrapper and content reorder
- ArticleList: `filterCollection` useMemo is still present and the reorder/count changes still apply despite the Collapsible restructuring
- Other Plan 07 files (Sidebar.tsx, confirm-dialog.tsx, ArticleContent.tsx) were not modified by Plan 06

No updates to Plan 07 needed — executor agents read files fresh and adapt to current state.

## Self-Check: PASSED

- `bun run build` — zero errors
- `bun run lint` — zero errors on changed files (pre-existing errors elsewhere unchanged)
- `uv run ruff check .` — zero new errors (pre-existing model.py warnings unchanged)
- `uv run pytest` — 31 pass, 6 pre-existing failures unchanged

---
*Phase: 09.5-refine-main-view-ux-and-typography*
*Completed: 2026-02-22*
