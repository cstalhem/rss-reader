---
phase: 09.5-refine-main-view-ux-and-typography
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/backend/schemas.py
  - backend/src/backend/routers/articles.py
  - frontend/src/lib/types.ts
  - frontend/src/lib/api.ts
  - frontend/src/hooks/useFeedMutations.ts
autonomous: true
requirements: []

must_haves:
  truths:
    - "Article list endpoint returns summary_preview and score_reasoning fields"
    - "Per-article rescore endpoint queues a single article for re-scoring"
    - "Mark-all-read endpoint marks all unread scored non-blocked articles as read (cross-feed)"
    - "Frontend types and API client match new backend response shape"
  artifacts:
    - path: "backend/src/backend/schemas.py"
      provides: "ArticleListItem with summary_preview and score_reasoning fields"
      contains: "summary_preview"
    - path: "backend/src/backend/routers/articles.py"
      provides: "POST /mark-all-read and POST /{article_id}/rescore endpoints"
      contains: "mark-all-read"
    - path: "frontend/src/lib/types.ts"
      provides: "Updated ArticleListItem with summary_preview and score_reasoning"
      contains: "summary_preview"
    - path: "frontend/src/lib/api.ts"
      provides: "rescoreArticle and markAllArticlesRead API functions"
      contains: "rescoreArticle"
  key_links:
    - from: "frontend/src/lib/api.ts"
      to: "/api/articles/mark-all-read"
      via: "fetch POST"
      pattern: "mark-all-read"
    - from: "frontend/src/lib/api.ts"
      to: "/api/articles/{id}/rescore"
      via: "fetch POST"
      pattern: "rescore"
---

<objective>
Add backend endpoints and frontend data layer for the main view UX redesign.

Purpose: Provide the data foundation (summary preview, per-article rescore, cross-feed mark-all-read) that all subsequent plans depend on.
Output: Updated schemas, two new backend endpoints, updated frontend types and API client functions.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09.5-refine-main-view-ux-and-typography/09.5-CONTEXT.md
@.planning/phases/09.5-refine-main-view-ux-and-typography/09.5-RESEARCH.md
@backend/src/backend/schemas.py
@backend/src/backend/routers/articles.py
@frontend/src/lib/types.ts
@frontend/src/lib/api.ts
@frontend/src/hooks/useFeedMutations.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Backend — Add summary_preview/score_reasoning to list endpoint, add rescore and mark-all-read endpoints</name>
  <files>
    backend/src/backend/schemas.py
    backend/src/backend/routers/articles.py
  </files>
  <action>
**schemas.py:**
- Add `summary_preview: str | None` and `score_reasoning: str | None` fields to `ArticleListItem`

**routers/articles.py:**
- Add a private helper `_strip_html_truncate(html: str | None, max_len: int = 200) -> str | None` that strips HTML tags via `re.sub(r"<[^>]+>", "", html)`, normalizes whitespace, and truncates with `...` suffix
- Update `_article_to_list_item` to include `summary_preview=_strip_html_truncate(article.summary)` and `score_reasoning=article.score_reasoning`
- Add `POST /mark-all-read` endpoint (static route, registered BEFORE parameterized `/{article_id}` routes):
  - Uses `sqlalchemy.update(Article)` with `.where(Article.is_read.is_(False)).where(Article.scoring_state == "scored").where(Article.composite_score != 0).values(is_read=True)`
  - Returns `{"ok": True, "count": result.rowcount}` after session.commit()
- Add `POST /{article_id}/rescore` endpoint:
  - Fetches article by ID, raises 404 if not found
  - Sets `article.scoring_state = "queued"` and `article.scoring_priority = 1`
  - Commits and returns `{"ok": True}`

**IMPORTANT:** The static route `/mark-all-read` MUST be registered before the parameterized route `/{article_id}` to avoid path conflicts. Move the existing `get_article` and `update_article` endpoints to AFTER the new static routes, or add the new static routes above them.
  </action>
  <verify>
`cd /Users/cstalhem/projects/rss-reader/backend && uv run ruff check . && uv run pytest` — all lint and tests pass.
  </verify>
  <done>
ArticleListItem schema includes summary_preview and score_reasoning. Two new endpoints exist: POST /api/articles/mark-all-read and POST /api/articles/{article_id}/rescore. Static route precedes parameterized routes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Frontend — Update types, API client, and mark-all-read hook</name>
  <files>
    frontend/src/lib/types.ts
    frontend/src/lib/api.ts
    frontend/src/hooks/useFeedMutations.ts
  </files>
  <action>
**types.ts:**
- Change `ArticleListItem` from `Omit<Article, "content" | "summary" | "score_reasoning">` to an explicit interface that includes all current fields PLUS `summary_preview: string | null` and `score_reasoning: string | null`. This is needed because the list endpoint now returns these two fields that weren't previously on the list item.

**api.ts:**
- Add `rescoreArticle(articleId: number): Promise<{ok: boolean}>` — POST to `${API_BASE_URL}/api/articles/${articleId}/rescore`
- Add `markAllArticlesRead(): Promise<{ok: boolean; count: number}>` — POST to `${API_BASE_URL}/api/articles/mark-all-read`

**useFeedMutations.ts:**
- Add `useMarkAllArticlesRead` hook that wraps `markAllArticlesRead` in a `useMutation` with:
  - `meta: { errorTitle: "Failed to mark all articles read" }`
  - `onSettled` that invalidates `queryKeys.articles.all` and `queryKeys.feeds.all`
- Export this new hook alongside existing exports
  </action>
  <verify>
`cd /Users/cstalhem/projects/rss-reader/frontend && bun run lint && bun run build` — no type or lint errors.
  </verify>
  <done>
ArticleListItem type includes summary_preview and score_reasoning. rescoreArticle and markAllArticlesRead API functions exist. useMarkAllArticlesRead hook exists and is exported.
  </done>
</task>

</tasks>

<verification>
1. Backend tests pass: `cd backend && uv run pytest`
2. Backend lint passes: `cd backend && uv run ruff check .`
3. Frontend builds: `cd frontend && bun run build`
4. Frontend lint passes: `cd frontend && bun run lint`
</verification>

<success_criteria>
- GET /api/articles returns objects with `summary_preview` (HTML-stripped, truncated to 200 chars) and `score_reasoning` fields
- POST /api/articles/mark-all-read marks all scored non-blocked unread articles as read
- POST /api/articles/{id}/rescore queues a single article for re-scoring with priority 1
- Frontend types match backend response shape
- Frontend API client and hooks ready for consumer components
</success_criteria>

<output>
After completion, create `.planning/phases/09.5-refine-main-view-ux-and-typography/09.5-01-SUMMARY.md`
</output>
