---
phase: 09.5-refine-main-view-ux-and-typography
plan: 01
subsystem: api, ui
tags: [fastapi, nextjs, tanstack-query, schemas, endpoints]

# Dependency graph
requires: []
provides:
  - ArticleListItem schema with summary_preview and score_reasoning fields
  - POST /api/articles/mark-all-read endpoint for cross-feed mark all read
  - POST /api/articles/{id}/rescore endpoint for per-article re-scoring
  - rescoreArticle and markAllArticlesRead frontend API functions
  - useMarkAllArticlesRead TanStack Query mutation hook
affects: [09.5-02, 09.5-03, 09.5-04, 09.5-05]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "_strip_html_truncate helper for HTML-to-text preview generation"
    - "Cross-feed bulk action endpoint pattern (mark-all-read)"

key-files:
  created: []
  modified:
    - backend/src/backend/schemas.py
    - backend/src/backend/routers/articles.py
    - frontend/src/lib/types.ts
    - frontend/src/lib/api.ts
    - frontend/src/hooks/useFeedMutations.ts

key-decisions:
  - "summary_preview generated server-side via HTML strip + truncate (not client-side)"
  - "mark-all-read uses sqlalchemy bulk update for efficiency (no per-article loop)"
  - "useMarkAllArticlesRead uses onSettled (not onSuccess) for cache freshness on both success and error"

patterns-established:
  - "_strip_html_truncate: regex HTML strip + whitespace normalize + ellipsis truncate"
  - "Cross-feed mark-all-read: bulk update with scored + non-blocked + unread filters"

requirements-completed: []

# Metrics
duration: 2.9min
completed: 2026-02-22
---

# Phase 09.5 Plan 01: Data Layer Foundation Summary

**Backend summary_preview/score_reasoning fields, per-article rescore and cross-feed mark-all-read endpoints, with matching frontend types, API client, and mutation hook**

## Performance

- **Duration:** 2.9 min
- **Started:** 2026-02-22T20:22:53Z
- **Completed:** 2026-02-22T20:25:50Z
- **Tasks:** 2
- **Files modified:** 5

## Accomplishments
- Added summary_preview (HTML-stripped, truncated to 200 chars) and score_reasoning fields to ArticleListItem schema and list endpoint
- Added POST /api/articles/mark-all-read endpoint with bulk update for scored non-blocked unread articles
- Added POST /api/articles/{id}/rescore endpoint that queues single article with priority 1
- Updated frontend ArticleListItem type to explicit interface matching new backend shape
- Added rescoreArticle and markAllArticlesRead API client functions
- Added useMarkAllArticlesRead hook with articles + feeds cache invalidation

## Task Commits

Each task was committed atomically:

1. **Task 1: Backend -- Add summary_preview/score_reasoning, rescore, and mark-all-read endpoints** - `40bbda1` (feat)
2. **Task 2: Frontend -- Update types, API client, and mark-all-read hook** - `f4277a1` (feat)

## Files Created/Modified
- `backend/src/backend/schemas.py` - Added summary_preview and score_reasoning to ArticleListItem
- `backend/src/backend/routers/articles.py` - Added _strip_html_truncate helper, updated _article_to_list_item, added mark-all-read and rescore endpoints
- `frontend/src/lib/types.ts` - Changed ArticleListItem from Omit type to explicit interface with new fields
- `frontend/src/lib/api.ts` - Added rescoreArticle and markAllArticlesRead functions
- `frontend/src/hooks/useFeedMutations.ts` - Added useMarkAllArticlesRead hook

## Decisions Made
- summary_preview generated server-side via HTML strip + truncate rather than shipping raw HTML to the client
- mark-all-read uses SQLAlchemy bulk update for efficiency rather than per-article loop
- useMarkAllArticlesRead uses onSettled instead of onSuccess for cache freshness on both success and error paths

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness
- All data layer foundations ready for consumer components in Plans 02-05
- summary_preview and score_reasoning available in article list responses
- rescoreArticle and markAllArticlesRead API functions ready for UI wiring
- useMarkAllArticlesRead hook ready for toolbar/button integration

## Self-Check: PASSED

All 5 modified files verified on disk. Both task commits (40bbda1, f4277a1) verified in git log.

---
*Phase: 09.5-refine-main-view-ux-and-typography*
*Completed: 2026-02-22*
