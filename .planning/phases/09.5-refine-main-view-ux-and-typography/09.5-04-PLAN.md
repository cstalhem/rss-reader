---
phase: 09.5-refine-main-view-ux-and-typography
plan: 04
type: execute
wave: 2
depends_on: ["09.5-01", "09.5-02"]
files_modified:
  - frontend/src/components/article/ArticleReader.tsx
  - frontend/src/components/article/ArticleContent.tsx
  - frontend/src/theme/typography.ts
autonomous: true
requirements: []

must_haves:
  truths:
    - "Reader replaces the article list in the main content area (not a drawer overlay)"
    - "Sidebar remains visible when reader is open"
    - "Reader has a sticky header with article title, Open original, Up/Down nav, and Close"
    - "Below sticky header: metadata, category tags, score + reasoning, then content"
    - "Content rendered via html-react-parser with DOMPurify sanitization"
    - "Images are responsive and lazy-loaded, links open in new tab"
    - "Content max-width is ~800px"
    - "Reader content styles defined as a reusable constant (not inline css prop)"
  artifacts:
    - path: "frontend/src/components/article/ArticleReader.tsx"
      provides: "Inline reader component (not drawer) with sticky header, metadata, content"
      contains: "position.*sticky"
    - path: "frontend/src/components/article/ArticleContent.tsx"
      provides: "Content rendering via html-react-parser + DOMPurify"
      contains: "html-react-parser"
    - path: "frontend/src/theme/typography.ts"
      provides: "Reader content styles as textStyle or exported constant"
      contains: "reader"
  key_links:
    - from: "frontend/src/components/article/ArticleReader.tsx"
      to: "frontend/src/components/article/ArticleContent.tsx"
      via: "renders ArticleContent with sanitized HTML"
      pattern: "ArticleContent"
    - from: "frontend/src/components/article/ArticleContent.tsx"
      to: "isomorphic-dompurify"
      via: "DOMPurify.sanitize before parse"
      pattern: "DOMPurify"
---

<objective>
Replace the drawer-based ArticleReader with an inline reader that swaps the article list in the main content area, and modernize content rendering.

Purpose: The inline reader provides a more integrated reading experience where the sidebar stays visible and the reader occupies the full content area. Content rendering via html-react-parser + DOMPurify replaces dangerouslySetInnerHTML for safety and element-level control.
Output: Rewritten ArticleReader as inline component, new ArticleContent component, installed html-react-parser + isomorphic-dompurify.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09.5-refine-main-view-ux-and-typography/09.5-CONTEXT.md
@.planning/phases/09.5-refine-main-view-ux-and-typography/09.5-RESEARCH.md
@.planning/phases/09.5-refine-main-view-ux-and-typography/09.5-01-SUMMARY.md
@.planning/phases/09.5-refine-main-view-ux-and-typography/09.5-02-SUMMARY.md
@frontend/src/components/article/ArticleReader.tsx
@frontend/src/components/article/ArticleList.tsx
@frontend/src/theme/typography.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create ArticleContent component with html-react-parser + DOMPurify</name>
  <files>
    frontend/src/components/article/ArticleContent.tsx
    frontend/src/theme/typography.ts
  </files>
  <action>
**Install dependencies:**
```bash
cd frontend && bun add html-react-parser isomorphic-dompurify && bun add -d @types/dompurify
```

**New file: ArticleContent.tsx:**
- Create a component that takes `html: string` prop and renders sanitized, parsed content
- Pipeline: `DOMPurify.sanitize(html)` → `parse(sanitized, parserOptions)`
- Parser options with `replace` callback:
  - `<img>`: wrap in `<a href={src} target="_blank" rel="noopener noreferrer">`, add `loading="lazy"`, `style={{ maxWidth: "100%", height: "auto" }}`, `borderRadius: "8px"`, `my: 4`
  - `<a>`: add `target="_blank"`, `rel="noopener noreferrer"`, recurse children with `domToReact`
- Wrap output in a `<Box>` with the reader content styles applied
- The reader content styles should be defined as a constant object (CSS-in-JS style) that can be applied via the `css` prop. Extract the current inline styles from ArticleReader.tsx into a named constant in this file or in typography.ts.

**typography.ts:**
- Try to define reader content styles as a Chakra `textStyle` (e.g., `reader.content`). If deeply nested selectors like `& pre code` and `& :not(pre) > code` don't work in `defineTextStyles`, instead export a `READER_CONTENT_STYLES` constant object from this file (or from ArticleContent.tsx) and use it via the `css` prop.
- Either way, the styles should be in ONE place (single source of truth), not inline in the component.
- Content `maxW` increases from `"680px"` to `"800px"` per CONTEXT.md decision.

**Type imports:**
- `import DOMPurify from "isomorphic-dompurify";`
- `import parse, { domToReact, Element, type HTMLReactParserOptions } from "html-react-parser";`
- Check `Element` import — in html-react-parser v5.x, `Element` is imported from `html-react-parser`. Verify the actual export. If `Element` is from `domhandler`, use `import { Element } from "domhandler"`.
  </action>
  <verify>
`cd /Users/cstalhem/projects/rss-reader/frontend && bun run build` — builds successfully. No SSR errors from isomorphic-dompurify.
  </verify>
  <done>
html-react-parser and isomorphic-dompurify installed. ArticleContent component renders sanitized HTML with custom image and link replacements. Reader content styles are defined as a single-source constant. Content max-width is 800px.
  </done>
</task>

<task type="auto">
  <name>Task 2: Rewrite ArticleReader as inline component (not drawer)</name>
  <files>
    frontend/src/components/article/ArticleReader.tsx
    frontend/src/components/article/ArticleList.tsx
  </files>
  <action>
**ArticleReader.tsx — Complete rewrite from drawer to inline:**

Remove all Drawer imports and rendering. The component now renders as a regular Box that fills the content area.

**Structure:**
1. **Sticky header bar** at top (`position="sticky"`, `top={0}`, `zIndex={2}`, `bg="bg"`, `borderBottomWidth="1px"`, `borderColor="border.subtle"`):
   - Left: Article title (truncated, `Text` with `whiteSpace="nowrap"`, `overflow="hidden"`, `textOverflow="ellipsis"`, `flex={1}`)
   - Right: Open original icon button (`LuExternalLink`, opens article.url in new tab), Up arrow (`LuArrowUp`, disabled if no prevArticle, calls onNavigate), Down arrow (`LuArrowDown`, same for next), Close X (`LuX`, calls onClose)
   - Use `Flex` with `alignItems="center"`, `gap={2}`, `px={4}`, `py={2}`

2. **Scrollable content area** below sticky header:
   - **Metadata block:** feed name, date, author — `Flex` with `gap={2}`, `fontSize="sm"`, `color="fg.muted"`, `px={4}` (or centered within max-width)
   - **Category tags:** existing tag rendering with interactive weight change
   - **Score + reasoning:** ScoreBadge + quality + score_reasoning text (existing pattern)
   - **Content:** `<ArticleContent html={contentHtml} />` — uses the new component from Task 1
   - All content centered with `maxW="800px"`, `mx="auto"`, `px={{ base: 4, md: 8 }}`

**Props interface change:**
```tsx
interface ArticleReaderProps {
  article: ArticleListItem;  // non-null — parent only renders when article is selected
  articles: ArticleListItem[];
  onClose: () => void;
  onNavigate: (article: ArticleListItem) => void;
}
```
Note: `article` is now non-null. The parent (ArticleList) conditionally renders based on `selectedArticle !== null`.

**Key prop on reader:** Parent already uses `key={selectedArticle.id}` which resets all state (optimisticWeights, etc.) on article change. Preserve this.

**Auto-mark-as-read:** Keep the `useAutoMarkAsRead` hook call.

**Data fetching:** Keep the `useQuery` for full article content (`fetchArticle`).

**Weight mutation:** Keep the `useMutation` for category weight changes.

**ArticleList.tsx — Conditional rendering:**
Update ArticleList to conditionally render:
- When `selectedArticle === null`: show the full article list (heading, controls, rows)
- When `selectedArticle !== null`: show `<ArticleReader key={selectedArticle.id} article={selectedArticle} articles={displayArticles ?? []} onClose={() => setSelectedArticle(null)} onNavigate={setSelectedArticle} />`
- The `useArticles` query stays mounted unconditionally at the top (data persists for prev/next)
- **Scroll position saving:** Before showing reader, save `scrollTop` of the main content area (or the scroll container). On close, restore it. Use a `useRef` to store the position. The scroll container is likely the `<Box as="main">` in AppShell — if ArticleList doesn't own the scroll, save `document.documentElement.scrollTop` or `window.scrollY`.
  </action>
  <verify>
`cd /Users/cstalhem/projects/rss-reader/frontend && bun run build` — builds with no errors. Clicking an article shows inline reader. Sidebar stays visible. Close returns to list.
  </verify>
  <done>
ArticleReader is an inline component (no drawer). Sticky header with title, nav arrows, close. Content rendered via ArticleContent with html-react-parser. Parent conditionally swaps between list and reader. Scroll position saved and restored.
  </done>
</task>

</tasks>

<verification>
1. `cd frontend && bun run build` — no type errors
2. `cd frontend && bun run lint` — no lint errors
3. No remaining Drawer imports in ArticleReader
4. ArticleContent uses html-react-parser (grep confirms)
5. Images are lazy-loaded, links open in new tab
6. Content max-width is 800px
7. Scroll position is restored when closing reader
</verification>

<success_criteria>
- Reader replaces article list in the main content area (no drawer overlay)
- Sidebar remains visible during reading
- Sticky header has: truncated title, Open original, Up/Down nav, Close X
- Below header: metadata → tags → score+reasoning → content
- Content rendered via html-react-parser with DOMPurify sanitization
- Images responsive/lazy-loaded, links open in new tab with proper rel
- Content max-width ~800px
- Reader content styles in a single named constant (not inline)
- Auto-mark-as-read still works
- Category weight changes still work
- Scroll position restored on reader close
</success_criteria>

<output>
After completion, create `.planning/phases/09.5-refine-main-view-ux-and-typography/09.5-04-SUMMARY.md`
</output>
