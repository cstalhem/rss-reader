---
phase: 01-production-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/pyproject.toml
  - backend/src/backend/config.py
  - backend/src/backend/database.py
  - backend/src/backend/main.py
  - backend/Dockerfile
  - backend/.dockerignore
autonomous: true

must_haves:
  truths:
    - "Backend container builds successfully with multi-stage Dockerfile"
    - "SQLite uses WAL mode preventing database locked errors"
    - "GET /health returns 200 when service is healthy"
    - "Configuration loads from YAML with environment variable overrides"
  artifacts:
    - path: "backend/src/backend/config.py"
      provides: "Pydantic Settings configuration management"
      contains: "class Settings"
    - path: "backend/Dockerfile"
      provides: "Multi-stage Docker build for backend"
      contains: "FROM python"
    - path: "backend/.dockerignore"
      provides: "Docker build exclusions"
      min_lines: 5
  key_links:
    - from: "backend/src/backend/database.py"
      to: "SQLite WAL mode"
      via: "event listener on connect"
      pattern: "PRAGMA journal_mode=WAL"
    - from: "backend/src/backend/main.py"
      to: "/health endpoint"
      via: "FastAPI route"
      pattern: "@app.get.*health"
---

<objective>
Configure backend for production Docker deployment with proper configuration management, SQLite WAL mode, and health monitoring.

Purpose: Establish backend infrastructure that can be containerized and monitored reliably.
Output: Production-ready backend with Dockerfile, configuration system, WAL mode, and health endpoint.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-production-infrastructure/01-CONTEXT.md
@.planning/phases/01-production-infrastructure/01-RESEARCH.md
@backend/src/backend/main.py
@backend/src/backend/database.py
@backend/pyproject.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add configuration management with Pydantic Settings</name>
  <files>
    backend/pyproject.toml
    backend/src/backend/config.py
  </files>
  <action>
    1. Add dependencies to pyproject.toml:
       - pydantic-settings>=2.0.0
       - pyyaml>=6.0.0

    2. Create backend/src/backend/config.py with Pydantic Settings:
       - DatabaseConfig model with `path: str = "/data/rss-reader.db"`
       - LoggingConfig model with `level: str = "INFO"` and `format: str = "json"`
       - SchedulerConfig model with `feed_refresh_interval: int = 1800` (30 min) and `log_job_execution: bool = False`
       - Settings class inheriting from BaseSettings:
         - Nested models for database, logging, scheduler
         - env_nested_delimiter='__' for DATABASE__PATH style overrides
         - Custom settings_customise_sources to load YAML from CONFIG_FILE env var (optional)
         - env_file='.env' for secrets
       - get_settings() function with @lru_cache for singleton

    Priority order: env vars > .env > YAML > defaults
    App must work with NO config file (just defaults).

    Use plain text log format (not JSON) - simpler for home server use.
  </action>
  <verify>
    Run: cd /Users/cstalhem/projects/rss-reader/backend && uv sync
    Verify pydantic-settings installs without error.
  </verify>
  <done>
    config.py exists with Settings class, get_settings() returns valid config with defaults.
  </done>
</task>

<task type="auto">
  <name>Task 2: Enable SQLite WAL mode and add /health endpoint</name>
  <files>
    backend/src/backend/database.py
    backend/src/backend/main.py
  </files>
  <action>
    1. Update database.py:
       - Import get_settings from config
       - Import event from sqlalchemy
       - Use settings.database.path for DATABASE_URL construction
       - Add @event.listens_for(engine, "connect") decorator to set_sqlite_pragma function:
         - PRAGMA journal_mode=WAL
         - PRAGMA synchronous=NORMAL (performance)
         - PRAGMA cache_size=-64000 (64MB cache)
         - PRAGMA temp_store=MEMORY

    2. Update main.py:
       - Import get_settings from config
       - Create HealthResponse Pydantic model with status: str
       - Replace root() with proper /health endpoint:
         - Route: GET /health
         - Returns HealthResponse(status="healthy")
         - Include status_code=200 in decorator
         - Add tags=["monitoring"]
       - Use settings in lifespan for data directory (settings.database.path directory)
       - Configure logging using settings.logging.level
       - Keep existing /api/articles endpoints unchanged
  </action>
  <verify>
    Run backend and test health endpoint:
    cd /Users/cstalhem/projects/rss-reader/backend && uv run uvicorn backend.main:app --host 0.0.0.0 --port 8000 &
    sleep 3
    curl -s http://localhost:8000/health | grep -q "healthy" && echo "Health check OK"
    pkill -f "uvicorn backend.main"

    Verify WAL mode by checking for .db-wal file after first connection.
  </verify>
  <done>
    /health endpoint returns {"status": "healthy"}, SQLite creates -wal and -shm files.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create backend Dockerfile with multi-stage build</name>
  <files>
    backend/Dockerfile
    backend/.dockerignore
  </files>
  <action>
    1. Create backend/.dockerignore:
       - .venv/
       - __pycache__/
       - *.pyc, *.pyo, *.pyd
       - .pytest_cache/
       - .ruff_cache/
       - .coverage, htmlcov/
       - dist/, build/, *.egg-info/
       - .git/
       - .env
       - data/
       - *.db, *.db-wal, *.db-shm

    2. Create backend/Dockerfile with multi-stage build:

       Builder stage (FROM python:3.14-slim AS builder):
       - COPY --from=ghcr.io/astral-sh/uv:latest /uv /uvx /bin/
       - WORKDIR /app
       - COPY pyproject.toml uv.lock ./
       - ENV UV_LINK_MODE=copy UV_COMPILE_BYTECODE=1
       - RUN --mount=type=cache,target=/root/.cache/uv uv sync --locked --no-install-project --no-dev
       - COPY . .
       - RUN --mount=type=cache,target=/root/.cache/uv uv sync --locked --no-dev

       Runtime stage (FROM python:3.14-slim):
       - Install curl for health checks: RUN apt-get update && apt-get install -y --no-install-recommends curl && rm -rf /var/lib/apt/lists/*
       - WORKDIR /app
       - COPY --from=builder /app/.venv /app/.venv
       - COPY --from=builder /app/src /app/src
       - ENV PATH="/app/.venv/bin:$PATH" PYTHONUNBUFFERED=1
       - HEALTHCHECK --interval=10s --timeout=5s --retries=3 --start-period=10s CMD curl -f http://localhost:8000/health || exit 1
       - EXPOSE 8000
       - CMD ["uvicorn", "backend.main:app", "--host", "0.0.0.0", "--port", "8000"]

    Note: Use exec form CMD for proper signal handling.
  </action>
  <verify>
    Build the image:
    cd /Users/cstalhem/projects/rss-reader/backend && docker build -t rss-reader-backend:test .
    Verify build completes without error.

    Test container starts:
    docker run --rm -d --name test-backend -p 8001:8000 rss-reader-backend:test
    sleep 5
    curl -s http://localhost:8001/health | grep -q "healthy" && echo "Container healthy"
    docker stop test-backend
  </verify>
  <done>
    Dockerfile builds successfully, container starts and /health returns healthy.
  </done>
</task>

</tasks>

<verification>
1. Config system works: `uv run python -c "from backend.config import get_settings; print(get_settings())"` prints config
2. WAL mode active: After running backend once, `ls data/` shows .db-wal file
3. Health endpoint works: `curl http://localhost:8000/health` returns 200 with {"status": "healthy"}
4. Docker build succeeds: `docker build -t rss-reader-backend:test backend/` completes
5. Container runs: `docker run --rm rss-reader-backend:test` starts without error
</verification>

<success_criteria>
- pydantic-settings and pyyaml added to dependencies
- config.py provides Settings with database, logging, scheduler sections
- database.py enables WAL mode on every connection
- main.py exposes /health endpoint
- Dockerfile builds production image with multi-stage build
- Container passes health check within 30 seconds of startup
</success_criteria>

<output>
After completion, create `.planning/phases/01-production-infrastructure/01-01-SUMMARY.md`
</output>
