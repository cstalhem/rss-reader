---
phase: 03-feed-management
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - frontend/src/lib/types.ts
  - frontend/src/lib/api.ts
  - frontend/src/hooks/useFeeds.ts
  - frontend/src/hooks/useFeedMutations.ts
  - frontend/src/hooks/useLocalStorage.ts
  - frontend/src/hooks/useArticles.ts
  - frontend/src/components/layout/AppShell.tsx
  - frontend/src/components/layout/Header.tsx
  - frontend/src/components/layout/Sidebar.tsx
  - frontend/src/components/layout/MobileSidebar.tsx
  - frontend/src/components/feed/AddFeedDialog.tsx
  - frontend/src/components/feed/EmptyFeedState.tsx
  - frontend/src/components/article/ArticleList.tsx
autonomous: true

must_haves:
  truths:
    - "Sidebar shows list of feeds below 'All Articles' with per-feed unread counts"
    - "Clicking a feed filters article list to that feed only"
    - "Clicking 'All Articles' shows all articles (aggregate unread count displayed)"
    - "Selected feed row has accent highlight"
    - "Sidebar collapses fully on desktop with toggle button to restore, state persists via localStorage"
    - "On mobile, hamburger button in header opens sidebar as drawer overlay"
    - "'+' button in sidebar header opens add feed dialog"
    - "Add feed dialog: URL input, submit fetches feed, shows spinner + status, on success enables rename field"
    - "Dialog stays open after add for adding more feeds; 'Done' button closes"
    - "Empty sidebar shows friendly message prompting to add first feed"
  artifacts:
    - path: "frontend/src/hooks/useFeeds.ts"
      provides: "TanStack Query hook for fetching feeds"
      exports: ["useFeeds"]
    - path: "frontend/src/hooks/useFeedMutations.ts"
      provides: "Mutations for add, delete, update, reorder, mark-all-read"
      exports: ["useAddFeed", "useDeleteFeed", "useUpdateFeed", "useReorderFeeds", "useMarkAllRead"]
    - path: "frontend/src/hooks/useLocalStorage.ts"
      provides: "localStorage persistence hook"
      exports: ["useLocalStorage"]
    - path: "frontend/src/components/layout/MobileSidebar.tsx"
      provides: "Drawer overlay for mobile sidebar"
    - path: "frontend/src/components/feed/AddFeedDialog.tsx"
      provides: "Dialog for adding new RSS feeds"
    - path: "frontend/src/components/feed/EmptyFeedState.tsx"
      provides: "Empty state message for sidebar with no feeds"
  key_links:
    - from: "Sidebar.tsx"
      to: "useFeeds hook"
      via: "data fetching for feed list"
      pattern: "useFeeds"
    - from: "AddFeedDialog.tsx"
      to: "useAddFeed mutation"
      via: "form submit triggers mutation"
      pattern: "useAddFeed"
    - from: "Sidebar feed click"
      to: "ArticleList feed filter"
      via: "selectedFeedId state in AppShell"
      pattern: "selectedFeedId"
    - from: "MobileSidebar.tsx"
      to: "Sidebar feed list"
      via: "shared FeedList rendering inside Drawer"
      pattern: "Drawer.*FeedList"
---

<objective>
Build the frontend data layer, sidebar with feed list, mobile sidebar drawer, and add feed dialog.

Purpose: Enable users to see their feeds, navigate between them, add new feeds, and use the app on mobile. This is the core UI for feed management.
Output: Working sidebar with feed navigation, add feed dialog, mobile drawer, and data hooks.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-feed-management/03-RESEARCH.md
@.planning/phases/03-feed-management/03-01-SUMMARY.md
@frontend/src/lib/types.ts
@frontend/src/lib/api.ts
@frontend/src/lib/queryClient.ts
@frontend/src/hooks/useArticles.ts
@frontend/src/components/layout/AppShell.tsx
@frontend/src/components/layout/Header.tsx
@frontend/src/components/layout/Sidebar.tsx
@frontend/src/components/article/ArticleList.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Frontend data layer — types, API client, hooks</name>
  <files>
    frontend/src/lib/types.ts
    frontend/src/lib/api.ts
    frontend/src/hooks/useFeeds.ts
    frontend/src/hooks/useFeedMutations.ts
    frontend/src/hooks/useLocalStorage.ts
    frontend/src/hooks/useArticles.ts
  </files>
  <action>
  **types.ts** — Update Feed interface to include `display_order: number` and `unread_count: number`. Add `FeedCreateResponse` type if the backend returns extra fields (article count).

  **api.ts** — Add feed API client functions following existing pattern (throw on !ok):
  - `fetchFeeds(): Promise<Feed[]>` — GET /api/feeds
  - `createFeed(url: string): Promise<Feed>` — POST /api/feeds with JSON body `{url}`
  - `deleteFeed(id: number): Promise<void>` — DELETE /api/feeds/{id}
  - `updateFeed(id: number, data: {title?: string, display_order?: number}): Promise<Feed>` — PATCH /api/feeds/{id}
  - `reorderFeeds(feedIds: number[]): Promise<void>` — PATCH /api/feeds/reorder with JSON body `{feed_ids}`
  - `markAllFeedRead(feedId: number): Promise<void>` — POST /api/feeds/{feedId}/mark-all-read

  Update `fetchArticles` to accept optional `feed_id` parameter and pass it as query param.

  **useFeeds.ts** — Create hook using `useQuery` with key `["feeds"]`, calls `fetchFeeds()`, same pattern as useArticles.

  **useFeedMutations.ts** — Create mutation hooks:
  - `useAddFeed()` — mutationFn calls `createFeed(url)`. onSuccess: invalidate `["feeds"]` and `["articles"]` queries.
  - `useDeleteFeed()` — mutationFn calls `deleteFeed(id)`. onSuccess: invalidate `["feeds"]` and `["articles"]`.
  - `useUpdateFeed()` — mutationFn calls `updateFeed(id, data)`. onSuccess: invalidate `["feeds"]`.
  - `useReorderFeeds()` — mutationFn calls `reorderFeeds(feedIds)`. Use optimistic update pattern: onMutate cancels queries, snapshots previous, sets optimistic data. onError rolls back. onSettled invalidates.
  - `useMarkAllRead()` — mutationFn calls `markAllFeedRead(feedId)`. onSuccess: invalidate `["feeds"]` and `["articles"]`.

  **useLocalStorage.ts** — Create generic hook `useLocalStorage<T>(key: string, initialValue: T): [T, (value: T) => void]`. SSR-safe (check `typeof window`). Reads from localStorage on init, writes on setValue. JSON serialize/deserialize.

  **useArticles.ts** — Update `useArticles` to accept optional `feedId` parameter. Pass it to `fetchArticles` as `feed_id`. Include `feedId` in the query key so feed switches trigger refetch.
  </action>
  <verify>
  Run `cd /Users/cstalhem/projects/rss-reader/frontend && npx tsc --noEmit` to confirm no type errors.

  Check imports resolve: `grep -r "useFeeds\|useFeedMutations\|useLocalStorage" frontend/src/hooks/`
  </verify>
  <done>All feed API functions, query hooks, mutation hooks, and localStorage hook exist and type-check. useArticles supports feedId filter.</done>
</task>

<task type="auto">
  <name>Task 2: Sidebar with feed list, mobile drawer, and AppShell integration</name>
  <files>
    frontend/src/components/layout/Sidebar.tsx
    frontend/src/components/layout/MobileSidebar.tsx
    frontend/src/components/layout/AppShell.tsx
    frontend/src/components/layout/Header.tsx
    frontend/src/components/feed/EmptyFeedState.tsx
    frontend/src/components/article/ArticleList.tsx
  </files>
  <action>
  **AppShell.tsx** — Lift state for feed management:
  - Replace `useState` for sidebar collapse with `useLocalStorage('sidebar-collapsed', false)` for persistence.
  - Add `selectedFeedId: number | null` state (null = "All Articles").
  - Add `isMobileSidebarOpen` state for hamburger menu.
  - Pass `selectedFeedId` and `onSelectFeed` to Sidebar, MobileSidebar, and ArticleList.
  - Render MobileSidebar component (only shows on mobile via Drawer).

  **Header.tsx** — Add hamburger menu button on mobile (display on base, hidden on md+). Use `LuMenu` icon from react-icons/lu. Clicking toggles mobile sidebar open. Accept `onMenuToggle` prop from AppShell.

  **Sidebar.tsx** — Full overhaul:
  - Accept props: `isCollapsed`, `onToggle`, `selectedFeedId`, `onSelectFeed`, `onAddFeedClick`.
  - Use `useFeeds()` hook to fetch feed list.
  - Render sidebar header with "Feeds" label and '+' IconButton (opens add dialog, via `onAddFeedClick` callback).
  - Render "All Articles" row first — clickable, shows aggregate unread count (sum of all feed unread_counts). Highlight with accent when `selectedFeedId === null`.
  - Below: render feed list. Each feed row shows title and unread_count badge. Clickable — sets `selectedFeedId` to feed.id. Highlight with accent bg when selected.
  - When collapsed: show only the collapse toggle button (existing behavior).
  - If no feeds and not collapsed: render `EmptyFeedState`.
  - Keep existing styling patterns (bg.subtle, border.subtle, etc).

  **MobileSidebar.tsx** — NEW component:
  - Accepts `isOpen`, `onClose`, `selectedFeedId`, `onSelectFeed`, `onAddFeedClick`.
  - Uses Chakra Drawer with placement="left", size="xs" on sm+ and "full" on base.
  - Drawer header: "Feeds" title + '+' button + close trigger.
  - Drawer body: Same feed list as Sidebar (reuse rendering logic — extract a shared FeedListContent component or inline duplicate since it's small).
  - When a feed is clicked: call `onSelectFeed(feedId)` AND `onClose()` to dismiss drawer.
  - Display only on mobile (the Drawer itself handles visibility; the trigger is in Header).

  **EmptyFeedState.tsx** — NEW component:
  - Simple centered message: "No feeds yet — tap + to add your first feed" with muted text styling.
  - Keep it minimal — just a Box with Text.

  **ArticleList.tsx** — Accept `selectedFeedId: number | null` prop. Pass `feedId: selectedFeedId ?? undefined` to `useArticles()`. This makes the article list filter by feed when a feed is selected. No other changes to ArticleList.

  **Integration in AppShell:**
  - Add state for `isAddDialogOpen` boolean.
  - Pass `onAddFeedClick={() => setIsAddDialogOpen(true)}` to Sidebar and MobileSidebar.
  - Render `AddFeedDialog` (from Task 3) with `isOpen={isAddDialogOpen}` and `onClose`. For now, just add the state and pass prop — the dialog component will be created in Task 3. If AddFeedDialog doesn't exist yet, conditionally render it or add a placeholder.
  </action>
  <verify>
  Run `cd /Users/cstalhem/projects/rss-reader/frontend && npx tsc --noEmit` to confirm no type errors.

  Start the dev server (`npm run dev`) and verify:
  1. Sidebar shows "All Articles" with aggregate unread count
  2. Feeds appear below "All Articles" (if any exist in DB)
  3. Clicking a feed filters the article list
  4. Clicking "All Articles" shows all articles
  5. Selected feed has visual highlight
  6. Sidebar collapse works and state persists on reload
  7. On mobile viewport: hamburger button appears, opens drawer with feed list
  8. Clicking feed in mobile drawer closes drawer and filters articles
  </verify>
  <done>Sidebar shows feed list with unread counts. Feed selection filters articles. Sidebar collapse persists. Mobile drawer works with hamburger menu. Empty state shown when no feeds.</done>
</task>

<task type="auto">
  <name>Task 3: Add Feed Dialog with URL validation and rename flow</name>
  <files>
    frontend/src/components/feed/AddFeedDialog.tsx
    frontend/src/components/layout/AppShell.tsx
  </files>
  <action>
  **AddFeedDialog.tsx** — NEW component implementing the full add-feed flow per user decisions:

  Props: `isOpen: boolean`, `onClose: () => void`.

  State machine with steps:
  1. **url** step (initial): URL input field + "Add" submit button.
  2. **loading** step: Spinner + status text "Fetching feed..." while mutation runs.
  3. **success** step: Status text "Found X articles". Name input field auto-populated with feed title from response — user can edit to rename. "Save Name" button (if renamed) and "Add Another" button that resets to step 1.

  Use `useAddFeed()` mutation from useFeedMutations. On submit:
  - Set step to loading.
  - Call mutation with URL.
  - On success: set step to success, store response (feed title, article count).
  - On error: set step back to url, show error inline using Chakra Field.Root with invalid prop and Field.ErrorText.

  If user edits the name in success step and clicks "Save Name": call `useUpdateFeed()` with new title, then show confirmation (brief inline text or keep simple).

  "Done" button in footer closes dialog (any step).
  When dialog closes (via Done or backdrop click): reset all state to initial (url step, empty inputs, no error). Use the reset-on-close pattern — reset state in the onClose handler.

  Dialog stays open after successful add — user can click "Add Another" to add more feeds.

  Use Chakra Dialog.Root with placement="center". Structure:
  - Dialog.Backdrop
  - Dialog.Positioner
  - Dialog.Content (maxW="md" for reasonable sizing)
  - Dialog.Header with Dialog.Title "Add RSS Feed"
  - Dialog.Body with form content
  - Dialog.Footer with action buttons
  - Dialog.CloseTrigger

  Error handling: show error text below URL input. Common errors: "URL must start with http:// or https://", "Failed to fetch URL", "URL is not a valid RSS feed", "Feed already exists".

  **AppShell.tsx** — Wire up the AddFeedDialog:
  - Import AddFeedDialog.
  - Render `<AddFeedDialog isOpen={isAddDialogOpen} onClose={() => setIsAddDialogOpen(false)} />` inside AppShell.
  </action>
  <verify>
  Run `cd /Users/cstalhem/projects/rss-reader/frontend && npx tsc --noEmit` to confirm no type errors.

  Manual test with dev server running (both frontend and backend):
  1. Click '+' in sidebar header — dialog opens centered
  2. Enter invalid URL — shows error inline
  3. Enter valid RSS feed URL (e.g., https://feeds.arstechnica.com/arstechnica/index) — shows spinner, then success with article count
  4. Name field shows feed title — can edit and save
  5. Click "Add Another" — form resets to URL step
  6. Click "Done" — dialog closes
  7. Reopen dialog — form is fresh (no stale state)
  8. New feed appears in sidebar with unread count
  </verify>
  <done>Add feed dialog opens from sidebar '+' button. Full flow works: URL input, validation, spinner, success with article count, rename, add another. Dialog resets on close. Errors shown inline.</done>
</task>

</tasks>

<verification>
- Feeds appear in sidebar with correct unread counts
- Clicking "All Articles" shows aggregate count and all articles
- Clicking a specific feed filters to that feed's articles only
- Selected feed has accent highlight
- Sidebar collapse persists across page reload (localStorage)
- Mobile hamburger menu opens drawer with feed list
- Mobile drawer closes on feed selection
- Add feed dialog: URL → validate → spinner → success → rename → add another
- Add feed dialog shows inline errors for invalid URLs
- Dialog resets on close
- Empty sidebar shows "No feeds yet" message
- TypeScript compiles with no errors
</verification>

<success_criteria>
Users can see feeds in sidebar, navigate between them to filter articles, add new feeds via dialog with URL validation and rename, and use the app on mobile via hamburger menu drawer. All state changes persist correctly.
</success_criteria>

<output>
After completion, create `.planning/phases/03-feed-management/03-02-SUMMARY.md`
</output>
