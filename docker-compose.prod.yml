services:
  ollama:
    image: ollama/ollama:latest
    container_name: rss-reader-ollama
    restart: unless-stopped
    volumes:
      - ollama-data:/root/.ollama
    networks:
      - internal

  backend:
    image: ghcr.io/cstalhem/rss-reader/backend:latest
    container_name: rss-reader-backend
    restart: unless-stopped
    depends_on:
      - ollama
    volumes:
      - db-data:/data
      - ./config:/config:ro
    environment:
      - CONFIG_FILE=/config/app.yaml
      - PYTHONUNBUFFERED=1
      - OLLAMA__HOST=http://ollama:11434
    env_file:
      - .env
    healthcheck:
      test: ["CMD", "curl", "-f", "http://127.0.0.1:8000/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    stop_grace_period: 30s
    labels:
      traefik.enable: "true"
      traefik.http.routers.rss-reader-backend.rule: Host(`rss-reader.tailsrv1.home.stalhem.se`) && PathPrefix(`/api`)
      traefik.http.routers.rss-reader-backend.entrypoints: websecure
      traefik.http.routers.rss-reader-backend.tls: "true"
      traefik.http.routers.rss-reader-backend.tls.certresolver: cloudflare
      traefik.http.routers.rss-reader-backend.service: rss-reader-backend-service
      traefik.http.services.rss-reader-backend-service.loadbalancer.server.port: "8000"
    networks:
      - srv1_docker_net
      - internal

  frontend:
    image: ghcr.io/cstalhem/rss-reader/frontend:latest
    container_name: rss-reader-frontend
    restart: unless-stopped
    depends_on:
      backend:
        condition: service_healthy
        restart: true
    labels:
      traefik.enable: "true"
      traefik.http.routers.rss-reader-frontend.rule: Host(`rss-reader.tailsrv1.home.stalhem.se`)
      traefik.http.routers.rss-reader-frontend.entrypoints: websecure
      traefik.http.routers.rss-reader-frontend.tls: "true"
      traefik.http.routers.rss-reader-frontend.tls.certresolver: cloudflare
      traefik.http.routers.rss-reader-frontend.service: rss-reader-frontend-service
      traefik.http.services.rss-reader-frontend-service.loadbalancer.server.port: "3000"
    networks:
      - srv1_docker_net

volumes:
  db-data:
    driver: local
  ollama-data:
    driver: local

networks:
  srv1_docker_net:
    external: true
  internal:
    driver: bridge
